
 /**
 * @app $Id: jsroll.dao.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA
 * @author Андрей Новиков andrey (at) novikov (dot) be
 * @status beta
 * @version 2.1.2b
 * @revision $Id: jsroll.dao.min.js 0004 06/05/2022 12:30:01Z $
 */\n

(function(b,c,e){"use strict";var a=function(h,f,i,j,g){return Object.merge({processing:false,get name(){return this.tables[0]},tables:typeof h==="string"?[h]:h,autoIncrement:!!f,primaryKey:f||null,schema:i,launch:j,clear:function(m){var n=this,k;try{var l=n.store("readwrite",n.status(a.NEWINDEX),m);if(m&&typeof m.success==="function"){return l.clear().onsuccess=function(p){return status=m.success.call(n,p,l)}}else{return l.clear().onsuccess=m.complete}}catch(o){if(m&&typeof m.fail==="function"){m.fail.call(n,o)}else{n.fail(o)}}},count:function(k,m){var n=this;try{var l=n.store("readonly",n.status(a.COUNT),m);if(typeof k==="function"){l.count().onsuccess=function(p){return k.call(n,p,n.status(a.COUNT),l)}}else{l.count().onsuccess=l.oncomplete}}catch(o){n.fail(o)}},paginator:function(r,o,m){var q=this,u=[],k=parseInt(r),n=parseInt(o),t=k===0;var s=q.store("readonly",q.status(a.PAGINATOR),m);s.count().onsuccess=function(p){var l=parseInt(p.target.result);if(l>0){s.openCursor().onsuccess=function(v){var w=v.target.result;if(w&&u.length<n){if(!t){t=true;w.advance(k*n)}else{u.push(w.value);w["continue"]()}}else{return s.oncomplete({result:u,count:l,page:k,limit:n})}}}else{return s.oncomplete({result:[],count:0,page:k,limit:n})}}},createIndex:function(m,p,l){var n=this;try{var k=n.store("readwrite",n.status(a.NEWINDEX));return k.createIndex(m,p,l).onsuccess=k.oncomplete}catch(o){n.fail(o)}},index:function(n){var o=this,k;try{var l=o.store("readonly",o.status(a.INDEX),n);var m=l.index(arguments.shift());k=m.get(arguments).onsuccess=l.oncomplete;return typeof k==="function"?{}:k}catch(p){o.fail(p)}},get:function(p,m){var n=this,k;try{var l=n.store("readonly",n.status(a.GET),m);if(m&&typeof m.success==="function"){k=l.get(p).onsuccess=function(q){return status=m.success.call(n,q,n.status(a.GET),l)}}else{k=l.get(p).onsuccess=l.oncomplete}return typeof k==="function"?{}:k}catch(o){if(m&&typeof m.fail==="function"){m.fail.call(n,o)}else{n.fail(o)}}},getAll:function(n){var o=this,l=true,k;if(o.processing){return(n&&typeof n.cancel==="function")?n.cancel.call(o,p):o.cancel(p)}try{var m=o.store("readonly",o.status(a.GETALL,l),n);if(n&&typeof n.success==="function"){k=m.getAll().onsuccess=function(q){return l=n.success.call(o,q,o.status(a.GETALL),m)}}else{k=m.getAll().onsuccess=m.oncomplete}return typeof k==="function"?{}:k}catch(p){if(n&&typeof n.fail==="function"){n.fail.call(o,p)}else{o.fail(p)}}},add:function(o,k){var p=this,n=true,u=[],w=o instanceof Array?o:[o];if(p.processing){return(k&&typeof k.cancel==="function")?k.cancel.call(p,s):p.cancel(s)}try{p.processing=true;var t=p.store("readwrite",p.status(a.ADD,n),k);var q=0,v,m=w.length,r=function(){v=p.data2row(w[q++],QueryParam.STRNULL);if(v.hasOwnProperty(p.primaryKey)){if(v[p.primaryKey]===null||v[p.primaryKey]===""){delete v[p.primaryKey]}else{u.push(v[p.primaryKey])}}if(k&&typeof k.success==="function"){t.add(v).onsuccess=function(l){return n=n&&k.success.call(p,l,p.status(a.ADD,n),t,q,w)}}else{t.add(v)}if(q<m){return r()}else{p.processing=false;t.oncomplete({result:u,rows:w});return u}};return r()}catch(s){p.processing=false;if(k&&typeof k.fail==="function"){k.fail.call(p,s)}else{p.fail(s)}}},put:function(o,k){var p=this,n=true,u=[],w=o instanceof Array?o:[o];if(p.processing){return(k&&typeof k.cancel==="function")?k.cancel.call(p,s):p.cancel(s)}try{p.processing=true;var t=p.store("readwrite",p.status(a.PUT,n),k);var q=0,v,m=w.length,r=function(){v=p.data2row(w[q++],QueryParam.STRNULL);if(!p.primaryKey||v[p.primaryKey]===null||v[p.primaryKey]===""){throw"PrimaryKey is not set!"}else{u.push(v[p.primaryKey])}if(k&&typeof k.success==="function"){t.put(v).onsuccess=function(l){return n=n&&k.success.call(p,l,p.status(a.PUT,n),t,q,w)}}else{t.put(v)}if(q<m){return r()}else{p.processing=false;t.oncomplete({result:u,rows:w});return u}};return r()}catch(s){p.processing=false;if(k&&typeof k.fail==="function"){k.fail.call(p,s)}else{p.fail(s)}}},del:function(u,m){var p=this,o=true;if(p.processing){return(m&&typeof m.cancel==="function")?m.cancel.call(p,s):p.cancel(s)}if(!(u instanceof Array)){u=[u]}try{p.processing=true;var t=p.store("readwrite",p.status(a.DEL,o),m);var q=0,k,n=u.length,r=function(){k=u[q++];if(m&&typeof m.success==="function"){t["delete"](k).onsuccess=function(l){return m.success.call(p,l,p.status(a.DEL,o),t,q,rows)}}else{t["delete"](k)}if(q<n){return r()}else{p.processing=false;t.oncomplete({result:u});return u}};return r()}catch(s){p.processing=false;if(m&&typeof m.fail==="function"){m.fail.call(p,s)}else{p.fail(s)}}}},g)};a.GET=1;a.GETALL=2;a.ADD=3;a.PUT=3;a.UPSERT=4;a.DEL=5;a.INDEX=6;a.TRUNCATE=7;a.COUNT=8;a.NEWINDEX=9;a.PAGINATOR=10;b.IndexedDBmodel=a;var d=function(g,f){if(f&&typeof f==="object"){this.merge(f)}if(g!==null){this.webSQLinstance=g}else{throw"webSQL object not exist!"}};d.prototype={webSQLinstance:null,modelName:null,tableName:null,primaryKey:null,processing:false,requestLimit:1500,DDL:null,done:function(f,g){return console.log("webSQLmodel "+this.webSQLinstance+" успешно стартовала")},fail:function(f,g){return console.error("webSQLmodel "+g.message)},init:function(g,f){if(this.webSQLinstance===null){return console.error("DB webSQL not istalled!")}if(typeof f!=="undefined"&&f!==this.webSQLinstance.version){this.webSQLinstance.changeVersion(this.webSQLinstance.version,f,this.changeVersion)}this.webSQLinstance.stmt([g?g:this.DDL],[],this.done,this.fail);return this},changeVersion:function(f){return console.log(f)},unload:function(j,i,h){var f=this,g=Object.assign({timer:0,xhrCount:0,url:"/chunking",method:"PUT",params:{},limit:100,page:0,count:0},h);if(typeof i==="string"){f.webSQLinstance.filter(i,[],function(k,l){g.count=l.rows?l.rows[0].count:0;if(g.count===0){return false}else{if(typeof g.before==="function"){g.before(l)}}var m=function(o,p){var n=" LIMIT "+g.limit+" OFFSET "+(g.page*g.limit);f.webSQLinstance.filter(j+n,[],function(q,s){g.length=parseInt(s&&s.rows.length);var u=function(){if(f.processing&&!g.timer){g.timer=setTimeout(function(){u()},50);return false}clearTimeout(g.timer);xhr({method:g.method,url:g.url,rs:{"Content-type":"application/json",ver:f.webSQLinstance.version,pk:f.primaryKey,model:f.tablelName,limit:g.limit,page:g.page},data:JSON.stringify(Object.assign({rows:obj2array(s.rows)},g.params)),before:function(r){f.processing=true},after:function(r){f.processing=false;g.xhrCount++},done:function(v,t){var r=c.src(v).responseJSON;if(r.result==="ok"){if(g.length+(g.page++*g.limit)<g.count){if(typeof g.progress==="function"){g.progress(f,Object.assign(g,{rows:r.data?r.data.rows:[]}))}return m(q,s)}else{if(typeof g.after==="function"){g.after(f,Object.assign(g,{rows:r.data?r.data.rows:[]}))}}}else{if(typeof g.after==="function"){g.after(f,g)}console.error(r.message)}},fail:function(r){if(typeof g.after==="function"){g.after(f,r)}console.error("Model["+f.modalName+"]"+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}});return false};if(g.xhrCount<f.requestLimit||g.length>0){u()}else{if(typeof g.after==="function"){g.after()}}},function(q,r){console.error(r.message)})};if(typeof j==="string"){m(k,l)}},function(k,l){console.error(l.message)})}},populate:function(i){var g=this,h=Object.assign({timer:0,xhrCount:0,url:"/chunking",params:{},limit:100,page:0,count:0},i);var j=function(k){if(g.processing){h.timer=setTimeout(function(){j()},50);return false}clearTimeout(h.timer);xhr({url:location.update(h.url,h.params),rs:{ver:g.webSQLinstance.version,pk:g.primaryKey,model:g.tablelName,limit:h.limit,page:h.page},before:function(l){g.processing=true;return false},after:function(l){g.processing=false;h.xhrCount++;return false},done:function(o,n){var m=c.src(o).responseJSON;if(m.result==="ok"){h.length=m.data&&m.data.rows?m.data.rows.length:0;h.page=m.paginator.page+1;h.limit=m.paginator.limit||h.limit;h.count=m.paginator.count||h.length;var l=[];if(h.length>0){g.add(m.data.rows,{done:function(p,q){if(h.length+(m.paginator.page*h.limit)<h.count){if(typeof h.progress==="function"){h.progress(g,m)}return f(l)}else{if(typeof h.after==="function"){h.after(g,m)}}}},webSQL.BULK|webSQL.UPSERT)}}else{if(typeof h.after==="function"){h.after(g,m)}console.error(m.message)}return false},fail:function(l){if(typeof h.after==="function"){h.after(g,l)}console.error("Model["+g.modalName+"]"+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}});return false},f=function(k){if(h.xhrCount<g.requestLimit){j(k)}else{if(typeof h.after==="function"){h.after()}}return false};if(typeof h.before==="function"){h.before()}return f()}};b.webSQLmodel=d}(window,window.ui));