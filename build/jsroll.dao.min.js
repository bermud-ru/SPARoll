
 /**
 * @app $Id: jsroll.dao.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA
 * @author Андрей Новиков andrey (at) novikov (dot) be
 * @status beta
 * @version 2.1.2b
 * @revision $Id: jsroll.dao.min.js 0004 07/05/2022 18:46:20Z $
 */\n

(function(b,c,f){"use strict";var a=function(i,g,j,k,h){return Object.merge({processing:false,get name(){return this.tables[0]},tables:typeof i==="string"?[i]:i,autoIncrement:!!g,primaryKey:g||null,schema:j,launch:k,clear:function(m){var n=this,l=n.store("readwrite",n.status(a.NEWINDEX),m);if(m&&typeof m.success==="function"){return l.clear().onsuccess=function(o){return status=m.success.call(n,o,l)}}else{return l.clear().onsuccess=m.complete}},count:function(l,n){var o=this,m=o.store("readonly",o.status(a.COUNT),n);if(typeof l==="function"){m.count().onsuccess=function(p){return l.call(o,p,o.status(a.COUNT),m)}}else{m.count().onsuccess=m.oncomplete}},paginator:function(s,q,n){var r=this,v=[],m=parseInt(s),o=parseInt(q),u=m===0;var t=r.store("readonly",r.status(a.PAGINATOR),n);t.count().onsuccess=function(p){var l=p.target.result;if(l>0){t.openCursor().onsuccess=function(w){var x=w.target.result;if(x&&v.length<o){if(!u){u=true;x.advance(m*o)}else{v.push(x.value);x["continue"]()}}else{return t.oncomplete({result:v,count:l,page:m,limit:o})}}}else{return t.oncomplete({result:[],count:0,page:m,limit:o})}}},createIndex:function(n,p,m){var o=this,l=o.store("readwrite",o.status(a.NEWINDEX));return l.createIndex(n,p,m).onsuccess=l.oncomplete},index:function(o){var p=this,l,m=p.store("readonly",p.status(a.INDEX),o);var n=m.index(arguments.shift());l=n.get(arguments).onsuccess=m.oncomplete;return typeof l==="function"?{}:l},get:function(u,m){var o=this,v=[],r=u instanceof Array;if(!r){u=[u]}try{var t=o.store("readwrite",o.status(a.DEL),m);var p=0,n=u.length,q=function(){t.get(u[p++]).onsuccess=function(l){v.push(l.target.result);if(m&&typeof m.success==="function"){m.success.call(o,l,o.status(a.GET),t,p,rows)}if(p<n){return q()}t.oncomplete({result:v});return r?v:v[0]}};return q()}catch(s){if(m&&typeof m.fail==="function"){m.fail.call(o,s)}else{o.fail(s)}}},getAll:function(n){var o=this,l;if(o.processing){return(n&&typeof n.cancel==="function")?n.cancel.call(o,e):o.cancel(e)}var m=o.store("readonly",o.status(a.GETALL),n);if(n&&typeof n.success==="function"){l=m.getAll().onsuccess=function(p){return n.success.call(o,p,o.status(a.GETALL),m)}}else{l=m.getAll().onsuccess=m.oncomplete}return typeof l==="function"?{}:l},add:function(o,m){var p=this,u=[],w=o instanceof Array?o:[o];if(p.processing){return(m&&typeof m.cancel==="function")?m.cancel.call(p,s):p.cancel(s)}p.processing=true;try{var q=0,n=w.length,t=p.store("readwrite",p.status(a.ADD),m);var v,r=function(){v=p.data2row(w[q++],QueryParam.STRNULL);if(v.hasOwnProperty(p.primaryKey)&&(v[p.primaryKey]===null||v[p.primaryKey]==="")){delete v[p.primaryKey]}t.add(v).onsuccess=function(l){u.push(l.target.result);if(m&&typeof m.success==="function"){m.success.call(p,l,p.status(a.ADD),t,q,w)}if(q<n){return r()}p.processing=false;t.oncomplete({result:u,rows:w});return u}};return r()}catch(s){if(m&&typeof m.fail==="function"){m.fail.call(p,s)}else{p.fail(s)}}},put:function(o,m){var p=this,u=[],w=o instanceof Array?o:[o];if(p.processing){return(m&&typeof m.cancel==="function")?m.cancel.call(p,s):p.cancel(s)}p.processing=true;try{var q=0,n=w.length,t=p.store("readwrite",p.status(a.PUT),m);var v,r=function(){v=p.data2row(w[q++],QueryParam.STRNULL);if(!p.primaryKey||v[p.primaryKey]===null||v[p.primaryKey]===""){throw"PrimaryKey is not set!"}t.put(v).onsuccess=function(l){u.push(l.target.result);if(m&&typeof m.success==="function"){m.success.call(p,l,p.status(a.PUT),t,q,w)}if(q<n){return r()}p.processing=false;t.oncomplete({result:u,rows:w});return u}};return r()}catch(s){if(m&&typeof m.fail==="function"){m.fail.call(p,s)}else{p.fail(s)}}},del:function(u,m){var o=this,r=u instanceof Array;if(o.processing){return(m&&typeof m.cancel==="function")?m.cancel.call(o,s):o.cancel(s)}if(!r){u=[u]}o.processing=true;try{var t=o.store("readwrite",o.status(a.DEL),m);var p=0,n=u.length,q=function(){t["delete"](u[p++]).onsuccess=function(l){if(m&&typeof m.success==="function"){m.success.call(o,l,o.status(a.DEL),t,p,rows)}if(p<n){return q()}o.processing=false;t.oncomplete({result:u});return r?u:u[0]}};return q()}catch(s){if(m&&typeof m.fail==="function"){m.fail.call(o,s)}else{o.fail(s)}}}},h)};a.GET=1;a.GETALL=2;a.ADD=3;a.PUT=3;a.UPSERT=4;a.DEL=5;a.INDEX=6;a.TRUNCATE=7;a.COUNT=8;a.NEWINDEX=9;a.PAGINATOR=10;b.IndexedDBmodel=a;var d=function(h,g){if(g&&typeof g==="object"){this.merge(g)}if(h!==null){this.webSQLinstance=h}else{throw"webSQL object not exist!"}};d.prototype={webSQLinstance:null,modelName:null,tableName:null,primaryKey:null,processing:false,requestLimit:1500,DDL:null,done:function(g,h){return console.log("webSQLmodel "+this.webSQLinstance+" успешно стартовала")},fail:function(g,h){return console.error("webSQLmodel "+h.message)},init:function(h,g){if(this.webSQLinstance===null){return console.error("DB webSQL not istalled!")}if(typeof g!=="undefined"&&g!==this.webSQLinstance.version){this.webSQLinstance.changeVersion(this.webSQLinstance.version,g,this.changeVersion)}this.webSQLinstance.stmt([h?h:this.DDL],[],this.done,this.fail);return this},changeVersion:function(g){return console.log(g)},unload:function(k,j,i){var g=this,h=Object.assign({timer:0,xhrCount:0,url:"/chunking",method:"PUT",params:{},limit:100,page:0,count:0},i);if(typeof j==="string"){g.webSQLinstance.filter(j,[],function(l,m){h.count=m.rows?m.rows[0].count:0;if(h.count===0){return false}else{if(typeof h.before==="function"){h.before(m)}}var n=function(p,q){var o=" LIMIT "+h.limit+" OFFSET "+(h.page*h.limit);g.webSQLinstance.filter(k+o,[],function(s,u){h.length=parseInt(u&&u.rows.length);var v=function(){if(g.processing&&!h.timer){h.timer=setTimeout(function(){v()},50);return false}clearTimeout(h.timer);xhr({method:h.method,url:h.url,rs:{"Content-type":"application/json",ver:g.webSQLinstance.version,pk:g.primaryKey,model:g.tablelName,limit:h.limit,page:h.page},data:JSON.stringify(Object.assign({rows:obj2array(u.rows)},h.params)),before:function(r){g.processing=true},after:function(r){g.processing=false;h.xhrCount++},done:function(w,t){var r=c.src(w).responseJSON;if(r.result==="ok"){if(h.length+(h.page++*h.limit)<h.count){if(typeof h.progress==="function"){h.progress(g,Object.assign(h,{rows:r.data?r.data.rows:[]}))}return n(s,u)}else{if(typeof h.after==="function"){h.after(g,Object.assign(h,{rows:r.data?r.data.rows:[]}))}}}else{if(typeof h.after==="function"){h.after(g,h)}console.error(r.message)}},fail:function(r){if(typeof h.after==="function"){h.after(g,r)}console.error("Model["+g.modalName+"]"+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}});return false};if(h.xhrCount<g.requestLimit||h.length>0){v()}else{if(typeof h.after==="function"){h.after()}}},function(r,s){console.error(s.message)})};if(typeof k==="string"){n(l,m)}},function(l,m){console.error(m.message)})}},populate:function(j){var h=this,i=Object.assign({timer:0,xhrCount:0,url:"/chunking",params:{},limit:100,page:0,count:0},j);var k=function(l){if(h.processing){i.timer=setTimeout(function(){k()},50);return false}clearTimeout(i.timer);xhr({url:location.update(i.url,i.params),rs:{ver:h.webSQLinstance.version,pk:h.primaryKey,model:h.tablelName,limit:i.limit,page:i.page},before:function(m){h.processing=true;return false},after:function(m){h.processing=false;i.xhrCount++;return false},done:function(p,o){var n=c.src(p).responseJSON;if(n.result==="ok"){i.length=n.data&&n.data.rows?n.data.rows.length:0;i.page=n.paginator.page+1;i.limit=n.paginator.limit||i.limit;i.count=n.paginator.count||i.length;var m=[];if(i.length>0){h.add(n.data.rows,{done:function(q,r){if(i.length+(n.paginator.page*i.limit)<i.count){if(typeof i.progress==="function"){i.progress(h,n)}return g(m)}else{if(typeof i.after==="function"){i.after(h,n)}}}},webSQL.BULK|webSQL.UPSERT)}}else{if(typeof i.after==="function"){i.after(h,n)}console.error(n.message)}return false},fail:function(m){if(typeof i.after==="function"){i.after(h,m)}console.error("Model["+h.modalName+"]"+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}});return false},g=function(l){if(i.xhrCount<h.requestLimit){k(l)}else{if(typeof i.after==="function"){i.after()}}return false};if(typeof i.before==="function"){i.before()}return g()}};b.webSQLmodel=d}(window,window.ui));