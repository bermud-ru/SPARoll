
 /**
 * @app $Id: jsroll.dao.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA
 * @author Андрей Новиков andrey (at) novikov (dot) be
 * @status beta
 * @version 2.1.2b
 * @revision $Id: jsroll.dao.min.js 0004 27/04/2022 19:41:36Z $
 */


(function(b,c,f){"use strict";var a=function(i,g,j,k,h){return Object.merge({get name(){return this.tables[0]},tables:typeof i==="string"?[i]:i,autoIncrement:!!g,primaryKey:g||null,schema:j,launch:k,get:function(r,n){var p=this;var o=Object.assign({done:p.owner.done.bind(p.owner),fail:p.owner.fail.bind(p.owner),close:p.owner.close.bind(p.owner)},n);if(r&&typeof o.done==="function"){try{var l=p.owner.db.transaction(p.tables,"readonly");var m=l.objectStore(p.tables);l.onerror=l.onabort=function(s){return o.fail(s,l)};return m.get(r).onsuccess=function(s){return o.done(s,m,l)}}catch(q){o.fail(q)}}},getAll:function(n){var p=this;var o=Object.assign({done:p.owner.done.bind(p.owner),fail:p.owner.fail.bind(p.owner),close:p.owner.close.bind(p.owner)},n);try{var l=p.owner.db.transaction(p.tables,"readonly");l.onerror=l.onabort=function(r){return o.fail(r,l)};var m=l.objectStore(p.tables);return m.getAll().onsuccess=function(r){return o.done(r,m,l)}}catch(q){o.fail(q)}},add:function(o,m){var p=this,x=o instanceof Array?o:[o];var v=Object.assign({done:p.owner.done.bind(p.owner),fail:p.owner.fail.bind(p.owner),close:p.owner.close.bind(p.owner)},m);try{console.log("db",p.owner.db);var r=p.owner.db.transaction(p.tables,"readwrite");r.onerror=function(l){return v.fail(l,r)};var u=r.objectStore(p.tables[0]);var q=0,w,n=x.length,s=function(){w=p.data2row(x[q++],QueryParam.STRNULL);if(p.autoIncrement&&w.hasOwnProperty(p.primaryKey)){if(w[p.primaryKey]===null){delete w[p.primaryKey]}}r.onabort=function(l){if(p.primaryKey&&w.hasOwnProperty(p.primaryKey)){console.error("row PrimaryKey["+p.primaryKey+"] = "+w[p.primaryKey]+" in "+JSON.stringify(p.tables)+"already has!")}};if(typeof v.done==="function"){u.add(w).onsuccess=q<n?function(){return s()}:function(l){return v.done(l,u,r)}}else{u.add(w);return s()}};s()}catch(t){v.fail(t)}},put:function(o,m){var p=this,x=o instanceof Array?o:[o];var v=Object.assign({done:p.owner.done.bind(p.owner),fail:p.owner.fail.bind(p.owner),close:p.owner.close.bind(p.owner)},m);try{var r=p.owner.db.transaction(p.tables,"readwrite");r.onerror=r.onabort=function(l){return v.fail(l,r)};var u=r.objectStore(p.name);var q=0,w,n=x.length,s=function(){w=p.data2row(x[q++],QueryParam.STRNULL);if(!p.primaryKey||w[p.primaryKey]===null){throw"PrimaryKey is not set!"}if(typeof v.done==="function"){u.put(w).onsuccess=q<n?function(){return s()}:function(l){return v.done(l,u,r)}}else{u.put(w);return s()}};s()}catch(t){v.fail(t)}},del:function(l,o){var q=this;var p=Object.assign({done:q.owner.done.bind(q.owner),fail:q.owner.fail.bind(q.owner),close:q.owner.close.bind(q.owner)},o);try{var m=q.owner.db.transaction(q.tables,"readwrite");m.onerror=m.onabort=function(s){return p.fail(s,m)};var n=m.objectStore(q.tables);if(typeof p.done==="function"){n["delete"](l).onsuccess=function(s){return p.done(s,n,m)}}else{n["delete"](l)}}catch(r){p.fail(r)}}},h)};b.IndexedDBmodel=a;var e=function(h,g){if(g&&typeof g==="object"){this.merge(g)}if(h!==null){this.webSQLinstance=h}else{throw"webSQL object not exist!"}};e.prototype={webSQLinstance:null,modelName:null,tableName:null,primaryKey:null,processing:false,requestLimit:1500,DDL:null,done:function(g,h){return console.log("webSQLmodel "+this.webSQLinstance+" успешно стартовала")},fail:function(g,h){return console.error("webSQLmodel "+h.message)},init:function(h,g){if(this.webSQLinstance===null){return console.error("DB webSQL not istalled!")}if(typeof g!=="undefined"&&g!==this.webSQLinstance.version){this.webSQLinstance.changeVersion(this.webSQLinstance.version,g,this.changeVersion)}this.webSQLinstance.stmt([h?h:this.DDL],[],this.done,this.fail);return this},changeVersion:function(g){return console.log(g)},unload:function(k,j,i){var g=this,h=Object.assign({timer:0,xhrCount:0,url:"/chunking",method:"PUT",params:{},limit:100,page:0,count:0},i);if(typeof j==="string"){g.webSQLinstance.filter(j,[],function(l,m){h.count=m.rows?m.rows[0].count:0;if(h.count===0){return false}else{if(typeof h.before==="function"){h.before(m)}}var n=function(p,q){var o=" LIMIT "+h.limit+" OFFSET "+(h.page*h.limit);g.webSQLinstance.filter(k+o,[],function(s,u){h.length=parseInt(u&&u.rows.length);var v=function(){if(g.processing&&!h.timer){h.timer=setTimeout(function(){v()},50);return false}clearTimeout(h.timer);xhr({method:h.method,url:h.url,rs:{"Content-type":"application/json",ver:g.webSQLinstance.version,pk:g.primaryKey,model:g.tablelName,limit:h.limit,page:h.page},data:JSON.stringify(Object.assign({rows:obj2array(u.rows)},h.params)),before:function(r){g.processing=true},after:function(r){g.processing=false;h.xhrCount++},done:function(w,t){var r=c.src(w).responseJSON;if(r.result==="ok"){if(h.length+(h.page++*h.limit)<h.count){if(typeof h.progress==="function"){h.progress(g,Object.assign(h,{rows:r.data?r.data.rows:[]}))}return n(s,u)}else{if(typeof h.after==="function"){h.after(g,Object.assign(h,{rows:r.data?r.data.rows:[]}))}}}else{if(typeof h.after==="function"){h.after(g,h)}console.error(r.message)}},fail:function(r){if(typeof h.after==="function"){h.after(g,r)}console.error("Model["+g.modalName+"]"+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}});return false};if(h.xhrCount<g.requestLimit||h.length>0){v()}else{if(typeof h.after==="function"){h.after()}}},function(r,s){console.error(s.message)})};if(typeof k==="string"){n(l,m)}},function(l,m){console.error(m.message)})}},populate:function(j){var h=this,i=Object.assign({timer:0,xhrCount:0,url:"/chunking",params:{},limit:100,page:0,count:0},j);var k=function(l){if(h.processing){i.timer=setTimeout(function(){k()},50);return false}clearTimeout(i.timer);xhr({url:location.update(i.url,i.params),rs:{ver:h.webSQLinstance.version,pk:h.primaryKey,model:h.tablelName,limit:i.limit,page:i.page},before:function(m){h.processing=true;return false},after:function(m){h.processing=false;i.xhrCount++;return false},done:function(p,o){var n=c.src(p).responseJSON;if(n.result==="ok"){i.length=n.data&&n.data.rows?n.data.rows.length:0;i.page=n.paginator.page+1;i.limit=n.paginator.limit||i.limit;i.count=n.paginator.count||i.length;var m=[];if(i.length>0){h.add(n.data.rows,{done:function(q,r){if(i.length+(n.paginator.page*i.limit)<i.count){if(typeof i.progress==="function"){i.progress(h,n)}return g(m)}else{if(typeof i.after==="function"){i.after(h,n)}}}},webSQL.BULK|webSQL.UPSERT)}}else{if(typeof i.after==="function"){i.after(h,n)}console.error(n.message)}return false},fail:function(m){if(typeof i.after==="function"){i.after(h,m)}console.error("Model["+h.modalName+"]"+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}});return false},g=function(l){if(i.xhrCount<h.requestLimit){k(l)}else{if(typeof i.after==="function"){i.after()}}return false};if(typeof i.before==="function"){i.before()}return g()}};b.webSQLmodel=e;var d=function(){return function(m){var g=is_empty(m.index)||parseInt(m.index);var j=m.primaryKey?m.primaryKey:null;var k=m.crud;var i,l=function(n){switch(h.method.toLowerCase()){case"del":k.splice(g,1);break;case"post":if(j){n[j]=Math.max.apply(Math,k.map(function(o){return o[j]}))+1}k.push(n);break;case"put":k[g].merge(n);break;case"get":default:}if(typeof h.done==="function"){h.done(g!==null?k[g]:k)}return l.done=true};var h=Object.assign({srcElement:l,method:"get",index:g,rows:k,timeout:1000},m);l.timeout=function(){var n=((Date.now()-l.start)<h.timeout);if(!n){clearTimeout(l.instance);if(typeof h.cansel==="function"){h.cansel()}else{console.warn("Worker timeout")}}return n};l.start=Date.now();l.done=false;if((typeof h.before==="function")?[f,true].indexOf(h.before())>-1:true){(i=function(){if(l.timeout()){l.instance=setTimeout(function(){l(m.data);if(!l.done){return i()}if(typeof h.after=="function"){h.after()}return false},0)}})()}return l}};b.sqlObject=d}(window,window.ui));