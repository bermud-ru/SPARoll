
 /**
 * @app $Id: jsroll.dao.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA
 * @author Андрей Новиков andrey (at) novikov (dot) be
 * @status beta
 * @version 2.1.2b
 * @revision $Id: jsroll.dao.min.js 0004 22/07/2022 16:30:41Z $
 */\n

(function(b,c,e){"use strict";var a=function(h,f,i,j,g){return Object.merge({__processing__:[],get processing(){var k=this.__processing__.length?this.__processing__.shift():false;return k?k.call(this):false},set processing(k){this.__processing__.push(k);if(this.__processing__.length===1){return this.processing}},get name(){return this.tables[0]},tables:typeof h==="string"?[h]:h,autoIncrement:!!f,primaryKey:f||null,schema:i,launch:j,clear:function(l){var m=this,k=m.store("readwrite",m.status(a.TRUNCATE),l);if(l&&typeof l.success==="function"){return k.clear().onsuccess=function(n){return l.success.call(m,n,k)}}else{return k.clear().onsuccess=k.complete}},count:function(l){var m=this,k=m.store("readonly",m.status(a.COUNT),l);if(l&&typeof l.success==="function"){k.count(l&&l.keyRange).onsuccess=function(n){return l.success.call(m,n,k)}}else{k.count(l&&l.keyRange).onsuccess=k.oncomplete}},filter:function(o,k){if(!o instanceof IDBFilter){throw"IDBmodel::filter() mng - must be of IDBFilter object!"}var n=this;var m=true,l=function(){var p=n.store("readonly",n.status(a.FILTER),k);p.openCursor(k&&k.keyRange,k&&k.keyDirection).onsuccess=function(q){var r=q.target.result;if(o.populated(r)){if(!o.advanced){o.advanced=true;if(o.offset>0){r.advance(o.offset)}}else{o.condition(r);r["continue"]()}}else{p.oncomplete({result:o.chunk,offset:o.offset,limit:o.limit});if(m){m=false;return n.processing}}}};n.processing=l},paginator:function(s,o,m){var r=this,v=[],k=parseInt(s),n=parseInt(o),u=k===0;var q=true,t=function(){var l=r.store("readonly",r.status(a.PAGINATOR),m);l.count(m&&m.keyRange).onsuccess=function(w){var p=w.target.result;if(p>0){l.openCursor(m&&m.keyRange).onsuccess=function(x){var y=x.target.result;if(y&&v.length<n){if(!u){u=true;y.advance(k*n)}else{v.push(y.value);y["continue"]()}}else{return l.oncomplete({result:v,count:p,page:k,limit:n})}}}else{l.oncomplete({result:[],count:0,page:k,limit:n});if(q){q=false;return r.processing}}}};r.processing=t},index:function(m){var n=this,k=n.store("readonly",n.status(a.INDEX),m);var l=k.index(arguments.shift());l.get(arguments).onsuccess=k.oncomplete},get:function(l,n){var q=this,k=[],m=l instanceof Array;var p=true,o=function(){if(!m){l=[l]}try{var t=q.store("readonly",q.status(a.GET),n);var u=0,s=l.length,r=function(){t.get(l[u++]).onsuccess=function(w){k.push(w.target.result);if(n&&typeof n.success==="function"){n.success.call(q,w,q.status(a.GET),t,u,l)}if(u<s){return r()}t.oncomplete({result:k});if(p){p=false;return q.processing}}};return r()}catch(v){if(n&&typeof n.fail==="function"){n.fail.call(q,v)}else{q.fail(v)}if(p){p=false;return q.processing}}};q.processing=o},getAll:function(k){var n=this,m=true,l=function(){var o=n.store("readonly",n.status(a.GETALL),k);o.getAll(k&&k.keyRange||null,k&&k.count||null).onsuccess=function(p){if(k&&typeof k.success==="function"){k.success.call(n,p,n.status(a.GETALL),o)}else{o.oncomplete({result:p.target.result})}if(m){m=false;return n.processing}}};n.processing=l},tree:function(k){var l=this;l.getAll({index:k.index,keyRange:IDBKeyRange.only(k.id),done:function(p,n,m){var q=p.result,o=function(r,s){if(r<s.length){m.objectStore(l.tables).index(k.index).getAll(IDBKeyRange.only(s[r][l.primaryKey])).onsuccess=function(t){return o(r+1,Array.merge(s,t.target.result))}}else{p.result=s;return k&&typeof k.done==="function"?k.done.call(l,p,n,m):l.done(p,n,m)}};return o(0,q)}})},add:function(q,l){var p=this,k=[],o=q instanceof Array?q:[q];var n=true,m=function(){try{var u=0,s=o.length,t=p.store("readwrite",p.status(a.ADD),l);var w,r=function(){w=p.data2row(o[u++],QueryParam.STRNULL);if(w.hasOwnProperty(p.primaryKey)&&(w[p.primaryKey]===null||w[p.primaryKey]==="")){delete w[p.primaryKey]}t.add(w).onsuccess=function(x){k.push(x.target.result);if(l&&typeof l.success==="function"){l.success.call(p,x,p.status(a.ADD),t,u,o)}if(u<s){return r()}t.oncomplete({result:k,rows:o});if(n){n=false;return p.processing}}};return r()}catch(v){if(l&&typeof l.fail==="function"){l.fail.call(p,v)}else{p.fail(v)}if(n){n=false;return p.processing}}};p.processing=m},put:function(q,l){var p=this,k=[],o=q instanceof Array?q:[q];var n=true,m=function(){try{var u=0,s=o.length,t=p.store("readwrite",p.status(a.PUT),l);var w,r=function(){w=p.data2row(o[u++],QueryParam.STRNULL);if(!p.primaryKey||w[p.primaryKey]===null||w[p.primaryKey]===""){throw"PrimaryKey is not set! "+JSON.stringify(w)}t.put(w).onsuccess=function(x){k.push(x.target.result);if(l&&typeof l.success==="function"){l.success.call(p,x,p.status(a.PUT),t,u,o)}if(u<s){return r()}t.oncomplete({result:k,rows:o});if(n){n=false;return p.processing}}};return r()}catch(v){if(l&&typeof l.fail==="function"){l.fail.call(p,v)}else{p.fail(v)}if(n){n=false;return p.processing}}};p.processing=m},del:function(k,m){var p=this,l=k instanceof Array;var o=true,n=function(){if(!l){k=[k]}try{var s=p.store("readwrite",p.status(a.DEL),m);var t=0,r=k.length,q=function(){s["delete"](k[t++]).onsuccess=function(v){if(m&&typeof m.success==="function"){m.success.call(p,v,p.status(a.DEL),s,t,rows)}if(t<r){return q()}s.oncomplete({result:k});if(o){o=false;return p.processing}}};return q()}catch(u){if(m&&typeof m.fail==="function"){m.fail.call(p,u)}else{p.fail(u)}if(o){o=false;return p.processing}}};p.processing=n}},g)};a.GET=1;a.GETALL=2;a.ADD=3;a.PUT=3;a.UPSERT=4;a.DEL=5;a.INDEX=6;a.TRUNCATE=7;a.COUNT=8;a.PAGINATOR=9;a.FILTER=10;b.IDBmodel=a;var d=function(g,f){if(f&&typeof f==="object"){this.merge(f)}if(g!==null){this.webSQLinstance=g}else{throw"webSQL object not exist!"}};d.prototype={webSQLinstance:null,modelName:null,tableName:null,primaryKey:null,processing:false,requestLimit:1500,DDL:null,done:function(f,g){return console.log("webSQLmodel "+this.webSQLinstance+" успешно стартовала")},fail:function(f,g){return console.error("webSQLmodel "+g.message)},init:function(g,f){if(this.webSQLinstance===null){return console.error("DB webSQL not istalled!")}if(typeof f!=="undefined"&&f!==this.webSQLinstance.version){this.webSQLinstance.changeVersion(this.webSQLinstance.version,f,this.changeVersion)}this.webSQLinstance.stmt([g?g:this.DDL],[],this.done,this.fail);return this},changeVersion:function(f){return console.log(f)},unload:function(j,i,h){var f=this,g=Object.assign({timer:0,xhrCount:0,url:"/chunking",method:"PUT",params:{},limit:100,page:0,count:0},h);if(typeof i==="string"){f.webSQLinstance.filter(i,[],function(k,l){g.count=l.rows?l.rows[0].count:0;if(g.count===0){return false}else{if(typeof g.before==="function"){g.before(l)}}var m=function(o,p){var n=" LIMIT "+g.limit+" OFFSET "+(g.page*g.limit);f.webSQLinstance.filter(j+n,[],function(q,s){g.length=parseInt(s&&s.rows.length);var u=function(){if(f.processing&&!g.timer){g.timer=setTimeout(function(){u()},50);return false}clearTimeout(g.timer);xhr({method:g.method,url:g.url,rs:{"Content-type":"application/json",ver:f.webSQLinstance.version,pk:f.primaryKey,model:f.tablelName,limit:g.limit,page:g.page},data:JSON.stringify(Object.assign({rows:obj2array(s.rows)},g.params)),before:function(r){f.processing=true},after:function(r){f.processing=false;g.xhrCount++},done:function(v,t){var r=c.src(v).responseJSON;if(r.result==="ok"){if(g.length+(g.page++*g.limit)<g.count){if(typeof g.progress==="function"){g.progress(f,Object.assign(g,{rows:r.data?r.data.rows:[]}))}return m(q,s)}else{if(typeof g.after==="function"){g.after(f,Object.assign(g,{rows:r.data?r.data.rows:[]}))}}}else{if(typeof g.after==="function"){g.after(f,g)}console.error(r.message)}},fail:function(r){if(typeof g.after==="function"){g.after(f,r)}console.error("Model["+f.modalName+"]"+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}});return false};if(g.xhrCount<f.requestLimit||g.length>0){u()}else{if(typeof g.after==="function"){g.after()}}},function(q,r){console.error(r.message)})};if(typeof j==="string"){m(k,l)}},function(k,l){console.error(l.message)})}},populate:function(i){var g=this,h=Object.assign({timer:0,xhrCount:0,url:"/chunking",params:{},limit:100,page:0,count:0},i);var j=function(k){if(g.processing){h.timer=setTimeout(function(){j()},50);return false}clearTimeout(h.timer);xhr({url:location.update(h.url,h.params),rs:{ver:g.webSQLinstance.version,pk:g.primaryKey,model:g.tablelName,limit:h.limit,page:h.page},before:function(l){g.processing=true;return false},after:function(l){g.processing=false;h.xhrCount++;return false},done:function(o,n){var m=c.src(o).responseJSON;if(m.result==="ok"){h.length=m.data&&m.data.rows?m.data.rows.length:0;h.page=m.paginator.page+1;h.limit=m.paginator.limit||h.limit;h.count=m.paginator.count||h.length;var l=[];if(h.length>0){g.add(m.data.rows,{done:function(p,q){if(h.length+(m.paginator.page*h.limit)<h.count){if(typeof h.progress==="function"){h.progress(g,m)}return f(l)}else{if(typeof h.after==="function"){h.after(g,m)}}}},webSQL.BULK|webSQL.UPSERT)}}else{if(typeof h.after==="function"){h.after(g,m)}console.error(m.message)}return false},fail:function(l){if(typeof h.after==="function"){h.after(g,l)}console.error("Model["+g.modalName+"]"+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}});return false},f=function(k){if(h.xhrCount<g.requestLimit){j(k)}else{if(typeof h.after==="function"){h.after()}}return false};if(typeof h.before==="function"){h.before()}return f()}};b.webSQLmodel=d}(window,window.ui));