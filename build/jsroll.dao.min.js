
 /**
 * @app $Id: jsroll.dao.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA
 * @author Андрей Новиков andrey (at) novikov (dot) be
 * @status beta
 * @version 2.1.2b
 * @revision $Id: jsroll.dao.min.js 0004 27/04/2022 20:02:15Z $
 */\n

(function(b,c,e){"use strict";var a=function(h,f,i,j,g){return Object.merge({get name(){return this.tables[0]},tables:typeof h==="string"?[h]:h,autoIncrement:!!f,primaryKey:f||null,schema:i,launch:j,get:function(q,m){var o=this;var n=Object.assign({done:o.owner.done.bind(o.owner),fail:o.owner.fail.bind(o.owner),close:o.owner.close.bind(o.owner)},m);if(q&&typeof n.done==="function"){try{var k=o.owner.db.transaction(o.tables,"readonly");var l=k.objectStore(o.tables);k.onerror=k.onabort=function(r){return n.fail(r,k)};return l.get(q).onsuccess=function(r){return n.done(r,l,k)}}catch(p){n.fail(p)}}},getAll:function(m){var o=this;var n=Object.assign({done:o.owner.done.bind(o.owner),fail:o.owner.fail.bind(o.owner),close:o.owner.close.bind(o.owner)},m);try{var k=o.owner.db.transaction(o.tables,"readonly");k.onerror=k.onabort=function(q){return n.fail(q,k)};var l=k.objectStore(o.tables);return l.getAll().onsuccess=function(q){return n.done(q,l,k)}}catch(p){n.fail(p)}},add:function(o,k){var p=this,u=[],x=o instanceof Array?o:[o];var v=Object.assign({done:p.owner.done.bind(p.owner),fail:p.owner.fail.bind(p.owner),close:p.owner.close.bind(p.owner)},k);try{console.log("db",p.owner.db);var q=p.owner.db.transaction(p.tables,"readwrite");q.onerror=function(l){return v.fail(l,q)};var t=q.objectStore(p.tables[0]);var n=0,w,m=x.length,r=function(){w=p.data2row(x[n++],QueryParam.STRNULL);if(w.hasOwnProperty(p.primaryKey)){if(w[p.primaryKey]===null){delete w[p.primaryKey]}else{u.push(w[p.primaryKey])}}q.onabort=function(l){if(p.primaryKey&&w.hasOwnProperty(p.primaryKey)){console.error("row PrimaryKey["+p.primaryKey+"] = "+w[p.primaryKey]+" in "+JSON.stringify(p.tables)+"already has!")}};if(typeof v.done==="function"){t.add(w).onsuccess=n<m?function(){return r()}:function(l){return v.done(l,t,q,u)}}else{t.add(w);return r()}};r()}catch(s){v.fail(s)}},put:function(o,k){var p=this,u=[],x=o instanceof Array?o:[o];var v=Object.assign({done:p.owner.done.bind(p.owner),fail:p.owner.fail.bind(p.owner),close:p.owner.close.bind(p.owner)},k);try{var q=p.owner.db.transaction(p.tables,"readwrite");q.onerror=q.onabort=function(l){return v.fail(l,q)};var t=q.objectStore(p.name);var n=0,w,m=x.length,r=function(){w=p.data2row(x[n++],QueryParam.STRNULL);if(!p.primaryKey||w[p.primaryKey]===null){throw"PrimaryKey is not set!"}else{u.push(w[p.primaryKey])}if(typeof v.done==="function"){t.put(w).onsuccess=n<m?function(){return r()}:function(l){return v.done(l,t,q,u)}}else{t.put(w);return r()}};r()}catch(s){v.fail(s)}},del:function(k,n){var p=this;var o=Object.assign({done:p.owner.done.bind(p.owner),fail:p.owner.fail.bind(p.owner),close:p.owner.close.bind(p.owner)},n);try{var l=p.owner.db.transaction(p.tables,"readwrite");l.onerror=l.onabort=function(r){return o.fail(r,l)};var m=l.objectStore(p.tables);if(typeof o.done==="function"){m["delete"](k).onsuccess=function(r){return o.done(r,m,l)}}else{m["delete"](k)}}catch(q){o.fail(q)}}},g)};b.IndexedDBmodel=a;var d=function(g,f){if(f&&typeof f==="object"){this.merge(f)}if(g!==null){this.webSQLinstance=g}else{throw"webSQL object not exist!"}};d.prototype={webSQLinstance:null,modelName:null,tableName:null,primaryKey:null,processing:false,requestLimit:1500,DDL:null,done:function(f,g){return console.log("webSQLmodel "+this.webSQLinstance+" успешно стартовала")},fail:function(f,g){return console.error("webSQLmodel "+g.message)},init:function(g,f){if(this.webSQLinstance===null){return console.error("DB webSQL not istalled!")}if(typeof f!=="undefined"&&f!==this.webSQLinstance.version){this.webSQLinstance.changeVersion(this.webSQLinstance.version,f,this.changeVersion)}this.webSQLinstance.stmt([g?g:this.DDL],[],this.done,this.fail);return this},changeVersion:function(f){return console.log(f)},unload:function(j,i,h){var f=this,g=Object.assign({timer:0,xhrCount:0,url:"/chunking",method:"PUT",params:{},limit:100,page:0,count:0},h);if(typeof i==="string"){f.webSQLinstance.filter(i,[],function(k,l){g.count=l.rows?l.rows[0].count:0;if(g.count===0){return false}else{if(typeof g.before==="function"){g.before(l)}}var m=function(o,p){var n=" LIMIT "+g.limit+" OFFSET "+(g.page*g.limit);f.webSQLinstance.filter(j+n,[],function(q,s){g.length=parseInt(s&&s.rows.length);var u=function(){if(f.processing&&!g.timer){g.timer=setTimeout(function(){u()},50);return false}clearTimeout(g.timer);xhr({method:g.method,url:g.url,rs:{"Content-type":"application/json",ver:f.webSQLinstance.version,pk:f.primaryKey,model:f.tablelName,limit:g.limit,page:g.page},data:JSON.stringify(Object.assign({rows:obj2array(s.rows)},g.params)),before:function(r){f.processing=true},after:function(r){f.processing=false;g.xhrCount++},done:function(v,t){var r=c.src(v).responseJSON;if(r.result==="ok"){if(g.length+(g.page++*g.limit)<g.count){if(typeof g.progress==="function"){g.progress(f,Object.assign(g,{rows:r.data?r.data.rows:[]}))}return m(q,s)}else{if(typeof g.after==="function"){g.after(f,Object.assign(g,{rows:r.data?r.data.rows:[]}))}}}else{if(typeof g.after==="function"){g.after(f,g)}console.error(r.message)}},fail:function(r){if(typeof g.after==="function"){g.after(f,r)}console.error("Model["+f.modalName+"]"+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}});return false};if(g.xhrCount<f.requestLimit||g.length>0){u()}else{if(typeof g.after==="function"){g.after()}}},function(q,r){console.error(r.message)})};if(typeof j==="string"){m(k,l)}},function(k,l){console.error(l.message)})}},populate:function(i){var g=this,h=Object.assign({timer:0,xhrCount:0,url:"/chunking",params:{},limit:100,page:0,count:0},i);var j=function(k){if(g.processing){h.timer=setTimeout(function(){j()},50);return false}clearTimeout(h.timer);xhr({url:location.update(h.url,h.params),rs:{ver:g.webSQLinstance.version,pk:g.primaryKey,model:g.tablelName,limit:h.limit,page:h.page},before:function(l){g.processing=true;return false},after:function(l){g.processing=false;h.xhrCount++;return false},done:function(o,n){var m=c.src(o).responseJSON;if(m.result==="ok"){h.length=m.data&&m.data.rows?m.data.rows.length:0;h.page=m.paginator.page+1;h.limit=m.paginator.limit||h.limit;h.count=m.paginator.count||h.length;var l=[];if(h.length>0){g.add(m.data.rows,{done:function(p,q){if(h.length+(m.paginator.page*h.limit)<h.count){if(typeof h.progress==="function"){h.progress(g,m)}return f(l)}else{if(typeof h.after==="function"){h.after(g,m)}}}},webSQL.BULK|webSQL.UPSERT)}}else{if(typeof h.after==="function"){h.after(g,m)}console.error(m.message)}return false},fail:function(l){if(typeof h.after==="function"){h.after(g,l)}console.error("Model["+g.modalName+"]"+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}});return false},f=function(k){if(h.xhrCount<g.requestLimit){j(k)}else{if(typeof h.after==="function"){h.after()}}return false};if(typeof h.before==="function"){h.before()}return f()}};b.webSQLmodel=d}(window,window.ui));