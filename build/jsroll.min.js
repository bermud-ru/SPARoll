
 /**
 * @app jsroll.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA javascritp framework
 * @author Андрей Новиков <andrey@novikov.be>
 * @status beta
 * @version 0.1.0
 * @revision $Id: jsroll.min.js 0004 14/06/2016 10:14:49Z $
 */

(function(i,d){"use strict";var f=("onload" in new XMLHttpRequest())?XMLHttpRequest:XDomainRequest;var b=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(p){var o=Math.random()*16|0,g=p=="x"?o:(o&3|8);return g.toString(16)})};i.uuid=b;var e=function(o){var q=/[?&]([^=#]+)=([^&#]*)/g,s={},g;try{while(g=q.exec((o||i.location.search))){if(g[1]&&g[2]){s[decodeURIComponent(g[1])]=decodeURIComponent(g[2])}}}catch(r){return null}return s};i.location.params=e;function h(p,g){var o=null;p&&(o=setInterval(function(){p.style.opacity=p.style.opacity&&p.style.opacity>0?(parseFloat(p.style.opacity)-0.1).toFixed(1):"1";if(parseFloat(p.style.opacity)<=0){if(g&&typeof g==="function"&&g.call(p)){g.call(p)}p.style.display="none";clearInterval(o)}},typeof g==="number"?g:25))}i.fadeOut=h;function k(p,g){var o=null;p&&(o=setInterval(function(){if(p.style.display=="none"){p.style.display="inherit"}p.style.opacity=p.style.opacity&&p.style.opacity<1?(parseFloat(p.style.opacity)+0.1).toFixed(1):"0";if(parseFloat(p.style.opacity)>=1){if(g&&typeof g==="function"&&g.call(p)){g.call(p)}clearInterval(o)}},typeof g==="number"?g:25))}i.fadeIn=k;function c(o,g){o.setAttribute("valid",1);o.xhr=null;o.prepare=function(r){var q={result:{},data:[]};if(!r||(typeof r==="function"&&r.call(o,q))){for(var p=0;p<o.elements.length;p++){q.data.push((o.elements[p].name||p)+"="+encodeURIComponent(o.elements[p].value))}}o.setAttribute("valid",JSON.stringify(q.result));return q.data.join("&")};o.validator=g||o.validator;o.release=function(r){var q=o.prepare(r&&r.validator||o.validator);if(o.getAttribute("valid")!=0){i.xhr.request(Object.assign({method:r&&r.method||o.method,url:r&&r.url||o.action,data:q},{rs:r.rs||{}})).result(r&&r.callback||function(){var s={result:"error"};if([200,206].indexOf(this.status)<0){s.message=this.status+": "+this.statusText}else{try{s=JSON.parse(this.responseText);if(s.form){for(var p=0;p<o.elements.length;p++){if(s.form.hasOwnProperty(o.elements[p].name)){css.el(o.elements[p].parentElement).add("has-error")}else{css.el(o.elements[p].parentElement).del("has-error")}}}}catch(t){s.message="Cервер вернул не коректные данные"}}o.xhr=s;if(r&&typeof r.fn=="function"){r.fn.call(o,s)}return o})}return o};o.insert=function(q){for(var p=0;p<o.elements.length;p++){if(q[o.elements[p].name]){o.elements[p].value=q[o.elements[p].name]}else{var r=/\[([^\]]+)\]/.exec(o.elements[p].name)[1];if(r&&q[r]){o.elements[p].value=q[r]}}}return o};o.setup=function(r){if(r){switch(true){case r.hasOwnProperty("form"):console.log("data from data");if(typeof r.form==="object"){o.insert(r.form);var q=(r&&r.validator||o.validator);if(typeof q=="function"){q.call(o,r.data)}}break;case r.hasOwnProperty("xhr"):i.xhr.request({method:r.xhr.method||"GET",url:r.xhr.url,data:r.xhr.data||null,rs:r.xhr.rs||{}}).result(r.xhr.callback||function(){var s={result:"error"};if([200,206].indexOf(this.status)<0){s.message=this.status+": "+this.statusText}else{try{s=JSON.parse(this.responseText);o.insert(s.data||{});var p=(r&&r.validator||o.validator);if(typeof p=="function"){p.call(o,s.data)}}catch(t){s.message="Cервер вернул не коректные данные"}}o.xhr=s;if(r&&typeof r.fn=="function"){r.fn.call(o,s)}return o});break;default:o.reset()}}else{o.reset()}return o};return o}i.JSON.form=c;function m(p){var o=!!(history.pushState)?1:0;var g=p;return{root:g,rt:[],itv:0,base:o?window.location.pathname+window.location.search:"",clr:function(q){return q.toString().replace(/\/$/,"").replace(/^\//,"")},frgm:o?function(){var q=this.clr(decodeURI(location.pathname+location.search)).replace(/\?(.*)$/,"");return this.clr(this.root!="/"?q.replace(this.root,""):q)}:function(){var q=window.location.href.match(/#(.*)$/);return q?this.clr(q[1]):""},add:function(r,q){if(typeof r=="function"){q=r;r=""}this.rt.push({re:r,handler:q});this.rt=this.rt.sort(function(t,s){if(t.re.toString().length<s.re.toString().length){return 1}if(t.re.toString().length>s.re.toString().length){return -1}return 0});return this},rm:function(r){for(var q in this.rt){if(this.rt[q].handler===r||this.rt[q].re.toString()===r.toString()){this.rt.splice(q,1);return this}}return this},chk:function(r){var t=r||this.frgm();for(var s in this.rt){var q=t.match(this.rt[s].re);if(q){q.shift();this.rt[s].handler.apply({},q);return this}}return this},lsn:function(){var r=this,t=r.frgm(),q=function(){if(t!==r.frgm()){t=r.frgm();r.chk(t)}return r};clearInterval(r.itv);r.itv=setInterval(q,50);return r},set:o?function(q){history.pushState(null,null,this.root+this.clr((q||"")));return this}:function(q){window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+(q||"");return this}}}i.router=m("/");function a(){var g={tuple:[],cache:[],donned:function(o){return false},failed:function(o){return false},pool:function(p,o){this.chain.cache.push(this);if(this.chain.tuple.length==this.chain.cache.length){this.chain.donned.apply(this.chain,this.chain.cache)}},done:function(o){this.donned=o},fail:function(o){this.failed=o}};g.tuple=Array.prototype.slice.call(arguments).map(function(o){o.onload=function(){g.pool.apply(o,arguments)};o.chain=g;return o});return g}i.chain=a;function n(){var g=new f();if(!g){return null}if(!g.hasOwnProperty("ref")){g.ref={}}g.request=function(r){var p=Object.assign({method:"GET"},r);p.rs=Object.assign({"Content-type":"application/x-www-form-urlencoded"},r.rs);var s=p.method+"_"+(p.url?p.url.replace(/(\.|:|\/|\-)/g,"_"):i.uuid());var q=new n();q.isLoad=false;if((["GET","DELETE"].indexOf(p.method.toUpperCase())>=0)&&p.data){p.url=(p.url||i.location)+"?"+p.data;p.data=null}q.open(p.method,p.url||i.location,p.async||true,p.username||d,p.password||d);if(p.rs){for(var o in p.rs){q.setRequestHeader(o.trim(),p.rs[o].trim())}}q.send(p.data||null);q.id=s;p.result&&(q.result=g.result(p.result));p.process&&(q.process=g.process(p.process));return g.ref[s]=q};g.result=function(o){g.onload=function(p){this.isLoad=true;if(typeof o==="function"){return o.call(this,p)}};return this};g.process=function(o){g.onreadystatechange=function(p){if(typeof o==="function"){return o.call(this,p)}};return this};return g}i.xhr=n();var l=function l(s,q,g,o){var p=function(u){return new Function("_e","var p=[], print=function(){ p.push.apply(p,arguments); };with(_e){p.push('"+u.replace(/[\r\t\n]/g," ").split("{%").join("\t").replace(/((^|%})[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%}/g,"',$1,'").split("\t").join("');").split("%}").join("p.push('").split("\r").join("\\'")+"');} return p.join('').replace(/<%/g,'{%').replace(/%>/g,'%}');")},r=function(y,z){var w=typeof z!=="undefined";if(w&&i.tmpl.cache[z]){u=i.tmpl.cache[z].call(i.tmpl,q||{});if(typeof g=="function"){g.call(i.tmpl,u)}return u}var u=null,v=null;try{v=p(y);if(w){i.tmpl.cache[z]=v}u=v.call(i.tmpl,q||{});if(typeof g=="function"){g.call(v||i.tmpl,u)}}catch(x){console.error(x)}return u};switch(true){case s.match(/^(?:https?:\/\/)?(?:(?:[\w]+\.)(?:\.?[\w]{2,})+)?([\/\w]+)(\.[\w]+)/i)?true:false:var t=s.replace(/(\.|\/|\-)/g,"");if(i.tmpl.cache[t]){return r(null,t)}return i.xhr.request(Object.assign({url:s,async:(typeof g=="function")},o)).result(function(u){if([200,206].indexOf(this.status)<0){console.warn(this.status+": "+this.statusText)}else{r(this.responseText,t)}});case !/[^\w\-\.]/.test(s):return r(i.document.getElementById(s).innerHTML,s);default:return r(s)}};l.cache={};i.tmpl=l;var j=function(g){var g=g||i.localStorage;try{g.setItem("test","1");g.removeItem("test")}catch(o){return{p:[],setItem:function(p,q){this.p.push(p);this[p]=q},getItem:function(p){if(this.hasOwnProperty(p)){return this[p]}return null},removeItem:function(p){if(this.hasOwnProperty(p)){delete this.p[p];delete this[p]}},clear:function(){this.p.map(function(p){delete this[p]});this.p=[]}}}return g};i.storage=j()}(window));(function(c,h){c.config={app:{container:'[role="workspace"]'},msg:{container:".alert.alert-danger",tmpl:"alert-box"},spinner:".locker.spinner",popup:{wnd:".b-popup",container:".b-popup .b-popup-content"}};var d=function(g){this.instance=g||c;return this};d.prototype={el:function(i){var g=null;if(typeof i==="string"){if(!i.match(/^#*/)){g=c.document.getElementById(i.replace(/^#/,""))}else{g=this.instance.querySelector(i)}if(g&&!g.hasOwnProperty("spa")){g.spa=new d(g);g.css=new b(g)}}return g},els:function(k,j){if(typeof k==="string"){var i=this.instance.querySelectorAll(k);if(!i){return[]}var g=Array.prototype.slice.call(i),l=0;return g.map(function(m){if(!m.hasOwnProperty("spa")){m.spa=new d(m);m.css=new b(m);if(typeof j=="function"){j.call(c,m,l++)}}return m})}else{return[]}},json:function(g){if(g){try{return JSON.parse(this.instance.getAttribute(g))}catch(i){return this.instance.getAttribute(g)}}return{}},get parent(){return new d(this.instance&&this.instance.parentElement)},src:function(i){var g=i?i:this.instance;return new d(g.srcElement||g.target)},css:function(){return c.css.el(this.instance)},on:function(j,i,g){this.instance.addEventListener(j,i,g||true);return this.instance}};c.spa=new d(document);var b=function(g){this.instance=g;return this};b.prototype={el:function(g){this.instance=g;return this},re:function(i,j){return new RegExp(i,j||"g")},has:function(g){return this.instance.className.match(this.re("(?:^|\\s)"+g+"(?!\\S)"))},add:function(g){if(!this.has(g)){this.instance.className+=" "+g}return this},del:function(g){this.instance.className=this.instance.className.replace(this.re("(?:^|\\s)"+g+"(?!\\S)"),"");return this},tgl:function(g){if(!this.has(g)){this.instance.className+=" "+g}else{this.instance.className=this.instance.className.replace(this.re("(?:^|\\s)"+g+"(?!\\S)"),"")}return this}};c.css=new b(document);var f={elem:c.spa.el(c.config.msg.container),show:function(i,g){this.elem.innerHTML=tmpl(c.config.msg.tmpl,i);this.elem.style.display="inherit";if(typeof g=="undefined"||!g){fadeOut(this.elem,105)}}};c.msg=f;var a={visible:false,wnd:c.spa.el(c.config.popup.wnd),container:c.spa.el(c.config.popup.container),init:function(g){if(typeof g==="object"){if(g.width){this.container.style.width=g.width+"px";this.container.style.marginLeft=(g.width/(-2))+"px"}if(g.height){this.container.style.height=g.height+"px";this.container.style.marginTop=(g.height/(-2))+"px"}}},show:function(g){if(this.wnd){this.wnd.style.opacity="0";g.content&&this.container&&(this.container.innerHTML=g.content);if(typeof g==="object"){(g.width||g.height)&&this.init(g)}this.container.spa.els('[role="popup-close"]',function(i){i.spa.on("click",function(j){return a.hide()})});if(g.event&&g.event.length){g.event.map(function(j,k){j.call(a,k)})}this.visible=true;fadeIn(this.wnd,35);g.cb&&g.cb.call(this)}},hide:function(g){if(this.wnd){this.visible=false;fadeOut(this.wnd,g||35)}}};c.popup=a;c.spa.on("keyup",function(g){if(g.keyCode==27&&a.visible){a.hide()}},false);var e={count:0,element:c.spa.el(c.config.spinner),set run(g){g?this.count++:this.count--;this.count>0?this.element.style.display="block":this.element.style.display="none"},get run(){if(this.element.style.display=="none"){return false}else{return true}}};c.spinner=e}(window));