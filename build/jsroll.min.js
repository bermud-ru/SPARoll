
 /**
 * @app jsroll.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA javascritp framework
 * @author Андрей Новиков <andrey@novikov.be>
 * @data 11/09/2018
 * @status beta
 * @version 2.0.122b
 * @revision $Id: jsroll.min.js 2.0.122b 2018-09-11 11:30:14Z $
 **/

(function(g,undefined){"use strict";var version="2.0.12b";g.HTTP_RESPONSE_CODE={100:"Continue",101:"Switching Protocol",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choice",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Switch Proxy",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"};var xmlHttpRequest=("XMLHttpRequest" in g?g.XMLHttpRequest:("ActiveXObject" in g?g.ActiveXObject("Microsoft.XMLHTTP"):g.XDomainRequest));if(!("indexedDB" in g)){g.indexedDB=g.mozIndexedDB||g.webkitIndexedDB||g.msIndexedDB||null;if(g.indexedDB){g.IDBTransaction=g.webkitIDBTransaction||g.msIDBTransaction;g.IDBKeyRange=g.webkitIDBKeyRange||g.msIDBKeyRange}}g.URL=g.URL||g.webkitURL;g.requestFileSystem=g.requestFileSystem||g.webkitRequestFileSystem;var is_url=/^(?:https?:\/\/)?(?:(?:[\w]+\.)(?:\.?[\w]{2,})+)?([\/\w]+)(\.[\w]+)|^(?:\/[\w]+){1,}/i;var re=function(s,f){return new RegExp(s,f||"g")};g.re=re;var str2json=function(s,def){try{var o=(typeof s==="string"?JSON.parse(s):s||(typeof def==="undefined"?null:def))}catch(e){o=typeof def==="undefined"?null:def}return o};g.str2json=str2json;var obj2array=function(a){return Array.prototype.slice.call(a)};g.obj2array=obj2array;var coalesce=function(){for(var i in arguments){if(typeof arguments[i]!=="undefined"&&arguments[i]!==null){return arguments[i]}}return null};g.coalesce=coalesce;var bitfields=function(status,d){var res=[],st=parseInt(status);if(st==0||typeof d!=="object"){return res}for(var i=0;i<d.length;i++){if(st&Math.pow(2,i)){res.push(d[i])}}return res};g.bitfields=bitfields;var uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16)})};g.uuid=uuid;var crc32=function(str){var makeCRCHelper=g.makeCRCHelper||(g.makeCRCHelper=function(){var c;var makeCRCHelper=[];for(var n=0;n<256;n++){c=n;for(var k=0;k<8;k++){c=((c&1)?(3988292384^(c>>>1)):(c>>>1))}makeCRCHelper[n]=c}return makeCRCHelper});var crc=0^(-1);for(var i=0;i<str.length;i++){crc=(crc>>>8)^makeCRCHelper[(crc^str.charCodeAt(i))&255]}return(crc^(-1))>>>0};g.crc32=crc32;Object.defineProperty(Object.prototype,"merge",{value:function(){if(!arguments.length){return null}var o=(typeof this!=="function"?this:{});Array.prototype.slice.call(arguments).forEach(function(v,k,a){Object.defineProperties(o,Object.keys(v||{}).reduce(function(d,key){if(o.hasOwnProperty(key)&&Object.getOwnPropertyDescriptor(o,key)["set"]){o[key]=v[key];d[key]=Object.getOwnPropertyDescriptor(o,key)}else{d[key]=Object.getOwnPropertyDescriptor(v,key)}return d},{}))});return o},enumerable:false});Object.defineProperty(Object.prototype,"inherit",{value:function(){if(!arguments.length||typeof arguments[0]!=="object"){return null}this.__proto__=Object.merge(arguments[0]);if(arguments[1]==="object"){this.merge(arguments[1])}return this},enumerable:false});Object.defineProperty(Object.prototype,"parent",{value:function(){if(!arguments.length||typeof arguments[0]!=="object"){return null}this.__proto__=arguments[0];if(arguments[0].hasOwnProperty("childs")){arguments[0].childs.push(this)}else{arguments[0].childs=[this]}if(arguments[1]==="object"){this.merge(arguments[1])}return this},enumerable:false});var bb=function(data,params){var opt=Object.assign({type:"application/x-www-form-urlencoded"},params);var BlobBuilder=("MozBlobBuilder" in g?g.MozBlobBuilder:("WebKitBlobBuilder" in g?g.WebKitBlobBuilder:g.BlobBuilder));if(BlobBuilder){var bb=new BlobBuilder();bb.append(data);return bb.getBlob(opt.type)}return new Blob([data],opt)};g.bb=bb;var func=function(str,self,args){if(typeof str!=="string"){return console.error("jsRoll::func(",str,self,args,") Source of context not defined!")}try{var s=str.replace(/(\/\*[\w\'\s\r\n\*]*\*\/)|(\/\/[^\r\n]*)/igm,"");switch(true){case /^\s*function.*[}|;]\s*$/i.test(s):return new Function("return "+s+".apply(this, arguments)");default:return(function(){return eval(s)}).apply(self||this,args||[self])}}catch(e){return console.error("jsRoll::func(",str,self,args,")",e)}};g.func=func;var decoder=function(search,re){var re=re||/[?&]([^=#]+)=([^&#]*)/g,p={},m;try{while(m=re.exec((search||g.location.search))){if(m[1]&&m[2]){p[decodeURIComponent(m[1])]=decodeURIComponent(m[2])}}}catch(e){return null}return p};g.location.decoder=decoder;var encoder=function(params,divider){if(typeof params==="object"){return Object.keys(params).map(function(e,i,a){return encodeURIComponent(e)+"="+encodeURIComponent(params[e])}).join(divider||"&")}return undefined};g.location.encoder=encoder;var update=function(search,params){var u=[],h=[],url=g.location.search,kv=params||{};if(typeof search==="string"){url=search}else{kv=search}var p=g.location.decoder(url);if(url.indexOf("#")>-1){h=url.split("#")}if(url.indexOf("?")>-1){u=url.split("?")}for(var i in kv){p[decodeURIComponent(i)]=decodeURIComponent(kv[i])}var res=[];for(var a in p){res.push(a+"="+p[a])}if(res.length){return((!u.length&&!h.length)?url:(u.length?u[0]:h[0]))+"?"+res.join("&")+(h.length?h[1]:"")}return url};g.location.update=update;function timer(t,c,f,done){if(t&&c&&typeof f==="function"){var fn=function fn(c,f,done){var r=f.call(this,c);if(!c||(r!==undefined&&!r)){clearTimeout(thread);if(typeof done==="function"){return done.call(this,r)}return null}else{return thread=g.setTimeout(fn.bind(this,--c,f,done),t)}},thread=g.setTimeout(fn.bind(this,c,f,done),t);return thread}return undefined}g.timer=timer;function router(r){var isHistory=!!(history.pushState)?1:0;var root=r;return{root:root,rt:[],itv:0,base:isHistory?g.location.pathname+g.location.search:"",referrer:root,clr:function(path){return path.toString().replace(/\/$/,"").replace(/^\//,"")},fr:isHistory?function(){return this.root+this.clr(decodeURI(g.location.pathname+g.location.search)).replace(/\?(.*)$/,"")}:function(){var m=g.location.href.match(/#(.*)$/);return this.root+(m?this.clr(m[1]):"")},add:function(re,handler){if(typeof re=="function"){handler=re;re=""}this.rt.push({re:re,handler:handler});this.rt=this.rt.sort(function(a,b){if(a.re.toString().length<b.re.toString().length){return 1}if(a.re.toString().length>b.re.toString().length){return -1}return 0});return this},rm:function(param){for(var i in this.rt){if(this.rt[i].handler===param||this.rt[i].re.toString()===param.toString()){this.rt.splice(i,1);return this}}return this},chk:function(fr){var f=fr||this.fr(),m=false;for(var i in this.rt){if(m=f.match(this.rt[i].re)){this.rt[i].handler.call(m||{},f);return this}}return this},lsn:function(){var s=this,c=s.fr(),fn=function(){if(c!==s.fr()){c=s.fr();s.chk(c)}return s};clearInterval(s.itv);s.itv=setInterval(fn,50);return s},set:isHistory?function(path){this.referrer=g.location.pathname+g.location.search;history.pushState(null,null,this.root+this.clr(path||""));return this}:function(path){this.referrer=g.location.pathname+g.location.search;window.location.href=g.location.href.replace(/#(.*)$/,"")+"#"+(path||"");return this}}}g.router=router("/");function chain(){var c={tuple:[],cache:[],donned:function(fn){return false},failed:function(fn){return false},pool:function(fn,arg){this.chain.cache.push(this);if(this.chain.tuple.length==this.chain.cache.length){this.chain.donned.apply(this.chain,this.chain.cache)}},done:function(fn){this.donned=fn},fail:function(fn){this.failed=fn}};c.tuple=Array.prototype.slice.call(arguments).map(function(fn){fn.onload=function(){c.pool.apply(fn,arguments)};fn.chain=c;return fn});return c}g.chain=chain;function js(src,opt){if(!src){return null}var opt=Object.assign({async:false,type:"text/javascript",container:g.document.body},opt);var s=g.document.createElement("script");s.type=opt.type;s.async=opt.async;if(opt.hasOwnProperty("id")){s.id=opt.id}if(src.match(is_url)){s.src=src}else{s.text=src}if(typeof opt.onload==="funciton"){s.onload=onload}if(typeof opt.onreadystatechange==="funciton"){s.onreadystatechange=onreadystatechange}if(typeof opt.container.appendChild==="function"){opt.container.appendChild(s)}else{console.error("jsRoll::js() Не существущий контейнер",opt.container)}return s}g.js=js;function xhr(params){var x=new xmlHttpRequest();if(!x){return null}x.fail=function(fn){if(typeof fn==="function"){return fn.call(x,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm))}return x};x.done=function(fn){if(typeof fn==="function"){return fn.call(x,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm))}return x};x.process=function(opt){var proc=opt.process;x.onreadystatechange=function(){if(typeof proc==="function"){return proc.call(x,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm))}else{if(x.readyState==4&&x.status>=400){return x.fail.call(x,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm))}}};x.timeout=opt.timeout;if(typeof opt.hang==="function"){x.ontimeout=function(){x.abort();return opt.hang.call(x,opt)}}else{x.ontimeout=function(){x.abort();return x.done.call(x,null,{status:408})}}return x};x.onload=function(e){x.done.call(x,e,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm));if(typeof x.after=="function"){x.after.call(this)}return x};if(params&&params.hasOwnProperty("responseType")){x.responseType=params.responseType}var opt=Object.assign({method:"GET",timeout:10000,hang:null},params);x.method=opt.method.toUpperCase();var rs=Object.assign({"Xhr-Version":version,"Content-type":"application/x-www-form-urlencoded"},(params||{}).rs);if(rs["Content-type"]===false||rs["Content-type"].toLowerCase()=="multipart/form-data"){delete rs["Content-type"]}try{for(var i in opt){if(typeof opt[i]=="function"){x[i]=opt[i]}}if((["GET","DELETE"].indexOf(x.method)>=0)&&opt.data){var u=opt.url||g.location;opt.url=u+(u.indexOf("?")!=-1?"&":"?")+opt.data;opt.data=null}if(typeof x.before=="function"){x.before.call(x,opt,x)}x.open(x.method,opt.url||g.location,opt.async||true,opt.username,opt.password);for(var m in rs){x.setRequestHeader(m.trim(),rs[m].trim())}x.response_header=null;x.process(opt).send(opt.data)}catch(e){x.abort();x.fail.call(x,e);return x}return x}g.xhr=xhr;var InputHTMLElementSerialize=function(el){if(el instanceof HTMLElement){return el.name+"="+(["checkbox","radio"].indexOf((el.getAttribute("type")||"text").toLowerCase())<0?encodeURIComponent(el.value):(el.checked?(el.value.indexOf("on")==-1?el.value:1):(el.value.indexOf("on")==-1?"":0)))}return null};g.InputHTMLElementSerialize=InputHTMLElementSerialize;var InputHTMLElementValue=function(el,def){var n=undefined;if(el instanceof HTMLElement){n=el.value?(Number(el.value)==el.value?Number(el.value):String(el.value)):(typeof def!=="undefined"?def:null);if(["checkbox","radio"].indexOf((el.getAttribute("type")||"text").toLowerCase())>-1){n=el.checked?(el.value.indexOf("on")==-1?n:1):(el.value.indexOf("on")==-1?(typeof def!=="undefined"?def:null):0)}}return n};g.InputHTMLElementValue=InputHTMLElementValue;Object.defineProperty(JSON,"form",{value:function(f){if(f&&!f.hasOwnProperty("MODEL")){Object.defineProperty(f,"MODEL",{set:function MODEL(d){f.reset();if(typeof d==="object"){var is_array,field,index,el,value;for(var i=0;i<f.elements.length;i++){field=null;index=null;el=f.elements[i];if(el.getAttribute("type")&&el.type.toLowerCase()==="button"){continue}if(is_array=/\[.*\]$/.test(el.name)){field=el.name.replace(/\[.*\]$/,"");if(!d.hasOwnProperty(field)){continue}else{value=d[field]}if(index=/\[([^\]]+)\]/.exec(this.elements[i].name)){index=String(index[1]);if(!d[field].hasOwnProperty(index)){continue}else{value=d[field][index]}}}else{field=el.name||String(i);if(!d.hasOwnProperty(field)){continue}else{value=d[field]}}switch((el.getAttribute("type")||"text").toLowerCase()){case"text":case"textarea":el.value=decodeURIComponent(value);break;case"checkbox":case"radio":if(is_array){el.checked=el.value==="on"?!!value:str2json(value,[]).indexOf(el.value)!==-1}else{el.checked=el.value==="on"?!!value:String(el.value)==String(value)}break;case"number":el.value=Number(value);break;case"color":case"date":case"date":case"datetime-local":case"email":case"month":case"range":case"search":case"tel":case"time":case"url":case"week":default:el.value=String(value)}}}},get:function MODEL(){f.__MODEL__={};var el;for(var i=0;i<f.elements.length;i++){el=f.elements[i];if(el.getAttribute("type")&&el.type.toLowerCase()==="button"){continue}var field=el.name&&/\[.*\]$/.test(el.name)?el.name.replace(/\[.*\]$/,""):(el.name||String(i));var n=["text","textarea"].indexOf((el.getAttribute("type")||"text").toLowerCase())>-1?el.value:InputHTMLElementValue(el);if((typeof f.__MODEL__[field]==="undefined")||(f.__MODEL__[field]===null)){f.__MODEL__[field]=n}else{if(typeof f.__MODEL__[field]!=="undefined"&&n!==null){if(typeof f.__MODEL__[field]!=="object"){f.__MODEL__[field]=[f.__MODEL__[field]]}f.__MODEL__[field].push(n)}}}return f.__MODEL__}});f.prepare=function(validator){var data=[];if(!validator||(typeof validator==="function"&&validator.call(f,data))){for(var i=0;i<f.elements.length;i++){data.push(InputHTMLElementSerialize(f.elements[i]))}}else{f.setAttribute("valid",0)}return data.join("&")};f.fail=typeof f.fail=="function"?f.fail:function(res){f.setAttribute("valid",0);var a=res.form||res.message;if(a){for(var i=0;i<this.elements.length;i++){if(a.hasOwnProperty(this.elements[i].name)){this.elements[i].status="error"}else{this.elements[i].status="none"}}}return f};f.send=function(){var data=f.prepare(f.validator),before=true,args=arguments;if(f.getAttribute("valid")!=0){if(typeof f.before=="function"){before=f.before.call(this)}if(before==undefined||!!before){var done=typeof args[0]=="function"?function(e,hr){f.response_header=hr||{};var callback=args.shift();var result=callback.apply(this,args);return f}:function(e,hr){f.response_header=hr||{};try{var res=JSON.parse(this.responseText)}catch(e){res={result:"error",message:this.status+": "+g.HTTP_RESPONSE_CODE[this.status]}}if(res.result=="error"){if(typeof f.fail=="function"){f.fail.call(f,res,hr,args)}}else{if(typeof f.done=="function"){f.done.call(f,res,hr,args)}}if(typeof f.after=="function"){f.after.call(f,res,hr,args)}return f};g.xhr(Object.assign({method:f.rest,url:f.action,data:data,done:done},f.opt))}}else{f.setAttribute("valid",1)}return f}}f.setAttribute("valid",1);f.rest=f.getAttribute("rest")||f.method;f.validator=f.validator||null;f.opt=f.opt||{};return f},enumerable:false});var tmpl=function tmpl(str,data,cb,opt){var self=Object.merge({progress:false,timer:null,wait:function(after,args){var item=this;if(item.progress){item.timer=setTimeout(function(){item.wait(after,args)},50);return false}if(typeof after=="function"){after.apply(item.tmplContext,args)}else{func(after,item.tmplContext,args)}return},response_header:null,__tmplContext:undefined,get tmplContext(){if(this.__tmplContext){this.__tmplContext.owner=self}return this.__tmplContext},set tmplContext(v){this.__tmplContext=v},onTmplError:function(type,id,str,args,e){console.error("ERROR["+type+"] jsRoll.tmpl()",[id,str],args,e);return}},typeof this!=="undefined"?this:{});var args=arguments;args[1]=args[1]||{};var compile=function(str){var _e="_e"+uuid().replace(/-/g,""),source=str.replace(/(\/\*[\w\'\s\r\n\*]*\*\/)|(\/\/[^\r\n]*)|(\<![\-\-\s\w\>\/]*\>)/igm,"").replace(/\>\s+\</g,"><").trim(),tag=["{%","%}"];if(!source.match(/{%(.*?)%}/g)&&source.match(/<%(.*?)%>/g)){tag=["<%","%>"]}return source.length?new Function(_e,"var p=[], print=function(){ p.push.apply(p,arguments); }; with("+_e+"){p.push('"+source.replace(/[\r\t\n]/g," ").split(tag[0]).join("\t").replace(re("((^|"+tag[1]+")[^\t]*)'","g"),"$1\r").replace(re("\t=(.*?)"+tag[1],"g"),"',$1,'").split("\t").join("');").split(tag[1]).join("p.push('").split("\r").join("\\'")+"');} return p.join('');"):undefined},build=function(str,id){var isId=typeof id!=="undefined",data={},pattern=null;var result=null,after,before,a,pig=g.document.getElementById(id);try{if(pig){var nn=undefined;Array.prototype.slice.call(pig.attributes).forEach(function(i){if(i&&/^tmpl-*/i.test(i.nodeName.toString())&&(nn=i.nodeName.toString().replace(/^tmpl-/i,""))){try{data[nn]=JSON.parse(i.value)}catch(e){data[nn]=i.value}}});if(a=pig.getAttribute("arguments")){try{data=Object.merge(JSON.parse(a)||{},data)}catch(e){return self.onTmplError("tmpl-arguments",id,str,args,a)}}args[1]=Object.merge(args[1],data);if(before=pig.getAttribute("before")){func(before,self,args)}}else{if(opt&&typeof opt.before=="object"){args[1]=Object.assign(args[1],opt.before)}else{if(opt&&typeof opt.before=="function"){opt.before.call(self,args)}}}if(isId&&g.tmpl.cache[id]){pattern=g.tmpl.cache[id]}else{pattern=compile(str);if(isId){g.tmpl.cache[id]=pattern}}if(!pattern){return self.onTmplError("tmpl-pattern",id,str,args,"пустой шаблон")}result=pattern.call(g.tmpl,args[1]);if(typeof cb=="function"){self.tmplContext=cb.call(pattern||g.tmpl,result)||g.tmpl}else{if(self.tmplContext instanceof HTMLElement||cb instanceof HTMLElement&&(self.tmplContext=cb)){self.tmplContext.innerHTML=result}}if(self.tmplContext&&pig&&(after=pig.getAttribute("after"))){self.wait(after,args)}else{if(opt&&typeof opt.after=="function"){self.wait(opt.after,args)}}return}catch(e){return self.onTmplError("tmpl-build",id,str,args,e)}return result};try{switch(true){case str.match(is_url)?true:false:var id=str.replace(/(\.|\/|\-)/g,"");if(g.tmpl.cache[id]){return build(null,id)}var opt=opt||{};opt.rs=Object.assign(opt.rs||{},{"Content-type":"text/x-template"});return g.xhr(Object.assign({url:str,async:(typeof cb=="function"),done:function(e,hr){self.response_header=hr;build(this.responseText,id)}},opt));case !/[^\w\-\.]/.test(str):return build(g.document.getElementById(str).innerHTML,str);default:return build(str)}}catch(e){return self.onTmplError("tmpl",id,str,args,e)}};tmpl.cache={};g.tmpl=tmpl;var storage=function(s){try{var s=s||g.localStorage;s.setItem("test","1");s.removeItem("test")}catch(e){return{p:[],setItem:function(key,value){this.p.push(key);this[key]=value},getItem:function(key){if(this.hasOwnProperty(key)){return this[key]}return null},removeItem:function(key){if(this.hasOwnProperty(key)){delete this.p[key];delete this[key]}},clear:function(){this.p.forEach(function(item){delete this[item]});this.p=[]}}}return s};g.storage=storage();var dom=function(){var p;try{if("DOMParser" in g){p=new DOMParser();return function(d,mime){try{return p.parseFromString(d,mime||"text/xml")}catch(e){return null}}}else{if("ActiveXObject" in g){p=new ActiveXObject("Microsoft.XMLDOM");p.async="false";return function(d,mime){try{p.instance.loadXML(d);return p}catch(e){return null}}}}return null}catch(e){return undefined}};g.dom=dom()}(window));(function(d,j){"use strict";var a=function(g){this.instance=this.el(g).instance;return this};a.prototype={el:function(g){this.instance=typeof g==="string"?d.document.querySelector(g):g;return this},style:function(l,g){this.instance.style[l]=g;return this},has:function(l){var k=this.instance.className;if(typeof l!=="string"&&k){return null}var g=[];l.split(" +").forEach(function(o,n,m){if(k.match(re("(?:^|\\s)"+o+"(?!\\S)"))){g.push(o)}});return g.length?g:null},add:function(g){if(this.instance&&!this.has(g)){this.instance.className+=" "+g}return this},del:function(k){var g=this.instance;if(k&&g){k.split(/\s+/).forEach(function(n,m,l){g.className=g.className.replace(re("(?:^|\\s)"+n+"(?!\\S)"),"").trim()})}return this},rpl:function(g,l){var k=this.instance;if(g&&l&&k){k.className=k.className.replace(g,l)}},tgl:function(g){if(this.instance){if(!this.has(g)){this.instance.className+=" "+g}else{this.instance.className=this.instance.className.replace(re("(?:^|\\s)"+g+"(?!\\S)"),"").trim()}}return this}};d.css=new a(d);var h=("CustomEvent" in d?d.CustomEvent:(function(){function g(l,m){m=m||{bubbles:false,cancelable:false,detail:j};var k=d.document.createEvent("CustomEvent");k.initCustomEvent(l,m.bubbles,m.cancelable,m.detail);return k}g.prototype=d.Event.prototype;return g})());d.ce=h;Element.matches=Element.matches||Element.matchesSelector||Element.webkitMatchesSelector||Element.msMatchesSelector||function(g){var m=this,k=(m.parentNode||m.document).querySelectorAll(g),l=-1;while(k[++l]&&k[l]!=m){}return !!k[l]};var e=function(g){if(g.hasOwnProperty("ui")){return g}this._parent=null;this.instance=g||d.document;if(g){this.instance.css=new a(this.instance);this.wrap(this.instance.parentElement)}return this};e.prototype={wrap:function(k,g){if(k instanceof Element&&!k.hasOwnProperty("ui")){k.ui=new e(k);if(typeof g=="string"){d[g]=k}}return k},el:function(l,g){var k=null;if(typeof l==="string"){if(!l.match(/^#*/)){k=d.document.getElementById(l.replace(/^#/,""))}else{k=this.instance.querySelector(l)}}else{if(typeof l==="object"){k=l}}if(k){if(!k.hasOwnProperty("ui")){k.ui=new e(k)}if(typeof g==="string"){d[g]=k}else{if(typeof g==="function"){g.call(k,arguments)}}}return k},els:function(l,k,g){if(typeof l==="string"){var m=[];l.split(",").forEach((function(n){m.push.apply(m,Array.prototype.slice.call(this.instance.querySelectorAll(n.trim())||{}).map(function(q,p,o){if(!q.hasOwnProperty("ui")){q.ui=new e(q)}if(typeof k=="function"){k.call(q,p,o)}return q}))}).bind(this));if(typeof k=="string"){d[k]=m}else{if(typeof g=="string"){d[g]=m}}return m}else{return[]}},attr:function(k,l){if(k==j){var m={},r;for(var o in this.instance.attributes){m[(r=this.instance.attributes[o].nodeName)]=this.instance.getAttribute(r)}return m}else{if(typeof k==="object"&&typeof l==="undefined"){for(var o in k){if(!/\d+/.test(o)){this.instance.setAttribute(o,k[o])}}return this}else{if(typeof k==="string"&&typeof l==="undefined"){var g=k.indexOf("*")!=-1?re(k.split("*")[0],"i"):null;if(g){var p={};Array.prototype.slice.call(this.instance.attributes).forEach(function(u,t,n){var s=u.nodeName.toString();if(g.test(s)&&(s=s.replace(g,""))){p[s]=u.value}});return p}else{try{return JSON.parse(this.instance.getAttribute(k))}catch(q){return this.instance.getAttribute(k)}}}else{if(typeof k==="string"&&l){if(!/\d+/.test(k)){if(typeof l==="object"){this.instance.setAttribute(k,JSON.stringify(l))}else{this.instance.setAttribute(k,l)}}}}}}return this},tmpl:function(m,l,g,k){tmpl.apply(this.instance,[m,l,g,k]);return this.instance},merge:function(){merge.apply(this.instance,arguments);return this.instance},src:function(k){var g=k?k:this.instance;return new e(g.srcElement||g.target)},on:function(m,l,k){var g=this;m.split(",").forEach(function(n){g.instance.addEventListener(n.trim(),l,!!k)});return this.instance},dg:function(m,n,l,k){var g=this;g.instance.addEventListener(n,function(q){var p,o=(q.target||q.srcElement);while(o&&o.matches&&o!==g&&!(p=o.matches(m))){o=o.parentElement}if(p){l.call(g.wrap(o),q);return o}return !!p},!!k);return this.instance},dom:function(l,k){if(!l||typeof l!=="string"){return null}var g=d.dom(l,k).childNodes;return g.length>1?g:g[0]},up:function(n,m){var g=d.dom(n,m).childNodes,l=this.instance===d.document?d.ui.el("body"):this.instance;for(var k=0;k<g.length;k++){l.appendChild(g[k])}return l},rm:function(g){if(!g||typeof g!=="string"){return null}this.els(g).forEach(function(k){k.parentNode.removeChild(k)});return this.instance},get active(){return this.instance===d.document.activeElement},focus:function(k){var g;if(k){g=(typeof k=="string"?this.el(k):k)}else{g=this.instance}if(g){d.setTimeout(function(){g.focus();return false},0)}return g}};d.ui=new e(document);Object.defineProperty(d,"selected",{get:function c(){return d.getSelection?d.getSelection().toString():d.document.selection.createRange().text}});function b(){if(d.getSelection){if(d.getSelection().empty){d.getSelection().empty()}else{if(d.getSelection().removeAllRanges){d.getSelection().removeAllRanges()}}}else{if(d.document.selection){d.document.selection.empty()}}}d.selection=b;function i(l,k){if(!l){return false}var g=null;var k=Object.assign({display:false,timeout:500,context:null},k),m=function(n){if(!n.hasOwnProperty("fade")){n.faded=n.style.opacity==0;n.opt=k;n.opt.context=typeof k.context==="string"?n.el(k.context):n;Object.defineProperty(n,"fade",{get:function(){return n.faded},set:function(o){if(o){n.css.add("fade");if(n.opt.display){setTimeout(function(){n.style.display="none"},n.opt.timeout)}return n.faded=true}else{if(n.opt.display){n.style.display=n.getAttribute("display")?n.getAttribute("display"):"inherit"}n.css.del("fade");return n.faded=false}},enumerable:true,configurable:true})}return n};if(typeof l==="string"){g=d.ui.els(l);g.forEach(function(o,p,n){m(o)})}else{if(l instanceof HTMLElement){g=m(l)}else{if(typeof l==="object"){g=l;l.forEach(function(o,p,n){m(o)})}}}return g}d.fader=i}(window));(function(b,d,i){"use strict";if(typeof d==="undefined"){return false}var e=function(k,j){this.__valid=true;this.opt=Object.merge({method:"get",url:b.location.href,before:function(l){b.spinner=true},after:function(l){b.spinner=false}},j);this.wrongs=[];this.elements=typeof k==="string"?d.els(k):k;this.length=this.elements.length||0;var g=this;this.elements.forEach(function(n,m,l){n.group=g})};e.prototype={events:{},on:function(l,k,j){var g=this;g.events[l]=k;this.elements.forEach(function(o,n,m){o.ui.on(l,g.events[l],j)})},set valid(j){this.wrongs=[];if(j.message){for(var g=0;g<this.elements.length;g++){this.__valid=true;if(j.message.hasOwnProperty(this.elements[g].name)){this.elements[g].status="error";this.__valid=false;this.wrongs.push(this.elements[g].name)}else{this.elements[g].status="none"}}}},get valid(){this.__valid=true;var g=this;this.wrongs=[];this.elements.forEach(function(m,l,k){var j=input_validator(m);if(!j){g.wrongs.push(m.name)}g.__valid&=j});return this.__valid},is_wrong:function(){if(arguments.length){var k=this,j=typeof arguments[0]==="object"?arguments[0]:Array.prototype.slice.call(arguments,0);var g=true;j.forEach(function(n,m,l){g&=k.wrongs.indexOf(n)>-1});return g}return !!this.wrongs.length},__MODEL__:{},set MODEL(j){if(j&&typeof j==="object"){this.__MODEL__=j;this.wrongs=[];for(var g=0;g<this.elements.length;g++){if(j.hasOwnProperty(this.elements[g].name)){this.elements[g].value=j[this.elements[g].name];if(["checkbox","radio"].indexOf((this.elements[g].getAttribute("type")||"text").toLowerCase())>-1){this.elements[g].checked=parseInt(j[this.elements[g].name])!==0}}}}else{this.__MODEL__={}}},get MODEL(){this.__MODEL__={};for(var g=0;g<this.elements.length;g++){var j=this.elements[g].value.length?new Number(this.elements[g].value):NaN;this.__MODEL__[this.elements[g].name||g]=["checkbox","radio"].indexOf((this.elements[g].getAttribute("type")||"text").toLowerCase())<0?(isNaN(j)?this.elements[g].value:j):(this.elements[g].checked?(this.elements[g].value.indexOf("on")==-1?this.elements[g].value:1):(this.elements[g].value.indexOf("on")==-1?"":0))}return this.__MODEL__},data:function(){var j=[];for(var g=0;g<this.elements.length;g++){j.push(b.InputHTMLElementSerialize(this.elements[g]))}return j.join("&")},send:function(){var j=arguments,g=this;if(typeof g.after=="function"){g.opt.after()}b.xhr(Object.assign({data:g.data(),done:typeof j[0]=="function"?function(l){g.response_header=l;var m=j.shift();var k=m.apply(this,j);return f}:function(l){g.response_header=l;try{var k=JSON.parse(this.responseText)}catch(m){k={result:"error",message:this.status+": "+b.HTTP_RESPONSE_CODE[this.status]}}if(k.result=="error"){if(typeof g.fail=="function"){g.fail.call(f,k,j)}}else{if(typeof g.done=="function"){g.done.call(f,k,j)}}if(typeof g.after=="function"){g.after.call(f,k,j)}return f}},g.opt));return this}};b.group=e;b.config={app:{container:'[role="workspace"]'},msg:{container:".alert.alert-danger",tmpl:"alert-box"},spinner:".locker.spinner",popup:{wnd:".b-popup",container:".b-popup .b-popup-content"}};var h=function(g){this.route=router;this.registry={};this.dim={};this.instance=g||b;return this};h.prototype={bootstrap:function(g){this.route.set(g).chk(g).lsn();return this},get store(){return str2json(storage.getItem("app"))},set store(g){storage.setItem("app",g==="string"?g:JSON.stringify(g))},widget:function(j,m,n,l){var k=this,g=typeof j.root=="string"?b.ui.el(j.root):j.root;tmpl(m,n,function(o){if(g&&o&&(g.innerHTML=o)){k.implement(g,j.event||[]);k.inject(j.root,g,j.code||l&&l.code)}},l);return this},event:function(g,j){this.registry[g]=j;return this},implement:function(k,j){var g=this;(j||[]).forEach(function(m,n){for(var l in g.registry[m]){switch(typeof g.registry[m][l]){case"object":k.ui.els(m,function(){this.ui.on(g.registry[m][l][0],g.registry[m][l][1]);return this});break;case"string":k.ui.els(m,function(){this.ui.on(g.registry[m][0],g.registry[m][1]);return this});return;case"function":g.registry[m][l].call(k.ui.els(m),g.dim[m]||{})}}});return g},variable:function(g,j){if(!g){return i}if(!g.hasOwnProperty("dim")){Object.defineProperty(g,"dim",{get:function(){try{return b.app.dim[j]||(b.app.dim[j]=Object.assign(JSON.parse(storage.getItem(j)||""),{self:g}))}catch(k){b.app.dim[j]={};b.app.dim[j].self=g;return b.app.dim[j]}}});b.app.dim[j]={};b.app.dim[j].self=g;g.store=function(k){var l={};Object.keys(b.app.dim[j]).forEach(function(m){if(k.indexOf(m)!=-1){l[m]=b.app.dim[j][m]}});storage.setItem(j,JSON.stringify(l));return this}}return g},inject:function(g,k,j){if(typeof j==="function"){j.apply(this.variable(k,g),arguments)}return false},elem:fader(config.msg.container)[0],msg:function(j){var g=this;tmpl(config.msg.tmpl,j,g.elem);g.elem.fade=false;setTimeout(function(){g.elem.fade=true},3000);return this},spinner_count:0,spinner_element:d.el(b.config.spinner),set spinner(g){g?this.spinner_count++:this.spinner_count--;this.spinner_count>0?this.spinner_element.style.display="block":this.spinner_element.style.display="none"},get spinner(){if(this.spinner_element.style.display=="none"){return false}return true},before:function(){b.app.spinner=true},after:function(){b.app.spinner=false},list:b,popupEvent:function(g){if(g.keyCode==27){if(!b.app.elem.css.has("fade")){clearTimeout(b.app.elem.timer);b.app.elem.fade=true}else{b.app.popup()}}},popup:function(n,m,l){var j=this;this.wnd=this.wnd||d.el(b.config.popup.wnd);if(j.wnd.fade){this.container=this.container||d.el(b.config.popup.container);var g=false,k={onTmplError:function(){b.msg.show({message:"Ошибка выполнения приложения!"});console.error(arguments);g=true}};tmpl.apply(k,[n,m,this.variable(this.container,"popupBox"),l]);if(!g){b.addEventListener("keydown",b.app.popupEvent);j.container.css.del("is-(valid|invalid|warning|spinner)");j.wnd.fade=g=false}}else{b.removeEventListener("keydown",j.popupEvent);if(typeof arguments[0]=="function"){arguments[0].apply(j,obj2array(arguments).slice(1))}j.container.innerHTML=null;j.wnd.fade=true;if(j.list){j.list.ui.focus('[role="popup-box"]')}}return this},fader:function(j,g){b.fader(j,g);return this},download:function(g,k,l){var j=g;return b.xhr(Object.assign({responseType:"arraybuffer",url:k,done:function(s,v){try{var m=b.uuid();if(l&&l.hasOwnProperty("filename")){m=l.filename}else{var o=this.getResponseHeader("Content-Disposition");if(o&&o.indexOf("attachment")!==-1){var p=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;var r=p.exec(o);if(r!=null&&r[1]){m=r[1].replace(/['"]/g,"")}}}var t=this.getResponseHeader("Content-Type");var n=b.bb(this.response,{type:t});if(j.disabled){setTimeout(function(){j.disabled=false;j.css.del("spinner")},1500)}if(this.getResponseHeader("Action-Status")){msg.show({message:this.getResponseHeader("Action-Status")});return}if(typeof b.navigator.msSaveBlob!=="undefined"){b.navigator.msSaveBlob(n,m)}else{var q=b.URL.createObjectURL(n);if(m){var u=document.createElement("a");if(typeof u.download==="undefined"){b.open(q)}else{u.href=q;u.download=m;document.body.appendChild(u);u.click();setTimeout(function(){document.body.removeChild(u)},100)}}else{b.open(q)}setTimeout(function(){URL.revokeObjectURL(q)},100)}}catch(s){if(j.disabled){setTimeout(function(){j.disabled=false;j.css.del("spinner")},1500)}msg.show({message:this.status+": "+s+" (URL: "+k+")"});console.error("app::download Error "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},fail:function(m){if(j.disabled){setTimeout(function(){j.disabled=false;j.css.del("spinner")},1500)}console.error("download Error "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},l))},upload:function(v,j,l){var n=v.files[0];var q=l.done;delete l.done;var o=l.fail;delete l.fail;var t=l.stop;delete l.stop;if(!n){return console.warn("File not found!")}var u=function(z,C,y,A){var B=z.mozSlice?z.mozSlice:z.webkitSlice?z.webkitSlice:z.slice?z.slice:function(){};return B.bind(z)(C,y)};var x=n.size,g=n.name;var m=l.sliceSize||1024;var k=l.start||0,p;var r,w;var s=function(){p=k+m;if(x-p<0){p=x}w=u(n,k,p);r=new FormData();r.append("filename",g);r.append("size",x);r.append("start",k);r.append("end",p);r.append("file",w);if(t.call(this)){b.xhr(Object.assign({method:"post",rs:{"Content-type":"multipart/form-data",Hash:acl.user.hash},url:j,data:r,done:function(A,y){try{var z=JSON.parse(this.responseText)}catch(A){z={result:"error",message:this.status+": "+b.HTTP_RESPONSE_CODE[this.status]}}if(z.result=="ok"){if(typeof l.progress==="function"){l.progress.call(z,(Math.floor(z.end/x*1000)/10))}if(z.end<x){k+=m;setTimeout(s,1)}else{q.call(z)}}else{o.call(z);h.msg(z)}return},fail:function(z,y){if(typeof l.fail==="function"){l.fail.call(y,z)}console.error("app::upload Error "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},l))}};if(x>0){setTimeout(s,1)}return}};b.app=new h(b.document);b.paginator=function(k,j){var g=this,l=k.paginator;if(l){this.ui.el(".paginator",function(m){tmpl("paginator-box",{pages:Math.ceil(l.count/10),page:l.page,model:j},this)})}return l};var a=function(k,g){var l=[],j=0;if(k){if(typeof g==="object"&&g.hasOwnProperty("page")){j=g.page}k.forEach(function(p,o,m){var n=["INPUT","SELECT"].indexOf(p.tagName)>-1?p:p.ui.el("input,select");if(n){l.push(n);if(typeof g==="object"&&g.hasOwnProperty(n.name)){n.value=g[n.name]}if(n.tagName==="INPUT"){input_validator(n)}}});return{el:l,index:j,__valid:true,transformer:null,get valid(){var m=this;m.__valid=true;this.el.forEach(function(p,o,n){m.__valid&=input_validator(p)});return this.__valid},set params(n){var o={},m=this;m.__valid=true;if(typeof n==="object"){o=n}else{if(typeof n==="string"){o=location.decoder(n)}}if(o.hasOwnProperty("page")){this.index=o.page}this.el.forEach(function(r,q,p){if(o.hasOwnProperty(r.name)){r.value=o[r.name]}else{r.value=""}m.__valid&=input_validator(r)})},get params(){var n={},m=this;this.el.forEach(function(r,q,o){var p=InputHTMLElementValue(r);if(p!==null){n[r.name]=p;input_validator(r)}});return n},diff:function(m){var n=this.params;return Object.keys(n).concat(Object.keys(m)).reduce(function(p,o){if(n[o]!=m[o]){p[o]=m[o]}return p},{})},update:function(n){var q=this.params;q.page=this.index||0;if(typeof n==="string"){var m=location.decoder(n);for(var o in this.el){if(Object.keys(m).indexOf(this.el[o].name)>-1){m[this.el[o].name]=InputHTMLElementValue(this.el[o],"")}}return b.location.update(n,Object.assign(m,q))}else{if(typeof n==="object"){for(var o in this.el){if(Object.keys(n).indexOf(this.el[o].name)>-1){n[this.el[o].name]=InputHTMLElementValue(this.el[o],null);if(n[this.el[o].name]===null){delete n[this.el[o].name]}}}return Object.assign(n,q)}}return"?"+location.encoder(q)},get uri(){var m=this.params;m.page=this.index||0;if(typeof this.transformer==="function"){return location.encoder(this.transformer(m))}return location.encoder(m)},callback:function(o){var m=true,p=Object.keys(o.message||{});if(typeof o==="undefined"){return o}if(p.length){for(var n in this.el){if(p.indexOf(this.el[n].name)>-1){switch(o.result){case"ok":this.el[n].status="success";break;case"error":m&=false;default:this.el[n].status=o.result}}else{m&=input_validator(this.el[n])}}}return m}}}return null};b.filter=a;var c=function(s,o,j){if(!s){return i}var q=s.match(/^\/\w+.*/i)?"//"+location.hostname+s:s;var k=function(l,v,u){var n=[];if(typeof u=="object"){for(var p in u){n.push(p+"="+u[p])}u=n.join("&")}return xhr(Object.assign({method:v,url:l.route,data:u},l.opt))};var g={methods:o?o:["GET","POST","PUT","DELETE"],route:s,opt:j,rs:{},error:{},proc:null,before:null,after:null,abort:function(){if(this.proc){this.proc.abort()}this.proc=null},done:function(l,n){return this.rs[n]=l},fail:function(l,n){return this.error=l}};for(var m in o){var r=o[m].toLowerCase(),t=r.toUpperCase();g.rs[t]=null;g[r]=(function(l){return function(n){this.rs[l]=null;return this.proc=k(this,l,n)}}).apply(g,[t]);Object.defineProperty(g,t,{get:function(){return this.rs[t]}})}if(q){return g}else{console.warn("Can't resolve route:",s)}return{}};b.crud=c}(window,window.ui));(function(h,k,c){if(typeof k==="undefined"){return false}var b={elem:k.el(h.config.msg.container),show:function(o,n){tmpl(h.config.msg.tmpl,o,this.elem);this.elem.css.del("fade");var g=this.elem;if(typeof n=="undefined"||!n){g.timer=setTimeout(function(){g.css.add("fade")},3000)}return this.elem}};h.msg=b;h.spinner_count=0;h.spinner_element=k.el(h.config.spinner);if(h.spinner_element){Object.defineProperty(h,"spinner",{__proto__:null,enumerable:false,configurable:false,set:function(g){g?h.spinner_count++:h.spinner_count--;h.spinner_count>0?h.spinner_element.style.display="block":h.spinner_element.style.display="none"},get:function(){if(h.spinner_element.style.display=="none"){return false}return true}})}var i=function(g,n){if(g&&g.tagName){if(typeof n==="object"&&n.hasOwnProperty(g.name)){g.value=n[g.name]}else{g.value=null}return true}return false};h.setValueFromObject=i;var l=function(r,v){if(r&&((v||["INPUT","SELECT","TEXTAREA"]).indexOf(r.tagName)>-1)){var u=true,g=null,t;if(!r.hasOwnProperty("validator")&&(g=r.getAttribute("validator"))!==null){r.validator=func(g)}if((r.getAttribute("required")!==null)&&!r.value){u=false}else{if((r.getAttribute("required")===null)&&!r.value){u=true}else{if((t=r.getAttribute("pattern"))===null){u=true}else{if(!r.hasOwnProperty("testPattern")){try{var n=/[?\/](.+)(\/([igum]*$))/.exec(t)||[];r.regex=new RegExp(n[1]||t,n[3]||"");Object.defineProperty(r,"testPattern",{get:function q(){this.regex.lastIndex=0;return this.regex.test(this.value.trim())}})}catch(s){r.testPattern=false;console.error(r,t,s)}}u=r.testPattern}}}if(u&&r.hasOwnProperty("validator")){u=r.validator.call(r,u)}var o=r.type!="hidden"?r:false;if(o){e(k.wrap(o));if(!u){o.status="error"}else{if(!o.disabled){if(o.value.length){o.status="success"}else{o.status="none"}}else{o.status="none"}}}return u}return true};h.input_validator=l;var d=function(n,g){if(!n){return null}return this.ui.els(n,function(){if(["checkbox","radio"].indexOf((this.getAttribute("type")||"text").toLowerCase())>-1){this.checked=this.ui.attr(g||"default")||false}else{switch(this.tagName){case"SELECT":this.value=this.ui.attr(g||"default")||0;break;case"INPUT":case"TEXTAREA":default:this.value=this.ui.attr(g||"default")||""}}this.status="none"})};h.set_default=d;var e=function(n){if(n&&!n.hasOwnProperty("status")&&!n.css.has("no-status")){Object.defineProperty(n,"status",{set:function g(p){var o=!!this.getAttribute("paretnStatus")?true:false;this.parentElement.css.del("has-(danger|warning|success|spinner)");this.css.del("is-(valid|invalid|warinig|spinner)");switch(p){case"error":this._status="error";this.css.add("is-invalid");this.parentElement.css.add("has-danger");break;case"warning":this._status="warning";this.css.add("is-warning");this.parentElement.css.add("has-warning");break;case"success":this._status="success";this.css.add("is-valid");this.parentElement.css.add("has-success");break;case"spinner":this._status="spinner";this.css.add("is-spinner");this.parentElement.css.add("has-spinner");break;case"none":default:this._status="none"}},get:function g(){return this._status}})}return n};h.inputer=e;h.formvalidator=function(o){var g={};for(var n=0;n<this.elements.length;n++){if(!l(this.elements[n])){g[this.elements[n].name]=this.elements[n].value||"Поле с неверными данными или пустым значения!"}}if(Object.keys(g).length){if(h.spinner){h.spinner=false}g.caption="Неверно заполнена форма!";b.show({message:g});return false}return true};var a=function(n,g){if(n&&n.tagName){e(n).ui.on("focus",function(o){if(typeof this.status==="undefined"){l(this)}return false}).ui.on("input",function(o){l(this);return false}).ui.on("blur",function(o){l(this);return false})}};h.pattern_validator=a;var j=function(n,g){if(n&&n.tagName==="INPUT"){var o={index:0,key:null,cache:null,value:null,opt:{},delta:330,timer:null,request:null,__xhr:null,stoped:function(){if(this.owner.status="spinner"){this.owner.status="";if(this.__xhr){this.__xhr.abort()}}},delayed:function(){if(!this.timer){var p=function p(){if(this.request==this.owner.value){if(this.owner.pannel){this.owner.pannel.css.add("fade")}this.xhr()}clearTimeout(this.timer);this.timer=null;if(this.request&&this.request!="null"&&this.request!=this.owner.value){this.request=this.owner.value;this.timer=h.setTimeout(p.bind(this),this.delta)}};this.timer=h.setTimeout(p.bind(this),this.delta);this.request=this.owner.value}else{this.stoped()}return this.timer},activeItem:function(q){if(q&&this.cache.hasOwnProperty(q)){this.key=q}else{return}var p=this.owner,t=this.cache[this.key]||{},s={};if(p.pannel&&Object.keys(t).length){p.pannel.ui.el(".active",function(){this.css.del("active")});var r=Object.keys(t).map(function(u){return t[u]});var q=r.indexOf(p.value);if(q!=-1){p.pannel.ui.el('[value="'+q+'"]',function(){this.css.add("active")})}}return},tmpl:function(q){var p=this.owner;this.index=-1;this.key=p.value.toLowerCase()||"null";if(p.pannel){var r=k.dom(tmpl(this.opt.tmpl,{data:q,field:p.name}));if(r){p.pannel.innerHTML=r.innerHTML}}else{p.parentElement.insertAdjacentHTML("beforeend",tmpl(this.opt.tmpl,{data:q,field:p.name}));p.parentElement.css.add("dropdown");p.pannel=p.parentElement.ui.el(".dropdown-menu.list")}if(!this.opt.wrapper){p.pannel.setAttribute("style","left:"+p.offsetLeft+"px;width:"+p.clientWidth+"px;")}this.activeItem(this.key);p.parentElement.ui.els(".dropdown-menu.list li",function(){this.ui.on("mousedown",function(t){p.value=this.innerHTML;var s=p.typeahead.cache[p.typeahead.key];return})})},xhr:function(){var p=this.owner,r={};if(this.opt.skip>p.value.trim().length||(this.opt.validate&&!l(this.owner))){if(p.typeahead.cache===null){p.typeahead.cache={}}p.typeahead.cache[p.value.trim()]={};return p.typeahead.show([])}r[p.name]=p.value;var q=p.value?p.value.toLowerCase():"null";if((this.cache===null||!this.cache.hasOwnProperty(q)||q=="null")&&p.ui.attr("url")){p.status="spinner";this.__xhr=xhr({url:location.update(p.ui.attr("url"),r),rs:this.opt.rs,before:function(){p.status="spinner";if(p.pannel){p.pannel.css.add("fade")}},after:function(){if(p.status="spinner"){p.status=""}},done:function(t){try{var s=JSON.parse(this.responseText)}catch(t){s={result:"error",message:this.status+": "+HTTP_RESPONSE_CODE[this.status]}}if(s.result!="ok"){p.onError(s,this)}if(p.typeahead.cache===null){p.typeahead.cache={}}p.typeahead.cache[q]=s.data||[];p.typeahead.activeItem(q);p.typeahead.show(s.data||[]);return this},fail:function(s){console.error("typeahead",s)}})}else{if(this.cache&&this.cache.hasOwnProperty(q)){p.typeahead.show(this.cache[q])}}return this},show:function(q){var p=this.owner;if(p.ui.active){if(q&&Object.keys(q).length){this.tmpl(q);p.pannel.css.del("fade")}else{if(p.pannel){p.pannel.css.add("fade")}}}return false},onKeydown:function(u){var r=(u.charCode&&u.charCode>0)?u.charCode:u.keyCode;if(this.typeahead.cache!==null){var t=this.typeahead,p,s=t.cache[t.key],q={};if(s&&typeof s==="object"){switch(r){case 38:if(t.index>0){t.index--}else{t.index=Object.keys(s).length-1}break;case 40:if(t.index<Object.keys(s).length-1){t.index++}else{t.index=0}break;case 13:t.stoped();if(this.pannel){this.pannel.css.add("fade")}default:return}q=s[(p=Object.keys(s)[t.index])];this.value=(typeof q==="object"?q[this.name]:q)||"";this.selectionStart=this.selectionEnd=this.value.length;if(this.pannel){this.pannel.ui.el(".active",function(){this.css.del("active")});this.pannel.ui.el('[value="'+p+'"]',function(){this.css.add("active")})}}else{if(r!=9){q={}}}this.setValue(q)}return},onFocus:function(p){if(this.value.length){this.setSelectionRange(this.value.length,this.value.length)}this.__value=this.value;if(!this.value.length||(this.value.length&&["none","success"].indexOf(this.status)==-1)){this.typeahead.delayed()}return},onInput:function(p){if(this.pannel){this.pannel.css.add("fade")}this.typeahead.delayed();if(this.__value!==this.value){this.setValue()}l(this);return},onBlur:function(t){if(this.pannel){this.pannel.css.add("fade")}var q=c;if(this.typeahead.cache!==null){var p=this,s=this.typeahead,r=s.cache[s.key];if(s.timer){clearTimeout(s.timer);s.timer=null}if(r&&typeof r==="object"){Object.keys(r).forEach(function(u){if(r[u][p.name]==p.value){q=r[u]}})}}else{q={}}this.setValue(q);l(this);return}};if(typeof n.typeahead==="undefined"){n.typeahead=o;n.isSet=!!n.value.length;n.__value=n.value;n.typeahead.opt=Object.assign({wrapper:false,skip:0,validate:false,tmpl:"typeahead-tmpl",rs:{}},g);n.onError=function(p,q){this.status=p.result;this.isSet=false;console.error(p.message)};n.setValue=function(p){this.typeahead.value=typeof p==="object"?p:{};if(n.typeahead.opt.hasOwnProperty("fn")&&typeof n.typeahead.opt.fn==="function"){if(this.typeahead.cache!==null){n.typeahead.opt.fn.call(n,this.typeahead.value);n.isSet=n.value&&this.typeahead.value.hasOwnProperty(n.name)?true:false;this.dispatchEvent(new Event("change"))}else{if(this.__value!==this.value){n.typeahead.opt.fn.call(n,{});this.dispatchEvent(new Event("change"));n.isSet=false}else{n.isSet=true;n.typeahead.opt.fn.call(n,c)}}}};n.typeahead.owner=e(n);n.ui.on("focus",o.onFocus).ui.on("input",o.onInput).ui.on("blur",o.onBlur).ui.on("keydown",o.onKeydown);if(!n.ui.attr("tabindex")){n.ui.attr("tabindex","0")}}return n}};h.typeahead=j;var m=function(n,p,g){if(n.tagName==="INPUT"){var o=e(n);o.cleared=g==c?true:!!g;if(p){o.maxLength=o.ui.attr("placeholder",p||"").attr("placeholder").length}if(!o.ui.attr("tabindex")){o.ui.attr("tabindex","0")}if(o&&!o.hasOwnProperty("insertDigit")){o.insertDigit=function(v,t){if(t){var x=this.value.indexOf(t);var u=/\d/.test(v)?1:0;var q=this.ui.attr("placeholder").substr(x,t.length).indexOf("_");if(q>0){x+=q}this.value=this.value.substr(0,x)+(/\d/.test(v)?v:"")+this.ui.attr("placeholder").substr(x+u,t.length-u)+this.value.substr(x+t.length,this.value.length);this.selectionStart=this.e1=this.selectionEnd=this.s1=x+1}else{if(/\d/.test(v)&&(this.value||this.ui.attr("placeholder")).indexOf("_")>-1){var w=this.value||this.ui.attr("placeholder");var x=w.indexOf("_");var s=w.match(/\d/)?(w.indexOf(w.match(/\d/))):-1;if(x<=this.selectionStart||s<0||s>x){this.value=(this.value||this.ui.attr("placeholder")).replace("_",v);x=(this.value||this.ui.attr("placeholder")).indexOf("_");this.e1=this.selectionEnd=this.selectionStart=this.s1=x>-1?x:this.value.length}else{if(x>this.selectionStart){this.s1=x=this.selectionStart;var w=v+(this.value.substr(x,this.value.length).match(/\d+/g)||[]).join("")+"_";for(var r=0;r<w.length-1;r++){x=this.value.indexOf(w.charAt(r+1),x);if(x>-1){this.value=this.value.substr(0,x)+w.charAt(r)+this.value.substr(x+1,this.value.length)}}this.selectionStart=this.e1=this.selectionEnd=++this.s1}}}}this.dispatchEvent(new Event("change"));return this.selectionStart};o.init=function(q){var t=this.value;var u=0;if(t){this.value="";var s=this.ui.attr("placeholder");for(var r in s){if(t.length>r&&s[r]==t[r]){this.value+=t[r];u++}else{if(/_/.test(s[r])){this.value+=(u<t.length)?t[u++]:"_"}}}u=this.value.indexOf("_")}else{if(!q){this.value=this.ui.attr("placeholder")}u=this.ui.attr("placeholder").indexOf("_")}if(q){this.value=this.value.replace(/\_/g,"")}return this.e1=this.selectionEnd=this.selectionStart=this.s1=(u>-1?u:this.value.length)}}o.init(true);o.ui.on("keydown",function(w){if(this.ui.attr("placeholder").length&&!this.value){this.value=this.ui.attr("placeholder");this.e1=this.selectionEnd=this.selectionStart=this.s1=0}else{this.s1=this.selectionStart;this.e1=this.selectionEnd}var A=w.charCode||w.keyCode||0;if([13,27,82].indexOf(A)!=-1){return true}var z=((A>=96&&A<=105))?(A-96).toString():String.fromCharCode(A);switch(A){case 8:if(selected){var y=this.value.indexOf(selected);this.value=this.value.substr(0,y)+this.ui.attr("placeholder").substr(y,selected.length)+this.value.substr(y+selected.length,this.value.length);var r=this.ui.attr("placeholder").substr(y,selected.length).indexOf("_");if(r>0){y+=r}this.selectionStart=this.e1=this.selectionEnd=this.s1=y}else{this.e1=this.s1=--this.selectionStart;--this.selectionEnd;while((this.s1>=0)&&!/\d/.test(this.value.charAt(this.s1))){this.s1=--this.selectionStart;--this.selectionEnd}if(this.s1>=0&&/\d/.test(this.value.charAt(this.s1))){this.value=this.value.substr(0,this.s1)+"_"+this.value.substr((this.s1+1),this.value.length)}else{this.s1=this.e1+1}this.selectionStart=this.selectionEnd=this.s1}this.dispatchEvent(new Event("change"));break;case 9:var q=null;var B=w.shiftKey?-1:1;var u=parseInt(this.ui.attr("tabindex"))+B;if(u>0){while(q=k.el('[tabindex="'+u+'"]')){if(q.ui.attr("disabled")){u+=B}else{q.ui.focus();break}}}if(u<=1&&B<0){return w.preventDefault()}w.stopPropagation();return;case 37:this.s1=--this.selectionStart;this.e1=--this.selectionEnd;break;case 39:this.s1=++this.selectionStart;break;case 46:var s=this.value.slice(this.selectionStart),v,x=this.ui.attr("placeholder").slice(this.selectionStart);if(selected){v=(this.value.substr(this.selectionStart+selected.length,this.value.length).match(/\d+/g)||[]).join("");this.e1=this.s1}else{v=(this.value.slice(this.selectionStart).match(/\d+/g)||[]).join("").slice(1)}for(var t in v){x=x.replace("_",v[t])}this.value=this.value.replace(s,x);this.selectionStart=this.s1;this.selectionEnd=this.e1;break;default:this.insertDigit(z,selected)}w.preventDefault();w.stopPropagation();return}).ui.on("focus",function(q){this.init(false);return}).ui.on("blur",function(q){if(this.value.match(/[\d]+/g)){this.value=!this.cleared?this.value:this.value.replace(/\_/g,"")}else{this.value=""}l(this);return}).ui.on("paste",function(r){var s=r.clipboardData.getData("Text").match(/\d+/g)?r.clipboardData.getData("Text").match(/\d+/g).join(""):"";for(var q in s){this.insertDigit(s[q],selected)}return})}return o};h.maskedigits=m}(window,window.ui));