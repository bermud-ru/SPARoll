 /**
 * @app $Id: jsroll.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA
 * @author Андрей Новиков andrey (at) novikov (dot) be
 * @status beta
 * @version 2.1.2b
 * @revision $Id: jsroll.min.js 0004 06/12/2022 15:49:51Z $
 */\n
(function(g,undefined){"use strict";var version="2.1.2b";g.HTTP_RESPONSE_CODE={0:"Request runtime error / address unreachable",10:"Application offline",100:"Continue",101:"Switching Protocol",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choice",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Switch Proxy",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"};g.WEBSOCKET_RESPONSE_CODE={1000:"normal closure",1001:"going away",1002:"protocol error",1003:"unknown data (opcode)",1004:"frame too large",1005:"rrmote host error",1006:"remote host error",1007:"utf8 expected",1008:"message violates server policy",1015:"CERT_AUTHORITY_INVALID"};var WebSocket="MozWebSocket" in g?g.MozWebSocket:("WebSocket" in g?g.WebSocket:function(url,opt){return console.warn("WebSocket not supported!")});var ws=function(url,opt){this.opt=Object.assign(this.opt,opt);this.opt.url=url};ws.prototype={opt:{protocol:[],binaryType:"blob",reconnect:false,reconnectTimeout:1000,error:null,open:null,message:null,close:null},socket:null,connected:false,__status:ws.CONNECTING,get readyState(){return this.__status=this.socket?this.socket.readyState:ws.CONNECTING},up:function(opt){if(!this.connected||(typeof opt==="object"&&opt.url&&opt.url!==this.opt.url)){var $=this;if(opt){$.opt.merge(opt)}$.socket=new WebSocket($.opt.url,$.opt.protocol);if($.socket){$.socket.binaryType=$.opt.binaryType;["onerror","onopen","onmessage","onclose"].forEach(function(x){$.socket[x]=function(e){return $[x](e)}})}}return this.socket},onerror:function(e){this.connected=false;if(typeof this.opt.error==="function"){this.opt.error.call(this,e)}else{console.error(e)}return this},onmessage:function(e){return(typeof this.opt.message==="function")?this.opt.message.call(this,e):console.log(e)},onopen:function(e){this.connected=new Date();return(typeof this.opt.open==="function")?this.opt.open.call(this,e):console.log(e)},onclose:function(e){var $=this;$.connected=false;if(e instanceof Event){if($.opt.reconnect){var fn=function(){return $.readyState===ws.CONNECTING?$.up():setTimeout(fn,$.opt.reconnectTimeout)};return setTimeout(fn,$.opt.reconnectTimeout)}}else{if($.socket){$.socket.close()}}return(typeof $.opt.close==="function")?$.opt.close.apply($,arguments):console.warn(e)},close:function(code,reason){if(this.connected&&code){return this.socket.close(code,reason)}},send:function(data){if(this.connected){this.socket.send(typeof data==="string"?data:JSON.stringify(data))}else{console.warn(this.url+" not connected!")}}};ws.CONNECTING=0;ws.OPEN=1;ws.CLOSING=2;ws.CLOSED=3;ws.RECONNECTING=4;g.ws=ws;g.eventCode=function(e){return e instanceof InputEvent?e.data:e instanceof Event?"key" in e?e.key:"keyCode" in e?e.keyCode:"keyIdentifier" in e?e.keyIdentifier:e.charCode:null};if(!("indexedDB" in g)){g.indexedDB=g.mozIndexedDB||g.webkitIndexedDB||g.msIndexedDB||g.shimIndexedDB||null}if(!("IDBTransaction" in g)){g.IDBTransaction=g.webkitIDBTransaction||g.msIDBTransaction||null}if(!("IDBKeyRange" in g)){g.IDBKeyRange=g.webkitIDBKeyRange||g.msIDBKeyRange||null}g.IDB=function(name,version,opt){var $=this;$.name=name;$.version=parseInt(version);$.models={};$.__active__=g.IDB.LAUNCH;Object.defineProperty($,"active",{__proto__:null,get:function active(){return $.IDBinstance?$.IDBinstance.readyState==="done"&&$.__active__===g.IDB.READY:false}});if(typeof opt==="object"){$.merge(opt)}return $};g.IDB.prototype={IDBOpenDBRequest:null,set db(event){this.IDBOpenDBRequest=event instanceof Event?ui.src(event):event},get db(){return this.IDBOpenDBRequest?this.IDBOpenDBRequest.result:null},get tx(){return this.IDBOpenDBRequest?this.IDBOpenDBRequest.transaction:null},connect:function(){var $=this,max=0,wait=function(){clearTimeout(wait.processs);if(!$.heirs&&max++<30){return wait.processs=setTimeout(wait,20)}var IDBinstance=g.indexedDB.open($.name,$.version,function(e){return $.buildSchemas(e)});IDBinstance.onupgradeneeded=function(e){return $.buildSchemas(e)};IDBinstance.onsuccess=function(e){return $.launchSchemas(e)};IDBinstance.onblocked=function(e){return $.blocked(e)};IDBinstance.onerror=function(e){return $.fail(e)};return $.IDBinstance=IDBinstance};return wait()},destroy:function(event){var $=this;$.IDBinstance=null;$.populate=true;var IDBinstance=$.IDBinstance=g.indexedDB.deleteDatabase($.name,$.version);IDBinstance.onsuccess=function(e){return $.launchSchemas(e)};IDBinstance.onerror=function(e){return $.fail(e)};IDBinstance.onblocked=function(e){return $.blocked(e)};IDBinstance.onupgradeneeded=function(e){return $.buildSchemas(e)}},buildSchemas:function(db){this.__active__|=g.IDB.BUILD;var $=this;$.db=db;obj2array(this.heirs).map(function(v,i,a){if(typeof v.schema==="function"){v.schema($.db,$.tx)}else{if(!$.db.objectStoreNames.contains(v.name)){if(v.primaryKey){$.db.createObjectStore(v.name,{keyPath:v.primaryKey,autoIncrement:!!v.autoIncrement})}else{$.db.createObjectStore(v.name)}}}});this.__active__^=g.IDB.BUILD;return $},launchSchemas:function(db){var $=this;$.db=db;obj2array(this.heirs).map(function(v,i,a){$.models[v.tables.join("-")]=v;if(typeof v.launch==="function"){v.launch($.db,$.tx)}});$.__active__^=g.IDB.LAUNCH;$.__pool__.forEach(function(v){v.fn.apply($,v.args)});$.__pool__=[];return $},__pool__:[],onready:function(fn,arg){if(g.IDB.READY!==this.__active__){return this.__pool__.push({fn:fn,arg:arg||[]})}return fn.apply(this,arg||[])},store:function(k,status,opt,row){var store,$=this,tx=k?$.owner.db.transaction($.tables,k):$.owner.db.transaction($.tables);tx.onerror=function(e){return opt&&typeof opt.cancel==="function"?opt.fail.call($,e,status,store):$.fail(e,status,store)};tx.onabort=function(e){if($.primaryKey&&row&&row.hasOwnProperty($.primaryKey)){console.error("PrimaryKey["+$.primaryKey+"] = "+row[$.primaryKey]+" in "+JSON.stringify($.tables)+" already has!")}else{return opt&&typeof opt.fail==="function"?opt.fail.call($,e,status,store):(opt.hasOwnProperty("fail")?opt.fail:$.fail(e,status,store))}};store=tx.objectStore(!k||k==="readwrite"?$.name:$.tables);if(typeof opt==="object"&&opt.index){if(store.indexNames.contains(opt.index)){store=store.index(opt.index)}else{console.warn("IDB."+JSON.stringify($.tables)+" index ["+opt.index+"] not exist!")}}store.oncomplete=function(event){return opt&&typeof opt.done==="function"?opt.done.call($,event,status,tx):(opt.hasOwnProperty("done")?opt.done:$.done(event,status,tx))};return store},close:function(){var $=this;try{$.db.close()}catch(e){$.fail(e)}return $},blocked:function(event){console.warn(event);return this},done:function(event,status,store){console.table(event instanceof Event?event.target.result:event.result);return store},cancel:function(event,status,store){console.warn(event);return store},fail:function(event,status,store){return console.error("Fail database "+this.name+" ver "+this.version+" :"+(event instanceof Event?event.target.error:JSON.stringify(event)))},status:function(methodID,status){return parseInt(methodID)*(status===undefined||!!status?1:-1)},data2row:function(data,flag){if(data&&typeof data==="object"){var p=function(o){var res={};for(var i in o){res[i]=QueryParam(o[i],typeof flag==="undefined"?QueryParam.STRNULL:flag)}return res};if(data instanceof Array){return data.map(function(v){return p(v)})}return p(data)}return data},bind:function(model){return Object.createChild(this,model)}};g.IDB.READY=0;g.IDB.INITIALIZING=1;g.IDB.BUILD=2;g.IDB.LAUNCH=4;g.IDB.PROCCESS=8;g.IDBFilter=function(limit,condition,args){this.limit=parseInt(limit);if(isNaN(this.limit)){console.log("IDBFilter limit not define!")}this.args=args||[];if(typeof condition==="function"){this.fn=condition}};g.IDBFilter.prototype={offset:0,limit:0,advanced:true,count:0,fn:null,page:[],chunk:[],run:false,populated:function(cursor){return cursor&&(this.limit===0||this.chunk.length<this.limit)},condition:function(cursor){this.offset++;if(!this.fn){this.chunk.push(cursor.value)}else{this.fn.apply(this,[cursor].merge(this.args))}},next:function(){this.run=true;if(arguments.length){this.args=obj2array(arguments)}this.chunk=[];this.page.push(this.offset);this.advanced=false;return this},reset:function(){this.run=true;if(arguments.length){this.args=obj2array(arguments)}this.chunk=[];this.page=[];this.advanced=true;this.offset=0;return this}};g.IDBFilter.LIMITLESS=0;g.IDBFilter.only=function(a){if(a instanceof Array){a.__proto__.method="only"}return a};g.IDBFilter.bound=function(a){if(a instanceof Array){a.__proto__.method="bound"}return a};var QueryParam=function(v,o){var opt=typeof o==="undefined"?QueryParam.NATIVE:Number(o);if(v instanceof HTMLElement){v=v.innerHTML}if(typeof v==="undefined"||v===null){return !(opt&QueryParam.NULLSTR)&&opt&QueryParam.QOUTED|QueryParam.STRNULL?(opt&QueryParam.NULLSQL?"NULL":null):""}else{if(typeof v==="object"){return opt&QueryParam.QOUTED?"'"+JSON.stringify(v)+"'":String(JSON.stringify(v))}else{if(typeof v==="string"&&v===""){return(opt&QueryParam.NULLSTR)?"":((opt&QueryParam.STRNULL)?(opt&QueryParam.NULLSQL?"NULL":null):"")}}}return/\d+/.test(v)&&String(Number(v))===String(v)?(opt&QueryParam.INTQOUTED?String(v):Number(v)):(opt&QueryParam.QOUTED?"'"+v+"'":String(v))};QueryParam.NATIVE=0;QueryParam.QOUTED=1;QueryParam.STRNULL=2;QueryParam.INTQOUTED=4;QueryParam.NULLSTR=8;QueryParam.NULLSQL=16;g.QueryParam=QueryParam;var paramsNative=function(v,i,a){return QueryParam(v,QueryParam.STRNULL|QueryParam.INTQOUTED)};var paramStatment=function(v,i,a){return v+" = ?"};var webSQL=function(opt){var $=this;if("openDatabase" in g){this.webSQLinstance=openDatabase(opt.name,opt.version||"1.0",opt.displayName||"DB instace dreated at "+(new Date()),opt.estimatedSize||200000);$.stmt("SELECT * FROM sqlite_master WHERE type='table' AND name NOT LIKE '__Webkit%';",[],function(tx,rs){var table,tablesNumber=rs.rows.length;for(var i=0;i<tablesNumber;i++){table=rs.rows.item(i);if(table.type==="table"){tx.executeSql("SELECT name, sql FROM sqlite_master WHERE name = ?",[table.name],function(t,r){$.tables[r.rows[0].name]={type:"table",DDL:r.rows[0].sql}})}else{$.tables[table.name]={type:table.type}}}})}else{this.webSQLinstance=null;throw"webSQL object not exist!"}if(opt&&typeof opt==="object"){$.merge(opt)}};webSQL.prototype={opt:QueryParam.STRNULL|QueryParam.INTQOUTED,changeVersion:function(currentVer,newVer,callback){try{return this.webSQLinstance.changeVersion(currentVer,newVer,callback)}catch(e){this.fail(null,e)}return false},tables:{},get info(){return this.stmt("SELECT * FROM sqlite_master WHERE type='table' AND name NOT LIKE '__Webkit%';",[],function(tx,rs){var table,tablesNumber=rs.rows.length;console.log("webSQL DB info:");for(var i=0;i<tablesNumber;i++){table=rs.rows.item(i);if(table.type==="table"){tx.executeSql("SELECT name, sql FROM sqlite_master WHERE name = ?",[table.name],function(t,r){console.info("- table: "+r.rows[0].name+", DDL: "+r.rows[0].sql)})}else{console.info("- type: "+table.type+", name: "+table.name)}}})},get version(){return this.webSQLinstance.version},turn:false,runnig:false,proc:function(tx,callback){this.runnig=tx;if(typeof callback==="function"){return callback.call(this,tx)}return tx},fail:function(tx,error,callback,sql,index,query){if(typeof callback==="function"){callback.call(this,tx,error,sql,index,query)}else{console.error("webSQL query ["+sql+"] error("+error.code+"): "+error.message)}return this.runnig=false},done:function(tx,result,callback,sql,index,query){if(typeof callback==="function"){callback.call(this,tx,result,sql,index,query)}else{console.warn("webSQL query ["+sql+"] resultSet: ");console.table(result)}return this.runnig=false},cancel:function(tx){},transaction:function(proc,fail){var $=this;var wait=function(){if(!$.turn||!$.runnig){if(wait.timer){clearTimeout(wait.timer)}return $.webSQLinstance.transaction(function(tx){return $.proc(tx,proc)},function(error){return $.fail($.running,error,fail)})}else{return wait.timer=setTimeout(wait,50)}};wait()},executeSql:function(tx,query,data,done,fail){var $=this,multiQuery=typeof query!=="string";try{return(multiQuery?query:[query]).forEach(function(sql,i,a){return tx.executeSql(sql,(multiQuery?data[i]:data),function(tx,result){return $.done(tx,result,done,sql,i,a)},function(tx,error){return $.fail(tx,error,fail,sql,i,a)})})}catch(e){return $.fail(tx,e,fail)}},stmt:function(query,data,done,fail,bulk){var $=this,d=typeof data==="undefined"?[]:(!!bulk?data:[data]);return $.transaction(function(tx){var i=0,count=d.length,ResultSet=[];var next=function(tx,rs){if(i<count){if(typeof rs!=="undefined"){ResultSet[i]=rs}$.executeSql(tx,query,d[i++],next,fail)}else{return typeof done==="function"?done.call($,tx,count>1?ResultSet:rs):null}};return next(tx)},fail)},grinder:function(o,fields,no_uppend){var res={},$=this;if(fields instanceof Array&&typeof o==="object"){fields.forEach(function(v){if(o.hasOwnProperty(v)||!!no_uppend){res[v]=o.hasOwnProperty(v)?QueryParam(o[v],$.opt):null}})}return res},filtration:function(query,params){var $=this,m=false;if(/:([^\s$%\),]*)/m.test(query)){if(!Object.keys(params).length){throw"webSQL::filter params not exist!"}while(m=/:([^\s$%\),]*)/gm.exec(query)){if(params.hasOwnProperty(m[1])){query=query.replace(m[0],QueryParam(params[m[1]],$.opt))}else{throw"webSQL::filter param ("+m[1]+") not exist!"}}}return query},filter:function(query,params,done,fail){return this.stmt(this.filtration(query,params),[],done,fail)},insert:function(table,params,done,fail,option){var opt=typeof option==="undefined"?webSQL.DEFAULT:Number(option);var fields=opt&webSQL.BULK?Object.keys(params[0]):Object.keys(params);var values=opt&webSQL.BULK?params.map(function(v,i,a){return Object.values(v).map(paramsNative)}):Object.values(params).map(paramsNative);var query=(opt&webSQL.UPSERT?"INSERT OR REPLACE INTO ":"INSERT INTO ")+table+" ("+(fields.join(","))+") VALUES ("+(Array(fields.length).fill("?").join(","))+");";return this.stmt(query,values,done,fail,opt&webSQL.BULK)},update:function(table,params,filter,done,fail){var keys=[],where=[],$=this;if(typeof filter==="string"){filter=this.filtration(filter,params)}else{if(typeof filter==="object"){if(filter instanceof Array){filter.forEach(function(v,i,a){keys.push(v);where.push(QueryParam(params[v],$.opt));delete params[v]})}else{keys=Object.keys(filter);where=Object.values(filter).map(paramsNative)}}}var fields=Object.keys(params);var values=Object.values(params).map(paramsNative);var query="UPDATE "+table+" SET "+(fields.map(paramStatment).join(","));if(keys.length){query+=" WHERE "+(keys.map(paramStatment).join(" AND "))}else{if(typeof filter==="string"){query+=" WHERE "+filter}}return this.stmt(query,values.concat(where),done,fail)}};webSQL.BULK=1;webSQL.UPSERT=2;webSQL.DEFAULT=0;g.webSQL=webSQL;var dbf=function(webSQLinstance,opt){if(!db){return console.warn("webSQL "+opt.naeme+" not exit!")}return{opt:{},webSQLinstance:webSQLinstance,cancel:function(){return false},done:function(tx,rs){if(typeof this.opt.done==="function"){this.opt.done.call(this,tx,rs)}if(typeof this.opt.after==="function"){return this.opt.after.call(this,tx,rs)}},fail:function(tx,er){if(typeof this.opt.fail==="function"){this.opt.fail.call(this,tx,er)}if(typeof this.opt.after==="function"){return this.opt.after.call(this,tx,er)}},filter:function(query,params,opt){if(typeof opt==="object"){this.opt.merge(opt)}if(typeof opt.before==="function"){opt.before.call(this)}this.webSQLinstance.filter(query,params,this.done.bind(this),this.fail.bind(this));return this}}};g.dbf=dbf;g.URL=g.URL||g.webkitURL;g.requestFileSystem=g.requestFileSystem||g.webkitRequestFileSystem;var is_url=/^(?:https?:\/\/)?(?:(?:[\w]+\.)(?:\.?[\w]{2,})+)?([\/\w]+)(\.[\w]+)|^(?:\/[\w]+){1,}/i;g.is_empty=function(v){return v===""||v===null||v===undefined||false};var re=function(s,flags){if(typeof s==="object"){return s}try{var p=/[?\/](.+)(\/([igum]*$))/.exec(s)||[];return new RegExp(p[1]||s,p[3]||flags||"")}catch(e){console.error("jsroll::re("+s+")",e);return undefined}};g.re=re;var str2json=function(s,def){if(typeof s==="object"){return s}try{var o=(typeof s==="string"?JSON.parse(s):s||(typeof def==="undefined"?null:def))}catch(e){o=typeof def==="undefined"?s:def}return o};g.str2json=str2json;var obj2array=function(a){return(a&&typeof a==="object")?Array.prototype.slice.call(a):[]};g.obj2array=obj2array;g.kv2array=function(o,glue){return o&&typeof o==="object"?Object.keys(o).map(function(v,i,a){return typeof glue==="function"?glue(v,o[v]):(v+(glue?glue:" ")+o[v])}):[]};g.coalesce=function(){for(var i in arguments){if(typeof arguments[i]!=="undefined"&&arguments[i]!==null&&arguments[i]!==""){return arguments[i]}}return undefined};var quoter=function(v,opt){var s=typeof v==="string"?v:(v?JSON.stringify(v):null);if(s){opt=typeof opt==="undefined"?quoter.CODE_QOUTAS:opt;if(opt&quoter.SLASHES_QOUTAS){s=s.replace(/\\"/g,'"').replace(/\\'/g,"'")}if(opt&quoter.SLASHES_CODE){s=s.replace(/\\"/g,"&quot;")}if(opt&quoter.CODE_QOUTAS){s=s.replace(/"/g,"&quot;").replace(/'/g,"&#39;")}if(opt&quoter.CODE_QOUTAS2){s=s.replace(/"/g,"&#39;").replace(/'/g,"&quot;")}if(opt&quoter.QOUTAS_CODE){s=s.replace(/&quot;/g,'"').replace(/&#39;/g,"'")}return s}return""};g.quoter=quoter;g.quoter.CODE_QOUTAS=1;g.quoter.CODE_QOUTAS2=2;g.quoter.SLASHES_QOUTAS=4;g.quoter.SLASHES_CODE=8;g.quoter.QOUTAS_CODE=16;g.bundler=function(){return obj2array(arguments).filter(function(v){return(typeof v!=="undefined"&&v!==null&&v!=="")})};g.data_maker=function(o,f){if(f instanceof Array){var r={};f.forEach(function(v){r[v]=o.hasOwnProperty(v)?o[v]:null});return r}return o};g.bitfields=function(status,d){var res=[],st=parseInt(status);if(!st||typeof d!=="object"||d===null){return res}for(var i=0;i<d.length;i++){if(st&Math.pow(2,i)){res.push(d[i])}}return res};g.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c==="x"?r:(r&3|8);return v.toString(16)})};g.crc32=function(str){var makeCRCHelper=g.makeCRCHelper||(g.makeCRCHelper=function(){var c;var makeCRCHelper=[];for(var n=0;n<256;n++){c=n;for(var k=0;k<8;k++){c=((c&1)?(3988292384^(c>>>1)):(c>>>1))}makeCRCHelper[n]=c}return makeCRCHelper});var crc=0^(-1);for(var i=0;i<str.length;i++){crc=(crc>>>8)^makeCRCHelper[(crc^str.charCodeAt(i))&255]}return(crc^(-1))>>>0};g.base64=function(s){return g.btoa(unescape(encodeURIComponent(s instanceof HTMLElement?s.innerHTML:s)))};JSON.serialize=function(o,opt,c){if(o){var cls,s;if(typeof o==="string"){s=g[o];cls=o+":"}else{s=o;if(c){cls=typeof c==="string"?c+":":(c.constructor.name!=="Object"?c.constructor.name+":":"")}else{cls=s.constructor.name!=="Object"?o.constructor.name+":":""}}var src=cls+JSON.stringify(s).replace(/(^"|"$)/g,"");return parseInt(opt)&&JSON.BASE64?base64(src):src}return null};JSON.OBJECT=1;JSON.BASE64=2;JSON.unserialize=function(s,opt,c){var src=parseInt(opt)&&JSON.BASE64?atob(s):s;var pair=src.match(/^(([a-zA-Z0-9_]+?):)*(.*)$/);var o=str2json(pair[3],null);if(!c){c=pair[2]}if(o&&c){return typeof c==="string"?Object(typeof g[c]==="function"?new g[c]:g[c],o):c.merge(o)}return o};g.mb_case_title=function(s){return s.length?s.replace(/(?:^\s*|\s+)(\S?)/g,function(a,b){return a.slice(0,-1)+b.toUpperCase()}):null};g.datetimer=function(dt,option){var opt=typeof option==="undefined"?datetimer.DATETIME:Number(option);if(!dt){return null}var d;if(typeof dt==="string"){if(/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(dt)){d=new Date(dt.split(".").reverse().join("-"))}else{d=new Date(dt.replace(/\s/,"T"))}}else{d=dt}if(opt&datetimer.COMPARE){return new Date(d.getFullYear(),d.getMonth(),d.getDate())}if(opt&datetimer.RAW){return[d.getFullYear(),d.getMonth(),d.getDate(),d.getHours(),d.getMinutes(),d.getSeconds()]}var day=("0"+d.getDate()).slice(-2);var month=("0"+(d.getMonth()+1)).slice(-2);var year=d.getFullYear();var date=opt&datetimer.DATE?day+"."+month+"."+year:"";var hours=("0"+d.getHours()).slice(-2);var minutes=("0"+d.getMinutes()).slice(-2);var time=opt&datetimer.TIME?hours+":"+minutes:"";var sec=("0"+d.getSeconds()).slice(-2);var second=opt&datetimer.SECOND?"."+sec:"";return bundler(date,time).join(" ")+second};datetimer.DATE=1;datetimer.TIME=2;datetimer.DATETIME=3;datetimer.SECOND=8;datetimer.RAW=16;datetimer.COMPARE=32;g.localISOString=function(dt,Z){var tzoffset=(new Date()).getTimezoneOffset()*60000;return(new Date(Date.now(dt)-tzoffset)).toISOString().slice(0,-1)+(Z||"Z")};g.utcISOString=function(dt,Z){return(new Date(dt||Date.now())).toISOString().slice(0,-1)+(Z||"Z")};g.importFromCSV=function(file,cb,d){var divider=re("/"+(d?d:importFromCSV.DIVIDER)+'(?=(?:(?:[^"]*"){2})*[^"]*$)/');function parseFile2Array(csv){var dataSet=[];csv.split(importFromCSV.LF).forEach(function(line){if(line.trim()){var tuple=[];line.split(divider).forEach(function(cell){tuple.push(quoter(cell.replace(/^\"(.+)\"$/,"$1"),quoter.CODE_QOUTAS))});dataSet.push(tuple)}});return dataSet}file.ui.on("change",function(e){var reader=new FileReader();reader.onload=function(e){return cb.call(this.file,parseFile2Array(g.ui.src(e).result))};obj2array(file.files).forEach(function(f){reader.file=f;reader.readAsText(f)})})};g.importFromCSV.EOL=/\n/;g.importFromCSV.CR=/\r/;g.importFromCSV.LF=/\r?\n|\r/;g.importFromCSV.DIVIDER=",";g.exportToCSV=function(filename,data,d){var divider=d?d:importFromCSV.DIVIDER;var src=re('/("|'+divider+"|\n)/","g");var offset=data.hasOwnProperty("rowNumber")?1:0;var processRow=function(row){var finalVal="";for(var j=offset,z=row.length;j<z;j++){var innerValue=row[j]?QueryParam(row[j],QueryParam.INTQOUTED):"";if(row[j] instanceof Date){innerValue=row[j].toLocaleString()}var result=innerValue.replace(/"/g,'""');if(result.search(src)>=0){result='"'+result+'"'}if(j-offset){finalVal+=divider}finalVal+=result}return finalVal+"\n"};var csvFile="";if(data instanceof Array){for(var i=0,l=data.length;i<l;i++){csvFile+=processRow(data[i])}}else{for(var x=0,y=data.rows.length;x<y;x++){csvFile+=processRow(data.rows[x].cells)}}g.dwnBlob(csvFile,filename,"text/csv;base64;")};g.exportHTML2Word=function(ctx,fileName){var header="<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>"+(fileName||"document.doc")+"</title></head><body>";var footer="</body></html>";var source=header+(ctx instanceof HTMLElement?ctx.innerHTML:ctx)+footer;g.dwnBlob(source,(fileName||"document.doc"),"application/vnd.ms-word;base64;")};g.exportHTML2Excel=function(ctx,fileName,worksheet){var template='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>';var c={worksheet:worksheet||"Worksheet",table:ctx instanceof HTMLElement?ctx.innerHTML:ctx};var f=function(s,c){return s.replace(/{(\w+)}/g,function(m,p){return c[p]})};g.dwnBlob(f(template,c),(fileName||"export.xls"),"application/vnd.ms-excel;base64;")};g.copy2prn=function(cntx,data){var print_layer=g.document.createElement("iframe");print_layer.name="print_layer";print_layer.src="printer";print_layer.style.display="none";g.document.body.appendChild(print_layer);var prn=cntx instanceof HTMLElement?cntx.innerHTML:tpl(cntx,data||{});var frameDoc=(print_layer.contentWindow)?print_layer.contentWindow:(print_layer.contentDocument.document)?print_layer.contentDocument.document:print_layer.contentDocument;frameDoc.document.open();frameDoc.document.write(prn);frameDoc.document.close();setTimeout(function(){g.frames.print_layer.focus();g.frames.print_layer.print();g.frames.print_layer.close();g.document.body.removeChild(print_layer)},1)};g.crypt=function(salt,text){var textToChars=function(text){return text.split("").map(function(c){return c.charCodeAt(0)})};var applySaltToChar=function(code){return textToChars(salt).reduce(function(a,b){return a^b},code)};var byteHex=function(n){return("00"+Number(n).toString(16)).substr(-3)};return text.split("").map(textToChars).map(applySaltToChar).map(byteHex).join("")};g.decrypt=function(salt,encoded){var textToChars=function(text){return text.split("").map(function(c){return c.charCodeAt(0)})};var applySaltToChar=function(code){return textToChars(salt).reduce(function(a,b){return a^b},code)};return encoded.match(/.{1,3}/g).map(function(hex){return parseInt(hex,16)}).map(applySaltToChar).map(function(charCode){return String.fromCharCode(charCode)}).join("")};Object.defineProperty(Object.prototype,"merge",{value:function(){var o=(typeof this==="object"?this:(typeof this==="function"?new this:{}));if(!arguments.length){return o}if(o instanceof Array){obj2array(arguments).forEach(function(v,k,a){if(v instanceof Array){if(v.length){for(var i=0,l=v.length;i<l;i++){o.push(v[i]?v[i]:null)}}}else{if(v){o.push(v)}}});return o}if(typeof this==="function"&&o&&o.__proto__.__proto__){o.__proto__.constructor=this}obj2array(arguments).forEach(function(v,k,a){var x=(typeof v==="object"?v:(typeof v==="function"?new v:undefined));if(x){if(typeof v==="function"&&o.__proto__){o.__proto__.constructor=v}if(!o.__proto__){o.prototype=Object.create(x.__proto__)}else{if(o.__proto__&&Object.getPrototypeOf(x)!==Object.prototype){o.merge(x.__proto__);o.__proto__.constructor=x.__proto__.constructor}}Object.defineProperties(o,Object.getOwnPropertyNames(x).reduce(function(d,key){if(o.hasOwnProperty(key)&&Object.getOwnPropertyDescriptor(o,key)["set"]){o[key]=x[key];d[key]=Object.getOwnPropertyDescriptor(o,key)}else{d[key]=Object.getOwnPropertyDescriptor(x,key)}return d},{}))}});return o},enumerable:false});Object.defineProperty(Object.prototype,"createChild",{value:function(){if(!arguments.length||typeof arguments[0]!=="object"){return null}var $=(typeof this==="object"?this:(typeof this==="function"?new this:{}));var owner=arguments[0];switch(typeof arguments[1]){case"function":var fn=arguments[1];$=new fn;if($.__proto__){$.__proto__=Object.merge($.__proto__,owner);$.__proto__.constructor=fn}else{$.prototype=Object.merge(fn.prototype,owner)}break;case"object":$=Object.merge(arguments[1]);case"undefined":default:if($.__proto__){$.__proto__=owner}else{$.prototype=owner}}$.owner=owner;if(owner.hasOwnProperty("heirs")){if(owner.heirs instanceof Array){owner.heirs.push($)}else{owner.heirs[$.hasOwnProperty("childIndex")?$.childIndex:Object.keys(owner.heirs).length]=$}}else{if($.hasOwnProperty("childIndex")){owner.heirs={};owner.heirs[$.childIndex]=$}else{owner.heirs=[];owner.heirs.push($)}}return $},enumerable:false});Object.defineProperty(String.prototype,"hash",{value:function(){var hash=0,chr;for(var i=0;i<this.length;i++){chr=this.charCodeAt(i);hash=((hash<<5)-hash)+chr;hash|=0}return hash}});g.bb=function(blobParts,option){var opt=Object.assign({type:"application/x-www-form-urlencoded"},option);var BlobBuilder=("MozBlobBuilder" in g?g.MozBlobBuilder:("WebKitBlobBuilder" in g?g.WebKitBlobBuilder:g.BlobBuilder));if(BlobBuilder){var bb=new BlobBuilder();bb.append(blobParts);return bb.getBlob(opt.type)}return new Blob([blobParts],opt)};g.dwnBlob=function(src,filename,type){var blob=g.bb(src,type);if(typeof g.navigator.msSaveBlob!=="undefined"){g.navigator.msSaveBlob(blob,filename)}else{var downloadUrl=g.URL.createObjectURL(blob);if(filename){var a=g.document.createElement("a");if(typeof a.download==="undefined"){g.open(downloadUrl)}else{a.href=downloadUrl;a.download=filename;g.document.body.appendChild(a);a.click();setTimeout(function(){g.document.body.removeChild(a)},100)}}else{g.open(downloadUrl,"_self")}setTimeout(function(){g.URL.revokeObjectURL(downloadUrl)},100)}return false};g.download=function(button,url,opt){return xhr(Object.assign({responseType:"arraybuffer",url:url,done:function(e,x){var res=x.hasOwnProperty("action-status")?str2json(decodeURIComponent(x["action-status"]),{result:"ok"}):{result:"ok"};if(res.result!=="ok"){if(button.disabled){setTimeout(function(){button.disabled=false;button.css.del("spinner")},1500)}console.log(url+" donwload - OK");return false}try{var filename=uuid();if(opt&&opt.hasOwnProperty("filename")){filename=decodeURIComponent(quoter(opt.filename,quoter.SLASHES_QOUTAS).replace(/['"]/g,""))}else{var disposition=this.getResponseHeader("Content-Disposition");if(disposition&&disposition.indexOf("attachment")!==-1){var filenameRegex=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;var matches=filenameRegex.exec(disposition);if(matches!=null&&matches[1]){filename=decodeURIComponent(quoter(matches[1],quoter.SLASHES_QOUTAS).replace(/['"]/g,""))}}}if(button.disabled){setTimeout(function(){button.disabled=false;button.css.del("spinner")},1500)}return g.dwnBlob(this.response,filename,this.getResponseHeader("Content-Type"))}catch(e){if(button.disabled){setTimeout(function(){button.disabled=false;button.css.del("spinner")},1500)}console.error("download Error "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},fail:opt&&opt.fail||function(e){if(button.disabled){setTimeout(function(){button.disabled=false;button.css.del("spinner")},1500)}console.error("download Error "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},opt))};g.upload=function(stream,url,opt){var file=stream.files[0];var done=opt.done;delete opt.done;var fail=opt.fail;delete opt.fail;var stop=opt.stop;delete opt.stop;var dir=opt.dir||null;delete opt.dir;if(!file){return console.warn("File not found!")}var slice=function(file,start,end,type){var slice=file.mozSlice?file.mozSlice:file.webkitSlice?file.webkitSlice:file.slice?file.slice:function(){};return slice.bind(file)(start,end)};var size=file.size,filename=file.name;var sliceSize=opt.sliceSize||1024;var start=opt.start||0,end;var data,piece,xhr;var loop=function(){end=start+sliceSize;data=new FormData();if(size-end<0){end=size;if(opt.extra){data.append("payload",typeof opt.extra==="string"?opt.extra:(opt.extra?JSON.stringify(opt.extra):null))}}piece=slice(file,start,end);data.append("dir",dir);data.append("filename",filename);data.append("size",size);data.append("start",start);data.append("end",end);data.append("file",piece);if(stop.call(this,xhr)){xhr=g.xhr(Object.assign({method:"post",rs:{"Content-type":"multipart/form-data",Hash:acl.user.hash},url:url,data:data,done:function(e,x){var res=str2json(this.responseText,{result:"error",message:this.status+": "+HTTP_RESPONSE_CODE[this.status]});if(res.result==="ok"){if(typeof opt.progress==="function"){opt.progress.call(res,(Math.floor(res.end/size*1000)/10))}if(res.end<size){start+=sliceSize;setTimeout(loop,1)}else{done.call(res)}}else{fail.call(res)}return false},fail:function(e,x){if(typeof opt.fail==="function"){opt.fail.call(x,e)}console.error("::upload Error "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},opt))}};if(size>0){setTimeout(loop,1)}};g.location.decoder=function(search,regex){var re=regex||/[?&]([^=#]+)=([^&#]*)/g,p={},m;try{while(m=re.exec((search||g.location.search))){if(m[1]&&m[2]){p[decodeURIComponent(m[1])]=QueryParam(decodeURIComponent(m[2]),QueryParam.STRNULL)}}}catch(e){return null}return p};g.location.encoder=function(params,divider){if(params&&typeof params==="object"){return String(Object.keys(params).map(function(e,i,a){return encodeURIComponent(e)+"="+encodeURIComponent(QueryParam(params[e],QueryParam.NULLSTR))}).join(divider||"&"))}return params};g.location.update=function(search,params){var u=[],h=[],url=g.location.search,kv=params||{};if(typeof search==="string"){url=search}else{kv=search}var p=g.location.decoder(url);for(var i in kv){p[decodeURIComponent(i)]=QueryParam(decodeURIComponent(kv[i]),QueryParam.STRNULL)}var res=[];for(var a in p){res.push(a+"="+QueryParam(p[a],QueryParam.NULLSTR))}if(res.length){var prefix=url+"?",sufix="";if(url.indexOf("?")>-1){h=url.split("?");if(h.length>1){prefix=h[0]+"?"}}if(url.indexOf("#")>-1){u=url.split("#");if(u.length>1){sufix="#"+u[1]}}return prefix+res.join("&")+sufix}return url};g.location.params=function(id,def){if(typeof id==="string"){return g.location.decoder()[id]||def||null}return g.location.decoder()};function urn(r){var isHistory=!!(history.pushState)?1:0;var root=r;return{root:root,rt:[],itv:0,base:isHistory?location.pathname+location.search:"",referrer:root,handled:{hendler:null,hash:(location.pathname+location.search).hash()},clr:function(path){return path.toString().replace(/\/$/,"").replace(/^\//,"")},fr:isHistory?function(){return this.root+this.clr(decodeURI(location.pathname+location.search)).replace(/\?(.*)$/,"")}:function(){var m=location.href.match(/#(.*)$/);return this.root+(m?this.clr(m[1]):"")},add:function(re,handler){if(typeof re==="function"){handler=re;re=""}this.rt.push({re:re,handler:handler});this.rt=this.rt.sort(function(a,b){if(a.re.toString().length<b.re.toString().length){return 1}if(a.re.toString().length>b.re.toString().length){return -1}return 0});return this},rm:function(handler){for(var i in this.rt){if(this.rt[i].handler===handler){this.rt.splice(i,1);break}}return this},chk:function(){for(var i in this.rt){if(this.fr().match(this.rt[i].re)){this.handled={handler:this.rt[i].handler,hash:(location.pathname+location.search).hash()};if(this.rt[i].handler){this.rt[i].handler(location.pathname,location.search,true)}else{console.warn("Handler not exist ["+this.fr()+"]")}return this}}return this},lsn:function(){var s=this,c=s.fr(),fn=function(){if(c!==s.fr()){c=s.fr();s.chk(c)}return s};clearInterval(s.itv);s.itv=setInterval(fn,30);return s},set:isHistory?function(path){this.referrer=location.pathname+location.search;history.pushState(null,null,this.root+this.clr(path||""));return this}:function(path){this.referrer=location.pathname+location.search;location.href=location.href.replace(/#(.*)$/,"")+"#"+(path||"");return this}}}g.urn=urn("/");g.func=function(str,context,args){if(typeof str!=="string"){return console.error("func src is't a string type!\n",str)}try{var s=str.replace(/\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/|\/\/[^\r\n]*/igm,"");switch(true){case /^\s*function.*[}|;]*$/im.test(s):var fn=new Function(args||[],"var f="+s+"; return f.apply(this, arguments)");return context?fn.bind(context):fn;default:return function(){return eval(quoter(s,quoter.QOUTAS_CODE))}.apply(context||g,args||[])}}catch(e){return console.error("func ",e.message+"\n",s)}};g.js=function(src,params){if(!src){return null}var opt=Object.assign({async:false,type:"text/javascript",container:g.document.body},params);var s=g.document.createElement("script");s.type=opt.type;s.async=opt.async;if(opt.hasOwnProperty("id")){s.id=opt.id}if(src.match(is_url)){s.src=src}else{s.text=src}if(typeof opt.onload==="function"){s.onload=onload}if(typeof opt.onreadystatechange==="function"){s.onreadystatechange=onreadystatechange}if(typeof opt.container.appendChild==="function"){opt.container.appendChild(s)}else{console.error("jsRoll::js() Не существущий контейнер",opt.container)}return s};var xmlHttpRequest=("XMLHttpRequest" in g?g.XMLHttpRequest:("ActiveXObject" in g?g.ActiveXObject("Microsoft.XMLHTTP"):g.XDomainRequest));g.xhr=function(params){if(!navigator.onLine&&params&&!!params.local){if(typeof params.cancel==="function"){params.cancel({srcElement:this,status:10})}if(typeof params.after==="function"){params.after({srcElement:this,status:10},g.xhr.CANCEL)}return null}var x=new xmlHttpRequest();Object.defineProperty(x,"responseJSON",{__proto__:null,get:function responseJSON(){return str2json(this.responseText,{result:"error",message:this.status+": "+HTTP_RESPONSE_CODE[parseInt(this.status)]})}});if(params&&params.hasOwnProperty("responseType")){x.responseType=params.responseType}var d={srcElement:x,withCredentials:true,async:true,username:null,password:null,method:"GET",url:g.location.pathname,timeout:10000,cache:false};var opt=Object.assign(d,params);var rs=Object.assign({"Xhr-Version":version,"Content-type":"application/x-www-form-urlencoded"},(params||{}).rs);if(rs["Content-type"]===false||rs["Content-type"].toLowerCase()==="multipart/form-data"){delete rs["Content-type"]}var cancel=function(e){x.abort();g.removeEventListener("offline",cancel);if((typeof opt.cancel==="function")){opt.cancel(e)}if(typeof opt.after==="function"){opt.after(e,g.xhr.CANCEL)}};var fail=function(e){x.abort();g.removeEventListener("offline",cancel);if(typeof opt.fail==="function"){opt.fail(e)}if(typeof opt.after==="function"){opt.after(e,g.xhr.FAIL)}};var done=function(e){g.removeEventListener("offline",cancel);if(typeof opt.done==="function"){opt.done(e)}if(typeof opt.after==="function"){opt.after(e,g.xhr.DONE)}};try{if(typeof opt.data==="object"){opt.data=g.location.encoder(opt.data)}if((["GET","DELETE"].indexOf(opt.method)>-1)&&opt.data){opt.url+=(opt.url.indexOf("?")>-1?"&":"?")+opt.data;opt.data=null}if((typeof opt.before==="function")?[undefined,true].indexOf(opt.before())>-1:true){x.open(opt.method.toUpperCase(),opt.url,opt.async,opt.username,opt.password);x.withCredentials=opt.withCredentials;if(x.withCredentials){x.setRequestHeader("cookies",document.cookie)}for(var m in rs){x.setRequestHeader(m,rs[m])}g.addEventListener("offline",cancel);x.timeout=opt.timeout;x.ontimeout=cancel;x.onerror=fail;x.onload=done;x.onreadystatechange=(typeof opt.process==="function")?opt.process:function(e){return(x.readyState===g.xhr.DONE&&x.status>=400)?fail(e):false};x.send(opt.data)}else{cancel({srcElement:x,status:400})}}catch(e){fail(e)}return x};g.xhr.UNSENT=0;g.xhr.OPENED=1;g.xhr.HEADERS_RECEIVED=2;g.xhr.LOADING=3;g.xhr.DONE=4;g.xhr.FAIL=5;g.xhr.CANCEL=6;g.tpl=function tpl(str,data,cb,opt){var ctx=this,args=arguments;var arg=args[1]||[],pig={before:null,after:null};var fn,$={src:null,context:ctx,attr:null,caching:false,str:str,data:arg,cb:cb,processing:false,timer:null,wait:function(after,args,index){var $=this,tpl=index&&$.tpl instanceof Array?$.tpl[index]:$.tpl;if($.processing){$.timer=setTimeout(function(){$.wait(after,args,index)},5);return $}else{if(typeof after=="function"){after.apply(tpl,args)}else{if(after&&(typeof(fn=func(after,tpl,args))==="function")){fn.apply($.tpl,args)}}}return $},response_header:null,__tpl__:undefined,get tpl(){if(this.__tpl__){this.__tpl__.owner=$}return this.__tpl__},set tpl(v){this.__tpl__=v},onTplError:function(type,id,str,args,e){var msg=e&&typeof е==="object"?e.message:String(e);return console.error("tpl type=["+type+"]",[id,str],args,msg+"\n")}};var compile=function(str){var f="$"+uuid().replace(/-/g,"");var source=str.replace(/\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/|\/\/[^\r\n]*|\<![\-\-\s\w\>\/]*\>/igm,"").replace(/\>\s+\</g,"><").trim(),tag=["{%","%}"];if(!source.match(/{%(.*?)%}/g)&&source.match(/<%(.*?)%>/g)){tag=["<%","%>"]}return source.length?new Function(f,"var p=[], print=function(){ p.push.apply(p,arguments); }; with("+f+"){p.push('"+source.replace(/[\r\t\n]/g," ").split(tag[0]).join("\t").replace(re("/((^|"+tag[1]+")[^\t]*)'/g"),"$1\r").replace(re("/\t=(.*?)"+tag[1]+"/g"),"',$1,'").split("\t").join("');").split(tag[1]).join("p.push('").split("\r").join("\\'")+"');} return p.join('');"):undefined},build=function(str,id,cache){var isId=typeof id!=="undefined",pattern=null,dom=null;try{if(pig.before&&(typeof(fn=func(pig.before,$))==="function")){fn.apply($,args)}if(opt&&typeof opt.before==="object"){arg.merge(opt.before)}else{if(opt&&typeof opt.before==="function"){opt.before($,args)}}if(cache){pattern=func(cache)}else{pattern=compile(str);if(isId&&$.caching){g.sessionStorage.setItem(id,pattern.toString())}}if(!pattern){return $.onTplError("tpl-pattern",id,str,args,"пустой шаблон")}var a,awaiting=function(){if($.processing){$.timer=setTimeout(awaiting,50);return}if(!(cb instanceof Array)){a=typeof arg==="function"?arg.apply($,args):arg;if(data!==false){$.html=pattern.call($,a)}}var after=opt&&typeof opt.after=="function"?opt.after:null;if(typeof cb==="function"){$.tpl=cb.call(dom=ui.dom($.html,"html/dom"),$)}else{if(cb instanceof HTMLElement&&($.tpl=cb)){$.tpl.innerHTML=$.html}else{if(cb instanceof Array){$.tpl=cb;$.tpl.forEach(function(v,i,t){a=typeof arg==="function"?arg.call($,v,i,t):arg;if(data!==false){v.innerHTML=pattern.call($,a)}if(pig.after&&(typeof(fn=func(pig.after,v))==="function")){$.wait(fn,a,i)}else{if(after){$.wait(after,a,i)}}});return $.tpl}}}if(pig.after&&(typeof(fn=func(pig.after,$.tpl,a))==="function")){$.wait(fn,a)}else{if(after){$.wait(after,a)}}return dom||$.html};return awaiting()}catch(e){return $.onTplError("tpl-build",id,str,args,e)}};try{var cache;switch(true){case str.match(is_url):var id="uri"+str.hash();$.caching=true;if(cache=g.sessionStorage.getItem(id)){return build(null,id,cache)}var o=opt||{};o.rs=Object.assign(opt.rs||{},{"Content-type":"text/x-template"});return $.src=g.xhr(Object.assign({owner:$,url:str,async:(typeof cb==="function"),done:function(e){return build(ui.src(e).responseText,id)},fail:function(e){return $.onTplError("tpl-xhr",id,str,args,e)}},o));case !/[^#*\w\-\.]/.test(str):$.caching=true;$.src=g.document.getElementById(str.replace(/^#/,""));pig.before=$.src&&$.src.getAttribute("before");pig.after=$.src&&$.src.getAttribute("after");if(cache=g.sessionStorage.getItem(str)){return build(null,str,cache)}if(!$.src){return $.onTplError("tpl #"+str+" not exist!")}return build($.src.innerHTML,str);default:return build(str)}}catch(e){return $.onTplError("tpl",id,str,args,e)}};var dom=function(){var p;try{if("DOMParser" in g){p=new DOMParser();return function(d,mime){try{return p.parseFromString(d,mime||"text/xml")}catch(e){return null}}}else{if("ActiveXObject" in g){p=new ActiveXObject("Microsoft.XMLDOM");p.async="false";return function(d,mime){try{p.instance.loadXML(d);return p}catch(e){return null}}}}return null}catch(e){return undefined}};g.dom=dom()}(window));var storage=function(){try{localStorage.setItem("test","1");localStorage.removeItem("test")}catch(a){return{p:[],setItem:function(b,c){this.p.push(b);this[b]=c},getItem:function(b){if(this.hasOwnProperty(b)){return this[b]}return null},removeItem:function(b){if(this.hasOwnProperty(b)){delete this.p[b];delete this[b]}},clear:function(){this.p.forEach(function(b){delete this[b]});this.p=[]}}}return localStorage};var TIMEOUT=5;var Initializer=function(a,b){this.target=b||app;this.eventType=a;this.setup=false;this.isLast=false;this.pool=[];this.add=function(){var c=this,d=uuid();c.setup=true;c.pool.push(d);return d};this.done=function(f,d){if(f){var c=this,e=c.pool.indexOf(f);if(d){c.isLast=true}if(e>-1){c.pool.splice(e,1)}if(c.isLast&&!c.pool.length){app.onready(function(g){g.target.dispatchEvent(new ce(g.eventType))},[c])}}}};var Application=function(a){var b=this;b.localStorage=storage();b.merge(str2json(b.localStorage.getItem("Application")));b.sessionStorage=sessionStorage;b.version=a||new Date();window.onresize=b.resize.bind(b);window.onbeforeunload=function(d){if(b.confirmReload){return b.reload(d)}};if(window.addEventListener){if("onpagehide" in window){this.persisted=true;window.addEventListener("pageshow",b.run.bind(b),false);window.addEventListener("pagehide",b.destroy.bind(b),false)}else{window.addEventListener("load",b.run.bind(b),false);window.addEventListener("unload",b.destroy.bind(b),false)}window.addEventListener("online",b.online.bind(b),false);window.addEventListener("offline",b.offline.bind(b),false);window.document.addEventListener("DOMContentLoaded",function(d){return b.__ready__=true},false);window.addEventListener("popstate",function(d){var e=(location.pathname+location.search).hash();if(e!==urn.handled.hash){urn.handled.hash=e;if(typeof urn.handled.handler==="function"){urn.handled.handler.call(b,location.pathname,location.search,false)}}return false},false);this.events={};var c=new EventTarget();this.addEventListener=c.addEventListener.bind(c);this.removeEventListener=c.removeEventListener.bind(c);this.dispatchEvent=function(f){if(this.events.hasOwnProperty(f.type)){var d=this;this.events[f.type].forEach(function(g,e){if(g.parentNode){g.dispatchEvent(f)}else{d.events[f.type].splice(e,1)}})}else{c.dispatchEvent(f)}};this.eventListener=function(g,h,f,e){var i=this,d=g instanceof Array?g:[g];if(this.events.hasOwnProperty(h)){d.forEach(function(j){if((i.events[h].indexOf(j))===-1){i.events[h].push(j)}})}else{this.events[h]=d}d.forEach(function(j){j.addEventListener(h,f,e)})}}else{window.onload=b.run.bind(b);window.onunload=b.destroy.bind(b);window.document.body.ononline=b.online.bind(b);window.document.body.onoffline=b.offline.bind(b);window.document.onreadystatechange=function(d){if(window.document.readyState==="complete"){return b.ready(d)}}}};Application.prototype={persisted:false,$version:null,get version(){return this.$version},set version(a){var b=this;if(b.$version!==a){b.$version=a;var c=function(){if(b.__ready__){if(c.timer){clearTimeout(c.timer)}b.__version_pool__.forEach(function(d){d.fn.apply(b,d.args)})}else{return c.timer=setTimeout(c,TIMEOUT)}};return c()}},__ready__:false,notsupport:null,url:null,socket:null,run:function(a){if(a.persisted){return}if(typeof window.ui==="undefined"){return this.notsupport?window.location.href=this.notsupport:alert("Application not supported!")}return navigator.onLine?this.online():this.offline()},online:function(a){return console.log("app online "+datetimer(new Date()))},offline:function(a){return console.warn("app offline "+datetimer(new Date()))},__version_pool__:[],changeVersion:function(b,a){return this.__version_pool__.push({fn:b,args:a||[]})},readyFnpool:[],onready:function(b,a){if(typeof b!=="function"){return console.error("Fn not exist!")}var c=this,d=function(f,e){if(c.__ready__){c.readyFnpool.forEach(function(g){g.fn.apply(c,g.args)});clearTimeout(d.timer);d.timer=0;c.readyFnpool=[]}else{if(f){c.readyFnpool.push({fn:f,args:e})}d.timer=setTimeout(d,TIMEOUT)}};return c.__ready__?b.apply(c,a||[]):d(b,a||[])},resize:function(a){return false},serialize:function(c){var a={},b=this;Object.getOwnPropertyNames(b).forEach(function(d){if(d.startsWith("$")){a[d]=b[d]}});if(Object.keys(a).length===0){this.localStorage.removeItem("Application")}else{this.localStorage.setItem("Application",JSON.stringify(a))}},confirmReload:false,reload:function(a){if(a||(a=window.event)){a.cancelBubble=true;a.returnValue=this.confirmReload;if(a.stopPropagation){a.stopPropagation();a.preventDefault()}return false}return this.confirmReload},__destroyers__:[],ondestroy:function(b,a){if(typeof b==="function"){this.__destroyers__.push({fn:b,arg:a||[]})}},destroy:function(f){var d=this;d.serialize();d.__destroyers__.forEach(function(e){e.fn.apply(d,e.args)});if(!navigator.sendBeacon||!navigator.onLine){return}var b="/logout";var c="state="+event.type+"&location="+location.href;var a=navigator.sendBeacon(b,c);console.log("; data = ",c,"; status = ",a)},setCookie:function(d,e,g,f){if(typeof d!=="string"){return}var a="";if(g){var c=new Date();c.setTime(c.getTime()+(g*24*60*60*1000));a="; expires="+c.toUTCString()}var b=e?base64((typeof e==="string"?e:JSON.stringify(e).replace(/(^"|"$)/g,""))):"";document.cookie=d+"="+b+a+";path="+(f||"/")+";SameSite=Lax"},getCookie:function(g){if(typeof g!=="string"){return}var k=g+"=";var f=document.cookie.split(";");for(var h=0;h<f.length;h++){var m=f[h],d=m.length;while(m.charAt(0)===" "){m=m.substring(1,d)}if(m.indexOf(k)===0){var b=atob(m.substring(k.length,d));try{return JSON.parse(b)}catch(j){return b}}}return null},clearCookie:function(a){if(typeof a==="string"){document.cookie=a+"=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;SameSite=Lax"}}};(function(g,undefined){"use strict";var css=function(instance){this.instance=this.el(instance).instance;return this};css.prototype={el:function(i){this.instance=typeof i==="string"?g.document.querySelector(i):i;return this},style:function(k,v){this.instance.style[k]=v;return this},has:function(c){var cls=this.instance.className;if(typeof c!=="string"&&cls){return null}var result=[];c.split(" +").forEach(function(e,i,a){if(cls.match(re("/(?:^|\\s)"+e+"(?!\\S)/"))){result.push(e)}});return result.length?result:null},replace:function(r,n,f){this.instance.className=this.instance.className.replace(r,n,f);return this},add:function(c){var a=(typeof c==="string")?c.split(/(\s+|,)/):c,$=this;a.forEach(function(v,i,a){if($.instance&&!$.has(v)){$.instance.className+=" "+v}});return this},del:function(c){var h=this.instance;if(typeof c==="string"||c instanceof Array){var a=typeof c==="string"?c.split(/(\s+|,)/):c;a.forEach(function(v,i,a){h.className=h.className.replace(re("/(?:^|\\s)"+v+"(?!\\S)/"),"").replace(/\s+/," ").trim()})}else{if(typeof c==="object"){h.className=h.className.replace(c,"").replace(/\s+/," ").trim()}}return this},tgl:function(c){if(this.instance){if(!this.has(c)){this.instance.className+=" "+c}else{this.instance.className=this.instance.className.replace(re("/(?:^|\\s)"+c+"(?!\\S)/"),"").trim()}}return this}};g.css=new css(g);Object.defineProperty(g,"selected",{get:function selected(){return g.getSelection?g.getSelection().toString():g.document.selection.createRange().text}});g.emptySelection=function(){if(g.getSelection){if(g.getSelection().empty){g.getSelection().empty()}else{if(g.getSelection().removeAllRanges){g.getSelection().removeAllRanges()}}}else{if(document.selection){g.selection.empty()}}};var CustomEvent=("CustomEvent" in g?g.CustomEvent:(function(){function CustomEvent(e,params){var opt=Object.assign({bubbles:false,cancelable:false,detail:undefined},params);var event=g.document.createEvent(e);event.initCustomEvent(event,opt.bubbles,opt.cancelable,opt.detail);return event}CustomEvent.prototype=g.Event.prototype;return CustomEvent})());g.ce=CustomEvent;Element.matches=Element.matches||Element.matchesSelector||Element.webkitMatchesSelector||Element.msMatchesSelector||function(selector){var node=this,nodes=(node.parentNode||node.document).querySelectorAll(selector),i=-1;while(nodes[++i]&&nodes[i]!==node){}return !!nodes[i]};var he=function(){clearTimeout(he.timer);he.timer=0};var dbltap=function(el,e,fn,i,args){if(!he.timer||he.element!==el){he.timer=setTimeout(he,g.ui.DOUBLE_TIMEOUT);return he.element=el}else{clearTimeout(he.timer);he.timer=0;he.element=null;return fn.apply(i,argX(args,e))}};var ui=function(instance){if(instance.parentElement){this.wrap(instance.parentElement)}this.instance=instance||g};var argX=function(args,e){if(args&&args.length){if(args[0] instanceof Event){return args}args.unshift(e);return args}return[e]};ui.prototype={wrap:function(i,v){if(i&&!i.hasOwnProperty("ui")){Object.defineProperty(i,"ui",{value:new ui(i),writable:false,configurable:false});Object.defineProperty(i,"css",{value:new css(i),writable:false,configurable:false});if(typeof v==="string"){g[v]=i}}return i},el:function(s,fn,args){var el=null;if(typeof s==="string"){if(!s.match(/^#*/)){el=g.document.getElementById(s.replace(/^#/,""))}else{el=this.instance.querySelector(s)}}else{if(s instanceof Element){el=s}}if(el){this.wrap(el);if(typeof fn==="function"){fn.apply(el,args||[])}}return el},els:function(s,fn,args){var r=new Array(0),$=this;if(typeof s==="string"||s instanceof Array){var c=typeof s==="string"?s.split(/\s*,\s*/):s;c.forEach((function(x){r.push.apply(r,obj2array($.instance.querySelectorAll(x),[]).map(function(e,i,a){if(e instanceof Element){$.wrap(e);if(typeof fn=="function"){fn.apply(e,args?args.push(i,a)&&args:[i,a])}return e}}))}).bind($))}return $.wrap(r)},attr:function(a,v){if(a===undefined){var r={},attributes=this.instance.attributes,len=attributes.length;for(var i=0;i<len;i++){r[attributes[i].nodeName]=QueryParam(attributes[i].nodeValue,QueryParam.STRNULL)}return r}else{if(a instanceof HTMLElement&&v===undefined){var m=this.instance instanceof Array?this.instance:[this.instance];var atts=a.attributes,l=atts.length;m.forEach(function(v,i,z){for(var y=0;y<l;y++){v.setAttribute(atts[y].nodeName,atts[y].nodeValue)}})}else{if(typeof a==="object"&&v===undefined){for(var z in a){if(z&&!/^\d+$/.test(z)){this.instance.setAttribute(z,a[z])}}return this}else{if(typeof a==="string"&&v===undefined){var mask=a.indexOf("*")!==-1?re("/"+a.split("*")[0]+"/i"):null;if(mask){var data={};obj2array(this.instance.attributes).forEach(function(e,i,a){var name=e.nodeName.toString();if(mask.test(name)&&(name=name.replace(mask,""))){data[name]=str2json(e.value,QueryParam(e.value,QueryParam.STRNULL))}});return data}else{return str2json(this.instance.getAttribute(a),QueryParam(this.instance.getAttribute(a),QueryParam.STRNULL))}}else{if(typeof a==="string"){if(v===null){this.instance.removeAttribute(a)}else{if(typeof v==="object"){this.instance.setAttribute(a,JSON.stringify(v))}else{this.instance.setAttribute(a,v)}}}}}}}return this},tpl:function(str,data,cb,opt){var a=this.instance instanceof Array?this.instance:[this.instance];a.forEach(function(v,i,z){v.ui.inner=tpl(str,(typeof data==="function"?data.call(this,v,i,z):data),cb,opt)});return this.instance},merge:function(){var args=arguments,a=this.instance instanceof Array?this.instance:[this.instance];a.forEach(function(i){merge.apply(i,args)});return this.instance},src:function(e,def){var el=e?(e.target||e.srcElement||e):def;if(el instanceof HTMLElement){return this.wrap(el)}return el},de:function(event,opt){this.instance.dispatchEvent(new CustomEvent(event,opt||{}))},on:function(event,fn,args,opt){var a=this.instance instanceof Array?this.instance:[this.instance];event.split(/\s*,\s*/).forEach(function(e){var tags=e.split("|"),event=tags.pop();a.forEach(function(i){if(!tags.length||i.matches(tags[0])){switch(event){case"dbltap":i.addEventListener("touchend",function(e){return dbltap(g.ui.src(e),e,fn,i,args)},opt?opt:false);break;default:i.addEventListener(event,function(e){return fn.apply(i,argX(args,e))},opt?opt:false)}}})});return this.instance},dg:function(s,event,fn,args,opt){var a=this.instance instanceof Array?this.instance:[this.instance];event.split(/\s*,\s*/).forEach(function(p){var tags=p.split("|"),event=tags.pop();a.forEach(function(root){switch(event){case"dbltap":root.addEventListener("touchend",function(e){var $=this,found=false,el=g.ui.src(e);while(el&&el!==$&&!(found=el.matches(s))){el=el.parentElement}if(found&&(!tags.length||el.matches(tags[0]))){e.rootElement=root;return dbltap(el,e,fn,el,args)}return found});break;default:root.addEventListener(event,function(e){var $=this,found=false,el=g.ui.src(e);while(el&&el!==$&&!(found=el.ui.matches(s))){el=el.parentElement}if(found&&(!tags.length||el.matches(tags[0]))){e.rootElement=root;return fn.apply(el,argX(args,e))}return found},opt?opt:false)}})});return this.instance},off:function(event,fn,opt){var a=this.instance instanceof Array?this.instance:[this.instance];event.split(/\s*,\s*/).forEach(function(e){var tags=e.split("|"),event=tags.pop();a.forEach(function(i){if(!tags.length||i.matches(tags[0])){i.removeEventListener(event,fn,opt?opt:false)}})});return this.instance},matches:function(s){var a=this.instance instanceof Array?this.instance:[this.instance];var rules=typeof s==="string"?s.split(/\s*,\s*/):[s];var res=a.filter(function(el){return rules.filter(function(r){return el.matches(r)}).length});return res.length>0?res:false},dom:function(d,mime){if(!d||typeof d!=="string"){return null}var nodes=mime==="html/dom"?g.ui.wrap(dom(d,"text/html")).ui.el("body"):dom(d,mime);return this.wrap(nodes.childNodes.length>1?nodes.childNodes:nodes.childNodes[0])},set inner(s){var a=this.instance instanceof Array?this.instance:[this.instance];a.forEach(function(el,i){var cntx=s instanceof Array?(s[i]||s[0]):s;if(cntx instanceof HTMLElement){el.innerHTML="";el.appendChild(cntx)}else{el.innerHTML=cntx}})},up:function(d,mime){var nodes=dom(d,mime).childNodes,el=this.instance===g.document?ui.el("body"):this.instance;for(var i=0,l=nodes.length;i<l;i++){el.appendChild(nodes[i])}return el},rm:function(s){if(typeof s==="string"){this.els(s).forEach(function(el){el.parentNode.removeChild(el)})}else{var a=this.instance instanceof Array?this.instance:[this.instance];a.forEach(function(el){el.remove()})}return this.instance},get active(){return(this.instance instanceof Element&&(this.instance===g.document.activeElement))},focus:function(s){var el=this.instance;if(s){el=(typeof s==="string"?this.el(s):s)}setTimeout(function(e){return el.focus()},1);return el}};g.ui=new ui(document);g.ui.DOUBLE_TIMEOUT=300;var InputHTMLElementValue=function(el,def){var v=null;if(el instanceof Element){switch((el.getAttribute("type")||"text").toLowerCase()){case"checkbox":case"radio":var on=el.value.indexOf("on")>-1;v=el.checked?(on?1:el.value):(on?0:"");break;default:var attr;if(attr=el.getAttribute("@")){var o=function(g,group){return eval(quoter(attr,quoter.QOUTAS_CODE))}.call(el,g,el.group);v=o&&o.hasOwnProperty("value")?o.value:null;break}else{v=el.value||def}}}return QueryParam(v,QueryParam.NULLSTR)};g.InputHTMLElementValue=InputHTMLElementValue;var getElementsValues=function(elements,opt){var empty=QueryParam(null,opt||QueryParam.NULLSTR),data={},next=function(keys,d,f,el){if(d===undefined){d=[]}if(!keys||!keys.length){var g=["checkbox","radio"].indexOf((el.getAttribute("type")||"text").toLowerCase())>-1;if(f){if(d[f]===undefined||(g&&d[f]===empty)){d[f]=InputHTMLElementValue(el)}else{if(!g||el.checked){if(!!el.getAttribute("pack")&&String(Number(el.value))===String(el.value)){d[f]=Number(d[f])|Number(el.value)}else{if(!(d[f] instanceof Array)){d[f]=[d[f]]}d[f].push(InputHTMLElementValue(el))}}}}if(d[f]===undefined&&g&&!el.checked){d[f]=empty}return d}var key=keys.shift().replace(/^\[+|\]+$/g,"");if(f){if(d[f]===undefined){d[f]=key?{}:[]}return next(keys,d[f],key,el)}return next(keys,d,key,el)};if(elements.length){obj2array(elements).map(function(v){var field=null;if((v.getAttribute("type")||"text")!=="button"&&(field=v.name.match(/^\w+/g))){if(!data.hasOwnProperty(field)){data[field[0]]=undefined}return next(v.name.match(/(\[\w+\]?)/g),data,field[0],v)}return undefined})}return data};var setValueInputHTMLElement=function(el,value){switch((el.getAttribute("type")||"text").toLowerCase()){case"checkbox":case"radio":if(!!el.getAttribute("pack")&&String(Number(el.value))===String(el.value)){el.checked=(Number(value)&Number(el.value))===Number(el.value)}else{el.checked=el.value==="on"?!!value:((value instanceof Array)?value.indexOf(QueryParam(el.value))>-1:String(el.value)===String(value))}break;case"number":el.value=Number(value);break;case"hidden":var attr;try{if(attr=el.getAttribute("@")){var o=function(g,group){return eval(quoter(attr,quoter.QOUTAS_CODE))}.call(el,g,el.group);if(o&&o.hasOwnProperty("value")){o.value=el;break}}}catch(e){console.warn(e)}case"text":case"textarea":case"password":case"date":case"time":case"datetime-local":case"month":case"week":case"color":case"range":case"search":case"email":case"tel":case"url":default:if(!(el.value=QueryParam(value,QueryParam.NULLSTR))&&el.tagName==="SELECT"){el.selectedIndex=0}}};var setInputHTMLElementFromObject=function(el,v,required,alias){if(el&&el.tagName){var old=el.value;el.value=null;if(!(this instanceof HTMLElement)){el.required=!!required}if(typeof v==="object"&&v&&v.hasOwnProperty(alias||el.name)){el.value=v[alias||el.name]}else{el.value=typeof v==="undefined"?null:v}if(old!==el.value){el.dispatchEvent(new Event("change",{bubbles:true,cancelable:true,composed:true}))}var status=el.required?input_validator(el):!!el.value;if(this instanceof HTMLElement){if(!!required&&!status){this.status="error"}else{if(this.value){this.status="success"}}return this.status}return status}return"none"};g.setInputHTMLElementFromObject=setInputHTMLElementFromObject;var crud=function(api,meta){this.index=null;this.meta=meta;this.api=api;return this};crud.prototype.__data__=[];crud.prototype.clone=function(o){var $=this,c;if(null==o||"object"!=typeof o){return o}else{if(o instanceof Array){c=[];for(var i=0,len=o.length;i<len;i++){c[i]=$.clone(o[i])}return c}else{if(o instanceof Object){c={};for(var a in o){if(o.hasOwnProperty(a)){c[a]=$.clone(o[a])}}return c}}}};crud.prototype.item=function(idx){return this.__data__[idx]||this.clone(this.meta)};Object.defineProperty(crud.prototype,"data",{set:function(data){var $=this;if(data instanceof Array){$.__data__=data.map(function(v){return Object.merge($.meta,v)});$.index=0}else{$.__data__=[]}},get:function(){return this.__data__},enumerable:true,configurable:true});["post","put","get","del"].map(function(v){crud.prototype[v]=function(data,opt){var o=Object.merge(opt,{data:data_maker(data||Object.create(this.meta),opt.fields)});o.method={post:"POST",put:"PUT",get:"GET",del:"DELETE"}[v];return typeof this.api==="function"?this.api(o):this.api[v](o)}});g.crud=crud;var dataObject=function(){return function(o){var index=is_empty(o.index)||parseInt(o.index);var pk=o.primaryKey?o.primaryKey:null;var rows=o.crud;var fn,worker=function(row){switch(opt.method.toLowerCase()){case"del":rows.splice(index,1);break;case"post":if(pk){row[pk]=Math.max.apply(Math,rows.map(function(r){return r[pk]}))+1}rows.push(row);break;case"put":rows[index].merge(row);break;case"get":default:}if(typeof opt.done==="function"){opt.done(index!==null?rows[index]:rows)}return worker.done=true};var opt=Object.assign({srcElement:worker,method:"get",index:index,rows:rows,timeout:1000},o);worker.timeout=function(){var res=((Date.now()-worker.start)<opt.timeout);if(!res){clearTimeout(worker.instance);if(typeof opt.cansel==="function"){opt.cansel()}else{console.warn("Worker timeout")}}return res};worker.start=Date.now();worker.done=false;if((typeof opt.before==="function")?[undefined,true].indexOf(opt.before())>-1:true){(fn=function(){if(worker.timeout()){worker.instance=setTimeout(function(){worker(o.data);if(!worker.done){return fn()}if(typeof opt.after=="function"){opt.after()}return false},5)}})()}return worker}};g.dataObject=dataObject;g.group_xhr_opt={method:"post",url:location.pathname,before:function(e){return true},after:function(e){return false},done:function(e){var res=g.ui.src(e).responseJSON;if(res.result==="error"){console.warn(res.message)}else{console.log("stored success!")}return false},fail:function(e){return console.error(g.ui.src(e).responseJSON.message)},close:function(){return this.hXHR&&this.hXHR.readyState<xhr.DONE?this.hXHR.abort():false},hXHR:null,crud:function(p){return this.hXHR=xhr(p)}};var group=function(els,opt){var $=this,fields_set=true;$.opt=Object.merge({event:null,srcElement:this,method:null,done:null,fail:null,keyup:null,submit:null,crud:null},opt);$.__elements=typeof els==="string"?ui.els(els):els;$.form={};if($.__elements instanceof HTMLFormElement){$.form=$.__elements;fields_set=false;Object.defineProperty($.opt,"method",{enumerable:true,configurable:true,get:function method(){return $.form.getAttribute("method")||"get"}});$.opt.url=$.form.getAttribute("action")||$.opt.url;$.form.addEventListener("submit",$.onsubmit.bind($),true);$.__elements=g.ui.wrap(obj2array($.form.elements).map(function(el){return g.ui.wrap(el)}))}$.__elements.forEach(function(v){v.group=$;if(fields_set){$.form[v.name]=v}});if($.opt.submit){var submit=$.opt.submit instanceof Array?$.opt.submit:[$.opt.submit];submit.forEach(function(v){if(v instanceof Element){v.ui.on("click",$.onsubmit.bind($))}})}$.hashing();if($.opt.change){var fieldset=$.querySelector("fieldset");if(fieldset){fieldset.ui.on("change",$.opt.change.bind($))}else{$.elements.ui.on("change",$.opt.change.bind($))}}};group.prototype={form:null,__elements:[],get elements(){return this.__elements},get length(){return this.elements.length},byId:function(n){if(typeof n==="undefined"){return this.elements}var r=[];for(var i=0,l=this.length;i<l;i++){if(this.elements[i].getAttribute("name")===n||this.elements[i].getAttribute("id")===n){r.push(this.elements[i])}}return r.length===0?null:(r.length===1?r[0]:r)},querySelector:function(s){if(typeof s==="undefined"){return this.elements}var r=[];for(var i=0,l=this.length;i<l;i++){if(this.elements[i].matches(s)){r.push(this.elements[i])}}return r.length===0?null:(r.length===1?r[0]:g.ui.wrap(r))},onsubmit:function(e){e.stopPropagation();this.opt.event=e;if(e instanceof MouseEvent||e instanceof KeyboardEvent&&(eventCode(e)===13||eventCode(e)==="Enter")){this.store(this.data)}return false},__changed:null,hashing:function(s){this.__changed=JSON.stringify(s?s:this.data).hash()},get isChanged(){return this.__changed!==JSON.stringify(this.data).hash()},__valid:[],set valid(res){this.__valid=[];if(res&&typeof res.message==="object"){for(var i=0,l=this.elements.length;i<l;i++){if(res.message[this.elements[i].name]){this.elements[i].status=res.result||"error";this.__valid.push(this.elements[i])}else{this.elements[i].status="none"}}}},get valid(){this.__valid=[];var $=this;this.elements.forEach(function(e,i,a){if(!input_validator(e)){$.__valid.push(e)}});return !this.__valid.length},reset:function(attr){if(this.form){this.form.reset()}this.forEach(this.__elements,function(el){if(["checkbox","radio"].indexOf((el.getAttribute("type")||"text").toLowerCase())>-1){el.checked=el.ui.attr(attr||"default")||false}else{switch(el.tagName){case"SELECT":setValueInputHTMLElement(this,el.ui.attr(attr||"default")||0);break;case"INPUT":case"TEXTAREA":default:setValueInputHTMLElement(this,el.ui.attr(attr||"default")||"")}}el.status="none"});return this},set data(d){if(d&&typeof d==="object"){for(var i=0,l=this.elements.length;i<l;i++){setValueInputHTMLElement(this.elements[i],(d.hasOwnProperty(this.elements[i].name))?d[this.elements[i].name]:null)}}},get data(){return getElementsValues(this.elements)},store:function(data){try{if(this.opt.crud){if(data&&this.opt.fields){data=data_maker(data,this.opt.fields)}if(typeof this.opt.crud==="function"){this.opt.crud(Object.assign(this.opt,{data:data}))}else{this.opt.crud[this.opt.method.toLocaleLowerCase()](this.opt,data)}return this}}catch(e){if(typeof this.opt.fail==="function"){this.opt.fail(e)}}if(typeof this.opt.after==="function"){this.opt.after.call(this)}return this}};g.group=group;g.isvalid=function(element){var res=true,validator=null,pattern;if(element.validity.typeMismatch){res=false}else{if((element.getAttribute("required")!==null)&&!element.value){res=false}else{if((element.getAttribute("required")===null)&&!element.value){res=true}else{if((pattern=element.getAttribute("pattern"))===null){res=true}else{if(!element.hasOwnProperty("checkPattern")){element.regex=re(pattern);Object.defineProperty(element,"checkPattern",{get:function checkPattern(){if(typeof this.regex==="object"){this.regex.lastIndex=0;return this.regex.test(this.value.trim())}else{return true}}})}res=element.checkPattern}}}}if(typeof(validator=element.getAttribute("validator")||element.validator)==="function"){res=validator.apply(element,[res])}else{if(element.hasAttribute("validator")){validator=func(element.getAttribute("validator"));res=validator.apply(element,[res])}}return res};g.UIElementDecorator=function(el){if(el instanceof Element&&!el.hasOwnProperty("status")&&!el.css.has("no-status")&&g.ui.wrap(el)){Object.defineProperty(el,"status",{set:function status(stat){this.parentElement.css.del("has-(danger|warn|success|spinner)");this.css.del("is-(valid|invalid|warn|spinner)");if(this.disabled){stat="none"}else{if(stat===undefined||stat===null){stat="warn"}}switch(stat){case"error":this._status="error";this.css.add("is-invalid");this.parentElement.css.add("has-danger");break;case"warn":this._status="warn";this.css.add("is-warn");this.parentElement.css.add("has-warn");break;case"success":case"ok":this._status="success";this.css.add("is-valid");this.parentElement.css.add("has-success");break;case"spinner":this._status="spinner";this.css.add("is-spinner");this.parentElement.css.add("has-spinner");break;case"none":default:this._status="none"}},get:function status(){return this._status}})}return el};g.input_validator=function(element,tags){if(element&&((tags||["INPUT","SELECT","TEXTAREA"]).indexOf(element.tagName)>-1)){var res=isvalid(element)&&(element.hasOwnProperty("couple")?isvalid(element.couple):true);if(element.type!=="hidden"){UIElementDecorator(element);if(res===false){element.status="error"}else{if(res===null||res===undefined){element.status="warn"}else{if(element.value&&element.value.length){element.status="success"}else{element.status="none"}}}}return res}return true};g.pattern_validator=function(element){if(!element){return console.error("can't pattern_validator on null!")}var o=this,els=typeof element==="string"?o.ui.els(element):(element instanceof Array?element:[element]);return els.forEach(function(el,i,a){if(el instanceof Element){UIElementDecorator(el).ui.on("input",function(e){return(["INPUT","TEXTAREA"].indexOf(this.tagName)>-1&&this.value.length)?input_validator(this):this.status="none"})}})};g.tabpanel=function(tabs,panels,fn,cb,active){var nav={tabs:tabs||[],panels:panels||[],current:0,show:function(index,e){if(typeof active==="function"){active.call(nav,index,e)}this.current=index;if(this.tab){this.tab.css.add("active");this.tab.ui.focus()}if(this.panel){this.panel.css.add(["show","active"])}return this},hide:function(e){if(this.tab){this.tab.css.del("active")}if(this.panel){this.panel.css.del(["show","active"])}return this},get panel(){return this.panels[this.current]},get tab(){return this.tabs[this.current]}};nav.tabs.map(function(v,i,a){v.tabIndex=i;v.ui.on("click",function(e){nav.hide(e).show(this.tabIndex,e)});return(typeof cb==="function")?cb.call(v,i,nav):v});return(typeof fn==="function")?fn(nav,tabs,panels):nav}}(window));(function(b,c,e){"use strict";if(typeof c==="undefined"){return false}b.paginator=function(i,g,f){var h=f?parseInt(f):10;if(i){this.ui.el(".paginator",function(j){tpl("paginator-box",{pages:Math.ceil(i.count/h),page:i.page,model:g},this)})}};var d=function(g,f){if(g&&g.tagName==="INPUT"){var h={owner:null,index:0,key:null,cache:{},opt:{},delta:250,timer:null,__xhr:null,get value(){return this.cache.hasOwnProperty(this.key)&&this.cache[this.key][this.index]?this.cache[this.key][this.index]:null},stoped:function(i){if(this.timer!==null){if(this.__xhr){this.__xhr.ontimeout()}if(this.timer){clearTimeout(this.timer);this.timer=null}}if(this.owner.pannel){this.owner.pannel.css.add("fade")}return false},delayed:function(){var k=this,i=k.owner.__key__;var j=function j(){if(k.key===i){if(k.owner.pannel){k.owner.pannel.css.add("fade")}k.xhr()}else{k.stoped();if(k.key!=="null"&&k.key!==i){k.key=i;k.timer=setTimeout(j.bind(k),k.delta)}}return false};k.key=i;if(!k.timer){k.stoped()}k.timer=setTimeout(j.bind(k),k.delta)},activeItem:function(j){var i=this.owner,k=this;if(j&&k.cache[j]){k.key=j}else{if(i.pannel){i.pannel.css.add("fade")}return false}k.index=-1;var l=k.cache[k.key]||[];if(i.pannel&&l.length){i.pannel.ui.el(".active",function(){this.css.del("active")});l.forEach(function(n,o,m){if((k.index<0)&&n[i.name]&&(n[i.name].trim().toLowerCase()===i.__key__)){k.index=o}});i.pannel.ui.el('[value="'+(k.index<0?0:k.index)+'"]',function(){this.css.add("active")})}else{if(i.pannel){i.pannel.css.add("fade")}}return false},tpl:function(k){var j=this,i=this.owner;j.index=k.length?0:-1;if(i.pannel){if(k.length){i.pannel.ui.tpl(j.opt.tpl,{up:true,data:k,field:i.name})}}else{tpl(this.opt.tpl,{data:k,field:i.name},function(l){i.parentElement.insertAdjacentHTML("beforeend",l.html);i.parentElement.css.add(j.opt.up?"dropup":"dropdown");i.pannel=i.parentElement.ui.el(".dropdown-menu.list");i.pannel.ui.dg("li","mousedown",function(m){i.value=this.innerHTML;i.setValue(j.cache[j.key][j.index=parseInt(this.value)]);i.ui.focus()})})}j.activeItem(j.key=i.__key__);return false},xhr:function(){var j=this,k=this.owner,r=k.__key__,n=j.opt.ignore?true:isvalid(k);if((!n&&r!=="null")||(!j.opt.getEmpty&&r==="null")){return this}var o=j.cache.hasOwnProperty(r);if(o){j.activeItem(r);j.show(j.cache[r]);if(j.index>-1){k.__value=e;j.valueChanger(j.value)}}else{var p=o?j.cache[r].length:0;var l=!((r==="null"&&!!j.opt.skip)||(j.opt.skip>r.length));var i=(r!==k.__value.trim().toLowerCase());if(n&&l&&i&&!p){var q=k.status,m={};if(j.opt.alias){m[j.opt.alias]=k.value}else{m[k.name]=k.value}k.status="spinner";j.__xhr=j.opt.dbf?j.opt.dbf.filter(j.opt.query,m,{before:function(){k.status="spinner"},after:function(){k.status=q},done:function(s,t){j.cache[r]=b.obj2array(t.rows).map(function(u){if(j.opt.alias){u[k.name]=u[j.opt.alias];delete u[j.opt.alias];return u}else{return u}});j.activeItem(r);j.show(j.cache[r]);return false},fail:function(s,t){k.status="error";j.opt.error(t.message,this);return false}}):xhr({url:location.update(k.ui.attr("url"),m),rs:j.opt.rs,before:function(){k.status="spinner"},after:function(){k.status=q},done:function(t){var s=c.src(t).responseJSON;switch(s.result){case"ok":case"success":j.cache[r]=(s.data||[]).map(function(u){if(j.opt.alias){u[k.name]=u[j.opt.alias];delete u[j.opt.alias];return u}else{return u}});j.activeItem(r);j.show(j.cache[r]);break;case"error":q="error";j.opt.error(s);break;case"warn":default:q="warn";j.opt.warn(s)}return this},fail:function(s){k.status="error";j.opt.error(s,this)}})}}return this},show:function(k){var i=this.owner,j=this;if(i.ui.active){if(k&&k.length){j.tpl(k);if(j.index!==-1){i.setValue(j.value)}if(i.pannel){i.pannel.css.del("fade")}}else{if(i.pannel){i.pannel.css.add("fade")}}}return false},onKeydown:function(m){var l=this,i=b.eventCode(m),j=l.typeahead,k=j.cache[j.key]||[];if(k.length&&l.pannel){switch(i){case"ArrowUp":case 38:if(j.index<0){j.index=0}if(l.pannel){l.pannel.css.del("fade")}if(j.index>0){j.index--}else{j.index=k.length-1}break;case"ArrowDown":case 40:if(j.index<0){j.index=0}if(l.pannel){l.pannel.css.del("fade")}if(j.index<k.length-1){j.index++}else{j.index=0}break;case"Enter":case 13:j.stoped();l.setValue(j.index>-1?j.value:j.cache[j.key][0]);if(l.value.length){l.setSelectionRange(l.value.length,l.value.length)}return false;case"Escape":case 27:j.stoped();return false;default:if(l.pannel){l.pannel.css.add("fade")}setTimeout(j.valueChanger.bind(j),5);return false}l.pannel.ui.el(".active",function(){this.css.del("active")});l.pannel.ui.el('[value="'+j.index+'"]',function(){this.css.add("active")});l.setValue(j.value);if(l.value.length){l.setSelectionRange(l.value.length,l.value.length)}return false}else{if(i==="Enter"||i===13){j.stoped();if(l.pannel){l.pannel.css.add("fade")}}}return false},onFocus:function(l){var k=this,j=k.typeahead,i=k.value.length;if(i){k.setSelectionRange(i,i)}if((!i&&j.opt.getEmpty)||(i&&this.status!=="success")){j.delayed();j.activeItem(j.key=k.__key__)}return false},onInput:function(j){var i=this.typeahead;i.delayed();i.key=this.__key__;i.valueChanger();return false},onBlur:function(j){var i=this.typeahead;i.stoped();input_validator(this);return false},valueChanger:function(m){var l=this,i=this.owner,j=this.owner.status,k="null";if(!m){if(i.__key__!=="null"){l.index=-1;var n=l.cache[l.key=i.__key__]||[];n.forEach(function(p,q,o){if((l.index<0)&&(p[i.name].trim().toLowerCase()===i.__key__)){l.index=q}});if(l.index>-1){m=l.value;k=l.value[i.name].trim().toLowerCase()||"null"}else{if(i.__value===i.value){return}}}else{m=null}}else{if(m[i.name]){k=m[i.name].trim().toLowerCase()||"null"}else{if(Object.keys(m).length===0){m=null}}}if(i.__key__==="null"||i.__value!==i.value||i.__key__!==k){if(typeof l.opt.fn==="function"){i.status=l.opt.fn.call(i,m)}else{if(l.validate){input_validator(i)}else{i.status=j}}if(m&&m[i.name]){i.__value=i.value=m[i.name]}i.dispatchEvent(new b.ce("change",{detail:m}))}}};if(typeof g.typeahead==="undefined"){if(!c.wrap(g)){console.error("Not have attrib url",g);return}g.typeahead=h;Object.defineProperty(g,"__key__",{get:function(){var i=this.value.trim().toLowerCase();return i.length?i:"null"},enumerable:false});g.__value=g.value;g.typeahead.opt=merge({alias:null,getEmpty:true,query:null,dbf:null,fn:null,wrapper:false,skip:0,ignore:false,rs:{},up:g.hasAttribute("dropup"),tpl:"typeahead-tpl",error:function(i){console.error(typeof i==="object"?i.message:i)},warn:function(i){console.warn(typeof i==="object"?i.message:i)}},f);g.setValue=function(j){var l=this.typeahead,m=this,k=j&&j.hasOwnProperty(this.name),i=this.value===this.__value?this.value.trim().length:0;if(i&&k&&m.__key__===j[m.name].trim().toLowerCase()){if(typeof l.opt.fn==="function"){m.status=l.opt.fn.call(m,j)}}else{l.valueChanger(k?j:((l.index>-1)?l.value:null))}return false};g.typeahead.owner=UIElementDecorator(g);g.ui.on("focus",h.onFocus).ui.on("input",h.onInput).ui.on("blur",h.onBlur).ui.on("keydown",h.onKeydown).ui.on("search",h.onInput);if(!g.ui.attr("tabindex")){g.ui.attr("tabindex","0")}}return g}};b.typeahead=d;var a=function(h,k,f){if(h.tagName==="INPUT"){var j=UIElementDecorator(h);j.cleared=f===e?true:!!f;if(k){j.maxLength=j.ui.attr("placeholder",k||"").attr("placeholder").length}if(!j.ui.attr("tabindex")){j.ui.attr("tabindex","0")}if(j&&!j.hasOwnProperty("insertDigit")){j.insertDigit=function(t,p){if(p){var s=this.value.indexOf(p);var n=/\d/.test(t)?1:0;var m=this.ui.attr("placeholder").substr(s,p.length).indexOf("_");if(m>0){s+=m}this.value=this.value.substr(0,s)+(/\d/.test(t)?t:"")+this.ui.attr("placeholder").substr(s+n,p.length-n)+this.value.substr(s+p.length,this.value.length);this.selectionStart=this.e1=this.selectionEnd=this.s1=s+1}else{if(/\d/.test(t)&&(this.value||this.ui.attr("placeholder")).indexOf("_")>-1){var u=this.value||this.ui.attr("placeholder");var s=u.indexOf("_");var r=u.match(/\d/)?(u.indexOf(u.match(/\d/))):-1;if(s<=this.selectionStart||r<0||r>s){this.value=(this.value||this.ui.attr("placeholder")).replace("_",t);s=(this.value||this.ui.attr("placeholder")).indexOf("_");this.e1=this.selectionEnd=this.selectionStart=this.s1=s>-1?s:this.value.length}else{if(s>this.selectionStart){this.s1=s=this.selectionStart;u=t+(this.value.substr(s,this.value.length).match(/\d+/g)||[]).join("")+"_";for(var q=0,o=u.length-1;q<o;q++){s=this.value.indexOf(u.charAt(q+1),s);if(s>-1){this.value=this.value.substr(0,s)+u.charAt(q)+this.value.substr(s+1,this.value.length)}}this.selectionStart=this.e1=this.selectionEnd=++this.s1}}}}this.dispatchEvent(new Event("change",{bubbles:true,cancelable:true,composed:true}));return this.selectionStart};j.init=function(l){var o=this.value;var p=0;if(o){this.value="";var n=this.ui.attr("placeholder");for(var m in n){if(o.length>m&&n[m]===o[m]){this.value+=o[m];p++}else{if(/_/.test(n[m])){this.value+=(p<o.length)?o[p++]:"_"}}}p=this.value.indexOf("_")}else{if(!l){this.value=this.ui.attr("placeholder")}p=this.ui.attr("placeholder").indexOf("_")}if(l){this.value=this.value.replace(/_/g,"")}return this.e1=this.selectionEnd=this.selectionStart=this.s1=(p>-1?p:this.value.length)}}j.init(true);j.ui.on("keydown",function(r){if(r.ctrlKey||r.metaKey){return false}var v=eventCode(r);var u=((v>=96&&v<=105))?(v-96).toString():v;if(/\d/.test(u)){this.insertDigit(u,selected)}else{if(this.ui.attr("placeholder").length&&!this.value){this.value=this.ui.attr("placeholder");this.e1=this.selectionEnd=this.selectionStart=this.s1=0}else{this.s1=this.selectionStart;this.e1=this.selectionEnd}switch(v){case"Backspace":case 8:if(selected){var t=this.value.indexOf(selected);this.value=this.value.substr(0,t)+this.ui.attr("placeholder").substr(t,selected.length)+this.value.substr(t+selected.length,this.value.length);var m=this.ui.attr("placeholder").substr(t,selected.length).indexOf("_");if(m>0){t+=m}this.selectionStart=this.e1=this.selectionEnd=this.s1=t}else{this.e1=this.s1=--this.selectionStart;--this.selectionEnd;while((this.s1>=0)&&!/\d/.test(this.value.charAt(this.s1))){this.s1=--this.selectionStart;--this.selectionEnd}if(this.s1>=0&&/\d/.test(this.value.charAt(this.s1))){this.value=this.value.substr(0,this.s1)+"_"+this.value.substr((this.s1+1),this.value.length)}else{this.s1=this.e1+1}this.selectionStart=this.selectionEnd=this.s1}this.dispatchEvent(new Event("change",{bubbles:true,cancelable:true,composed:true}));break;case"Enter":case 13:this.dispatchEvent(new Event("change",{bubbles:true,cancelable:true,composed:true}));return false;case"Escape":case 27:this.dispatchEvent(new Event("blur"));return false;case"Tab":case 9:var l=null;var w=r.shiftKey?-1:1;var p=parseInt(this.ui.attr("tabindex"))+w;if(p>0){while(l=c.el('[tabindex="'+p+'"]')){if(l.ui.attr("disabled")){p+=w}else{l.ui.focus();break}}}if(p<=1&&w<0){return r.preventDefault()}break;case"ArrowLeft":case 37:if(this.selectionStart>0){this.s1=--this.selectionStart;this.e1=--this.selectionEnd}break;case"ArrowRight":case 39:this.s1=++this.selectionStart;break;case"Delete":case 46:var n=this.value.slice(this.selectionStart),q,s=this.ui.attr("placeholder").slice(this.selectionStart);if(selected){q=(this.value.substr(this.selectionStart+selected.length,this.value.length).match(/\d+/g)||[]).join("");this.e1=this.s1}else{q=(this.value.slice(this.selectionStart).match(/\d+/g)||[]).join("").slice(1)}for(var o in q){s=s.replace("_",q[o])}this.value=this.value.replace(n,s);this.selectionStart=this.s1;this.selectionEnd=this.e1;this.dispatchEvent(new Event("change",{bubbles:true,cancelable:true,composed:true}));break;default:}}r.preventDefault();r.stopPropagation();return false}).ui.on("focus",function(i){this.init(false);return false}).ui.on("blur",function(i){if(this.value.match(/[\d]+/g)){this.value=!this.cleared?this.value:this.value.replace(/\_/g,"")}else{this.value=""}input_validator(this);return false}).ui.on("copy",function(i){i.stopPropagation();i.preventDefault();if(b.clipboardData&&b.clipboardData.setData){b.clipboardData.setData("Text",selected)}else{var l=(i.originalEvent||i).clipboardData;if(l&&l.getData){l.setData("text/plain",selected)}}return false}).ui.on("paste",function(m){m.stopPropagation();m.preventDefault();var p="";if(b.clipboardData&&b.clipboardData.getData){p=b.clipboardData.getData("Text")}else{var o=(m.originalEvent||m).clipboardData;if(o&&o.getData){p=o.getData("text/plain")}}if(p){var n=p.match(/\d+/g)?p.match(/\d+/g).join(""):"";for(var l in n){this.insertDigit(n[l],selected)}}return false});return j}else{if(h instanceof Array){for(var g in h){b.maskedigits(h[g],k,f)}return h}}console.error("plugin maskedigits wrong parent element!");return e};b.maskedigits=a}(window,window.ui));