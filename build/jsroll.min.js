/**
 * @app jsroll.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA javascritp framework
 * @author Андрей Новиков <andrey@novikov.be>
 * @data 01/01/2016
 */

(function(i,d){"use strict";var f=("onload" in new XMLHttpRequest())?XMLHttpRequest:XDomainRequest;var a=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(s){var q=Math.random()*16|0,g=s=="x"?q:(q&3|8);return g.toString(16)})};i.uuid=a;var e=function(q){var r=/[?&]([^=#]+)=([^&#]*)/g,t={},g;try{while(g=r.exec((q||i.location.search))){if((m1=decodeURIComponent(g[1]))&&(m2=decodeURIComponent(g[2]))&&!t.hasOwnProperty(m1)){t[m1]=m2}}}catch(s){return null}return t};i.location.params=e;function h(r,g){var q=null;r&&(q=setInterval(function(){r.style.opacity=r.style.opacity&&r.style.opacity>0?(parseFloat(r.style.opacity)-0.1).toFixed(1):"1";if(parseFloat(r.style.opacity)<=0){if(g&&typeof g==="function"&&g.call(r)){g.call(r)}r.style.display="none";clearInterval(q)}},typeof g==="number"?g:25))}i.fadeOut=h;function l(r,g){var q=null;if(r.style.display=="none"){r.style.display="inherit"}r&&(q=setInterval(function(){r.style.opacity=r.style.opacity&&r.style.opacity<1?(parseFloat(r.style.opacity)+0.1).toFixed(1):"0";if(parseFloat(r.style.opacity)>=1){if(g&&typeof g==="function"&&g.call(r)){g.call(r)}clearInterval(q)}},typeof g==="number"?g:25))}i.fadeIn=l;function b(s,t){var r=Object.assign({type:"none",validator:null},t);var q={result:{},data:r.type=="json"?{}:[]};if(r.validator==null||(typeof r.validator==="function"&&r.validator.call(s,q))){for(var g=0;g<s.elements.length;g++){if(r.type=="json"){return q.data[s.elements[g].name||g]=encodeURIComponent(s.elements[g].value)}else{q.data.push((s.elements[g].name||g)+"="+encodeURIComponent(s.elements[g].value))}}}q.data=r.type=="json"?JSON.stringify(q.data):q.data.join("&");return q}i.JSON.form=b;function o(s){var q=!!(history.pushState)?1:0;var g=s;return{root:g,rt:[],itv:0,base:q?window.location.pathname+window.location.search:"",clr:function(r){return r.toString().replace(/\/$/,"").replace(/^\//,"")},frgm:q?function(){var r=this.clr(decodeURI(location.pathname+location.search)).replace(/\?(.*)$/,"");return this.clr(this.root!="/"?r.replace(this.root,""):r)}:function(){var r=window.location.href.match(/#(.*)$/);return r?this.clr(r[1]):""},add:function(t,r){if(typeof t=="function"){r=t;t=""}this.rt.push({re:t,handler:r});this.rt=this.rt.sort(function(v,u){if(v.re.toString().length<u.re.toString().length){return 1}if(v.re.toString().length>u.re.toString().length){return -1}return 0});return this},rm:function(t){for(var r in this.rt){if(this.rt[r].handler===t||this.rt[r].re.toString()===t.toString()){this.rt.splice(r,1);return this}}return this},chk:function(t){var v=t||this.frgm();for(var u in this.rt){var r=v.match(this.rt[u].re);if(r){r.shift();this.rt[u].handler.apply({},r);return this}}return this},lsn:function(){var t=this,u=t.frgm(),r=function(){if(u!==t.frgm()){u=t.frgm();t.chk(u)}return t};clearInterval(t.itv);t.itv=setInterval(r,50);return t},set:q?function(r){history.pushState(null,null,this.root+this.clr((r||"")));return this}:function(r){window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+(r||"");return this}}}i.router=o("/");function k(){var g=function(s,r){return i.dispatchEvent(new CustomEvent(s,{detail:r}))},q=function(t,s,r){return i.addEventListener(t,s,!!r?r:false)};i.onbeforeunload=function(r){r.preventDefault()};i.onclickhandler=function(r){if(i.eventhandler.onclick(r)){r.preventDefault();r.stopPropagation()}};q("onbeforeunload",i.onbeforeunload.bind(i),false);q("click",i.onclickhandler.bind(i),true);return{set onbeforeunload(r){i.onbeforeunload=r},onclick:function(r){return false},event:g,bind:q}}i.eventhandler=k();function p(){var g=new f();if(!g){return null}if(!g.hasOwnProperty("ref")){g.ref={}}g.request=function(t){var r=Object.assign({method:"GET",rs:{"Content-type":"application/x-www-form-urlencoded"}},t);var u=r.method+"_"+(r.url?r.url.replace(/(\.|:|\/|\-)/g,"_"):i.uuid());var s=new p();s.isLoad=false;s.open(r.method||"GET",r.url||d,r.async||true,r.username||d,r.password||d);if(r.rs){for(var q in r.rs){s.setRequestHeader(q,r.rs[q])}}s.send(r.data||null);s.id=u;r.result&&(s.result=g.result(r.result));r.process&&(s.process=g.process(r.process));return g.ref[u]=s};g.result=function(q){g.onload=function(r){this.isLoad=true;return q.call(this,r)};return this};g.process=function(q){g.onreadystatechange=function(r){return q.call(this,r)};return this};return g}i.xhr=p();var n=function(q,t,s){var r=Object.assign({method:"GET",async:false,rs:{"Content-type":"application/xml;charset=utf-8"}},s);n.src[t]=new f();if(r.async){n.src[t].onload=function(w){var v=m.cache[t]=c(this.responseText);for(var u in n.pool[t]){n.pool[t][u].cb.call(this,(n.pool[t][u].data?v(n.pool[t][u].data):v))}n.pool[t]=d}}n.src[t].open(r.method,q,r.async);if(r.rs){for(var g in r.rs){n.src[t].setRequestHeader(g,r.rs[g])}}n.src[t].send(null);if(!r.async){return(n.src[t].status!=200?"":n.src[t].responseText)}return""},c=function(g){return new Function("_e","var p=[], print=function(){ p.push.apply(p,arguments); };with(_e){p.push('"+g.replace(/[\r\t\n]/g," ").split("{%").join("\t").replace(/((^|%})[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%}/g,"',$1,'").split("\t").join("');").split("%}").join("p.push('").split("\r").join("\\'")+"');} return p.join('').replace(/<%/g,'{%').replace(/%>/g,'%}');")},m=function m(w,u,q){var g=w.match(/^(?:https?:\/\/)?(?:(?:[\w]+\.)(?:\.?[\w]{2,})+)?([\/\w]+)(\.[\w]+)/i);try{if(g){w=w.replace(/(\.|\/|\-)/g,"");if(typeof q==="function"){if(typeof n.pool[w]==="undefined"){n.pool[w]=[{data:u,cb:q}];return n(g.input,w,{async:q})}else{var r=n.pool[w];r.push({data:u,cb:q});return""}}else{m.cache[w]=m.cache[w]||c(n(g.input,w,false))}}var t=!/[^\w\-\.]/.test(w)?m.cache[w]=m.cache[w]||m(i.document.getElementById(w).innerHTML):c(w);var s=u?t(u):t;if(typeof(q)==="function"){return q.call(m,s)}else{return s}}catch(v){console.error(v);return""}};n.src=[];n.pool=[];m.cache={};i.tmpl=m;var j=function(g){var g=g||i.localStorage;try{g.setItem("test","1");g.removeItem("test")}catch(q){return{p:[],setItem:function(r,s){this.p.push(r);this[r]=s},getItem:function(r){if(this.hasOwnProperty(r)){return this[r]}return null},removeItem:function(r){if(this.hasOwnProperty(r)){delete this.p[r];delete this[r]}},clear:function(){this.p.map(function(r){delete this[r]});this.p=[]}}}return g};i.storage=j()}(window));