
 /**
 * @app jsroll.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA javascritp framework
 * @author Андрей Новиков <andrey@novikov.be>
 * @status beta
 * @version 0.1.0
 * @revision $Id: jsroll.min.js 0004 18/02/2017 16:12:21Z $
 */

(function(g,undefined){"use strict";var version="1.0.1b";var xmlHttpRequest=("onload" in new XMLHttpRequest())?XMLHttpRequest:XDomainRequest;var re=function(s,f){return new RegExp(s,f||"g")};g.re=re;var uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16)})};g.uuid=uuid;var decoder=function(search){var re=/[?&]([^=#]+)=([^&#]*)/g,p={},m;try{while(m=re.exec((search||g.location.search))){if(m[1]&&m[2]){p[decodeURIComponent(m[1])]=decodeURIComponent(m[2])}}}catch(e){return null}return p};g.location.decoder=decoder;var encoder=function(params,divider){if(typeof params==="object"){return Object.keys(params).map(function(e,i,a){return encodeURIComponent(e)+"="+encodeURIComponent(params[e])}).join(divider||"&")}return undefined};g.location.encoder=encoder;var update=function(search,params){var u=[],h=[],url=g.location.search,kv=params||{};if(typeof search==="string"){url=search}else{kv=search}var p=g.location.decoder(url);if(url.indexOf("#")>-1){h=url.split("#")}if(url.indexOf("?")>-1){u=url.split("?")}for(var i in kv){p[decodeURIComponent(i)]=decodeURIComponent(kv[i])}var res=[];for(var a in p){res.push(a+"="+p[a])}if(res.length){return((!u.length&&!h.length)?url:(u.length?u[0]:h[0]))+"?"+res.join("&")+(h.length?h[1]:"")}return url};g.location.update=update;function timer(t,c,f,done){if(t&&c&&typeof f==="function"){var fn=function fn(c,f,done){var r=f.call(this,c);if(!c||(r!==undefined&&!r)){clearTimeout(thread);if(typeof done==="function"){return done.call(this,r)}return null}else{return thread=setTimeout(fn.bind(this,--c,f,done),t)}},thread=setTimeout(fn.bind(this,c,f,done),t);return thread}return undefined}g.timer=timer;function router(r){var isHistory=!!(history.pushState)?1:0;var root=r;return{root:root,rt:[],itv:0,base:isHistory?g.location.pathname+g.location.search:"",referrer:root,clr:function(path){return path.toString().replace(/\/$/,"").replace(/^\//,"")},fr:isHistory?function(){return this.root+this.clr(decodeURI(g.location.pathname+g.location.search)).replace(/\?(.*)$/,"")}:function(){var m=g.location.href.match(/#(.*)$/);return this.root+(m?this.clr(m[1]):"")},add:function(re,handler){if(typeof re=="function"){handler=re;re=""}this.rt.push({re:re,handler:handler});this.rt=this.rt.sort(function(a,b){if(a.re.toString().length<b.re.toString().length){return 1}if(a.re.toString().length>b.re.toString().length){return -1}return 0});return this},rm:function(param){for(var i in this.rt){if(this.rt[i].handler===param||this.rt[i].re.toString()===param.toString()){this.rt.splice(i,1);return this}}return this},chk:function(fr){var f=fr||this.fr(),m=false;for(var i in this.rt){if(m=f.match(this.rt[i].re)){this.rt[i].handler.call(m||{},f);return this}}return this},lsn:function(){var s=this,c=s.fr(),fn=function(){if(c!==s.fr()){c=s.fr();s.chk(c)}return s};clearInterval(s.itv);s.itv=setInterval(fn,50);return s},set:isHistory?function(path){this.referrer=g.location.pathname+g.location.search;history.pushState(null,null,this.root+this.clr(path||""));return this}:function(path){this.referrer=g.location.pathname+g.location.search;window.location.href=g.location.href.replace(/#(.*)$/,"")+"#"+(path||"");return this}}}g.router=router("/");function chain(){var c={tuple:[],cache:[],donned:function(fn){return false},failed:function(fn){return false},pool:function(fn,arg){this.chain.cache.push(this);if(this.chain.tuple.length==this.chain.cache.length){this.chain.donned.apply(this.chain,this.chain.cache)}},done:function(fn){this.donned=fn},fail:function(fn){this.failed=fn}};c.tuple=Array.prototype.slice.call(arguments).map(function(fn){fn.onload=function(){c.pool.apply(fn,arguments)};fn.chain=c;return fn});return c}g.chain=chain;function xhr(params){var x=new xmlHttpRequest();if(!x){return null}x.fail=function(fn){if(typeof fn==="function"){return fn.call(this,x)}if(typeof x.after=="function"){x.after.call(this)}return this};x.done=function(fn){if(typeof fn==="function"){return fn.call(this)}return this};x.process=function(fn){x.onreadystatechange=function(e){if(typeof fn==="function"){return fn.call(this,e)}};return this};x.onload=function(e){x.done.call(this,e);if(typeof x.after=="function"){x.after.call(this,e)}return x};var opt=Object.assign({method:"GET"},params);var rs=Object.assign({"Xhr-Version":version,"Content-type":"application/x-www-form-urlencoded"},params.rs);var id=opt.method+"_"+(opt.url?opt.url.replace(/(\.|:|\/|\-)/g,"_"):g.uuid());try{for(var i in opt){if(typeof opt[i]=="function"){x[i]=opt[i]}}if((["GET","DELETE"].indexOf(opt.method.toUpperCase())>=0)&&opt.data){var u=opt.url||g.location;opt.url=u+(u.indexOf("?")!=-1?"&":"?")+opt.data;opt.data=null}if(typeof x.before=="function"){x.before.call(x,opt)}x.method=opt.method;x.open(opt.method,opt.url||g.location,opt.async||true,opt.username,opt.password);for(var m in rs){x.setRequestHeader(m.trim(),rs[m].trim())}x.send(opt.data||null);x.id=id}catch(e){x.abort();x.fail.call(x,e)}return g.xhr.ref[id]=x}xhr.ref={};g.xhr=xhr;function form(f){f.setAttribute("valid",1);f.response=null;f.rest=f.getAttribute("rest")||f.method;f.validator=f.validator||null;f.opt=f.opt||{};f.done=f.done||null;f.prepare=function(validator){var data=[];if(!validator||(typeof validator==="function"&&validator.call(f,data))){for(var i=0;i<f.elements.length;i++){data.push((f.elements[i].name||i)+"="+(["checkbox","radio"].indexOf((f.elements[i].getAttribute("type")||"text").toLowerCase())<0?encodeURIComponent(f.elements[i].value):(f.elements[i].checked?1:0)))}}else{f.setAttribute("valid",0)}return data.join("&")};f.update=function(data){for(var i=0;i<f.elements.length;i++){if(data[f.elements[i].name]){f.elements[i].value=data[f.elements[i].name]}else{var field=/\[([^\]]+)\]/.exec(f.elements[i].name)[1];if(field&&data[field]){f.elements[i].value=data[field]}}}return f};f.fail=typeof f.fail=="function"?f.fail:function(res){if(res.form){for(var i=0;i<this.elements.length;i++){if(res.form.hasOwnProperty(this.elements[i].name)){g.css.el(this.elements[i].parentElement).add("has-error")}else{g.css.el(this.elements[i].parentElement).del("has-error")}return true}}return false};f.send=function(callback){var data=f.prepare(f.validator),before=true;if(f.getAttribute("valid")!=0){if(typeof f.before=="function"){before=f.before.call(this)}if(before==undefined||!!before){g.xhr(Object.assign({method:f.rest,url:f.action,data:data,done:typeof callback=="function"?function(){var result=callback.apply(this,arguments);if(typeof f.after=="function"){return f.after.call(this,result)}return f}:function(){var res={result:"error"};f.response=this.responseText;if([200,206].indexOf(this.status)<0){res.message=this.status+": "+this.statusText}else{try{res=JSON.parse(this.responseText)}catch(e){res.message="Cервер вернул не коректные данные"}}if(res.result=="error"){if(typeof f.fail=="function"){f.fail.call(f,res)}}else{if(res.result=="ok"){if(typeof f.done=="function"){f.done.call(f,res)}}}if(typeof f.after=="function"){f.after.call(f,res,res.result=="ok")}return f}},f.opt))}}else{f.setAttribute("valid",1)}return f};return f}g.JSON.form=form;var tmpl=function tmpl(str,data,cb,opt){g.arguments=arguments;var compile=function(str){var source=str.replace(/(\/\*[\w\'\s\r\n\*]*\*\/)|(\/\/[\w\s\']*)|(\<![\-\-\s\w\>\/]*\>)/igm,"").replace(/\>\s+\</g,"><").trim();return source.length?new Function("_e","var p=[], print=function(){ p.push.apply(p,arguments); };with(_e){p.push('"+source.replace(/[\r\t\n]/g," ").split("{%").join("\t").replace(/((^|%})[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%}/g,"',$1,'").split("\t").join("');").split("%}").join("p.push('").split("\r").join("\\'")+"');} return p.join('').replace(/<%/g,'{%').replace(/%>/g,'%}');"):undefined},build=function(str,id){var isId=typeof id!=="undefined",pattern=null;var result=null,after=undefined,before=undefined,args=undefined;var pig=g.document.getElementById(id);var data={};var context;try{if(pig){if(before=pig.getAttribute("before")){eval.call(g.arguments,before)}var nn=undefined;Array.prototype.slice.call(pig.attributes).map(function(i){if(i&&/^tmpl-*/i.test(i.nodeName.toString())&&(nn=i.nodeName.toString().replace(/^tmpl-/i,""))){try{data[nn]=JSON.parse(i.nodeValue)}catch(e){data[nn]=i.nodeValue}}});if(args=pig.getAttribute("arguments")){data=Object.assign(JSON.parse(args)||{},data,g.arguments[1])}}if(opt&&typeof opt.before=="object"){data=Object.assign(data,opt.before)}else{if(opt&&typeof opt.before=="function"){opt.before.call(this,data)}}data=Object.assign(data,g.arguments[1]||{});if(isId&&g.tmpl.cache[id]){pattern=g.tmpl.cache[id]}else{pattern=compile(str);if(isId){g.tmpl.cache[id]=pattern}}result=pattern.call(g.tmpl,data);if(typeof cb=="function"){context=cb.call(pattern||g.tmpl,result)||g.tmpl}else{if(typeof cb=="object"&&(context=cb)){context.innerHTML=result}}if(context&&pig&&(after=pig.getAttribute("after"))){(function(){return eval(after)}).apply(context,g.arguments)}if(opt&&typeof opt.after=="function"){opt.after.apply(context,g.arguments)}}catch(e){console.error("#",id||str,"Error:",e);return undefined}return result};switch(true){case str.match(/^(?:https?:\/\/)?(?:(?:[\w]+\.)(?:\.?[\w]{2,})+)?([\/\w]+)(\.[\w]+)/i)?true:false:var id=str.replace(/(\.|\/|\-)/g,"");if(g.tmpl.cache[id]){return build(null,id)}return g.xhr(Object.assign({url:str,async:(typeof cb=="function"),done:function(e){if([200,206].indexOf(this.status)<0){console.warn(this.status+": "+this.statusText)}else{build(this.responseText,id)}}},opt));case !/[^\w\-\.]/.test(str):return build(g.document.getElementById(str).innerHTML,str);default:return build(str)}};tmpl.cache={};g.tmpl=tmpl;var storage=function(s){var s=s||g.localStorage;try{s.setItem("test","1");s.removeItem("test")}catch(e){return{p:[],setItem:function(key,value){this.p.push(key);this[key]=value},getItem:function(key){if(this.hasOwnProperty(key)){return this[key]}return null},removeItem:function(key){if(this.hasOwnProperty(key)){delete this.p[key];delete this[key]}},clear:function(){this.p.map(function(item){delete this[item]});this.p=[]}}}return s};g.storage=storage();var dom=function(){var p;try{if(g.DOMParser){p=new DOMParser();return function(d,mime){try{return p.parseFromString(d,mime||"text/xml")}catch(e){return null}}}else{p=new ActiveXObject("Microsoft.XMLDOM");p.async="false";return function(d,mime){try{p.instance.loadXML(d);return p}catch(e){return null}}}}catch(e){return undefined}};g.dom=dom()}(window));(function(e,h){"use strict";e.config={app:{container:'[role="workspace"]'},msg:{container:".alert.alert-danger",tmpl:"alert-box"},spinner:".locker.spinner",popup:{wnd:".b-popup",container:".b-popup .b-popup-content"}};var b=function(g){this.instance=g;return this};b.prototype={el:function(g){this.instance=typeof g==="string"?document.querySelector(g):g;return this},style:function(j,g){this.instance.style[j]=g;return this},has:function(g){return this.instance.className.match(re("(?:^|\\s)"+g+"(?!\\S)"))},add:function(g){if(this.instance&&!this.has(g)){this.instance.className+=" "+g}return this},del:function(g){if(this.instance){this.instance.className=this.instance.className.replace(re("(?:^|\\s)"+g+"(?!\\S)"),"")}return this},tgl:function(g){if(this.instance){if(!this.has(g)){this.instance.className+=" "+g}else{this.instance.className=this.instance.className.replace(re("(?:^|\\s)"+g+"(?!\\S)"),"")}}return this}};e.css=new b(e);var f=function(g){if(g.hasOwnProperty("ui")){return g}this._parent=null;this.instance=g||e;if(g){this.instance.css=new b(this.instance);this.wrap(this.instance.parentElement)}return this};f.prototype={wrap:function(j,g){if(j&&typeof j==="object"&&!j.hasOwnProperty("ui")){j.ui=new f(j);if(typeof g=="string"){e[g]=j}}return j},el:function(k,g){var j=null;if(typeof k==="string"){if(!k.match(/^#*/)){j=e.document.getElementById(k.replace(/^#/,""))}else{j=this.instance.querySelector(k)}}else{if(typeof k==="object"){j=k}}if(j){if(!j.hasOwnProperty("ui")){j.ui=new f(j)}if(typeof g==="string"){e[g]=j}else{if(typeof g==="function"){g.call(j,arguments)}}}return j},els:function(l,k,g){if(typeof l==="string"){var j=this.instance.querySelectorAll(l);if(!j){return[]}var m=Array.prototype.slice.call(j).map(function(p,o,n){if(!p.hasOwnProperty("ui")){p.ui=new f(p)}if(typeof k=="function"){k.call(p,o,n)}return p});if(typeof k=="string"){e[k]=m}else{if(typeof g=="string"){e[g]=m}}return m}else{return[]}},attr:function(j,k){if(j==h){var l={},q;for(var m in this.instance.attributes){l[(q=this.instance.attributes[m].nodeName)]=this.instance.getAttribute(q)}return l}else{if(typeof j==="object"&&typeof k==="undefined"){for(var m in j){this.instance.setAttribute(m,j[m])}return this}else{if(typeof j==="string"&&typeof k==="undefined"){var g=j.indexOf("*")!=-1?re(j.split("*")[0],"i"):null;if(g){var o={};Array.prototype.slice.call(this.instance.attributes).map(function(t,s,n){var r=t.nodeName.toString();if(g.test(r)&&(r=r.replace(g,""))){o[r]=t.nodeValue}});return o}else{try{return JSON.parse(this.instance.getAttribute(j))}catch(p){return this.instance.getAttribute(j)}}}else{if(typeof j==="string"&&k){if(typeof k==="object"){this.instance.setAttribute(j,JSON.stringify(k))}else{this.instance.setAttribute(j,k)}}}}}return this},merge:function(){var j=1,g=arguments[0]||{};if(this.instance.hasOwnProperty("ui")){g=this.instance;j=0}Array.prototype.slice.call(arguments,j).forEach(function(n,m,l){Object.defineProperties(g,Object.keys(n).reduce(function(o,k){o[k]=Object.getOwnPropertyDescriptor(n,k);return o},{}))});return g},src:function(j){var g=j?j:this.instance;return new f(g.srcElement||g.target)},on:function(k,j,g){this.instance.addEventListener(k,j,!!g);return this.instance},dom:function(k,j){if(!k||typeof k!=="string"){return null}var g=e.dom(k,j).childNodes;return g.length>1?g:g[0]},focus:function(j){var g;if(j){g=(typeof j=="string"?document.querySelector(j):j)}else{g=this.instance}if(g){e.setTimeout(function(){g.focus();return false},0)}return g}};e.ui=new f(document);Object.defineProperty(e,"selected",{get:function d(){return e.getSelection?e.getSelection().toString():document.selection.createRange().text}});function i(){if(window.getSelection){if(window.getSelection().empty){window.getSelection().empty()}else{if(window.getSelection().removeAllRanges){window.getSelection().removeAllRanges()}}}else{if(document.selection){document.selection.empty()}}}e.selecting=i;e.fadeRule=[0,0.301,0.477,0.602,0.699,0.778,0.845,0.903,0.954,1];function c(l,g){var j=null,m=8,k=function k(o,n){this.style.opacity=e.fadeRule[o];if(o--<=0){this.style.display="none";clearTimeout(j);if(typeof n==="function"){return n.call(this)}}else{return j=setTimeout(k.bind(this,o,n),typeof n==="number"?n:25)}};if(l){l.style.display="inherit";l.style.opacity=1;j=setTimeout(k.bind(l,m,g),typeof g==="number"?g:25)}}e.fadeOut=c;function a(l,g){var j=null,m=1,k=function k(o,n){this.style.opacity=e.fadeRule[o];if(o++>=9){clearTimeout(j);if(typeof n==="function"){return n.call(this)}}else{return j=setTimeout(k.bind(this,o,n),typeof n==="number"?n:25)}};if(l){l.style.display="inherit";l.style.opacity=0;return j=setTimeout(k.bind(l,m,g),typeof g==="number"?g:25)}}e.fadeIn=a}(window));(function(b,d,f){"use strict";if(typeof d==="undefined"){return false}var e=function(g){this.route=router;this.registry={};this.dim={};this.instance=g||b;d.on("keydown",function(h){if(h.keyCode==27){b.app.popup()}});return this};e.prototype={bootstrap:function(g){this.route.set(g).chk(g).lsn();return this},widget:function(h,k,l,j){var i=this,g=typeof h.root=="string"?b.ui.el(h.root):h.root;tmpl(k,l,function(m){if(g&&m&&(g.innerHTML=m)){i.implement(g,h.event||[]);i.inject(h.root,g,h.code||j&&j.code)}},j);return this},event:function(g,h){this.registry[g]=h;return this},implement:function(i,h){var g=this;(h||[]).map(function(k,l){for(var j in g.registry[k]){switch(typeof g.registry[k][j]){case"object":i.ui.els(k,function(){this.ui.on(g.registry[k][j][0],g.registry[k][j][1])});break;case"string":i.ui.els(k,function(){this.ui.on(g.registry[k][0],g.registry[k][1])});return;case"function":g.registry[k][j].call(i.ui.els(k),g.dim[k]||{})}}});return g},variable:function(g,h){if(g&&!g.hasOwnProperty("dim")){Object.defineProperty(g,"dim",{get:function(){try{return b.app.dim[h]||(b.app.dim[h]=Object.assign(JSON.parse(storage.getItem(h)||""),{self:g}))}catch(i){b.app.dim[h]={};b.app.dim[h].self=g;return b.app.dim[h]}}});b.app.dim[h]={};b.app.dim[h].self=g;g.store=function(i){var j={};Object.keys(b.app.dim[h]).map(function(l){if(i.indexOf(l)!=-1){j[l]=b.app.dim[h][l]}});storage.setItem(h,JSON.stringify(j));return this}}return g},inject:function(g,i,h){if(typeof h==="function"){h.apply(this.variable(i,g),arguments)}},elem:d.el(b.config.msg.container),msg:{show:function(h,g){tmpl(b.config.msg.tmpl,h,b.app.elem);fadeIn(b.app.elem,0);if(typeof g=="undefined"||!g){fadeOut(b.app.elem,90)}return b.app.elem}},spinner_count:0,spinner_element:d.el(b.config.spinner),set spinner(g){g?this.spinner_count++:this.spinner_count--;this.spinner_count>0?this.spinner_element.style.display="block":this.spinner_element.style.display="none"},get spinner(){if(this.spinner_element.style.display=="none"){return false}return true},before:function(){b.app.spinner=true},after:function(){b.app.spinner=false},popup:function(i,h,g){this.wnd=this.wnd||d.el(b.config.popup.wnd);if(arguments.length&&!this.wnd.visible){this.container=this.container||d.el(b.config.popup.container);tmpl(i,h,this.variable(this.container,i),g);fadeIn(this.wnd,35);this.wnd.visible=true}else{if(this.wnd.visible){fadeOut(this.wnd,35)}this.wnd.visible=false}return this.container},fader:function(j,h,i){var k=this,g=h?d.el(j,h):d.el(j);if(g&&!g.hasOwnProperty("fade")){g.sleep=35;g.faded=false;g.fade_context=i?g.ui.el(i):g;g.fade=function(n,m,l){if(arguments.length&&!g.faded){tmpl(n,m,k.variable(g.fade_context,n),l);fadeIn(g,this.sleep);g.faded=true}else{if(!arguments.length&&g.faded){fadeOut(g,this.sleep);g.faded=false}}return g}}return g}};b.app=new e(b.document);var a=function(i,g){var j=[],h=0;if(i){if(typeof g==="object"&&g.hasOwnProperty("page")){h=g.page}i.map(function(m,l,k){m.ui.el("input",function(n){j.push(this);if(typeof g==="object"&&g.hasOwnProperty(this.name)){this.value=g[this.name]}input_validator(this)})});return{el:j,index:h,get valid(){var k=true;this.el.map(function(n,m,l){k=k&input_validator(n)});return k},set params(k){var l={};if(typeof k==="object"){l=k}else{if(typeof k==="string"){l=location.decoder(k)}}this.valid=true;if(l.hasOwnProperty("page")){this.index=l.page}this.el.map(function(o,n,m){if(l.hasOwnProperty(o.name)){o.value=l[o.name]}else{o.value=""}input_validator(o)})},get params(){var l={},k=this;this.el.map(function(o,n,m){if(o.value){l[o.name]=o.value}input_validator(o)});return l},diff:function(k){var l=this.params;return Object.keys(l).concat(Object.keys(k)).reduce(function(n,m){if(l[m]!==k[m]){n[m]=k[m]}return n},{})},get uri(){var k=this.params;k.page=this.index;return location.encoder(k)}}}return null};b.filter=a;var c=function(q,k,h){if(!q){return f}var m=q.match(/^\/\w+.*/i)?"//"+location.hostname+q:q;var i=function(l,t,s){var n=[];if(typeof s=="object"){for(var p in s){n.push(p+"="+s[p])}s=n.join("&")}return xhr(Object.assign({method:t,url:l.route,data:s},l.opt))};var g={methods:k?k:["GET","POST","PUT","DELETE"],route:q,opt:h,rs:{},error:{},proc:null,before:null,after:null,abort:function(){if(this.proc){this.proc.abort()}this.proc=null},done:function(l,n){return this.rs[n]=l},fail:function(l,n){return this.error=l}};for(var j in k){var o=k[j].toLowerCase(),r=o.toUpperCase();g.rs[r]=null;g[o]=(function(l){return function(n){this.rs[l]=null;return this.proc=i(this,l,n)}}).apply(g,[r]);Object.defineProperty(g,r,{get:function(){return this.rs[r]}})}if(m){return g}else{console.warn("Can't resolve route:",q)}return{}};b.crud=c}(window,window.ui));(function(c,d,i){if(typeof d==="undefined"){return false}var h={elem:d.el(c.config.msg.container),show:function(j,g){tmpl(c.config.msg.tmpl,j,this.elem);fadeIn(this.elem,0);if(typeof g=="undefined"||!g){fadeOut(this.elem,90)}return this.elem}};c.msg=h;c.spinner_count=0;c.spinner_element=d.el(c.config.spinner);if(c.spinner_element){Object.defineProperty(c,"spinner",{__proto__:null,enumerable:false,configurable:false,set:function(g){g?c.spinner_count++:c.spinner_count--;c.spinner_count>0?c.spinner_element.style.display="block":c.spinner_element.style.display="none"},get:function(){if(c.spinner_element.style.display=="none"){return false}return true}})}var f=function(j){if(j){var g=true;if((j.getAttribute("required")!==null)&&!j.value){g=false}else{if((j.getAttribute("required")===null)&&!j.value){g=true}else{if(j.getAttribute("pattern")===null){g=true}else{try{var m=/[?\/]([^\/]+)\/([^\/]*)/g.exec(j.getAttribute("pattern"))||[];var l=new RegExp(m[1],m[2]);g=l.test(j.value.trim())}catch(n){g=false}}}}var k=b(d.wrap(j));if(!g){k.status="error"}else{if(!k.hasAttribute("disabled")){if(j.value.length){k.status="success"}else{k.status="none"}}}return g}return false};c.input_validator=f;var b=function(j){if(j&&!j.hasOwnProperty("status")){j.chk=j.parentElement.ui.el("span");Object.defineProperty(j,"status",{set:function g(k){this.parentElement.css.add("has-feedback").del("has-error").del("has-warning").del("has-success");if(this.chk){this.chk.css.del("glyphicon-ok").del("glyphicon-warning-sign").del("glyphicon-remove").del("spinner")}switch(k){case"error":this._status="error";if(this.chk){this.chk.css.add("glyphicon-remove")}this.parentElement.css.add("has-error");break;case"warning":this._status="warning";if(this.chk){this.chk.css.add("glyphicon-warning-sign")}this.parentElement.css.add("has-warning");break;case"success":this._status="success";if(this.chk){this.chk.css.add("glyphicon-ok")}this.parentElement.css.add("has-success");break;case"spinner":this._status="spinner";if(this.chk){this.chk.css.add("spinner")}break;case"none":default:this._status="none"}},get:function g(){return this._status}})}return j};c.inputer=b;c.formvalidator=function(k){var g=true;for(var j=0;j<this.elements.length;j++){g=g&f(this.elements[j])}if(!g){if(spinner){spinner=false}h.show({message:"неверно заполнены поля формы!"})}return g};var e=function(k,j){if(k&&k.tagName==="INPUT"){var g=d.wrap(k);var l={tmpl:function(o){var m=this.owner;this.index=0;this.key=m.value.toLowerCase()||"null";if(m.pannel){var p=d.dom(tmpl(this.opt.tmpl,{data:o}));if(p){m.pannel.innerHTML=p.innerHTML}}else{m.parentElement.insertAdjacentHTML("beforeend",tmpl(this.opt.tmpl,{data:o}));m.parentElement.css.add("dropdown");m.pannel=m.parentElement.ui.el(".dropdown-menu.list")}m.parentElement.els(".dropdown-menu.list li",function(){this.ui.on("mousedown",function(n){m.value=this.innerHTML;if(m.typeahead.opt.key){m.typeahead.opt.key.value=this.ui.attr("value")}return false})})},xhr:function(){var m=this.owner,o={};o[m.name]=m.value;var n=m.value?m.value.toLowerCase():"null";if((!this.cache.hasOwnProperty(n)||n=="null")&&m.ui.attr("url")){m.status="spinner";xhr({url:location.update(m.ui.attr("url"),o),rs:{Hash:acl.user.hash},before:null,after:null,done:function(q){if([200,206].indexOf(this.status)<0){h.show({error:"ОШИБКА",message:this.status+": "+this.statusText})}else{try{var p=JSON.parse(this.responseText);if(p.result=="error"){m.status="error"}else{m.typeahead.cache[n]=p.data;m.typeahead.show(p.data);f(m)}}catch(q){h.show({message:"сервер вернул не коректные данные"})}}if(!m.value){m.status="none"}return this},fail:function(p){console.error("typeahead",p)}})}else{m.typeahead.show(this.cache[n]);f(m)}},show:function(n){var m=this.owner;if(m===c.document.activeElement){if(Object.keys(n||{}).length){this.tmpl(n);return fadeIn(m.pannel)}else{if(m.pannel){m.pannel.innerHTML=null;fadeOut(m.pannel)}}}return false},onKeydown:function(r){var p=(r.charCode&&r.charCode>0)?r.charCode:r.keyCode;var q=this.typeahead,o=q.cache[q.key],n=Object.keys(o||{}).length-1,s=0;switch(p){case 38:for(var m in o){if(s==q.index){this.value=o[m];if(q.opt.key){q.opt.key.value=m}this.selectionStart=this.selectionEnd=this.value.length;if(q.index>0){q.index--}else{q.index=n}r.preventDefault();r.stopPropagation();return false}s++}return false;case 40:for(var m in o){if(s==q.index){this.value=o[m];if(q.opt.key){q.opt.key.value=m}this.selectionStart=this.selectionEnd=this.value.length;if(q.index<n){q.index++}else{q.index=0}r.preventDefault();r.stopPropagation();return false}s++}return false;case 13:f(this);fadeOut(this.pannel);return true;default:return false}},onChange:function(p){var n=this.typeahead;if(n.opt.key){n.opt.key.value="";if(this.value&&n.cache.hasOwnProperty(this.value.toLowerCase())){var o=this.typeahead.cache[this.value.toLowerCase()];for(var m in o){if(o[m].toLowerCase()===this.value.toLowerCase()){n.opt.key.value=m}}}return n.opt.key.value}return false},onFocus:function(m){this.typeahead.xhr();return false},onInput:function(m){this.typeahead.xhr();return false},onBlur:function(m){fadeOut(this.pannel);return false}};l.index=0;l.key=null;l.cache={};l.opt={master:[],slave:[],tmpl:"typeahead-tmpl"};g.typeahead=l;l.opt=Object.assign(l.opt,j);g.typeahead.owner=k;b(g).ui.on("focus",l.onFocus).ui.on("input",l.onInput).ui.on("blur",l.onBlur).ui.on("keydown",l.onKeydown).ui.on("change",l.onChange);if(!g.ui.attr("tabindex")){g.ui.attr("tabindex","0")}return g}};c.typeahead=e;var a=function(j,l,g){if(j.tagName==="INPUT"){var k=b(j);k.cleared=g==i?true:!!g;if(l){k.maxLength=k.ui.attr("placeholder",l||"").attr("placeholder").length}if(!k.ui.attr("tabindex")){k.ui.attr("tabindex","0")}if(k&&!k.hasOwnProperty("insertDigit")){k.insertDigit=function(r,p){if(p){var t=this.value.indexOf(p);var q=/\d/.test(r)?1:0;var m=this.ui.attr("placeholder").substr(t,p.length).indexOf("_");if(m>0){t+=m}this.value=this.value.substr(0,t)+(/\d/.test(r)?r:"")+this.ui.attr("placeholder").substr(t+q,p.length-q)+this.value.substr(t+p.length,this.value.length);this.selectionStart=this.e1=this.selectionEnd=this.s1=t+1}else{if(/\d/.test(r)&&(this.value||this.ui.attr("placeholder")).indexOf("_")>-1){var s=this.value||this.ui.attr("placeholder");var t=s.indexOf("_");var o=s.match(/\d/)?(s.indexOf(s.match(/\d/))):-1;if(t<=this.selectionStart||o<0||o>t){this.value=(this.value||this.ui.attr("placeholder")).replace("_",r);t=(this.value||this.ui.attr("placeholder")).indexOf("_");this.e1=this.selectionEnd=this.selectionStart=this.s1=t>-1?t:this.value.length}else{if(t>this.selectionStart){this.s1=t=this.selectionStart;var s=r+(this.value.substr(t,this.value.length).match(/\d+/g)||[]).join("")+"_";for(var n=0;n<s.length-1;n++){t=this.value.indexOf(s.charAt(n+1),t);if(t>-1){this.value=this.value.substr(0,t)+s.charAt(n)+this.value.substr(t+1,this.value.length)}}this.selectionStart=this.e1=this.selectionEnd=++this.s1}}}}return this.selectionStart};k.init=function(m){var o=this.value;var p=0;if(o){this.value=this.ui.attr("placeholder");p=this.value.indexOf("_");for(var n in o){if(/\d/.test(o[n])){this.value=this.value.replace("_",o[n]);p=this.value.indexOf("_")}}}else{if(!m){this.value=this.ui.attr("placeholder")}p=this.ui.attr("placeholder").indexOf("_")}if(m){this.value=this.value.replace(/\_/g,"")}return this.e1=this.selectionEnd=this.selectionStart=this.s1=(p>-1?p:this.value.length)}}k.init(true);k.ui.on("keydown",function(s){if(this.ui.attr("placeholder").length&&!this.value){this.value=this.ui.attr("placeholder");this.e1=this.selectionEnd=this.selectionStart=this.s1=0}else{this.s1=this.selectionStart;this.e1=this.selectionEnd}var w=(s.charCode&&s.charCode>0)?s.charCode:s.keyCode;if([13,27,82].indexOf(w)!=-1){return true}var v=((w>=96&&w<=105))?(w-96).toString():String.fromCharCode(w);switch(w){case 8:if(selected){var u=this.value.indexOf(selected);this.value=this.value.substr(0,u)+this.ui.attr("placeholder").substr(u,selected.length)+this.value.substr(u+selected.length,this.value.length);var n=this.ui.attr("placeholder").substr(u,selected.length).indexOf("_");if(n>0){u+=n}this.selectionStart=this.e1=this.selectionEnd=this.s1=u}else{this.e1=this.s1=--this.selectionStart;--this.selectionEnd;while((this.s1>=0)&&!/\d/.test(this.value.charAt(this.s1))){this.s1=--this.selectionStart;--this.selectionEnd}if(this.s1>=0&&/\d/.test(this.value.charAt(this.s1))){this.value=this.value.substr(0,this.s1)+"_"+this.value.substr((this.s1+1),this.value.length)}else{this.s1=this.e1+1}this.selectionStart=this.selectionEnd=this.s1}break;case 9:var m=false;var x=s.shiftKey?-1:1;var q=parseInt(this.ui.attr("tabindex"));if(q>0){while(m=d.el('[tabindex="'+q+'"]')){if(m.ui.attr("disabled")){q+=x}else{m.ui.focus();break}}}if(q<=1&&x<0){return s.preventDefault()}s.stopPropagation();return false;case 37:this.s1=--this.selectionStart;this.e1=--this.selectionEnd;break;case 39:this.s1=++this.selectionStart;break;case 46:var o=this.value.slice(this.selectionStart),r,t=this.ui.attr("placeholder").slice(this.selectionStart);if(selected){r=(this.value.substr(this.selectionStart+selected.length,this.value.length).match(/\d+/g)||[]).join("");this.e1=this.s1}else{r=(this.value.slice(this.selectionStart).match(/\d+/g)||[]).join("").slice(1)}for(var p in r){t=t.replace("_",r[p])}this.value=this.value.replace(o,t);this.selectionStart=this.s1;this.selectionEnd=this.e1;break;default:this.insertDigit(v,selected)}s.preventDefault();s.stopPropagation();return/d/.test(v)}).ui.on("focus",function(m){this.init(false);m.preventDefault();m.stopPropagation();return false}).ui.on("blur",function(m){if(this.value.match(/[\d]+/g)){this.value=!this.cleared?this.value:this.value.replace(/\_/g,"")}else{this.value=""}m.preventDefault();m.stopPropagation();return false}).ui.on("paste",function(n){var o=n.clipboardData.getData("Text").match(/\d+/g)?n.clipboardData.getData("Text").match(/\d+/g).join(""):"";for(var m in o){this.insertDigit(o[m],selected)}n.preventDefault();n.stopPropagation();return false})}return k};c.maskedigits=a}(window,window.ui));