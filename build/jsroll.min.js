
 /**
 * @app jsroll.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA javascritp framework
 * @author Андрей Новиков <andrey@novikov.be>
 * @status beta
 * @version 0.1.0
 * @revision $Id: jsroll.min.js 0004 29/07/2016 10:37:24Z $
 */

(function(j,d){"use strict";var h=("onload" in new XMLHttpRequest())?XMLHttpRequest:XDomainRequest;var b=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(q){var p=Math.random()*16|0,g=q=="x"?p:(p&3|8);return g.toString(16)})};j.uuid=b;var e=function(q){var r=/[?&]([^=#]+)=([^&#]*)/g,t={},g;try{while(g=r.exec((q||j.location.search))){if(g[1]&&g[2]){t[decodeURIComponent(g[1])]=decodeURIComponent(g[2])}}}catch(s){return null}return t};j.location.params=e;var f=function(z,r){var y=[],t=[],g=j.location.search,w=r||{};if(typeof z==="string"){g=z}else{w=z}var q=j.location.params(g);if(g.indexOf("#")>-1){t=g.split("#")}if(g.indexOf("?")>-1){y=g.split("?")}for(var s in w){q[decodeURIComponent(s)]=decodeURIComponent(w[s])}var v=[];for(var x in q){v.push(x+"="+q[x])}if(v.length){if(!y.length&&!t.length){return g+"?"+v.join("&")}else{if(y.length&&!t.length){return y[0]+"?"+v.join("&")}else{if(y.length&&t.length){return y[0]+"?"+v.join("&")+t[1]}else{if(!y.length&&t.length){return t[0]+"?"+v.join("&")+t[1]}}}}}return g};j.location.update=f;j.fadeRule=[0,0.301,0.477,0.602,0.699,0.778,0.845,0.903,0.954,1];function i(r,g){var p=null,s=8,q=function q(u,t){this.style.opacity=j.fadeRule[u];if(u--<=0){if(typeof t==="function"){t.call(this)}this.style.display="none";clearTimeout(p)}else{p=setTimeout(q.bind(this,u,t),typeof t==="number"?t:25)}};if(r){r.style.display="inherit";r.style.opacity=1;p=setTimeout(q.bind(r,s,g),typeof g==="number"?g:25)}}j.fadeOut=i;function l(r,g){var p=null,s=1,q=function q(u,t){this.style.opacity=j.fadeRule[u];if(u++>=9){if(typeof t==="function"){t.call(this)}clearTimeout(p)}else{p=setTimeout(q.bind(this,u,t),typeof t==="number"?t:25)}};if(r){r.style.display="inherit";r.style.opacity=0;p=setTimeout(q.bind(r,s,g),typeof g==="number"?g:25)}}j.fadeIn=l;function c(p,g){p.setAttribute("valid",1);p.xhr=null;p.prepare=function(r){var s=[];if(!r||(typeof r==="function"&&r.call(p,s))){for(var q=0;q<p.elements.length;q++){s.push((p.elements[q].name||q)+"="+(["checkbox","radio"].indexOf((p.elements[q].getAttribute("type")||"none").toLowerCase())<0?encodeURIComponent(p.elements[q].value):(p.elements[q].checked?1:0)))}}else{p.setAttribute("valid",0)}return s.join("&")};p.validator=g||p.validator;p.release=function(r){var q=p.prepare(r&&r.validator||p.validator);if(p.getAttribute("valid")!=0){j.xhr.request(Object.assign({method:r&&r.method||p.method,url:r&&r.url||p.action,data:q},{rs:r.rs||{}})).result(r&&r.callback||function(){var t={result:"error"};if([200,206].indexOf(this.status)<0){t.message=this.status+": "+this.statusText}else{try{t=JSON.parse(this.responseText);if(t.form){for(var s=0;s<p.elements.length;s++){if(t.form.hasOwnProperty(p.elements[s].name)){css.el(p.elements[s].parentElement).add("has-error")}else{css.el(p.elements[s].parentElement).del("has-error")}}}}catch(u){t.message="Cервер вернул не коректные данные"}}p.xhr=t;if(r&&typeof r.fn=="function"){r.fn.call(p,t)}return p})}return p};p.insert=function(r){for(var q=0;q<p.elements.length;q++){if(r[p.elements[q].name]){p.elements[q].value=r[p.elements[q].name]}else{var s=/\[([^\]]+)\]/.exec(p.elements[q].name)[1];if(s&&r[s]){p.elements[q].value=r[s]}}}return p};p.setup=function(r){if(r){switch(true){case r.hasOwnProperty("form"):if(typeof r.form==="object"){p.insert(r.form);var q=(r&&r.validator||p.validator);if(typeof q=="function"){q.call(p,r.data)}}break;case r.hasOwnProperty("xhr"):j.xhr.request({method:r.xhr.method||"GET",url:r.xhr.url,data:r.xhr.data||null,rs:r.xhr.rs||{}}).result(r.xhr.callback||function(){var t={result:"error"};if([200,206].indexOf(this.status)<0){t.message=this.status+": "+this.statusText}else{try{t=JSON.parse(this.responseText);p.insert(t.data||{});var s=(r&&r.validator||p.validator);if(typeof s=="function"){s.call(p,t.data)}}catch(u){t.message="Cервер вернул не коректные данные"}}p.xhr=t;if(r&&typeof r.fn=="function"){r.fn.call(p,t)}return p});break;default:p.reset()}}else{p.reset()}return p};return p}j.JSON.form=c;function n(q){var p=!!(history.pushState)?1:0;var g=q;return{root:g,rt:[],itv:0,base:p?window.location.pathname+window.location.search:"",clr:function(r){return r.toString().replace(/\/$/,"").replace(/^\//,"")},frgm:p?function(){var r=this.clr(decodeURI(location.pathname+location.search)).replace(/\?(.*)$/,"");return this.clr(this.root!="/"?r.replace(this.root,""):r)}:function(){var r=window.location.href.match(/#(.*)$/);return r?this.clr(r[1]):""},add:function(s,r){if(typeof s=="function"){r=s;s=""}this.rt.push({re:s,handler:r});this.rt=this.rt.sort(function(u,t){if(u.re.toString().length<t.re.toString().length){return 1}if(u.re.toString().length>t.re.toString().length){return -1}return 0});return this},rm:function(s){for(var r in this.rt){if(this.rt[r].handler===s||this.rt[r].re.toString()===s.toString()){this.rt.splice(r,1);return this}}return this},chk:function(s){var u=s||this.frgm();for(var t in this.rt){var r=u.match(this.rt[t].re);if(r){r.shift();this.rt[t].handler.apply({},r);return this}}return this},lsn:function(){var t=this,u=t.frgm(),r=function(){if(u!==t.frgm()){u=t.frgm();t.chk(u)}return t};clearInterval(t.itv);t.itv=setInterval(r,50);return t},set:p?function(r){history.pushState(null,null,this.root+this.clr((r||"")));return this}:function(r){window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+(r||"");return this}}}j.router=n("/");function a(){var g={tuple:[],cache:[],donned:function(p){return false},failed:function(p){return false},pool:function(q,p){this.chain.cache.push(this);if(this.chain.tuple.length==this.chain.cache.length){this.chain.donned.apply(this.chain,this.chain.cache)}},done:function(p){this.donned=p},fail:function(p){this.failed=p}};g.tuple=Array.prototype.slice.call(arguments).map(function(p){p.onload=function(){g.pool.apply(p,arguments)};p.chain=g;return p});return g}j.chain=a;function o(){var g=new h();if(!g){return null}if(!g.hasOwnProperty("ref")){g.ref={}}g.request=function(s){var q=Object.assign({method:"GET"},s);q.rs=Object.assign({"Content-type":"application/x-www-form-urlencoded"},s.rs);var t=q.method+"_"+(q.url?q.url.replace(/(\.|:|\/|\-)/g,"_"):j.uuid());var r=new o();r.isLoad=false;if((["GET","DELETE"].indexOf(q.method.toUpperCase())>=0)&&q.data){q.url=(q.url||j.location)+"?"+q.data;q.data=null}r.open(q.method,q.url||j.location,q.async||true,q.username||d,q.password||d);if(q.rs){for(var p in q.rs){r.setRequestHeader(p.trim(),q.rs[p].trim())}}r.send(q.data||null);r.id=t;q.result&&(r.result=g.result(q.result));q.process&&(r.process=g.process(q.process));return g.ref[t]=r};g.result=function(p){g.onload=function(q){this.isLoad=true;if(typeof p==="function"){return p.call(this,q)}};return this};g.process=function(p){g.onreadystatechange=function(q){if(typeof p==="function"){return p.call(this,q)}};return this};return g}j.xhr=o();var m=function m(t,r,g,p){var q=function(v){return new Function("_e","var p=[], print=function(){ p.push.apply(p,arguments); };with(_e){p.push('"+v.replace(/[\r\t\n]/g," ").split("{%").join("\t").replace(/((^|%})[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%}/g,"',$1,'").split("\t").join("');").split("%}").join("p.push('").split("\r").join("\\'")+"');} return p.join('').replace(/<%/g,'{%').replace(/%>/g,'%}');")},s=function(z,A){var x=typeof A!=="undefined";if(x&&j.tmpl.cache[A]){v=j.tmpl.cache[A].call(j.tmpl,r||{});if(typeof g=="function"){g.call(j.tmpl,v)}return v}var v=null,w=null;try{w=q(z);if(x){j.tmpl.cache[A]=w}v=w.call(j.tmpl,r||{});if(typeof g=="function"){g.call(w||j.tmpl,v)}}catch(y){console.error(y)}return v};switch(true){case t.match(/^(?:https?:\/\/)?(?:(?:[\w]+\.)(?:\.?[\w]{2,})+)?([\/\w]+)(\.[\w]+)/i)?true:false:var u=t.replace(/(\.|\/|\-)/g,"");if(j.tmpl.cache[u]){return s(null,u)}return j.xhr.request(Object.assign({url:t,async:(typeof g=="function")},p)).result(function(v){if([200,206].indexOf(this.status)<0){console.warn(this.status+": "+this.statusText)}else{s(this.responseText,u)}});case !/[^\w\-\.]/.test(t):return s(j.document.getElementById(t).innerHTML,t);default:return s(t)}};m.cache={};j.tmpl=m;var k=function(g){var g=g||j.localStorage;try{g.setItem("test","1");g.removeItem("test")}catch(p){return{p:[],setItem:function(q,r){this.p.push(q);this[q]=r},getItem:function(q){if(this.hasOwnProperty(q)){return this[q]}return null},removeItem:function(q){if(this.hasOwnProperty(q)){delete this.p[q];delete this[q]}},clear:function(){this.p.map(function(q){delete this[q]});this.p=[]}}}return g};j.storage=k()}(window));(function(d,h){d.config={app:{container:'[role="workspace"]'},msg:{container:".alert.alert-danger",tmpl:"alert-box"},spinner:".locker.spinner",popup:{wnd:".b-popup",container:".b-popup .b-popup-content"}};var e=function(g){this.instance=g||d;return this};e.prototype={create:function(i,g){if(typeof i==="object"){var j=new e(i);if(j&&typeof g=="string"){d[g]=j}return j}return null},el:function(j,g){var i=null;if(typeof j==="string"){if(!j.match(/^#*/)){i=d.document.getElementById(j.replace(/^#/,""))}else{i=this.instance.querySelector(j)}if(i){if(!i.hasOwnProperty("spa")){i.spa=new e(i);i.css=new b(i)}if(typeof g==="string"){d[g]=i}else{if(typeof g==="function"){g.call(i,arguments)}}}}return i},els:function(l,k,i){if(typeof l==="string"){var j=this.instance.querySelectorAll(l);if(!j){return[]}var g=Array.prototype.slice.call(j),m=0;return g.map(function(n){if(!n.hasOwnProperty("spa")){n.spa=new e(n);n.css=new b(n);if(typeof k=="function"){k.call(d,n,m++)}if(typeof k=="string"||typeof i=="string"){if(!d[i]){d[i]=[]}d[i].push(n)}}return n})}else{return[]}},attr:function(g,i){if(g&&typeof i==="undefined"){try{return JSON.parse(this.instance.getAttribute(g))}catch(j){return this.instance.getAttribute(g)}}else{if(g&&i){if(typeof i==="object"){this.instance.setAttribute(g,JSON.stringify(i))}else{this.instance.setAttribute(g,i)}}}return this},get parent(){return new e(this.instance&&this.instance.parentElement)},src:function(i){var g=i?i:this.instance;return new e(g.srcElement||g.target)},css:function(){return d.css.el(this.instance)},on:function(j,i,g){this.instance.addEventListener(j,i,g||true);return this.instance},xml:function(l,j){var g,i;if(!l||typeof l!=="string"){return null}try{if(d.DOMParser){i=new DOMParser();g=i.parseFromString(l,j||"text/xml")}else{g=new ActiveXObject("Microsoft.XMLDOM");g.async="false";g.loadXML(l)}}catch(k){g=h}return g}};d.spa=new e(document);var b=function(g){this.instance=g;return this};b.prototype={el:function(g){this.instance=g;return this},style:function(i,g){this.instance.style[i]=g},re:function(i,j){return new RegExp(i,j||"g")},has:function(g){return this.instance.className.match(this.re("(?:^|\\s)"+g+"(?!\\S)"))},add:function(g){if(!this.has(g)){this.instance.className+=" "+g}return this},del:function(g){this.instance.className=this.instance.className.replace(this.re("(?:^|\\s)"+g+"(?!\\S)"),"");return this},tgl:function(g){if(!this.has(g)){this.instance.className+=" "+g}else{this.instance.className=this.instance.className.replace(this.re("(?:^|\\s)"+g+"(?!\\S)"),"")}return this}};d.css=new b(document);var f={elem:d.spa.el(d.config.msg.container),show:function(i,g){this.elem.innerHTML=tmpl(d.config.msg.tmpl,i);this.elem.style.display="inherit";if(typeof g=="undefined"||!g){fadeOut(this.elem,90)}}};d.msg=f;var a={visible:false,wnd:d.spa.el(d.config.popup.wnd),container:d.spa.el(d.config.popup.container),init:function(g){if(typeof g==="object"){if(g.width){this.container.style.width=g.width+"px";this.container.style.marginLeft=(g.width/(-2))+"px"}if(g.height){this.container.style.height=g.height+"px";this.container.style.marginTop=(g.height/(-2))+"px"}}},show:function(g){if(this.wnd){this.wnd.style.opacity="0";g.content&&this.container&&(this.container.innerHTML=g.content);if(typeof g==="object"){(g.width||g.height)&&this.init(g)}this.container.spa.els('[role="popup-close"]',function(i){i.spa.on("click",function(j){return a.hide()});2});if(g.event&&g.event.length){g.event.map(function(j,k){j.call(a,k)})}this.visible=true;fadeIn(this.wnd,35);g.cb&&g.cb.call(this);this.container.spa.el('[tabindex="1"]',function(){this.focus()})}},hide:function(g){if(this.wnd){this.visible=false;fadeOut(this.wnd,g||35)}}};d.popup=a;d.spinner_count=0;d.spinner_element=d.spa.el(d.config.spinner);if(d.spinner_element){Object.defineProperty(d,"spinner",{__proto__:null,enumerable:false,configurable:false,set:function(g){g?d.spinner_count++:d.spinner_count--;d.spinner_count>0?d.spinner_element.style.display="block":d.spinner_element.style.display="none"},get:function(){if(d.spinner_element.style.display=="none"){return false}return true}})}Object.defineProperty(d,"selected",{get:function c(){return d.getSelection?d.getSelection().toString():document.selection.createRange().text}})}(window));