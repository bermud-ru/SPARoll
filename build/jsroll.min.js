
 /**
 * @app jsroll.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA javascritp framework
 * @author Андрей Новиков <andrey@novikov.be>
 * @data 31/01/2018
 * @status beta
 * @version 2.0.9b
 * @revision $Id: jsroll.min.js 2.0.9b 2018-01-31 10:37:00Z $
 */

(function(g,undefined){"use strict";var version="2.0.10b";var xmlHttpRequest=("XMLHttpRequest" in g?g.XMLHttpRequest:("ActiveXObject" in g?g.ActiveXObject("Microsoft.XMLHTTP"):g.XDomainRequest));var CustomEvent=("CustomEvent" in g?g.CustomEvent:(function(){function CustomEvent(event,params){params=params||{bubbles:false,cancelable:false,detail:undefined};var evt=g.document.createEvent("CustomEvent");evt.initCustomEvent(event,params.bubbles,params.cancelable,params.detail);return evt}CustomEvent.prototype=g.Event.prototype;return CustomEvent})());g.evt=CustomEvent;var is_url=/^(?:https?:\/\/)?(?:(?:[\w]+\.)(?:\.?[\w]{2,})+)?([\/\w]+)(\.[\w]+)|^(?:\/[\w]+){1,}/i;g.URL=g.URL||g.webkitURL;g.requestFileSystem=g.requestFileSystem||g.webkitRequestFileSystem;var re=function(s,f){return new RegExp(s,f||"g")};g.re=re;var str2json=function(s){try{var o=(typeof s==="string"?JSON.parse(s):s)}catch(e){o={}}return o};g.str2json=str2json;var obj2array=function(a){return Array.prototype.slice.call(a)};g.obj2array=obj2array;var coalesce=function(){for(var i in arguments){if(typeof arguments[i]!=="undefined"&&arguments[i]!==null){return arguments[i]}}return null};g.coalesce=coalesce;var uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16)})};g.uuid=uuid;Object.defineProperty(Object.prototype,"merge",{value:function(){if(!arguments.length){return null}var o=(typeof this!=="function"?this:{});Array.prototype.slice.call(arguments).forEach(function(v,k,a){Object.defineProperties(o,Object.keys(v||{}).reduce(function(d,key){if(o.hasOwnProperty(key)&&Object.getOwnPropertyDescriptor(o,key)["set"]){o[key]=v[key];d[key]=Object.getOwnPropertyDescriptor(o,key)}else{d[key]=Object.getOwnPropertyDescriptor(v,key)}return d},{}))});return o},enumerable:false});var bb=function(data,params){var opt=Object.assign({type:"application/x-www-form-urlencoded"},params);var BlobBuilder=("MozBlobBuilder" in g?g.MozBlobBuilder:("WebKitBlobBuilder" in g?g.WebKitBlobBuilder:g.BlobBuilder));if(BlobBuilder){var bb=new BlobBuilder();bb.append(data);return bb.getBlob(opt.type)}return new Blob([data],opt)};g.bb=bb;var func=function(str,self,args){if(typeof str!=="string"){return console.error("jsRoll::func(",str,self,args,") ERROR: Source of context not defined!")}try{var s=str.replace(/(\/\*[\w\'\s\r\n\*]*\*\/)|(\/\/[^\r\n]*)/igm,"");switch(true){case /^\s*function.*[}|;]\s*$/i.test(s):return new Function("return "+s+".apply(this, arguments)");default:return(function(){return eval(s)}).apply(self||this,args||[self])}}catch(e){return console.error("jsRoll::func(",str,self,args,") ERROR: ",e)}};g.func=func;var decoder=function(search){var re=/[?&]([^=#]+)=([^&#]*)/g,p={},m;try{while(m=re.exec((search||g.location.search))){if(m[1]&&m[2]){p[decodeURIComponent(m[1])]=decodeURIComponent(m[2])}}}catch(e){return null}return p};g.location.decoder=decoder;var encoder=function(params,divider){if(typeof params==="object"){return Object.keys(params).map(function(e,i,a){return encodeURIComponent(e)+"="+encodeURIComponent(params[e])}).join(divider||"&")}return undefined};g.location.encoder=encoder;var update=function(search,params){var u=[],h=[],url=g.location.search,kv=params||{};if(typeof search==="string"){url=search}else{kv=search}var p=g.location.decoder(url);if(url.indexOf("#")>-1){h=url.split("#")}if(url.indexOf("?")>-1){u=url.split("?")}for(var i in kv){p[decodeURIComponent(i)]=decodeURIComponent(kv[i])}var res=[];for(var a in p){res.push(a+"="+p[a])}if(res.length){return((!u.length&&!h.length)?url:(u.length?u[0]:h[0]))+"?"+res.join("&")+(h.length?h[1]:"")}return url};g.location.update=update;function timer(t,c,f,done){if(t&&c&&typeof f==="function"){var fn=function fn(c,f,done){var r=f.call(this,c);if(!c||(r!==undefined&&!r)){clearTimeout(thread);if(typeof done==="function"){return done.call(this,r)}return null}else{return thread=g.setTimeout(fn.bind(this,--c,f,done),t)}},thread=g.setTimeout(fn.bind(this,c,f,done),t);return thread}return undefined}g.timer=timer;function router(r){var isHistory=!!(history.pushState)?1:0;var root=r;return{root:root,rt:[],itv:0,base:isHistory?g.location.pathname+g.location.search:"",referrer:root,clr:function(path){return path.toString().replace(/\/$/,"").replace(/^\//,"")},fr:isHistory?function(){return this.root+this.clr(decodeURI(g.location.pathname+g.location.search)).replace(/\?(.*)$/,"")}:function(){var m=g.location.href.match(/#(.*)$/);return this.root+(m?this.clr(m[1]):"")},add:function(re,handler){if(typeof re=="function"){handler=re;re=""}this.rt.push({re:re,handler:handler});this.rt=this.rt.sort(function(a,b){if(a.re.toString().length<b.re.toString().length){return 1}if(a.re.toString().length>b.re.toString().length){return -1}return 0});return this},rm:function(param){for(var i in this.rt){if(this.rt[i].handler===param||this.rt[i].re.toString()===param.toString()){this.rt.splice(i,1);return this}}return this},chk:function(fr){var f=fr||this.fr(),m=false;for(var i in this.rt){if(m=f.match(this.rt[i].re)){this.rt[i].handler.call(m||{},f);return this}}return this},lsn:function(){var s=this,c=s.fr(),fn=function(){if(c!==s.fr()){c=s.fr();s.chk(c)}return s};clearInterval(s.itv);s.itv=setInterval(fn,50);return s},set:isHistory?function(path){this.referrer=g.location.pathname+g.location.search;history.pushState(null,null,this.root+this.clr(path||""));return this}:function(path){this.referrer=g.location.pathname+g.location.search;window.location.href=g.location.href.replace(/#(.*)$/,"")+"#"+(path||"");return this}}}g.router=router("/");function chain(){var c={tuple:[],cache:[],donned:function(fn){return false},failed:function(fn){return false},pool:function(fn,arg){this.chain.cache.push(this);if(this.chain.tuple.length==this.chain.cache.length){this.chain.donned.apply(this.chain,this.chain.cache)}},done:function(fn){this.donned=fn},fail:function(fn){this.failed=fn}};c.tuple=Array.prototype.slice.call(arguments).map(function(fn){fn.onload=function(){c.pool.apply(fn,arguments)};fn.chain=c;return fn});return c}g.chain=chain;function js(src,opt){if(!src){return null}var opt=Object.assign({async:false,type:"text/javascript",container:g.document.body},opt);var s=g.document.createElement("script");s.type=opt.type;s.async=opt.async;if(opt.hasOwnProperty("id")){s.id=opt.id}if(src.match(is_url)){s.src=src}else{s.text=src}if(typeof opt.onload==="funciton"){s.onload=onload}if(typeof opt.onreadystatechange==="funciton"){s.onreadystatechange=onreadystatechange}if(typeof opt.container.appendChild==="function"){opt.container.appendChild(s)}else{console.error("jsRoll::js() Не существущий контейнер",opt.container)}return s}g.js=js;function xhr(params){var x=new xmlHttpRequest();if(!x){return null}x.fail=function(fn){if(typeof fn==="function"){return fn.call(this,x)}if(typeof x.after=="function"){x.after.call(this,x)}return this};x.done=function(fn){if(typeof fn==="function"){return fn.call(this,x)}return this};x.process=function(fn){x.onreadystatechange=function(e){if(typeof fn==="function"){return fn.call(this,e,x)}};return this};x.onload=function(e){x.done.call(this,e);if(typeof x.after=="function"){x.after.call(this,e,x)}return x};if(params&&params.hasOwnProperty("responseType")){x.responseType=params.responseType}var opt=Object.assign({method:"GET"},params);var rs=Object.assign({"Xhr-Version":version,"Content-type":"application/x-www-form-urlencoded"},(params||{}).rs);var id=opt.method+"_"+(opt.url?opt.url.replace(/(\.|:|\/|\-)/g,"_"):g.uuid());try{for(var i in opt){if(typeof opt[i]=="function"){x[i]=opt[i]}}if((["GET","DELETE"].indexOf(opt.method.toUpperCase())>=0)&&opt.data){var u=opt.url||g.location;opt.url=u+(u.indexOf("?")!=-1?"&":"?")+opt.data;opt.data=null}if(typeof x.before=="function"){x.before.call(x,opt,x)}x.method=opt.method;x.open(opt.method,opt.url||g.location,opt.async||true,opt.username,opt.password);for(var m in rs){x.setRequestHeader(m.trim(),rs[m].trim())}x.send(opt.data||null);x.id=id}catch(e){x.abort();x.fail.call(x,e,x)}return g.xhr.ref[id]=x}xhr.ref={};g.xhr=xhr;Object.defineProperty(JSON,"form",{value:function(f){f.setAttribute("valid",1);f.response=null;f.MODEL=f.MODEL||{};f.rest=f.getAttribute("rest")||f.method;f.validator=f.validator||null;f.opt=f.opt||{};f.done=f.done||null;f.prepare=function(validator){var data=[];if(!validator||(typeof validator==="function"&&validator.call(f,data))){for(var i=0;i<f.elements.length;i++){data.push((f.elements[i].name||i)+"="+(f.MODEL[f.elements[i].name||i]=(["checkbox","radio"].indexOf((f.elements[i].getAttribute("type")||"text").toLowerCase())<0?encodeURIComponent(f.elements[i].value):(f.elements[i].checked?(f.elements[i].value.indexOf("on")==-1?f.elements[i].value:1):(f.elements[i].value.indexOf("on")==-1?"":0)))))}}else{f.setAttribute("valid",0)}return data.join("&")};f.update=function(data){for(var i=0;i<f.elements.length;i++){if(data[f.elements[i].name]){f.elements[i].value=data[f.elements[i].name]}else{var field=/\[([^\]]+)\]/.exec(f.elements[i].name)[1];if(field&&data[field]){f.elements[i].value=data[field]}}}return f};f.fail=typeof f.fail=="function"?f.fail:function(res){if(res.form){for(var i=0;i<this.elements.length;i++){if(res.form.hasOwnProperty(this.elements[i].name)){g.css.el(this.elements[i].parentElement).add("has-error")}else{g.css.el(this.elements[i].parentElement).del("has-error")}return true}}return false};f.send=function(callback){var data=f.prepare(f.validator),before=true;if(f.getAttribute("valid")!=0){if(typeof f.before=="function"){before=f.before.call(this)}if(before==undefined||!!before){g.xhr(Object.assign({method:f.rest,url:f.action,data:data,done:typeof callback=="function"?function(){var result=callback.apply(this,arguments);if(typeof f.after=="function"){return f.after.call(this,result)}return f}:function(){var res={result:"error"};f.response=this.responseText;if([200,206].indexOf(this.status)<0){res.message=this.status+": "+this.statusText}else{try{res=JSON.parse(this.responseText)}catch(e){res.message="Cервер вернул не коректные данные"}}if(res.result=="error"){if(typeof f.fail=="function"){f.fail.call(f,res)}}else{if(res.result=="ok"){if(typeof f.done=="function"){f.done.call(f,res)}}}if(typeof f.after=="function"){f.after.call(f,res,res.result=="ok")}return f}},f.opt))}}else{f.setAttribute("valid",1)}return f};return f},enumerable:false});var tmpl=function tmpl(str,data,cb,opt){var self=Object.merge({tmplContext:undefined,onTmplError:function(type,id,str,args,e){console.error("ERROR["+type+"] jsRoll.tmpl()",[id,str],args,e);return}},typeof this!=="undefined"?this:{});var args=arguments;args[1]=args[1]||{};var compile=function(str){var _e="_e"+uuid().replace(/-/g,""),source=str.replace(/(\/\*[\w\'\s\r\n\*]*\*\/)|(\/\/[^\r\n]*)|(\<![\-\-\s\w\>\/]*\>)/igm,"").replace(/\>\s+\</g,"><").trim(),tag=["{%","%}"];if(!source.match(/{%(.*?)%}/g)&&source.match(/<%(.*?)%>/g)){tag=["<%","%>"]}return source.length?new Function(_e,"var p=[], print=function(){ p.push.apply(p,arguments); }; with("+_e+"){p.push('"+source.replace(/[\r\t\n]/g," ").split(tag[0]).join("\t").replace(re("((^|"+tag[1]+")[^\t]*)'","g"),"$1\r").replace(re("\t=(.*?)"+tag[1],"g"),"',$1,'").split("\t").join("');").split(tag[1]).join("p.push('").split("\r").join("\\'")+"');} return p.join('');"):undefined},build=function(str,id){var isId=typeof id!=="undefined",data={},pattern=null;var result=null,after,before,a,pig=g.document.getElementById(id);try{if(pig){var nn=undefined;Array.prototype.slice.call(pig.attributes).forEach(function(i){if(i&&/^tmpl-*/i.test(i.nodeName.toString())&&(nn=i.nodeName.toString().replace(/^tmpl-/i,""))){try{data[nn]=JSON.parse(i.value)}catch(e){data[nn]=i.value}}});if(a=pig.getAttribute("arguments")){try{data=Object.merge(JSON.parse(a)||{},data)}catch(e){return self.onTmplError("tmpl-arguments",id,str,args,a)}}args[1]=Object.merge(args[1],data);if(before=pig.getAttribute("before")){func(before,pig,args)}}else{if(opt&&typeof opt.before=="object"){args[1]=Object.assign(args[1],opt.before)}else{if(opt&&typeof opt.before=="function"){opt.before.call(this,args)}}}if(isId&&g.tmpl.cache[id]){pattern=g.tmpl.cache[id]}else{pattern=compile(str);if(isId){g.tmpl.cache[id]=pattern}}if(!pattern){return self.onTmplError("tmpl-pattern",id,str,args,"пустой шаблон")}result=pattern.call(g.tmpl,args[1]);if(typeof cb=="function"){self.tmplContext=cb.call(pattern||g.tmpl,result)||g.tmpl}else{if(self.tmplContext instanceof HTMLElement||cb instanceof HTMLElement&&(self.tmplContext=cb)){self.tmplContext.innerHTML=result}}if(self.tmplContext&&pig&&(after=pig.getAttribute("after"))){func(after,self.tmplContext,args)}else{if(opt&&typeof opt.after=="function"){opt.after.apply(self.tmplContext,args)}}}catch(e){return self.onTmplError("tmpl-build",id,str,args,e)}return result};try{switch(true){case str.match(is_url)?true:false:var id=str.replace(/(\.|\/|\-)/g,"");if(g.tmpl.cache[id]){return build(null,id)}var opt=opt||{};opt.rs=Object.assign(opt.rs||{},{"Content-type":"text/x-template"});return g.xhr(Object.assign({url:str,async:(typeof cb=="function"),done:function(e){if([200,206].indexOf(this.status)<0){console.warn(this.status+": "+this.statusText)}else{build(this.responseText,id)}}},opt));case !/[^\w\-\.]/.test(str):return build(g.document.getElementById(str).innerHTML,str);default:return build(str)}}catch(e){return self.onTmplError("tmpl",id,str,args,e)}};tmpl.cache={};g.tmpl=tmpl;var storage=function(s){var s=s||g.localStorage;try{s.setItem("test","1");s.removeItem("test")}catch(e){return{p:[],setItem:function(key,value){this.p.push(key);this[key]=value},getItem:function(key){if(this.hasOwnProperty(key)){return this[key]}return null},removeItem:function(key){if(this.hasOwnProperty(key)){delete this.p[key];delete this[key]}},clear:function(){this.p.forEach(function(item){delete this[item]});this.p=[]}}}return s};g.storage=storage();var dom=function(){var p;try{if("DOMParser" in g){p=new DOMParser();return function(d,mime){try{return p.parseFromString(d,mime||"text/xml")}catch(e){return null}}}else{if("ActiveXObject" in g){p=new ActiveXObject("Microsoft.XMLDOM");p.async="false";return function(d,mime){try{p.instance.loadXML(d);return p}catch(e){return null}}}}return null}catch(e){return undefined}};g.dom=dom()}(window));(function(d,h){"use strict";var a=function(g){this.instance=this.el(g).instance;return this};a.prototype={el:function(g){this.instance=typeof g==="string"?d.document.querySelector(g):g;return this},style:function(i,g){this.instance.style[i]=g;return this},has:function(j){var i=this.instance.className;if(typeof j!=="string"&&i){return null}var g=[];j.split(" +").forEach(function(m,l,k){if(i.match(re("(?:^|\\s)"+m+"(?!\\S)"))){g.push(m)}});return g.length?g:null},add:function(g){if(this.instance&&!this.has(g)){this.instance.className+=" "+g}return this},del:function(i){var g=this.instance;if(i&&g){i.split(" +").forEach(function(l,k,j){g.className=g.className.replace(re("(?:^|\\s)"+l+"(?!\\S)"),"").trim()})}return this},tgl:function(g){if(this.instance){if(!this.has(g)){this.instance.className+=" "+g}else{this.instance.className=this.instance.className.replace(re("(?:^|\\s)"+g+"(?!\\S)"),"").trim()}}return this}};d.css=new a(d);var e=function(g){if(g.hasOwnProperty("ui")){return g}this._parent=null;this.instance=g||d;if(g){this.instance.css=new a(this.instance);this.wrap(this.instance.parentElement)}return this};e.prototype={wrap:function(i,g){if(i&&typeof i==="object"&&!i.hasOwnProperty("ui")){i.ui=new e(i);if(typeof g=="string"){d[g]=i}}return i},el:function(j,g){var i=null;if(typeof j==="string"){if(!j.match(/^#*/)){i=d.document.getElementById(j.replace(/^#/,""))}else{i=this.instance.querySelector(j)}}else{if(typeof j==="object"){i=j}}if(i){if(!i.hasOwnProperty("ui")){i.ui=new e(i)}if(typeof g==="string"){d[g]=i}else{if(typeof g==="function"){g.call(i,arguments)}}}return i},els:function(j,i,g){if(typeof j==="string"){var k=[];j.split(",").forEach((function(l){k.push.apply(k,Array.prototype.slice.call(this.instance.querySelectorAll(l.trim())||{}).map(function(o,n,m){if(!o.hasOwnProperty("ui")){o.ui=new e(o)}if(typeof i=="function"){i.call(o,n,m)}return o}))}).bind(this));if(typeof i=="string"){d[i]=k}else{if(typeof g=="string"){d[g]=k}}return k}else{return[]}},attr:function(j,k){if(j==h){var l={},q;for(var m in this.instance.attributes){l[(q=this.instance.attributes[m].nodeName)]=this.instance.getAttribute(q)}return l}else{if(typeof j==="object"&&typeof k==="undefined"){for(var m in j){if(!/\d+/.test(m)){this.instance.setAttribute(m,j[m])}}return this}else{if(typeof j==="string"&&typeof k==="undefined"){var g=j.indexOf("*")!=-1?re(j.split("*")[0],"i"):null;if(g){var o={};Array.prototype.slice.call(this.instance.attributes).forEach(function(t,s,n){var r=t.nodeName.toString();if(g.test(r)&&(r=r.replace(g,""))){o[r]=t.value}});return o}else{try{return JSON.parse(this.instance.getAttribute(j))}catch(p){return this.instance.getAttribute(j)}}}else{if(typeof j==="string"&&k){if(!/\d+/.test(j)){if(typeof k==="object"){this.instance.setAttribute(j,JSON.stringify(k))}else{this.instance.setAttribute(j,k)}}}}}}return this},tmpl:function(k,j,g,i){tmpl.apply(this.instance,[k,j,g,i])},merge:function(){merge.apply(this.instance,arguments);return this.instance},src:function(i){var g=i?i:this.instance;return new e(g.srcElement||g.target)},on:function(k,j,i){var g=this;k.split(",").forEach(function(l){g.instance.addEventListener(l.trim(),j,!!i)});return this.instance},dom:function(j,i){if(!j||typeof j!=="string"){return null}var g=d.dom(j,i).childNodes;return g.length>1?g:g[0]},get active(){return this.instance===d.document.activeElement},focus:function(i){var g;if(i){g=(typeof i=="string"?this.el(i):i)}else{g=this.instance}if(g){d.setTimeout(function(){g.focus();return false},0)}return g}};d.ui=new e(document);Object.defineProperty(d,"selected",{get:function c(){return d.getSelection?d.getSelection().toString():d.document.selection.createRange().text}});function b(){if(d.getSelection){if(d.getSelection().empty){d.getSelection().empty()}else{if(d.getSelection().removeAllRanges){d.getSelection().removeAllRanges()}}}else{if(d.document.selection){d.document.selection.empty()}}}d.selection=b;function f(i,g){if(!i){return false}var g=Object.assign({display:false,timeout:500,context:null},g),j=function(k){if(!k.hasOwnProperty("fade")){k.faded=k.style.opacity==0;k.opt=g;k.opt.context=typeof g.context==="string"?k.el(g.context):k;Object.defineProperty(k,"fade",{get:function(){return k.faded},set:function(l){if(l){k.css.add("fade");if(k.opt.display){setTimeout(function(){k.style.display="none"},k.opt.timeout)}return k.faded=true}else{if(k.opt.display){k.style.display=k.getAttribute("display")?k.getAttribute("display"):"inherit"}k.css.del("fade");return k.faded=false}},enumerable:true,configurable:true})}};if(typeof i==="string"){d.ui.els(i).forEach(function(l,m,k){j(l)})}else{if(i instanceof HTMLElement){j(i)}else{if(typeof i==="object"){i.forEach(function(l,m,k){j(l)})}else{return false}}}}d.fader=f}(window));(function(b,d,h){"use strict";if(typeof d==="undefined"){return false}var e=function(i,g){if(i&&typeof i==="object"&&typeof(g||{}).slave==="object"){var g=Object.assign({slave:[],event:null,eh:null},g);b.ui.wrap(i).slave=g.slave;if(g.eh){i.slave.forEach(function(l,k,j){l.ui.on(g.event,g.eh)})}i.ui.on(g.event,function(k){var j=k.type;this.slave.forEach(function(n,m,l){n.dispatchEvent(new Event(j))})});return i}return h};b.group=e;b.config={app:{container:'[role="workspace"]'},msg:{container:".alert.alert-danger",tmpl:"alert-box"},spinner:".locker.spinner",popup:{wnd:".b-popup",container:".b-popup .b-popup-content"}};var f=function(g){this.route=router;this.registry={};this.dim={};this.instance=g||b;return this};f.prototype={bootstrap:function(g){this.route.set(g).chk(g).lsn();return this},widget:function(i,l,m,k){var j=this,g=typeof i.root=="string"?b.ui.el(i.root):i.root;tmpl(l,m,function(n){if(g&&n&&(g.innerHTML=n)){j.implement(g,i.event||[]);j.inject(i.root,g,i.code||k&&k.code)}},k);return this},event:function(g,i){this.registry[g]=i;return this},implement:function(j,i){var g=this;(i||[]).forEach(function(l,m){for(var k in g.registry[l]){switch(typeof g.registry[l][k]){case"object":j.ui.els(l,function(){this.ui.on(g.registry[l][k][0],g.registry[l][k][1]);return this});break;case"string":j.ui.els(l,function(){this.ui.on(g.registry[l][0],g.registry[l][1]);return this});return;case"function":g.registry[l][k].call(j.ui.els(l),g.dim[l]||{})}}});return g},variable:function(g,i){if(!g){return h}if(!g.hasOwnProperty("dim")){Object.defineProperty(g,"dim",{get:function(){try{return b.app.dim[i]||(b.app.dim[i]=Object.assign(JSON.parse(storage.getItem(i)||""),{self:g}))}catch(j){b.app.dim[i]={};b.app.dim[i].self=g;return b.app.dim[i]}}});b.app.dim[i]={};b.app.dim[i].self=g;g.store=function(j){var k={};Object.keys(b.app.dim[i]).forEach(function(l){if(j.indexOf(l)!=-1){k[l]=b.app.dim[i][l]}});storage.setItem(i,JSON.stringify(k));return this}}return g},inject:function(g,j,i){if(typeof i==="function"){i.apply(this.variable(j,g),arguments)}return false},elem:d.el(b.config.msg.container),msg:{show:function(i,g){tmpl(b.config.msg.tmpl,i,b.app.elem);b.app.elem.fade=false;if(typeof g=="undefined"||!g){b.app.elem.fade=true}return b.app.elem}},spinner_count:0,spinner_element:d.el(b.config.spinner),set spinner(g){g?this.spinner_count++:this.spinner_count--;this.spinner_count>0?this.spinner_element.style.display="block":this.spinner_element.style.display="none"},get spinner(){if(this.spinner_element.style.display=="none"){return false}return true},before:function(){b.app.spinner=true},after:function(){b.app.spinner=false},list:b,popupEvent:function(g){if(g.keyCode==27){if(!b.app.elem.css.has("fade")){clearTimeout(b.app.elem.timer);b.app.elem.fade=true}else{b.app.popup()}}},popup:function(m,l,k){var i=this;this.wnd=this.wnd||d.el(b.config.popup.wnd);if(arguments.length&&!this.wnd.visible){this.container=this.container||d.el(b.config.popup.container);var g=false,j={onTmplError:function(){b.msg.show({message:"Ошибка выполнения приложения!"});console.error(arguments);g=true}};tmpl.apply(j,[m,l,this.variable(this.container,"popupBox"),k]);if(!g){b.addEventListener("keydown",b.app.popupEvent);i.container.css.del("is-(valid|invalid|warning|spinner)");i.wnd.fade=g=false}}else{b.removeEventListener("keydown",i.popupEvent);i.container.innerHTML=null;i.wnd.fade=true;if(i.list){i.list.ui.focus('[role="popup-box"]')}}return this},fader:function(i,g){b.fader(i,g);return this},download:function(g,i){return b.xhr(Object.assign({responseType:"arraybuffer",url:g,done:function(p,s){if([200,206].indexOf(this.status)<0){f.msg.show({message:this.status+": "+this.statusText+" (URL: "+g+")"})}else{try{var j=b.uuid();if(i&&i.hasOwnProperty("filename")){j=i.filename}else{var l=this.getResponseHeader("Content-Disposition");if(l&&l.indexOf("attachment")!==-1){var m=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;var o=m.exec(l);if(o!=null&&o[1]){j=o[1].replace(/['"]/g,"")}}}var q=this.getResponseHeader("Content-Type");var k=b.bb(this.response,{type:q});if(typeof b.navigator.msSaveBlob!=="undefined"){b.navigator.msSaveBlob(k,j)}else{var n=b.URL.createObjectURL(k);if(j){var r=document.createElement("a");if(typeof r.download==="undefined"){b.open(n)}else{r.href=n;r.download=j;document.body.appendChild(r);r.click();setTimeout(function(){document.body.removeChild(r)},100)}}else{b.open(n)}setTimeout(function(){URL.revokeObjectURL(n)},100)}}catch(p){console.error("сервер вернул не коректные данные",p)}}}},i))}};b.app=new f(b.document);b.paginator=function(j,i){var g=this,k=j.paginator;if(k){this.ui.el(".paginator",function(l){tmpl("paginator-box",{pages:Math.ceil(k.count/10),page:k.page,model:i},this)})}};var a=function(j,g){var k=[],i=0;if(j){if(typeof g==="object"&&g.hasOwnProperty("page")){i=g.page}j.forEach(function(o,n,l){var m=["INPUT","SELECT"].indexOf(o.tagName)>-1?o:o.ui.el("input,select");if(m){k.push(m);if(typeof g==="object"&&g.hasOwnProperty(m.name)){m.value=g[m.name]}if(m.tagName==="INPUT"){input_validator(m)}}});return{el:k,index:i,__valid:true,get valid(){var l=this;l.__valid=true;this.el.forEach(function(o,n,m){l.__valid&=input_validator(o)});return this.__valid},set params(m){var n={},l=this;l.__valid=true;if(typeof m==="object"){n=m}else{if(typeof m==="string"){n=location.decoder(m)}}if(n.hasOwnProperty("page")){this.index=n.page}this.el.forEach(function(q,p,o){if(n.hasOwnProperty(q.name)){q.value=n[q.name]}else{q.value=""}l.__valid&=input_validator(q)})},get params(){var m={},l=this;this.el.forEach(function(p,o,n){if(p.value){switch(p.tagName){case"INPUT":m[p.name]=p.value;input_validator(p);break;case"SELECT":if(p.value!=0){m[p.name]=p.value}break}}});return m},diff:function(l){var m=this.params;return Object.keys(m).concat(Object.keys(l)).reduce(function(o,n){if(m[n]!==l[n]){o[n]=l[n]}return o},{})},get uri(){var l=this.params;l.page=this.index;return location.encoder(l)},callback:function(o){var l=true,q=Object.keys(o.error||{}),m=Object.keys(o.warning||{}),p=Object.keys(o.filter||{});if(typeof o==="undefined"){return o}if(q.length||m.length||p.length){for(var n in this.el){if(q.length&&q.indexOf(this.el[n].name)>-1){this.el[n].status="error";l&=false}else{if(m.length&&m.indexOf(this.el[n].name)>-1){this.el[n].status="warning";l&=false}else{if(p.length&&p.indexOf(this.el[n].name)>-1){l&=input_validator(this.el[n])}}}}}return l}}}return null};b.filter=a;var c=function(r,m,i){if(!r){return h}var o=r.match(/^\/\w+.*/i)?"//"+location.hostname+r:r;var j=function(l,u,t){var n=[];if(typeof t=="object"){for(var p in t){n.push(p+"="+t[p])}t=n.join("&")}return xhr(Object.assign({method:u,url:l.route,data:t},l.opt))};var g={methods:m?m:["GET","POST","PUT","DELETE"],route:r,opt:i,rs:{},error:{},proc:null,before:null,after:null,abort:function(){if(this.proc){this.proc.abort()}this.proc=null},done:function(l,n){return this.rs[n]=l},fail:function(l,n){return this.error=l}};for(var k in m){var q=m[k].toLowerCase(),s=q.toUpperCase();g.rs[s]=null;g[q]=(function(l){return function(n){this.rs[l]=null;return this.proc=j(this,l,n)}}).apply(g,[s]);Object.defineProperty(g,s,{get:function(){return this.rs[s]}})}if(o){return g}else{console.warn("Can't resolve route:",r)}return{}};b.crud=c}(window,window.ui));(function(e,i,c){if(typeof i==="undefined"){return false}var a={elem:i.el(e.config.msg.container),show:function(m,l){tmpl(e.config.msg.tmpl,m,this.elem);this.elem.css.del("fade");var g=this.elem;if(typeof l=="undefined"||!l){g.timer=setTimeout(function(){g.css.add("fade")},3000)}return this.elem}};e.msg=a;e.spinner_count=0;e.spinner_element=i.el(e.config.spinner);if(e.spinner_element){Object.defineProperty(e,"spinner",{__proto__:null,enumerable:false,configurable:false,set:function(g){g?e.spinner_count++:e.spinner_count--;e.spinner_count>0?e.spinner_element.style.display="block":e.spinner_element.style.display="none"},get:function(){if(e.spinner_element.style.display=="none"){return false}return true}})}var f=function(g,l){if(g&&g.tagName){if(typeof l==="object"&&l.hasOwnProperty(g.name)){g.value=l[g.name]}else{g.value=null}return true}return false};e.setValueFromObject=f;var j=function(o,t){if(o&&(t?(t.indexOf(o.tagName)>-1):(o.tagName==="INPUT"))){var s=true,g=null,r;if(!o.hasOwnProperty("validator")&&(g=o.getAttribute("validator"))!==null){o.validator=func(g)}if((o.getAttribute("required")!==null)&&!o.value){s=false}else{if((o.getAttribute("required")===null)&&!o.value){s=true}else{if((r=o.getAttribute("pattern"))===null){s=true}else{if(!o.hasOwnProperty("testPattern")){try{var l=/[?\/](.+)(\/([igum]*$))/.exec(r)||[];o.regex=new RegExp(l[1]||r,l[3]||"");Object.defineProperty(o,"testPattern",{get:function n(){this.regex.lastIndex=0;return this.regex.test(this.value.trim())}})}catch(q){o.testPattern=false;console.error(o,r,q)}}s=o.testPattern}}}if(s&&o.hasOwnProperty("validator")){s=o.validator.call(o,s)}var m=o.type!="hidden"?o:(o.hasOwnProperty("statusInstance")?o.statusInstance:false);if(m){d(i.wrap(m));if(!s){m.status="error"}else{if(!m.disabled){if(m.value.length){m.status="success"}else{m.status="none"}}else{m.status="none"}}}else{if(o.type=="hidden"&&!s){console.warn('Error "'+o.name+'" not valid!')}}return s}return true};e.input_validator=j;var d=function(l){if(l&&!l.hasOwnProperty("status")){Object.defineProperty(l,"status",{set:function g(m){this.parentElement.css.del("has-(danger|warning|success|spinner)");this.css.del("is-(valid|invalid|warinig|spinner)");switch(m){case"error":this._status="error";this.css.add("is-invalid");this.parentElement.css.add("has-danger");break;case"warning":this._status="warning";this.css.add("is-warning");this.parentElement.css.add("has-warning");break;case"success":this._status="success";this.css.add("is-valid");this.parentElement.css.add("has-success");break;case"spinner":this._status="spinner";this.css.add("is-spinner");this.parentElement.css.add("has-spinner");break;case"none":default:this._status="none"}},get:function g(){return this._status}})}return l};e.inputer=d;e.formvalidator=function(m){var g=[];for(var l=0;l<this.elements.length;l++){if(!j(this.elements[l],["INPUT","TEXTAREA"])){g.push(this.elements[l].name+": "+(this.elements[l].value||"поле с неверными данными или нет значения!"))}}if(g.length){if(e.spinner){e.spinner=false}g.unshift("<b>ФОРМА: неверно заполнены поля формы!</b>");a.show({message:g});return false}return true};var b=function(l,g){if(l&&l.tagName){d(l).ui.on("focus",function(m){if(typeof this.status==="undefined"){j(this)}return false}).ui.on("input",function(m){j(this);return false}).ui.on("blur",function(m){j(this);return false})}};e.pattern_validator=b;var h=function(l,g){if(l&&l.tagName==="INPUT"){var m={index:0,key:null,cache:null,value:null,opt:{},delta:330,timer:null,request:null,__xhr:null,stoped:function(){if(this.owner.status="spinner"){this.owner.status="";if(this.__xhr){this.__xhr.abort()}}},delayed:function(){if(!this.timer){var n=function n(){if(this.request==this.owner.value){if(this.owner.pannel){this.owner.pannel.css.add("fade")}this.xhr()}clearTimeout(this.timer);this.timer=null;if(this.request&&this.request!="null"&&this.request!=this.owner.value){this.request=this.owner.value;this.timer=e.setTimeout(n.bind(this),this.delta)}};this.timer=e.setTimeout(n.bind(this),this.delta);this.request=this.owner.value}else{this.stoped()}return this.timer},activeItem:function(o){if(o&&this.cache.hasOwnProperty(o)){this.key=o}else{return this.owner.setValue({})}var n=this.owner,r=this.cache[this.key]||{},q={};if(n.pannel&&Object.keys(r).length){n.pannel.ui.el(".active",function(){this.css.del("active")});var p=Object.keys(r).map(function(s){return r[s]});var o=p.indexOf(n.value);if(o!=-1){n.pannel.ui.el('[value="'+o+'"]',function(){this.css.add("active")});q=Object.keys(r)[o]}}return n.setValue(q)},tmpl:function(p){var o=this.owner;this.index=-1;this.key=o.value.toLowerCase()||"null";if(o.pannel){var q=i.dom(tmpl(this.opt.tmpl,{data:p,field:o.name}));if(q){o.pannel.innerHTML=q.innerHTML}}else{o.parentElement.insertAdjacentHTML("beforeend",tmpl(this.opt.tmpl,{data:p,field:o.name}));o.parentElement.css.add("dropdown");o.pannel=o.parentElement.ui.el(".dropdown-menu.list")}if(!this.opt.wrapper){o.pannel.setAttribute("style","left:"+o.offsetLeft+"px;width:"+o.clientWidth+"px;")}this.activeItem(this.key);o.parentElement.ui.els(".dropdown-menu.list li",function(){this.ui.on("mousedown",function(r){o.value=this.innerHTML;var n=o.typeahead.cache[o.typeahead.key];o.setValue(n[parseInt(this.ui.attr("value"))]);return false})})},xhr:function(){if(this.opt.skip>this.owner.value.trim().length||(this.opt.validate&&!j(this.owner))){return this.owner.typeahead.show([])}var n=this.owner,p={};p[n.name]=n.value;var o=n.value?n.value.toLowerCase():"null";if((this.cache===null||!this.cache.hasOwnProperty(o)||o=="null")&&n.ui.attr("url")){n.status="spinner";this.__xhr=xhr({url:location.update(n.ui.attr("url"),p),rs:this.opt.rs,before:function(){n.status="spinner";if(n.pannel){n.pannel.css.add("fade")}},after:function(){if(n.status="spinner"){n.status=""}},done:function(s){if([200,206].indexOf(this.status)<0){a.show({message:this.status+": "+this.statusText})}else{try{var q=JSON.parse(this.responseText);if(q.result=="error"){n.status="error"}else{var r=(q.data||[]).map(function(v,u,t){try{return JSON.parse(v)}catch(w){return v}});if(n.typeahead.cache===null){n.typeahead.cache={}}n.typeahead.cache[o]=r;n.typeahead.activeItem(o);n.typeahead.show(r)}}catch(s){console.error(s,"сервер вернул не коректные данные");n.status="error"}}return this},fail:function(q){console.error("typeahead",q)}})}else{if(this.cache.hasOwnProperty(o)){n.typeahead.show(this.cache[o])}}return this},show:function(o){var n=this.owner;if(n.ui.active){if(o&&Object.keys(o).length){this.tmpl(o);n.pannel.css.del("fade")}else{if(n.pannel){n.pannel.css.add("fade")}}}return false},onKeydown:function(s){var p=(s.charCode&&s.charCode>0)?s.charCode:s.keyCode;if(this.typeahead.cache!==null){var r=this.typeahead,n,q=r.cache[r.key],o={};if(q&&typeof q==="object"){switch(p){case 38:if(r.index>0){r.index--}else{r.index=Object.keys(q).length-1}break;case 40:if(r.index<Object.keys(q).length-1){r.index++}else{r.index=0}break;case 13:r.stoped();if(this.pannel){this.pannel.css.add("fade")}default:return false}o=q[(n=Object.keys(q)[r.index])];this.value=(typeof o==="object"?o[this.name]:o)||"";this.selectionStart=this.selectionEnd=this.value.length;if(this.pannel){this.pannel.ui.el(".active",function(){this.css.del("active")});this.pannel.ui.el('[value="'+n+'"]',function(){this.css.add("active")})}}else{if(p!=9){o={}}}this.setValue(o)}return false},onChange:function(r){var n,q=this.typeahead,p={};if((n=this.value.toLowerCase())&&(q.cache||{}).hasOwnProperty(n)){for(var o in q.cache[n]){if(q.cache[n][o][this.name]===n){p=q.cache[n][o]}}}this.setValue(p);j(this);return false},onFocus:function(n){if(this.value.length){this.setSelectionRange(this.value.length,this.value.length)}if(!this.value.length||(this.value.length&&["none","success"].indexOf(this.status)==-1)){this.typeahead.delayed()}return false},onInput:function(n){if(this.pannel){this.pannel.css.add("fade")}this.typeahead.delayed();j(this);return false},onBlur:function(r){if(this.pannel){this.pannel.css.add("fade")}var o={};if(this.typeahead.cache!==null){var n=this,q=this.typeahead,p=q.cache[q.key];if(q.timer){clearTimeout(q.timer);q.timer=null}if(p&&typeof p==="object"){Object.keys(p).forEach(function(s){if(p[s][n.name]==n.value){o=p[s]}})}}this.setValue(o);j(this);return false}};if(!l.typeahead){l.typeahead=m;l.typeahead.opt=Object.assign({wrapper:false,skip:0,validate:false,tmpl:"typeahead-tmpl",rs:{}},g);l.setValue=function(n){this.typeahead.value=typeof n==="object"?n:{};if(l.typeahead.opt.hasOwnProperty("fn")&&typeof l.typeahead.opt.fn==="function"){if(this.typeahead.cache!==null){l.typeahead.opt.fn.call(l,this.typeahead.value)}else{l.typeahead.opt.fn.call(l,c)}j(l)}};l.typeahead.owner=d(l);l.ui.on("focus",m.onFocus).ui.on("input",m.onInput).ui.on("blur",m.onBlur).ui.on("keydown",m.onKeydown).ui.on("change",m.onChange);if(!l.ui.attr("tabindex")){l.ui.attr("tabindex","0")}}return l}};e.typeahead=h;var k=function(l,n,g){if(l.tagName==="INPUT"){var m=d(l);m.cleared=g==c?true:!!g;if(n){m.maxLength=m.ui.attr("placeholder",n||"").attr("placeholder").length}if(!m.ui.attr("tabindex")){m.ui.attr("tabindex","0")}if(m&&!m.hasOwnProperty("insertDigit")){m.insertDigit=function(t,r){if(r){var v=this.value.indexOf(r);var s=/\d/.test(t)?1:0;var o=this.ui.attr("placeholder").substr(v,r.length).indexOf("_");if(o>0){v+=o}this.value=this.value.substr(0,v)+(/\d/.test(t)?t:"")+this.ui.attr("placeholder").substr(v+s,r.length-s)+this.value.substr(v+r.length,this.value.length);this.selectionStart=this.e1=this.selectionEnd=this.s1=v+1}else{if(/\d/.test(t)&&(this.value||this.ui.attr("placeholder")).indexOf("_")>-1){var u=this.value||this.ui.attr("placeholder");var v=u.indexOf("_");var q=u.match(/\d/)?(u.indexOf(u.match(/\d/))):-1;if(v<=this.selectionStart||q<0||q>v){this.value=(this.value||this.ui.attr("placeholder")).replace("_",t);v=(this.value||this.ui.attr("placeholder")).indexOf("_");this.e1=this.selectionEnd=this.selectionStart=this.s1=v>-1?v:this.value.length}else{if(v>this.selectionStart){this.s1=v=this.selectionStart;var u=t+(this.value.substr(v,this.value.length).match(/\d+/g)||[]).join("")+"_";for(var p=0;p<u.length-1;p++){v=this.value.indexOf(u.charAt(p+1),v);if(v>-1){this.value=this.value.substr(0,v)+u.charAt(p)+this.value.substr(v+1,this.value.length)}}this.selectionStart=this.e1=this.selectionEnd=++this.s1}}}}this.dispatchEvent(new Event("change"));return this.selectionStart};m.init=function(o){var q=this.value;var r=0;if(q){this.value=this.ui.attr("placeholder");r=this.value.indexOf("_");for(var p in q){if(/[\d_]/.test(q[p])){this.value=this.value.replace("_",q[p]);r=this.value.indexOf("_")}}}else{if(!o){this.value=this.ui.attr("placeholder")}r=this.ui.attr("placeholder").indexOf("_")}if(o){this.value=this.value.replace(/\_/g,"")}return this.e1=this.selectionEnd=this.selectionStart=this.s1=(r>-1?r:this.value.length)}}m.init(true);m.ui.on("keydown",function(u){if(this.ui.attr("placeholder").length&&!this.value){this.value=this.ui.attr("placeholder");this.e1=this.selectionEnd=this.selectionStart=this.s1=0}else{this.s1=this.selectionStart;this.e1=this.selectionEnd}var y=u.charCode||u.keyCode||0;if([13,27,82].indexOf(y)!=-1){return true}var x=((y>=96&&y<=105))?(y-96).toString():String.fromCharCode(y);switch(y){case 8:if(selected){var w=this.value.indexOf(selected);this.value=this.value.substr(0,w)+this.ui.attr("placeholder").substr(w,selected.length)+this.value.substr(w+selected.length,this.value.length);var p=this.ui.attr("placeholder").substr(w,selected.length).indexOf("_");if(p>0){w+=p}this.selectionStart=this.e1=this.selectionEnd=this.s1=w}else{this.e1=this.s1=--this.selectionStart;--this.selectionEnd;while((this.s1>=0)&&!/\d/.test(this.value.charAt(this.s1))){this.s1=--this.selectionStart;--this.selectionEnd}if(this.s1>=0&&/\d/.test(this.value.charAt(this.s1))){this.value=this.value.substr(0,this.s1)+"_"+this.value.substr((this.s1+1),this.value.length)}else{this.s1=this.e1+1}this.selectionStart=this.selectionEnd=this.s1}this.dispatchEvent(new Event("change"));break;case 9:var o=null;var z=u.shiftKey?-1:1;var s=parseInt(this.ui.attr("tabindex"))+z;if(s>0){while(o=i.el('[tabindex="'+s+'"]')){if(o.ui.attr("disabled")){s+=z}else{o.ui.focus();break}}}if(s<=1&&z<0){return u.preventDefault()}u.stopPropagation();return false;case 37:this.s1=--this.selectionStart;this.e1=--this.selectionEnd;break;case 39:this.s1=++this.selectionStart;break;case 46:var q=this.value.slice(this.selectionStart),t,v=this.ui.attr("placeholder").slice(this.selectionStart);if(selected){t=(this.value.substr(this.selectionStart+selected.length,this.value.length).match(/\d+/g)||[]).join("");this.e1=this.s1}else{t=(this.value.slice(this.selectionStart).match(/\d+/g)||[]).join("").slice(1)}for(var r in t){v=v.replace("_",t[r])}this.value=this.value.replace(q,v);this.selectionStart=this.s1;this.selectionEnd=this.e1;break;default:this.insertDigit(x,selected)}u.preventDefault();u.stopPropagation();return/\d/.test(x)}).ui.on("focus",function(o){this.init(false);return false}).ui.on("blur",function(o){if(this.value.match(/[\d]+/g)){this.value=!this.cleared?this.value:this.value.replace(/\_/g,"")}else{this.value=""}j(this);return false}).ui.on("paste",function(p){var q=p.clipboardData.getData("Text").match(/\d+/g)?p.clipboardData.getData("Text").match(/\d+/g).join(""):"";for(var o in q){this.insertDigit(q[o],selected)}return false})}return m};e.maskedigits=k}(window,window.ui));