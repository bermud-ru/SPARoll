
/**
 * @app jsroll.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA javascritp framework
 * @author Андрей Новиков <andrey@novikov.be>
 * @data 21/03/2016 17:42
 */

(function(j,e){"use strict";var h=("onload" in new XMLHttpRequest())?XMLHttpRequest:XDomainRequest;var b=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var s=Math.random()*16|0,g=t=="x"?s:(s&3|8);return g.toString(16)})};j.uuid=b;var f=function(r){var s=/[?&]([^=#]+)=([^&#]*)/g,u={},g;try{while(g=s.exec((r||j.location.search))){if((m1=decodeURIComponent(g[1]))&&(m2=decodeURIComponent(g[2]))&&!u.hasOwnProperty(m1)){u[m1]=m2}}}catch(t){return null}return u};j.location.params=f;function i(s,g){var r=null;s&&(r=setInterval(function(){s.style.opacity=s.style.opacity&&s.style.opacity>0?(parseFloat(s.style.opacity)-0.1).toFixed(1):"1";if(parseFloat(s.style.opacity)<=0){if(g&&typeof g==="function"&&g.call(s)){g.call(s)}s.style.display="none";clearInterval(r)}},typeof g==="number"?g:25))}j.fadeOut=i;function m(s,g){var r=null;s&&(r=setInterval(function(){if(s.style.display=="none"){s.style.display="inherit"}s.style.opacity=s.style.opacity&&s.style.opacity<1?(parseFloat(s.style.opacity)+0.1).toFixed(1):"0";if(parseFloat(s.style.opacity)>=1){if(g&&typeof g==="function"&&g.call(s)){g.call(s)}clearInterval(r)}},typeof g==="number"?g:25))}j.fadeIn=m;function c(t,s){var r={result:{},data:[]};if(!s||(typeof s==="function"&&s.call(t,r))){for(var g=0;g<t.elements.length;g++){r.data.push((t.elements[g].name||g)+"="+encodeURIComponent(t.elements[g].value))}}t.setAttribute("valid",JSON.stringify(r.result));return r.data.join("&")}j.JSON.form=c;function p(t){var s=!!(history.pushState)?1:0;var g=t;return{root:g,rt:[],itv:0,base:s?window.location.pathname+window.location.search:"",clr:function(r){return r.toString().replace(/\/$/,"").replace(/^\//,"")},frgm:s?function(){var r=this.clr(decodeURI(location.pathname+location.search)).replace(/\?(.*)$/,"");return this.clr(this.root!="/"?r.replace(this.root,""):r)}:function(){var r=window.location.href.match(/#(.*)$/);return r?this.clr(r[1]):""},add:function(u,r){if(typeof u=="function"){r=u;u=""}this.rt.push({re:u,handler:r});this.rt=this.rt.sort(function(w,v){if(w.re.toString().length<v.re.toString().length){return 1}if(w.re.toString().length>v.re.toString().length){return -1}return 0});return this},rm:function(u){for(var r in this.rt){if(this.rt[r].handler===u||this.rt[r].re.toString()===u.toString()){this.rt.splice(r,1);return this}}return this},chk:function(u){var w=u||this.frgm();for(var v in this.rt){var r=w.match(this.rt[v].re);if(r){r.shift();this.rt[v].handler.apply({},r);return this}}return this},lsn:function(){var u=this,v=u.frgm(),r=function(){if(v!==u.frgm()){v=u.frgm();u.chk(v)}return u};clearInterval(u.itv);u.itv=setInterval(r,50);return u},set:s?function(r){history.pushState(null,null,this.root+this.clr((r||"")));return this}:function(r){window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+(r||"");return this}}}j.router=p("/");function l(){var g=function(t,s){return j.dispatchEvent(new CustomEvent(t,{detail:s}))},r=function(u,t,s){return j.addEventListener(u,t,!!s?s:false)};j.onbeforeunload=function(s){s.preventDefault()};j.onclickhandler=function(s){if(j.eventhandler.onclick(s)){s.preventDefault();s.stopPropagation()}};r("onbeforeunload",j.onbeforeunload.bind(j),false);r("click",j.onclickhandler.bind(j),true);return{set onbeforeunload(s){j.onbeforeunload=s},onclick:function(s){return false},event:g,bind:r}}j.eventhandler=l();function a(){var g={tuple:[],cache:[],donned:function(r){return false},failed:function(r){return false},pool:function(s,r){this.chain.cache.push(this);if(this.chain.tuple.length==this.chain.cache.length){this.chain.donned.apply(this.chain,this.chain.cache)}},done:function(r){this.donned=r},fail:function(r){this.failed=r}};g.tuple=Array.prototype.slice.call(arguments).map(function(r){r.onload=function(){g.pool.apply(r,arguments)};r.chain=g;return r});return g}j.chain=a;function q(){var g=new h();if(!g){return null}if(!g.hasOwnProperty("ref")){g.ref={}}g.request=function(u){var s=Object.assign({method:"GET"},u);s.rs=Object.assign({"Content-type":"application/x-www-form-urlencoded"},u.rs);var v=s.method+"_"+(s.url?s.url.replace(/(\.|:|\/|\-)/g,"_"):j.uuid());var t=new q();t.isLoad=false;if((["GET","DELETE"].indexOf(s.method.toUpperCase())>=0)&&s.data){s.url=(s.url||j.location)+"?"+s.data;s.data=null}t.open(s.method,s.url||j.location,s.async||true,s.username||e,s.password||e);if(s.rs){for(var r in s.rs){t.setRequestHeader(r.trim(),s.rs[r].trim())}}t.send(s.data||null);t.id=v;s.result&&(t.result=g.result(s.result));s.process&&(t.process=g.process(s.process));return g.ref[v]=t};g.result=function(r){g.onload=function(s){this.isLoad=true;return r.call(this,s)};return this};g.process=function(r){g.onreadystatechange=function(s){return r.call(this,s)};return this};return g}j.xhr=q();var o=function(r,u,t){var s=Object.assign({method:"GET",async:false},t);s.rs=Object.assign({"Content-type":"application/x-www-form-urlencoded"},t.rs);o.src[u]=new h();if(s.async){o.src[u].onload=function(x){var w=n.cache[u]=d(this.responseText);for(var v in o.pool[u]){typeof o.pool[u][v].cb==="function"?o.pool[u][v].cb.call(this,(o.pool[u][v].data?w(o.pool[u][v].data):w)):o.pool[u][v].cb.async.call(this,(o.pool[u][v].data?w(o.pool[u][v].data):w))}o.pool[u]=e}}o.src[u].open(s.method,r,!!s.async?true:false);if(s.rs){for(var g in s.rs){o.src[u].setRequestHeader(g.trim(),s.rs[g].trim())}}o.src[u].send(null);if(!s.async){return(o.src[u].status!=200?"":o.src[u].responseText)}return""},d=function(g){return new Function("_e","var p=[], print=function(){ p.push.apply(p,arguments); };with(_e){p.push('"+g.replace(/[\r\t\n]/g," ").split("{%").join("\t").replace(/((^|%})[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%}/g,"',$1,'").split("\t").join("');").split("%}").join("p.push('").split("\r").join("\\'")+"');} return p.join('').replace(/<%/g,'{%').replace(/%>/g,'%}');")},n=function n(x,v,r){var g=x.match(/^(?:https?:\/\/)?(?:(?:[\w]+\.)(?:\.?[\w]{2,})+)?([\/\w]+)(\.[\w]+)/i);try{if(g){x=x.replace(/(\.|\/|\-)/g,"");if(typeof r==="function"||typeof r==="object"){if(typeof o.pool[x]==="undefined"){o.pool[x]=[{data:v,cb:r}];return o(g.input,x,(typeof r==="object"?r:{async:r}))}else{var s=o.pool[x];s.push({data:v,cb:r});return""}}else{n.cache[x]=n.cache[x]||d(o(g.input,x,false))}}var u=!/[^\w\-\.]/.test(x)?n.cache[x]=n.cache[x]||n(j.document.getElementById(x).innerHTML):d(x);var t=v?u(v):u;if(typeof(r)==="function"){return r.call(n,t)}else{return t}}catch(w){console.error(w);return""}};o.src=[];o.pool=[];n.cache={};j.tmpl=n;var k=function(g){var g=g||j.localStorage;try{g.setItem("test","1");g.removeItem("test")}catch(r){return{p:[],setItem:function(s,t){this.p.push(s);this[s]=t},getItem:function(s){if(this.hasOwnProperty(s)){return this[s]}return null},removeItem:function(s){if(this.hasOwnProperty(s)){delete this.p[s];delete this[s]}},clear:function(){this.p.map(function(s){delete this[s]});this.p=[]}}}return g};j.storage=k()}(window));