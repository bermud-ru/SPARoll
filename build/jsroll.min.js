
 /**
 * @app jsroll.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA javascritp framework
 * @author Андрей Новиков <andrey@novikov.be>
 * @status beta
 * @version 0.1.0
 * @revision $Id: jsroll.min.js 0004 22/12/2016 00:24:24Z $
 */

(function(g,undefined){"use strict";var xmlHttpRequest=("onload" in new XMLHttpRequest())?XMLHttpRequest:XDomainRequest;var uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16)})};g.uuid=uuid;var params=function(search){var re=/[?&]([^=#]+)=([^&#]*)/g,p={},m;try{while(m=re.exec((search||g.location.search))){if(m[1]&&m[2]){p[decodeURIComponent(m[1])]=decodeURIComponent(m[2])}}}catch(e){return null}return p};g.location.params=params;var update=function(search,params){var u=[],h=[],url=g.location.search,kv=params||{};if(typeof search==="string"){url=search}else{kv=search}var p=g.location.params(url);if(url.indexOf("#")>-1){h=url.split("#")}if(url.indexOf("?")>-1){u=url.split("?")}for(var i in kv){p[decodeURIComponent(i)]=decodeURIComponent(kv[i])}var res=[];for(var a in p){res.push(a+"="+p[a])}if(res.length){if(!u.length&&!h.length){return url+"?"+res.join("&")}else{if(u.length&&!h.length){return u[0]+"?"+res.join("&")}else{if(u.length&&h.length){return u[0]+"?"+res.join("&")+h[1]}else{if(!u.length&&h.length){return h[0]+"?"+res.join("&")+h[1]}}}}}return url};g.location.update=update;g.fadeRule=[0,0.301,0.477,0.602,0.699,0.778,0.845,0.903,0.954,1];function fadeOut(el,cb){var st=null,d=8,fn=function fn(d,cb){this.style.opacity=g.fadeRule[d];if(d--<=0){if(typeof cb==="function"){cb.call(this)}this.style.display="none";clearTimeout(st)}else{st=setTimeout(fn.bind(this,d,cb),typeof cb==="number"?cb:25)}};if(el){el.style.display="inherit";el.style.opacity=1;st=setTimeout(fn.bind(el,d,cb),typeof cb==="number"?cb:25)}}g.fadeOut=fadeOut;function fadeIn(el,cb){var st=null,d=1,fn=function fn(d,cb){this.style.opacity=g.fadeRule[d];if(d++>=9){if(typeof cb==="function"){cb.call(this)}clearTimeout(st)}else{st=setTimeout(fn.bind(this,d,cb),typeof cb==="number"?cb:25)}};if(el){el.style.display="inherit";el.style.opacity=0;st=setTimeout(fn.bind(el,d,cb),typeof cb==="number"?cb:25)}}g.fadeIn=fadeIn;function form(f,validator){f.setAttribute("valid",1);f.xhr=null;f.prepare=function(validator){var data=[];if(!validator||(typeof validator==="function"&&validator.call(f,data))){for(var i=0;i<f.elements.length;i++){data.push((f.elements[i].name||i)+"="+(["checkbox","radio"].indexOf((f.elements[i].getAttribute("type")||"text").toLowerCase())<0?encodeURIComponent(f.elements[i].value):(f.elements[i].checked?1:0)))}}else{f.setAttribute("valid",0)}return data.join("&")};f.validator=validator||f.validator;f.fail=function(res){if(res.form){for(var i=0;i<this.elements.length;i++){if(res.form.hasOwnProperty(this.elements[i].name)){css.el(this.elements[i].parentElement).add("has-error")}else{css.el(this.elements[i].parentElement).del("has-error")}return true}}return false};f.release=function(p){var data=f.prepare(p&&p.validator||f.validator);if(f.getAttribute("valid")!=0){g.xhr.request(Object.assign({method:p&&p.method||f.method,url:p&&p.url||f.action,data:data},{rs:p.rs||{}})).result(p&&p.callback||function(){var res={result:"error"};if([200,206].indexOf(this.status)<0){res.message=this.status+": "+this.statusText}else{try{f.xhr=res=JSON.parse(this.responseText)}catch(e){res.message="Cервер вернул не коректные данные"}}f.xhr=res;if(res.result=="error"){if(p&&typeof p.fail=="function"){p.fail.call(f,res)}else{f.fail(res)}}else{if(res.result=="ok"){if(p&&typeof p.done=="function"){p.done.call(f,res)}}}return f})}return f};f.insert=function(data){for(var i=0;i<f.elements.length;i++){if(data[f.elements[i].name]){f.elements[i].value=data[f.elements[i].name]}else{var field=/\[([^\]]+)\]/.exec(f.elements[i].name)[1];if(field&&data[field]){f.elements[i].value=data[field]}}}return f};f.setup=function(p){if(p){switch(true){case p.hasOwnProperty("form"):console.log("data from data");if(typeof p.form==="object"){f.insert(p.form);var validator=(p&&p.validator||f.validator);if(typeof validator=="function"){validator.call(f,p.data)}}break;case p.hasOwnProperty("xhr"):g.xhr.request({method:p.xhr.method||"GET",url:p.xhr.url,data:p.xhr.data||null,rs:p.xhr.rs||{}}).result(p.xhr.callback||function(){var res={result:"error"};if([200,206].indexOf(this.status)<0){res.message=this.status+": "+this.statusText}else{try{res=JSON.parse(this.responseText);f.insert(res.data||{});var validator=(p&&p.validator||f.validator);if(typeof validator=="function"){validator.call(f,res.data)}}catch(e){res.message="Cервер вернул не коректные данные"}}f.xhr=res;if(p&&typeof p.fn=="function"){p.fn.call(f,res)}return f});break;default:f.reset()}}else{f.reset()}return f};return f}g.JSON.form=form;function router(r){var isHistory=!!(history.pushState)?1:0;var root=r;return{root:root,rt:[],itv:0,base:isHistory?window.location.pathname+window.location.search:"",clr:function(path){return path.toString().replace(/\/$/,"").replace(/^\//,"")},frgm:isHistory?function(){var f=this.clr(decodeURI(location.pathname+location.search)).replace(/\?(.*)$/,"");return this.clr(this.root!=r?f.replace(this.root,""):f)}:function(){var m=window.location.href.match(/#(.*)$/);return m?this.clr(m[1]):""},add:function(re,handler){if(typeof re=="function"){handler=re;re=""}this.rt.push({re:re,handler:handler});this.rt=this.rt.sort(function(a,b){if(a.re.toString().length<b.re.toString().length){return 1}if(a.re.toString().length>b.re.toString().length){return -1}return 0});return this},rm:function(param){for(var i in this.rt){if(this.rt[i].handler===param||this.rt[i].re.toString()===param.toString()){this.rt.splice(i,1);return this}}return this},chk:function(fr){var f=fr||this.frgm();for(var i in this.rt){var m=f.match(this.rt[i].re);if(m){m.shift();this.rt[i].handler.apply({},m);return this}}return this},lsn:function(){var s=this,c=s.frgm(),fn=function(){if(c!==s.frgm()){c=s.frgm();s.chk(c)}return s};clearInterval(s.itv);s.itv=setInterval(fn,50);return s},set:isHistory?function(path){history.pushState(null,null,this.root+this.clr((path||"")));return this}:function(path){window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+(path||"");return this}}}g.router=router("/");function chain(){var c={tuple:[],cache:[],donned:function(fn){return false},failed:function(fn){return false},pool:function(fn,arg){this.chain.cache.push(this);if(this.chain.tuple.length==this.chain.cache.length){this.chain.donned.apply(this.chain,this.chain.cache)}},done:function(fn){this.donned=fn},fail:function(fn){this.failed=fn}};c.tuple=Array.prototype.slice.call(arguments).map(function(fn){fn.onload=function(){c.pool.apply(fn,arguments)};fn.chain=c;return fn});return c}g.chain=chain;function xhr(){var x=new xmlHttpRequest();if(!x){return null}if(!x.hasOwnProperty("ref")){x.ref={}}x.request=function(params){var opt=Object.assign({method:"GET"},params);opt.rs=Object.assign({"Content-type":"application/x-www-form-urlencoded"},params.rs);var id=opt.method+"_"+(opt.url?opt.url.replace(/(\.|:|\/|\-)/g,"_"):g.uuid());var item=new xhr();item.isLoad=false;if((["GET","DELETE"].indexOf(opt.method.toUpperCase())>=0)&&opt.data){opt.url=(opt.url||g.location)+"?"+opt.data;opt.data=null}item.open(opt.method,opt.url||g.location,opt.async||true,opt.username||undefined,opt.password||undefined);if(opt.rs){for(var m in opt.rs){item.setRequestHeader(m.trim(),opt.rs[m].trim())}}item.send(opt.data||null);item.id=id;opt.result&&(item.result=x.result(opt.result));opt.process&&(item.process=x.process(opt.process));return x.ref[id]=item};x.result=function(fn){x.onload=function(e){this.isLoad=true;if(typeof fn==="function"){return fn.call(this,e)}};return this};x.process=function(fn){x.onreadystatechange=function(e){if(typeof fn==="function"){return fn.call(this,e)}};return this};return x}g.xhr=xhr();var tmpl=function tmpl(str,data,cb,opt){var compile=function(str){var source=str.replace(/(\/\*[\w\'\s\r\n\*]*\*\/)|(\/\/[\w\s\']*)|(\<![\-\-\s\w\>\/]*\>)/igm,"").trim();return source.length?new Function("_e","var p=[], print=function(){ p.push.apply(p,arguments); };with(_e){p.push('"+source.replace(/[\r\t\n]/g," ").split("{%").join("\t").replace(/((^|%})[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%}/g,"',$1,'").split("\t").join("');").split("%}").join("p.push('").split("\r").join("\\'")+"');} return p.join(' ').replace(/<%/g,'{%').replace(/%>/g,'%}');"):undefined},build=function(str,id){var isId=typeof id!=="undefined";if(isId&&g.tmpl.cache[id]){result=g.tmpl.cache[id].call(g.tmpl,data||{});if(typeof cb=="function"){cb.call(g.tmpl,result)}return result}var result=null,pattern=null;try{var after=undefined,before=undefined,pig=g.document.getElementById(id);if(pig&&(before=pig.getAttribute("tmpl-before"))){eval(before)}pattern=compile(str);if(isId){g.tmpl.cache[id]=pattern}result=pattern.call(g.tmpl,data||{});if(typeof cb=="function"){cb.call(pattern||g.tmpl,result);if(pig&&(after=pig.getAttribute("tmpl-after"))){eval(after)}}}catch(e){console.error(e);return undefined}return result};switch(true){case str.match(/^(?:https?:\/\/)?(?:(?:[\w]+\.)(?:\.?[\w]{2,})+)?([\/\w]+)(\.[\w]+)/i)?true:false:var id=str.replace(/(\.|\/|\-)/g,"");if(g.tmpl.cache[id]){return build(null,id)}return g.xhr.request(Object.assign({url:str,async:(typeof cb=="function")},opt)).result(function(e){if([200,206].indexOf(this.status)<0){console.warn(this.status+": "+this.statusText)}else{build(this.responseText,id)}});case !/[^\w\-\.]/.test(str):return build(g.document.getElementById(str).innerHTML,str);default:return build(str)}};tmpl.cache={};g.tmpl=tmpl;var storage=function(s){var s=s||g.localStorage;try{s.setItem("test","1");s.removeItem("test")}catch(e){return{p:[],setItem:function(key,value){this.p.push(key);this[key]=value},getItem:function(key){if(this.hasOwnProperty(key)){return this[key]}return null},removeItem:function(key){if(this.hasOwnProperty(key)){delete this.p[key];delete this[key]}},clear:function(){this.p.map(function(item){delete this[item]});this.p=[]}}}return s};g.storage=storage()}(window));(function(d,h){d.config={app:{container:'[role="workspace"]'},msg:{container:".alert.alert-danger",tmpl:"alert-box"},spinner:".locker.spinner",popup:{wnd:".b-popup",container:".b-popup .b-popup-content"}};var e=function(g){this.instance=g||d;return this};e.prototype={create:function(i,g){if(typeof i==="object"){var j=new e(i);if(j&&typeof g=="string"){d[g]=j}return j}return null},el:function(j,g){var i=null;if(typeof j==="string"){if(!j.match(/^#*/)){i=d.document.getElementById(j.replace(/^#/,""))}else{i=this.instance.querySelector(j)}if(i){if(!i.hasOwnProperty("spa")){i.spa=new e(i);i.css=new b(i)}if(typeof g==="string"){d[g]=i}else{if(typeof g==="function"){g.call(i,arguments)}}}}return i},els:function(l,k,i){if(typeof l==="string"){var j=this.instance.querySelectorAll(l);if(!j){return[]}var g=Array.prototype.slice.call(j),m=0;return g.map(function(n){if(!n.hasOwnProperty("spa")){n.spa=new e(n);n.css=new b(n);if(typeof k=="function"){k.call(d,n,m++)}if(typeof k=="string"||typeof i=="string"){if(!d[i]){d[i]=[]}d[i].push(n)}}return n})}else{return[]}},attr:function(g,i){if(g&&typeof i==="undefined"){try{return JSON.parse(this.instance.getAttribute(g))}catch(j){return this.instance.getAttribute(g)}}else{if(g&&i){if(typeof i==="object"){this.instance.setAttribute(g,JSON.stringify(i))}else{this.instance.setAttribute(g,i)}}}return this},merge:function(){var j=1,g=arguments[0]||{};if(this.instance.hasOwnProperty("spa")){g=this.instance;j=0}Array.prototype.slice.call(arguments,j).forEach(function(m,l,i){Object.defineProperties(g,Object.keys(m).reduce(function(n,k){n[k]=Object.getOwnPropertyDescriptor(m,k);return n},{}))});return g},get parent(){return new e(this.instance&&this.instance.parentElement)},src:function(i){var g=i?i:this.instance;return new e(g.srcElement||g.target)},css:function(){return d.css.el(this.instance)},on:function(j,i,g){this.instance.addEventListener(j,i,g||true);return this.instance},xml:function(l,j){var g,i;if(!l||typeof l!=="string"){return null}try{if(d.DOMParser){i=new DOMParser();g=i.parseFromString(l,j||"text/xml")}else{g=new ActiveXObject("Microsoft.XMLDOM");g.async="false";g.loadXML(l)}}catch(k){g=h}return g}};d.spa=new e(document);var b=function(g){this.instance=g;return this};b.prototype={el:function(g){this.instance=g;return this},style:function(i,g){this.instance.style[i]=g},re:function(i,j){return new RegExp(i,j||"g")},has:function(g){return this.instance.className.match(this.re("(?:^|\\s)"+g+"(?!\\S)"))},add:function(g){if(!this.has(g)){this.instance.className+=" "+g}return this},del:function(g){this.instance.className=this.instance.className.replace(this.re("(?:^|\\s)"+g+"(?!\\S)"),"");return this},tgl:function(g){if(!this.has(g)){this.instance.className+=" "+g}else{this.instance.className=this.instance.className.replace(this.re("(?:^|\\s)"+g+"(?!\\S)"),"")}return this}};d.css=new b(document);var f={elem:d.spa.el(d.config.msg.container),show:function(i,g){this.elem.innerHTML=tmpl(d.config.msg.tmpl,i);this.elem.style.display="inherit";if(typeof g=="undefined"||!g){fadeOut(this.elem,90)}}};d.msg=f;var a={visible:false,wnd:d.spa.el(d.config.popup.wnd),container:d.spa.el(d.config.popup.container),init:function(g){if(typeof g==="object"){if(g.width){this.container.style.width=g.width+"px";this.container.style.marginLeft=(g.width/(-2))+"px"}if(g.height){this.container.style.height=g.height+"px";this.container.style.marginTop=(g.height/(-2))+"px"}}},show:function(g){if(this.wnd){this.wnd.style.opacity="0";g.content&&this.container&&(this.container.innerHTML=g.content);if(typeof g==="object"){(g.width||g.height)&&this.init(g)}this.container.spa.els('[role="popup-close"]',function(i){i.spa.on("click",function(j){return a.hide()})});if(g.event&&g.event.length){g.event.map(function(j,k){j.call(a,k)})}this.visible=true;fadeIn(this.wnd,35);g.cb&&g.cb.call(this);this.container.spa.el('[tabindex="1"]',function(){this.focus()})}},hide:function(g){if(this.wnd){this.visible=false;fadeOut(this.wnd,g||35)}}};d.popup=a;d.spinner_count=0;d.spinner_element=d.spa.el(d.config.spinner);if(d.spinner_element){Object.defineProperty(d,"spinner",{__proto__:null,enumerable:false,configurable:false,set:function(g){g?d.spinner_count++:d.spinner_count--;d.spinner_count>0?d.spinner_element.style.display="block":d.spinner_element.style.display="none"},get:function(){if(d.spinner_element.style.display=="none"){return false}return true}})}Object.defineProperty(d,"selected",{get:function c(){return d.getSelection?d.getSelection().toString():document.selection.createRange().text}})}(window));