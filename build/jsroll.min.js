
 /**
 * @app jsroll.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA javascritp framework
 * @author Андрей Новиков <andrey@novikov.be>
 * @data 28/10/2019
 * @status beta
 * @version 2.1.1b
 * @revision $Id: jsroll.min.js 2.1.1b 2019-10-28 14:39:57Z $
 **/

(function(g,undefined){"use strict";var version="2.1.1b";g.HTTP_RESPONSE_CODE={0:"Request runtime error",10:"Application offline",100:"Continue",101:"Switching Protocol",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choice",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Switch Proxy",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"};var eventCode=function(e){if(g.InputEvent&&(e instanceof InputEvent)){return e.data}else{if(e instanceof Event){switch(true){case e.key!==undefined:return e.key;case e.keyIdentifier!==undefined:return e.keyIdentifier;case e.keyCode!==undefined:return e.keyCode;default:return e.charCode}}}return null};g.eventCode=eventCode;var xmlHttpRequest=("XMLHttpRequest" in g?g.XMLHttpRequest:("ActiveXObject" in g?g.ActiveXObject("Microsoft.XMLHTTP"):g.XDomainRequest));if(!("indexedDB" in g)){g.indexedDB=g.mozIndexedDB||g.webkitIndexedDB||g.msIndexedDB||null;if(g.indexedDB){g.IDBTransaction=g.webkitIDBTransaction||g.msIDBTransaction;g.IDBKeyRange=g.webkitIDBKeyRange||g.msIDBKeyRange}}g.URL=g.URL||g.webkitURL;g.requestFileSystem=g.requestFileSystem||g.webkitRequestFileSystem;var is_url=/^(?:https?:\/\/)?(?:(?:[\w]+\.)(?:\.?[\w]{2,})+)?([\/\w]+)(\.[\w]+)|^(?:\/[\w]+){1,}/i;var re=function(s,flags){if(typeof s==="object"){return s}try{var p=/[?\/](.+)(\/([igum]*$))/.exec(s)||[];return new RegExp(p[1]||s,p[3]||flags||"")}catch(e){console.error("jsroll::re("+s+")",e);return undefined}};g.re=re;var str2json=function(s,def){try{var o=(typeof s==="string"?JSON.parse(s):s||(typeof def==="undefined"?null:def))}catch(e){o=typeof def==="undefined"?null:def}return o};g.str2json=str2json;var obj2array=function(a){return typeof a==="object"?Array.prototype.slice.call(a):[]};g.obj2array=obj2array;var coalesce=function(){for(var i in arguments){if(typeof arguments[i]!=="undefined"&&arguments[i]!==null&&arguments[i]!==""){return arguments[i]}}return undefined};g.coalesce=coalesce;var quoter=function(v,opt){var s=typeof v==="string"?v:(v?JSON.stringify(v):null);if(s){opt=typeof opt==="undefined"?quoter.CODE_QOUTAS:opt;if(opt&quoter.SLASHES_QOUTAS){s=s.replace(/\\"/g,'"').replace(/\\'/g,"'")}if(opt&quoter.CODE_QOUTAS){s=s.replace(/"/g,"&quot;").replace(/'/g,"&#39;")}return s}return""};g.quoter=quoter;g.quoter.CODE_QOUTAS=1;g.quoter.SLASHES_QOUTAS=2;var bundler=function(){return obj2array(arguments).filter(function(v){return(typeof v!=="undefined"&&v!==null&&v!=="")})};g.bundler=bundler;var bitfields=function(status,d){var res=[],st=parseInt(status);if(!st||typeof d!=="object"||d===null){return res}for(var i=0;i<d.length;i++){if(st&Math.pow(2,i)){res.push(d[i])}}return res};g.bitfields=bitfields;var uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16)})};g.uuid=uuid;var crc32=function(str){var makeCRCHelper=g.makeCRCHelper||(g.makeCRCHelper=function(){var c;var makeCRCHelper=[];for(var n=0;n<256;n++){c=n;for(var k=0;k<8;k++){c=((c&1)?(3988292384^(c>>>1)):(c>>>1))}makeCRCHelper[n]=c}return makeCRCHelper});var crc=0^(-1);for(var i=0;i<str.length;i++){crc=(crc>>>8)^makeCRCHelper[(crc^str.charCodeAt(i))&255]}return(crc^(-1))>>>0};g.crc32=crc32;Object.defineProperty(Object.prototype,"merge",{value:function(){if(!arguments.length){return null}var o=(typeof this==="object"?this:(typeof this==="function"?new this:null));if(typeof this==="function"&&o&&o.__proto__.__proto__){o.__proto__.constructor=this}obj2array(arguments).forEach(function(v,k,a){if(o===null){o=(typeof v==="object"?v:(typeof v==="function"?new v:null));if(o&&typeof v==="function"&&o.__proto__){o.__proto__.constructor=v}return o}var x=(typeof v==="object"?v:(typeof v==="function"?new v:null));if(x){if(typeof v==="function"&&x.__proto__){x.__proto__.constructor=v}if(Object.getPrototypeOf(x)!==Object.prototype){Object.merge(o.__proto__,x.__proto__)}Object.defineProperties(o,Object.getOwnPropertyNames(x).reduce(function(d,key){if(o.hasOwnProperty(key)&&Object.getOwnPropertyDescriptor(o,key)["set"]){o[key]=x[key];d[key]=Object.getOwnPropertyDescriptor(o,key)}else{d[key]=Object.getOwnPropertyDescriptor(x,key)}return d},{}))}});return o},enumerable:false});Object.defineProperty(Object.prototype,"__inherit__",{value:function(){if(!arguments.length){return{}}var self=arguments[0],extension=arguments[1];switch(typeof self){case"function":var fn=self;if(typeof extension==="object"){fn.prototype=Object.merge(fn.prototype,extension)}else{if(typeof extension==="function"){fn.prototype=Object.merge(fn.prototype,extension.prototype)}}self=new fn;self.__proto__.constructor=fn;if(typeof extension==="function"){self.merge(extension)}break;case"object":if(typeof extension==="object"){self.__proto__=Object.merge(self.__proto__,extension)}else{if(typeof extension==="function"){self.__proto__=Object.merge(self.__proto__,extension.prototype);self.__proto__.constructor=extension;self.merge(extension)}}break;default:return null}return self},enumerable:false});Object.defineProperty(Object.prototype,"__parent__",{value:function(){if(!arguments.length||typeof arguments[0]!=="object"){return null}var self=this,parent=arguments[0];switch(typeof arguments[1]){case"function":var fn=arguments[1];self=new fn;self.__proto__=Object.merge(self.__proto__,parent);self.__proto__.constructor=fn;break;case"object":self=Object.merge(arguments[1]);case"undefined":default:self.__proto__=parent}self.__parent__=parent;if(parent.hasOwnProperty("__childs__")){parent.__childs__.push(self)}else{parent.__childs__=[self]}return self},enumerable:false});var bb=function(data,params){var opt=Object.assign({type:"application/x-www-form-urlencoded"},params);var BlobBuilder=("MozBlobBuilder" in g?g.MozBlobBuilder:("WebKitBlobBuilder" in g?g.WebKitBlobBuilder:g.BlobBuilder));if(BlobBuilder){var bb=new BlobBuilder();bb.append(data);return bb.getBlob(opt.type)}return new Blob([data],opt)};g.bb=bb;var func=function(str,self,args){if(typeof str!=="string"){return console.error("func src is't a string type!\n",str)}try{var s=str.replace(/\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/|\/\/[^\r\n]*/igm,"");switch(true){case /^\s*function.*[}|;]*$/igm.test(s):var _e="_e"+uuid().replace(/-/g,"");var fn=new Function("var "+_e+"="+s+"; return "+_e+".apply(this, arguments)");return fn;default:return function(){return eval(s)}}}catch(e){return console.error("func ",e.message+"\n",str)}};g.func=func;var decoder=function(search,re){var re=re||/[?&]([^=#]+)=([^&#]*)/g,p={},m;try{while(m=re.exec((search||g.location.search))){if(m[1]&&m[2]){p[decodeURIComponent(m[1])]=decodeURIComponent(m[2])}}}catch(e){return null}return p};g.location.decoder=decoder;var encoder=function(params,divider){if(typeof params==="object"){return Object.keys(params).map(function(e,i,a){return encodeURIComponent(e)+"="+encodeURIComponent(params[e])}).join(divider||"&")}return undefined};g.location.encoder=encoder;var update=function(search,params){var u=[],h=[],url=g.location.search,kv=params||{};if(typeof search==="string"){url=search}else{kv=search}var p=g.location.decoder(url);if(url.indexOf("#")>-1){h=url.split("#")}if(url.indexOf("?")>-1){u=url.split("?")}for(var i in kv){p[decodeURIComponent(i)]=decodeURIComponent(kv[i])}var res=[];for(var a in p){res.push(a+"="+p[a])}if(res.length){return((!u.length&&!h.length)?url:(u.length?u[0]:h[0]))+"?"+res.join("&")+(h.length?h[1]:"")}return url};g.location.update=update;function router(r){var isHistory=!!(history.pushState)?1:0;var root=r;return{root:root,rt:[],itv:0,base:isHistory?g.location.pathname+g.location.search:"",referrer:root,clr:function(path){return path.toString().replace(/\/$/,"").replace(/^\//,"")},fr:isHistory?function(){return this.root+this.clr(decodeURI(g.location.pathname+g.location.search)).replace(/\?(.*)$/,"")}:function(){var m=g.location.href.match(/#(.*)$/);return this.root+(m?this.clr(m[1]):"")},add:function(re,handler){if(typeof re=="function"){handler=re;re=""}this.rt.push({re:re,handler:handler});this.rt=this.rt.sort(function(a,b){if(a.re.toString().length<b.re.toString().length){return 1}if(a.re.toString().length>b.re.toString().length){return -1}return 0});return this},rm:function(param){for(var i in this.rt){if(this.rt[i].handler===param||this.rt[i].re.toString()===param.toString()){this.rt.splice(i,1);return this}}return this},chk:function(fr){var f=fr||this.fr(),m=false;for(var i in this.rt){if(m=f.match(this.rt[i].re)){this.rt[i].handler.call(m||{},f);return this}}return this},lsn:function(){var s=this,c=s.fr(),fn=function(){if(c!==s.fr()){c=s.fr();s.chk(c)}return s};clearInterval(s.itv);s.itv=setInterval(fn,50);return s},set:isHistory?function(path){this.referrer=g.location.pathname+g.location.search;history.pushState(null,null,this.root+this.clr(path||""));return this}:function(path){this.referrer=g.location.pathname+g.location.search;window.location.href=g.location.href.replace(/#(.*)$/,"")+"#"+(path||"");return this}}}g.router=router("/");function chain(){var c={tuple:[],cache:[],donned:function(fn){return false},failed:function(fn){return false},pool:function(fn,arg){this.chain.cache.push(this);if(this.chain.tuple.length==this.chain.cache.length){this.chain.donned.apply(this.chain,this.chain.cache)}},done:function(fn){this.donned=fn},fail:function(fn){this.failed=fn}};c.tuple=obj2array(arguments).map(function(fn){fn.onload=function(){c.pool.apply(fn,arguments)};fn.chain=c;return fn});return c}g.chain=chain;function js(src,opt){if(!src){return null}var opt=Object.assign({async:false,type:"text/javascript",container:g.document.body},opt);var s=g.document.createElement("script");s.type=opt.type;s.async=opt.async;if(opt.hasOwnProperty("id")){s.id=opt.id}if(src.match(is_url)){s.src=src}else{s.text=src}if(typeof opt.onload==="funciton"){s.onload=onload}if(typeof opt.onreadystatechange==="funciton"){s.onreadystatechange=onreadystatechange}if(typeof opt.container.appendChild==="function"){opt.container.appendChild(s)}else{console.error("jsRoll::js() Не существущий контейнер",opt.container)}return s}g.js=js;function xhr(params){var x=new xmlHttpRequest();if(!x){return null}x.fail=function(fn){if(typeof fn==="function"){return fn.call(x,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm))}return x};x.done=function(fn){if(typeof fn==="function"){return fn.call(x,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm))}return x};x.cancel=function(fn){if(typeof fn==="function"){return fn.call(x,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm))}return x};x.process=function(opt){g.addEventListener("offline",x.onerror);var proc=opt.process;x.onreadystatechange=function(e){if(typeof proc==="function"){return proc.call(x,e,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm))}else{if(x.readyState==4&&x.status>=400){g.removeEventListener("offline",x.onerror);x.fail.call(x,e,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm));if(typeof x.after=="function"){x.after.call(x,{status:parseInt(x.status)})}}}return x};x.timeout=opt.timeout;x.ontimeout=function(e){x.halt({status:408});return x};return x};x.halt=function(opt){x.cancel.call(x,opt,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm));if(typeof x.after=="function"){x.after.call(x,opt)}g.removeEventListener("offline",x.onerror);x.abort();return x};x.onerror=function(e){x.fail.call(x,e,{status:10});x.halt({status:500});return false};x.onload=function(e){x.done.call(x,e,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm));if(typeof x.after=="function"){x.after.call(x,{status:parseInt(x.status)})}g.removeEventListener("offline",x.onerror);return x};if(params&&params.hasOwnProperty("responseType")){x.responseType=params.responseType}var opt=Object.assign({method:"GET",timeout:10000},params);x.method=opt.method.toUpperCase();var rs=Object.assign({"Xhr-Version":version,"Content-type":"application/x-www-form-urlencoded"},(params||{}).rs);if(rs["Content-type"]===false||rs["Content-type"].toLowerCase()=="multipart/form-data"){delete rs["Content-type"]}try{for(var i in opt){if(typeof opt[i]=="function"){x[i]=opt[i]}}if((["GET","DELETE"].indexOf(x.method)>=0)&&opt.data){var u=opt.url||g.location;opt.url=u+(u.indexOf("?")!=-1?"&":"?")+opt.data;opt.data=null}if(typeof x.before=="function"){x.before.call(x,opt,x)}x.open(x.method,opt.url||g.location,opt.async||true,opt.username,opt.password);for(var m in rs){x.setRequestHeader(m,rs[m])}x.response_header=null;if(!navigator.onLine){x.fail.call(x,null,{status:10});x.halt({status:10})}else{x.process(opt).send(opt.data)}}catch(e){x.fail.call(x,e,{status:0});x.halt({status:0});return x}return x}g.xhr=xhr;var InputHTMLElementSerialize=function(el){if(el instanceof HTMLElement){return el.name+"="+(["checkbox","radio"].indexOf((el.getAttribute("type")||"text").toLowerCase())<0?encodeURIComponent(el.value):(el.checked?(el.value.indexOf("on")==-1?el.value:1):(el.value.indexOf("on")==-1?"":0)))}return null};g.InputHTMLElementSerialize=InputHTMLElementSerialize;var InputHTMLElementValue=function(el,def){var n=undefined,type;if(el instanceof HTMLElement){type=(el.getAttribute("type")||"text").toLowerCase();n=el.value?(Number(el.value)==el.value&&(type=="number"||!/^0{1,}\d{1,}$/.test(el.value))?Number(el.value):String(el.value)):(typeof def!=="undefined"?def:null);if(["checkbox","radio"].indexOf(type)>-1){n=el.checked?(el.value.indexOf("on")==-1?n:1):(el.value.indexOf("on")==-1?(typeof def!=="undefined"?def:null):0)}}return n};g.InputHTMLElementValue=InputHTMLElementValue;Object.defineProperty(JSON,"form",{value:function(f){if(f&&!f.hasOwnProperty("MODEL")){Object.defineProperty(f,"MODEL",{set:function MODEL(d){f.reset();if(typeof d==="object"){var is_array,field,index,el,value,type;for(var i=0;i<f.elements.length;i++){field=null;index=null;el=f.elements[i];type=(el.getAttribute("type")||"text").toLowerCase();if(type==="button"){continue}if(is_array=/\[.*\]$/.test(el.name)){field=el.name.replace(/\[.*\]$/,"");if(!d.hasOwnProperty(field)){continue}else{value=d[field]}if(index=/\[([^\]]+)\]/.exec(this.elements[i].name)){index=String(index[1]);if(!d[field].hasOwnProperty(index)){continue}else{value=d[field][index]}}}else{field=el.name||String(i);if(!d.hasOwnProperty(field)){continue}else{value=d[field]}}switch(type){case"text":case"textarea":el.value=decodeURIComponent(value);break;case"checkbox":case"radio":if(is_array){el.checked=el.value==="on"?!!value:str2json(value,[]).indexOf(el.value)!==-1}else{el.checked=el.value==="on"?!!value:String(el.value)==String(value)}break;case"number":el.value=Number(value);break;case"color":case"date":case"date":case"datetime-local":case"email":case"month":case"range":case"search":case"tel":case"time":case"url":case"week":default:el.value=String(value)}}}},get:function MODEL(){f.__MODEL__={};var el,type;for(var i=0;i<f.elements.length;i++){el=f.elements[i];type=(el.getAttribute("type")||"text").toLowerCase();if(type==="button"){continue}var field=el.name&&/\[.*\]$/.test(el.name)?el.name.replace(/\[.*\]$/,""):(el.name||String(i));var n=["text","textarea"].indexOf(type)>-1?el.value:InputHTMLElementValue(el);if((typeof f.__MODEL__[field]==="undefined")||(f.__MODEL__[field]===null)){f.__MODEL__[field]=n}else{if(typeof f.__MODEL__[field]!=="undefined"&&n!==null){if(typeof f.__MODEL__[field]!=="object"){f.__MODEL__[field]=[f.__MODEL__[field]]}f.__MODEL__[field].push(n)}}}return f.__MODEL__}});f.prepare=function(validator){var data=[];if(!validator||(typeof validator==="function"&&validator.call(f,data))){for(var i=0;i<f.elements.length;i++){data.push(InputHTMLElementSerialize(f.elements[i]))}}else{f.setAttribute("valid",0)}return data.join("&")};f.fail=typeof f.fail=="function"?f.fail:function(res){f.setAttribute("valid",0);var a=res.form||res.message;if(a){for(var i=0;i<this.elements.length;i++){if(a.hasOwnProperty(this.elements[i].name)){this.elements[i].status="error"}else{this.elements[i].status="none"}}}return f};f.send=function(){var data=f.prepare(f.validator),before=true,args=arguments;if(f.getAttribute("valid")!=0){if(typeof f.before==="function"){before=f.before()}if(before===undefined||!!before){var done=typeof args[0]=="function"?function(e,hr){f.response_header=hr||{};var callback=args.shift();callback.apply(this,args);return f}:function(e,hr){f.response_header=hr||{};try{f.response=JSON.parse(this.responseText)}catch(e){f.response={result:"error",message:this.status+": "+g.HTTP_RESPONSE_CODE[this.status]}}if(f.response.result=="error"){if(typeof f.fail=="function"){f.fail.call(f,f.response,hr,args)}}else{if(typeof f.done=="function"){f.done.call(f,f.response,hr,args)}}return f};var after=(typeof f.after==="function")?f.after.bind(f):undefined;f.response={result:undefined};g.xhr(Object.assign({method:f.rest,url:f.action,data:data,done:done,after:after,fail:function(e,hr){console.error("JSON.form["+f.name+"]: "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},f.opt))}}else{f.setAttribute("valid",1)}return f}}f.setAttribute("valid",1);f.rest=f.getAttribute("rest")||f.method;f.validator=f.validator||null;f.opt=f.opt||{};return f},enumerable:false});var tmpl=function tmpl(str,data,cb,opt){var fn,self={processing:false,timer:null,wait:function(after,args){var item=this,self=this;if(item.processing){item.timer=setTimeout(function(){item.wait(after,args)},50);return self}else{if(typeof after=="function"){after.apply(item.tmplContext,args)}else{if(after&&(typeof(fn=func(after,item.tmplContext,args))==="function")){fn.apply(item.tmplContext,args)}}}return self},response_header:null,__tmplContext:undefined,get tmplContext(){if(this.__tmplContext){this.__tmplContext.owner=self}return this.__tmplContext},set tmplContext(v){this.__tmplContext=v},onTmplError:function(type,id,str,args,e){console.error("tmpl type=["+type+"]",[id,str],args,e.message+"\n");return}};var args=arguments;args[1]=args[1]||{};var compile=function(str){var _e="_e"+uuid().replace(/-/g,""),source=str.replace(/\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/|\/\/[^\r\n]*|\<![\-\-\s\w\>\/]*\>/igm,"").replace(/\>\s+\</g,"><").trim(),tag=["{%","%}"];if(!source.match(/{%(.*?)%}/g)&&source.match(/<%(.*?)%>/g)){tag=["<%","%>"]}return source.length?new Function(_e,"var p=[], print=function(){ p.push.apply(p,arguments); }; with("+_e+"){p.push('"+source.replace(/[\r\t\n]/g," ").split(tag[0]).join("\t").replace(re("/((^|"+tag[1]+")[^\t]*)'/g"),"$1\r").replace(re("/\t=(.*?)"+tag[1]+"/g"),"',$1,'").split("\t").join("');").split(tag[1]).join("p.push('").split("\r").join("\\'")+"');} return p.join('');"):undefined},build=function(str,id){var isId=typeof id!=="undefined",data={},pattern=null;var result=null,after,before,a,pig=g.document.getElementById(id);try{if(pig){var nn=undefined;Array.prototype.slice.call(pig.attributes).forEach(function(i){if(i&&/^tmpl-*/i.test(i.nodeName.toString())&&(nn=i.nodeName.toString().replace(/^tmpl-/i,""))){try{data[nn]=JSON.parse(i.value)}catch(e){data[nn]=i.value}}});if((a=pig.getAttribute("arguments"))){try{data=Object.merge(JSON.parse(a)||{},data)}catch(e){return self.onTmplError("tmpl-arguments",id,str,args,a)}}args[1].merge(data);if(pig.getAttribute("before")&&(typeof(fn=func(pig.getAttribute("before"),self,args))==="function")){fn.apply(self,args)}}else{if(opt&&typeof opt.before=="object"){args[1].merge(opt.before)}else{if(opt&&typeof opt.before=="function"){opt.before.call(self,args)}}}if(isId&&g.tmpl.cache[id]){pattern=g.tmpl.cache[id]}else{pattern=compile(str);if(isId){g.tmpl.cache[id]=pattern}}if(!pattern){return self.onTmplError("tmpl-pattern",id,str,args,"пустой шаблон")}var awaiting=function(self){if(self.processing){self.timer=setTimeout(function(){awaiting(self)},50);return}result=pattern.call(g.tmpl,args[1]);if(typeof cb=="function"){self.tmplContext=cb.call(pattern||g.tmpl,result)||g.tmpl}else{if(self.tmplContext instanceof HTMLElement||cb instanceof HTMLElement&&(self.tmplContext=cb)){self.tmplContext.innerHTML=result}}if(self.tmplContext&&pig&&(after=pig.getAttribute("after"))){self.wait(after,args)}else{if(opt&&typeof opt.after=="function"){self.wait(opt.after,args)}}return result};return awaiting(self)}catch(e){return self.onTmplError("tmpl-build",id,str,args,e)}return result};try{switch(true){case str.match(is_url)?true:false:var id=str.split(/\//).pop();if(g.tmpl.cache[id]){return build(null,id)}var opt=opt||{};opt.rs=Object.assign(opt.rs||{},{"Content-type":"text/x-template"});return g.xhr(Object.assign({url:str,async:(typeof cb==="function"),done:function(e,hr){self.response_header=hr;build(this.responseText,id)},fail:function(e,hr){console.error(e)}},opt));case !/[^#*\w\-\.]/.test(str)?true:false:return build(g.document.getElementById(str.replace(/^#/,"")).innerHTML,str);default:return build(str)}}catch(e){return self.onTmplError("tmpl",id,str,args,e)}};tmpl.cache={};g.tmpl=tmpl;var storage=function(s){try{var s=s||g.localStorage;s.setItem("test","1");s.removeItem("test")}catch(e){return{p:[],setItem:function(key,value){this.p.push(key);this[key]=value},getItem:function(key){if(this.hasOwnProperty(key)){return this[key]}return null},removeItem:function(key){if(this.hasOwnProperty(key)){delete this.p[key];delete this[key]}},clear:function(){this.p.forEach(function(item){delete this[item]});this.p=[]}}}return s};g.storage=storage();var dom=function(){var p;try{if("DOMParser" in g){p=new DOMParser();return function(d,mime){try{return p.parseFromString(d,mime||"text/xml")}catch(e){return null}}}else{if("ActiveXObject" in g){p=new ActiveXObject("Microsoft.XMLDOM");p.async="false";return function(d,mime){try{p.instance.loadXML(d);return p}catch(e){return null}}}}return null}catch(e){return undefined}};g.dom=dom()}(window));(function(d,j){"use strict";var a=function(g){this.instance=this.el(g).instance;return this};a.prototype={el:function(g){this.instance=typeof g==="string"?d.document.querySelector(g):g;return this},style:function(l,g){this.instance.style[l]=g;return this},has:function(l){var k=this.instance.className;if(typeof l!=="string"&&k){return null}var g=[];l.split(" +").forEach(function(o,n,m){if(k.match(re("/(?:^|\\s)"+o+"(?!\\S)/"))){g.push(o)}});return g.length?g:null},add:function(g){if(this.instance&&!this.has(g)){this.instance.className+=" "+g}return this},del:function(k){var g=this.instance;if(k&&g){if(typeof k==="string"){k.split(/\s+/).forEach(function(n,m,l){g.className=g.className.replace(re("/(?:^|\\s)"+n+"(?!\\S)/"),"").replace(/\s+/," ").trim()})}else{if(typeof k==="object"){g.className=g.className.replace(k,"").replace(/\s+/," ").trim()}}}return this},rpl:function(g,l){var k=this.instance;if(g&&l&&k){k.className=k.className.replace(g,l)}},tgl:function(g){if(this.instance){if(!this.has(g)){this.instance.className+=" "+g}else{this.instance.className=this.instance.className.replace(re("/(?:^|\\s)"+g+"(?!\\S)/"),"").trim()}}return this}};d.css=new a(d);var h=("CustomEvent" in d?d.CustomEvent:(function(){function g(l,m){m=m||{bubbles:false,cancelable:false,detail:j};var k=d.document.createEvent("CustomEvent");k.initCustomEvent(l,m.bubbles,m.cancelable,m.detail);return k}g.prototype=d.Event.prototype;return g})());d.ce=h;Element.matches=Element.matches||Element.matchesSelector||Element.webkitMatchesSelector||Element.msMatchesSelector||function(g){var m=this,k=(m.parentNode||m.document).querySelectorAll(g),l=-1;while(k[++l]&&k[l]!=m){}return !!k[l]};var e=function(g){if(g.hasOwnProperty("ui")){return g}this._parent=null;this.instance=g||d.document;if(g){this.instance.css=new a(this.instance);this.wrap(this.instance.parentElement)}return this};e.prototype={wrap:function(k,g){if(k&&!k.hasOwnProperty("ui")){k.ui=new e(k);if(typeof g=="string"){d[g]=k}}return k},el:function(l,g){var k=null;if(typeof l==="string"){if(!l.match(/^#*/)){k=d.document.getElementById(l.replace(/^#/,""))}else{k=this.instance.querySelector(l)}}else{if(typeof l==="object"){k=l}}if(k){if(!k.hasOwnProperty("ui")){k.ui=new e(k)}if(typeof g==="string"){d[g]=k}else{if(typeof g==="function"){g.call(k,arguments)}}}return k},els:function(l,k,g){var m=[];if(typeof l==="string"){l.split(",").forEach((function(n){m.push.apply(m,obj2array(this.instance.querySelectorAll(n.trim())||{}).map(function(q,p,o){if(!q.hasOwnProperty("ui")){q.ui=new e(q)}if(typeof k=="function"){k.call(q,p,o)}return q}))}).bind(this));if(typeof k=="string"){d[k]=m}else{if(typeof g=="string"){d[g]=m}}}return m},attr:function(k,l){if(k==j){var m={},r;for(var o in this.instance.attributes){m[(r=this.instance.attributes[o].nodeName)]=this.instance.getAttribute(r)}return m}else{if(typeof k==="object"&&typeof l==="undefined"){for(var o in k){if(!/\d+/.test(o)){this.instance.setAttribute(o,k[o])}}return this}else{if(typeof k==="string"&&typeof l==="undefined"){var g=k.indexOf("*")!=-1?re("/"+k.split("*")[0]+"/i"):null;if(g){var p={};obj2array(this.instance.attributes).forEach(function(u,t,n){var s=u.nodeName.toString();if(g.test(s)&&(s=s.replace(g,""))){p[s]=u.value}});return p}else{try{return JSON.parse(this.instance.getAttribute(k))}catch(q){return this.instance.getAttribute(k)}}}else{if(typeof k==="string"&&l){if(!/\d+/.test(k)){if(typeof l==="object"){this.instance.setAttribute(k,JSON.stringify(l))}else{this.instance.setAttribute(k,l)}}}}}}return this},tmpl:function(m,l,g,k){tmpl.apply(this.instance,[m,l,g,k]);return this.instance},merge:function(){merge.apply(this.instance,arguments);return this.instance},src:function(g){if(g instanceof Event){return this.wrap(g.target||g.srcElement)}return this.instance},on:function(m,l,k){var g=this;m.split(",").forEach(function(o){var n=g.instance instanceof Element?[g.instance]:g.instance;n.map(function(p){p.addEventListener(o.trim(),l,!!k)})});return this.instance},dg:function(m,n,l,k){var g=this;g.instance.addEventListener(n,function(q){var p,o=(q.target||q.srcElement);while(o&&o.matches&&o!==g&&!(p=o.matches(m))){o=o.parentElement}if(p){l.call(g.wrap(o),q);return o}return !!p},!!k);return this.instance},dom:function(l,k){if(!l||typeof l!=="string"){return null}var g=d.dom(l,k).childNodes;return g.length>1?g:g[0]},up:function(n,m){var g=d.dom(n,m).childNodes,l=this.instance===d.document?d.ui.el("body"):this.instance;for(var k=0;k<g.length;k++){l.appendChild(g[k])}return l},rm:function(g){if(!g||typeof g!=="string"){return null}this.els(g).forEach(function(k){k.parentNode.removeChild(k)});return this.instance},get active(){return(this.instance instanceof Element&&(this.instance===d.document.activeElement))},focus:function(k){var g=null;if(k){g=(typeof k=="string"?this.el(k):k)}else{g=this.instance}if(g instanceof HTMLElement){d.setTimeout(function(l){g.focus()},0)}return g}};d.ui=new e(document);Object.defineProperty(d,"selected",{get:function c(){return d.getSelection?d.getSelection().toString():d.document.selection.createRange().text}});function b(){if(d.getSelection){if(d.getSelection().empty){d.getSelection().empty()}else{if(d.getSelection().removeAllRanges){d.getSelection().removeAllRanges()}}}else{if(d.document.selection){d.document.selection.empty()}}}d.selection=b;function i(l,k){if(!l){return false}var g=null;var k=Object.assign({display:false,timeout:300,context:null},k),m=function(n){if(!n.hasOwnProperty("fade")){n.faded=n.style.opacity==0;n.opt=k;n.opt.context=typeof k.context==="string"?n.el(k.context):n;Object.defineProperty(n,"fade",{get:function(){return n.faded},set:function(o){if(o){n.css.add("fade");if(n.opt.display){setTimeout(function(){n.style.display="none"},n.opt.timeout)}return n.faded=true}else{if(n.opt.display){n.style.display=n.getAttribute("display")?n.getAttribute("display"):"inherit"}n.css.del("fade");return n.faded=false}},enumerable:true,configurable:true})}return n};if(typeof l==="string"){g=d.ui.els(l);g.forEach(function(o,p,n){m(o)})}else{if(l instanceof HTMLElement){g=m(l)}else{if(typeof l==="object"){g=l;l.forEach(function(o,p,n){m(o)})}}}return g}d.fader=i}(window));(function(c,e,j){"use strict";if(typeof e==="undefined"){return false}var h=function(l,k){this.__valid=true;this.opt=Object.merge({method:"get",url:c.location.href,before:function(m){c.spinner=true},after:function(m){c.spinner=false}},k);this.wrongs=[];this.elements=typeof l==="string"?e.els(l):l;this.length=this.elements.length||0;var g=this;this.elements.forEach(function(o,n,m){o.group=g})};h.prototype={events:{},on:function(m,l,k){var g=this;g.events[m]=l;this.elements.forEach(function(p,o,n){p.ui.on(m,g.events[m],k)})},set valid(k){this.wrongs=[];if(k.message){for(var g=0;g<this.elements.length;g++){this.__valid=true;if(k.message.hasOwnProperty(this.elements[g].name)){this.elements[g].status="error";this.__valid=false;this.wrongs.push(this.elements[g].name)}else{this.elements[g].status="none"}}}},get valid(){this.__valid=true;var g=this;this.wrongs=[];this.elements.forEach(function(n,m,l){var k=input_validator(n);if(!k){g.wrongs.push(n.name)}g.__valid&=k});return this.__valid},is_wrong:function(){if(arguments.length){var l=this,k=typeof arguments[0]==="object"?arguments[0]:Array.prototype.slice.call(arguments,0);var g=true;k.forEach(function(o,n,m){g&=l.wrongs.indexOf(o)>-1});return g}return !!this.wrongs.length},__MODEL__:{},set MODEL(k){if(k&&typeof k==="object"){this.__MODEL__=k;this.wrongs=[];for(var g=0;g<this.elements.length;g++){if(k.hasOwnProperty(this.elements[g].name)){this.elements[g].value=k[this.elements[g].name];if(["checkbox","radio"].indexOf((this.elements[g].getAttribute("type")||"text").toLowerCase())>-1){this.elements[g].checked=parseInt(k[this.elements[g].name])!==0}}}}else{this.__MODEL__={}}},get MODEL(){this.__MODEL__={};for(var g=0;g<this.elements.length;g++){var k=this.elements[g].value.length?new Number(this.elements[g].value):NaN;this.__MODEL__[this.elements[g].name||g]=["checkbox","radio"].indexOf((this.elements[g].getAttribute("type")||"text").toLowerCase())<0?(isNaN(k)?this.elements[g].value:k):(this.elements[g].checked?(this.elements[g].value.indexOf("on")==-1?this.elements[g].value:1):(this.elements[g].value.indexOf("on")==-1?"":0))}return this.__MODEL__},data:function(){var k=[];for(var g=0;g<this.elements.length;g++){k.push(c.InputHTMLElementSerialize(this.elements[g]))}return k.join("&")},send:function(){var k=arguments,g=this;if(typeof g.after=="function"){g.opt.after()}c.xhr(Object.assign({data:g.data(),done:typeof k[0]=="function"?function(m){g.response_header=m;var n=k.shift();var l=n.apply(this,k);return f}:function(m){g.response_header=m;try{var l=JSON.parse(this.responseText)}catch(n){l={result:"error",message:this.status+": "+c.HTTP_RESPONSE_CODE[this.status]}}if(l.result=="error"){if(typeof g.fail=="function"){g.fail.call(f,l,k)}}else{if(typeof g.done=="function"){g.done.call(f,l,k)}}if(typeof g.after=="function"){g.after.call(f,l,k)}return f}},g.opt));return this}};c.group=h;c.config={app:{container:'[role="workspace"]'},msg:{container:".alert.alert-danger",tmpl:"alert-box"},spinner:".locker.spinner",popup:{wnd:".b-popup",container:".b-popup .b-popup-content"}};function b(l,g){var k=typeof g==="object"?g:e.el(g);if(k){if(!k.hasOwnProperty("modal")){k.modal={kicker:l,visible:false,callback:null,event:function(n){var m=c.eventCode(n);if((m==27||m=="Escape")&&k.css.has("show")){k.modal.hide(k.modal.callback)}},show:function(o,n,m){if(o&&!k.css.has("show")){tmpl(o,(n?n:{}),k);k.css.add("show");c.addEventListener("keydown",k.modal.event);this.visible=true;if(typeof m==="function"){this.callback=m;this.callback()}}if(this.kicker instanceof HTMLElement){k.kicker=this.kicker}return this},getKicker:function(){return k.kicker},hide:function(m){c.removeEventListener("keydown",k.modal.event);k.css.del("show");k.innerHTML="";this.visible=false;this.callback=m||this.callback;if(typeof this.callback==="function"){this.callback()}if(k.kicker){k.kicker.ui.focus()}return this}}}else{if(l instanceof HTMLElement){k.modal.kicker=l}}return k}console.error('modalDialog: "'+g+'" wrong dialog object or selector!');return null}c.modalDialog=b;var i=function(g){this.route=router;this.registry={};this.dim={};this.instance=g||c;return this};i.prototype={online:function(g){console.log("app::online")},offline:function(g){console.log("app::offline")},bootstrap:function(g){this.route.set(g).chk(g).lsn();return this},get store(){return str2json(storage.getItem("app"),{})},set store(k){var g=str2json(storage.getItem("app"),{});if(typeof k==="object"){storage.setItem("app",JSON.stringify(Object.merge(g,k)))}else{console.error("app::store only Object instance can store! ["+JSON.stringify(k)+"]")}},widget:function(k,n,o,m){var l=this,g=typeof k.root=="string"?c.ui.el(k.root):k.root;tmpl(n,o,function(p){if(g&&p&&(g.innerHTML=p)){l.implement(g,k.event||[]);l.inject(k.root,g,k.code||m&&m.code)}},m);return this},event:function(g,k){this.registry[g]=k;return this},implement:function(l,k){var g=this;(k||[]).forEach(function(n,o){for(var m in g.registry[n]){switch(typeof g.registry[n][m]){case"object":l.ui.els(n,function(){this.ui.on(g.registry[n][m][0],g.registry[n][m][1]);return this});break;case"string":l.ui.els(n,function(){this.ui.on(g.registry[n][0],g.registry[n][1]);return this});return;case"function":g.registry[n][m].call(l.ui.els(n),g.dim[n]||{})}}});return g},variable:function(g,k){if(!g){return j}if(!g.hasOwnProperty("dim")){Object.defineProperty(g,"dim",{get:function(){try{return c.app.dim[k]||(c.app.dim[k]=Object.assign(JSON.parse(storage.getItem(k)||""),{self:g}))}catch(l){c.app.dim[k]={};c.app.dim[k].self=g;return c.app.dim[k]}}});c.app.dim[k]={};c.app.dim[k].self=g;g.store=function(l){var m={};Object.keys(c.app.dim[k]).forEach(function(n){if(l.indexOf(n)!=-1){m[n]=c.app.dim[k][n]}});storage.setItem(k,JSON.stringify(m));return this}}return g},inject:function(g,l,k){if(typeof k==="function"){k.apply(this.variable(l,g),arguments)}return false},elem:fader(config.msg.container)[0],msg:function(k){var g=this;tmpl(config.msg.tmpl,k,g.elem);g.elem.fade=false;setTimeout(function(){g.elem.fade=true},3000);return this},spinner_count:0,spinner_element:e.el(c.config.spinner),set spinner(g){g?this.spinner_count++:this.spinner_count--;this.spinner_count>0?this.spinner_element.style.display="block":this.spinner_element.style.display="none"},get spinner(){if(this.spinner_element.style.display=="none"){return false}return true},before:function(g){c.app.spinner=true},after:function(g){if(g&&g.hasOwnProperty("status")&&parseInt(g.status)==408){c.app.msg({result:"warning",message:"Первышен интервал запроса!"})}c.app.spinner=false},list:c,popupEvent:function(g){if(g.keyCode==27){if(!c.app.elem.css.has("fade")){clearTimeout(c.app.elem.timer);c.app.elem.fade=true}else{c.app.popup()}}},popup:function(o,n,m){var k=this;this.wnd=this.wnd||e.el(c.config.popup.wnd);if(k.wnd.fade){this.container=this.container||e.el(c.config.popup.container);var g=false,l={onTmplError:function(){c.app.msg({message:"Ошибка выполнения приложения!"});console.error(arguments);g=true}};tmpl.apply(l,[o,n,this.variable(this.container,"popupBox"),m]);if(!g){c.addEventListener("keydown",c.app.popupEvent);k.container.css.del("is-(valid|invalid|warning|spinner)");k.wnd.fade=g=false}}else{c.removeEventListener("keydown",k.popupEvent);if(typeof arguments[0]=="function"){arguments[0].apply(k,obj2array(arguments).slice(1))}k.container.innerHTML=null;k.wnd.fade=true;if(k.list){k.list.ui.el('[role="popup-box"]',function(){this.ui.focus()})}}return this},fader:function(k,g){c.fader(k,g);return this},download:function(g,l,m){var k=g,n=this;return c.xhr(Object.assign({responseType:"arraybuffer",url:l,done:function(u,z){var v=z.hasOwnProperty("action-status")?str2json(decodeURIComponent(z["action-status"]),{result:"ok"}):{result:"ok"};if(v.result!="ok"){if(k.disabled){setTimeout(function(){k.disabled=false;k.css.del("spinner")},1500)}c.app.msg(v);return false}try{var p=c.uuid();if(m&&m.hasOwnProperty("filename")){p=m.filename}else{var q=this.getResponseHeader("Content-Disposition");if(q&&q.indexOf("attachment")!==-1){var r=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;var t=r.exec(q);if(t!=null&&t[1]){p=t[1].replace(/['"]/g,"")}}}var w=this.getResponseHeader("Content-Type");var o=c.bb(this.response,{type:w});if(k.disabled){setTimeout(function(){k.disabled=false;k.css.del("spinner")},1500)}if(typeof c.navigator.msSaveBlob!=="undefined"){c.navigator.msSaveBlob(o,p)}else{var s=c.URL.createObjectURL(o);if(p){var y=document.createElement("a");if(typeof y.download==="undefined"){c.open(s)}else{y.href=s;y.download=p;document.body.appendChild(y);y.click();setTimeout(function(){document.body.removeChild(y)},100)}}else{c.open(s,"_self")}setTimeout(function(){URL.revokeObjectURL(s)},100)}}catch(u){if(k.disabled){setTimeout(function(){k.disabled=false;k.css.del("spinner")},1500)}c.app.msg({message:this.status+": "+u+" (URL: "+l+")"});console.error("app::download Error "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},fail:function(o){if(k.disabled){setTimeout(function(){k.disabled=false;k.css.del("spinner")},1500)}console.error("download Error "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},m))},upload:function(w,k,m){var o=w.files[0];var r=m.done;delete m.done;var p=m.fail;delete m.fail;var u=m.stop;delete m.stop;if(!o){return console.warn("File not found!")}var v=function(A,D,z,B){var C=A.mozSlice?A.mozSlice:A.webkitSlice?A.webkitSlice:A.slice?A.slice:function(){};return C.bind(A)(D,z)};var y=o.size,g=o.name;var n=m.sliceSize||1024;var l=m.start||0,q;var s,x;var t=function(){q=l+n;if(y-q<0){q=y}x=v(o,l,q);s=new FormData();s.append("filename",g);s.append("size",y);s.append("start",l);s.append("end",q);s.append("file",x);if(u.call(this)){c.xhr(Object.assign({method:"post",rs:{"Content-type":"multipart/form-data",Hash:acl.user.hash},url:k,data:s,done:function(B,z){try{var A=JSON.parse(this.responseText)}catch(B){A={result:"error",message:this.status+": "+c.HTTP_RESPONSE_CODE[this.status]}}if(A.result=="ok"){if(typeof m.progress==="function"){m.progress.call(A,(Math.floor(A.end/y*1000)/10))}if(A.end<y){l+=n;setTimeout(t,1)}else{r.call(A)}}else{p.call(A);c.app.msg(A)}return},fail:function(A,z){if(typeof m.fail==="function"){m.fail.call(z,A)}console.error("app::upload Error "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},m))}};if(y>0){setTimeout(t,1)}return}};c.app=new i(c.document);c.paginator=function(m,l,g){var k=this,o=m.paginator,n=g?parseInt(g):10;if(o){this.ui.el(".paginator",function(p){tmpl("paginator-box",{pages:Math.ceil(o.count/n),page:o.page,model:l},this)})}return o};var a=function(l,g){var m=[],k=0;if(l){if(typeof g==="object"&&g.hasOwnProperty("page")){k=g.page}l.forEach(function(q,p,n){var o=["INPUT","SELECT"].indexOf(q.tagName)>-1?q:q.ui.el("input,select");if(o){m.push(o);if(typeof g==="object"&&g.hasOwnProperty(o.name)){o.value=g[o.name]}if(o.tagName==="INPUT"){input_validator(o)}}});return{el:m,index:k,__valid:true,transformer:null,get valid(){var n=this;n.__valid=true;this.el.forEach(function(q,p,o){n.__valid&=input_validator(q)});return this.__valid},set params(o){var p={},n=this;n.__valid=true;if(typeof o==="object"){p=o}else{if(typeof o==="string"){p=location.decoder(o)}}if(p.hasOwnProperty("page")){this.index=p.page}this.el.forEach(function(s,r,q){if(p.hasOwnProperty(s.name)){s.value=p[s.name]}else{s.value=""}n.__valid&=input_validator(s)})},get params(){var o={},n=this;this.el.forEach(function(s,r,p){var q=InputHTMLElementValue(s);if(q!==null){o[s.name]=q;input_validator(s)}});return o},diff:function(n){var o=this.params;return Object.keys(o).concat(Object.keys(n)).reduce(function(q,p){if(o[p]!=n[p]){q[p]=n[p]}return q},{})},update:function(o){var r=this.params;r.page=this.index||0;if(typeof o==="string"){var n=location.decoder(o);for(var q in this.el){if(Object.keys(n).indexOf(this.el[q].name)>-1){n[this.el[q].name]=InputHTMLElementValue(this.el[q],"")}}return c.location.update(o,Object.assign(n,r))}else{if(typeof o==="object"){for(var q in this.el){if(Object.keys(o).indexOf(this.el[q].name)>-1){o[this.el[q].name]=InputHTMLElementValue(this.el[q],null);if(o[this.el[q].name]===null){delete o[this.el[q].name]}}}return Object.assign(o,r)}}return"?"+location.encoder(r)},get uri(){var n=this.params;n.page=this.index||0;if(typeof this.transformer==="function"){return location.encoder(this.transformer(n))}return location.encoder(n)},callback:function(p){var n=true,q=Object.keys(p.message||{});if(typeof p==="undefined"){return p}if(q.length){for(var o in this.el){if(q.indexOf(this.el[o].name)>-1){switch(p.result){case"ok":this.el[o].status="success";break;case"error":n&=false;default:this.el[o].status=p.result}}else{n&=input_validator(this.el[o])}}}return n}}}return null};c.filter=a;var d=function(l,k,o){if(!l){return j}var g=l.match(/^\/\w+.*/i)?"//"+location.hostname+l:l;var q=function(n,v,u){var p=[];if(typeof u=="object"){for(var t in u){p.push(t+"="+encodeURIComponent(u[t]))}u=p.join("&")}return xhr(Object.assign({method:v,url:n.route,data:u},n.opt))};var r={methods:k?k:["GET","POST","PUT","DELETE"],route:l,opt:o?o:this,rs:{},error:{},proc:null,before:null,after:null,process:function(n,p){return n},abort:function(){if(this.proc){this.proc.abort()}this.proc=null},done:function(n,p){return this.rs[p]=n},fail:function(n,p){return this.error=n}};for(var s in r.methods){var m=k[s].toUpperCase();r.rs[m]={};r[m]=(function(n){return function(p){this.rs[n]=null;return this.proc=q(this,n,p)}}).apply(r,[m])}if(g){return r}else{console.warn("Can't resolve route:",l)}return{}};c.crud=d}(window,window.ui));(function(i,l,d){if(typeof l==="undefined"){return false}var c={elem:l.el(i.config.msg.container),show:function(p,o){tmpl(i.config.msg.tmpl,p,this.elem);this.elem.css.del("fade");var g=this.elem;if(typeof o=="undefined"||!o){g.timer=setTimeout(function(){g.css.add("fade")},3000)}return this.elem}};i.msg=c;i.spinner_count=0;i.spinner_element=l.el(i.config.spinner);if(i.spinner_element){Object.defineProperty(i,"spinner",{__proto__:null,enumerable:false,configurable:false,set:function(g){g?i.spinner_count++:i.spinner_count--;i.spinner_count>0?i.spinner_element.style.display="block":i.spinner_element.style.display="none"},get:function(){if(i.spinner_element.style.display=="none"){return false}return true}})}var j=function(p,o,q){if(p&&p.tagName){p.value=null;if(!(this instanceof HTMLElement)){p.required=!!q}if(typeof o==="object"&&o&&o.hasOwnProperty(p.name)){p.value=o[p.name]}else{p.value=typeof o==="undefined"?null:o}var g=p.required?m(p):!!p.value;if(this instanceof HTMLElement){if(!!q&&!g){this.status="error"}else{if(this.value){this.status="success"}}}return g}return false};i.setValueFromObject=j;var a=function(p){var o=true,g=null,q;if((p.getAttribute("required")!==null)&&!p.value){o=false}else{if((p.getAttribute("required")===null)&&!p.value){o=true}else{if((q=p.getAttribute("pattern"))===null){o=true}else{if(!p.hasOwnProperty("testPattern")){p.regex=re(q);Object.defineProperty(p,"testPattern",{get:function r(){if(typeof this.regex==="object"){this.regex.lastIndex=0;return this.regex.test(this.value.trim())}else{return true}}})}o=p.testPattern}}}if(typeof(g=p.getAttribute("validator")||p.validator)==="function"){o=g.apply(p,[o])}return o};var m=function(p,g){if(p&&((g||["INPUT","SELECT","TEXTAREA"]).indexOf(p.tagName)>-1)){var o=a(p);if(p.type!="hidden"){h(l.wrap(p));if(o===false){p.status="error"}else{if(o===null||o===d){p.status="warning"}else{if(p.value.trim().length){p.status="success"}else{p.status="none"}}}}return o}return true};i.input_validator=m;var e=function(o,g){if(!o){return null}return this.ui.els(o,function(){if(["checkbox","radio"].indexOf((this.getAttribute("type")||"text").toLowerCase())>-1){this.checked=this.ui.attr(g||"default")||false}else{switch(this.tagName){case"SELECT":this.value=this.ui.attr(g||"default")||0;break;case"INPUT":case"TEXTAREA":default:this.value=this.ui.attr(g||"default")||""}}this.status="none"})};i.set_default=e;var h=function(o){if(o instanceof Element&&l.wrap(o)&&!o.hasOwnProperty("status")&&!o.css.has("no-status")){Object.defineProperty(o,"status",{set:function g(p){this.parentElement.css.del("has-(danger|warning|success|spinner)");this.css.del("is-(valid|invalid|warning|spinner)");if(this.disabled){p="none"}else{if(p===d||p===null){p="warn"}}switch(p){case"error":this._status="error";this.css.add("is-invalid");this.parentElement.css.add("has-danger");break;case"warning":case"warn":this._status="warning";this.css.add("is-warning");this.parentElement.css.add("has-warning");break;case"success":case"ok":this._status="success";this.css.add("is-valid");this.parentElement.css.add("has-success");break;case"spinner":this._status="spinner";this.css.add("is-spinner");this.parentElement.css.add("has-spinner");break;case"none":default:this._status="none"}},get:function g(){return this._status}})}return o};i.inputer=h;i.formvalidator=function(p,q){var g=p&&p.hasOwnProperty("message")&&typeof p.message==="object"&&p.message?p.message:{};for(var o=0;o<this.elements.length;o++){if(!g.hasOwnProperty(this.elements[o].name)&&!m(this.elements[o])){g[this.elements[o].name]=this.elements[o].value||"Поле с неверными данными или пустым значения!"}}if(Object.keys(g).length){if(i.spinner){i.spinner=false}g.caption="Неверно заполнена форма!";if(typeof q==="undefined"||!!q){app.msg({message:g})}return false}return true};var b=function(p){if(!p){return console.error("pattern_validator of null object!")}var q=typeof this==="undefined"?i:this,g=typeof p==="string"?q.ui.els(p):(p instanceof Element?[p]:p);g.forEach(function(s,r,o){if(s instanceof Element&&l.wrap(s)){h(s).ui.on("focus",function(t){if(this.tagName=="INPUT"&&this.value.length){m(this)}else{this.status="none"}return false}).ui.on("input",function(t){if(this.tagName=="INPUT"&&this.value.length){m(this)}else{this.status="none"}return false}).ui.on("blur",function(t){m(this);return false})}});return};i.pattern_validator=b;var k=function(o,g){if(o&&o.tagName==="INPUT"){var p={owner:null,index:0,key:null,cache:{},opt:{},delta:250,timer:null,__xhr:null,get value(){return this.cache.hasOwnProperty(this.key)&&this.cache[this.key][this.index]?this.cache[this.key][this.index]:null},stoped:function(q){if(this.timer!==null){if(this.__xhr){this.__xhr.cancel()}if(this.timer){i.clearTimeout(this.timer);this.timer=null}}if(this.owner.pannel){this.owner.pannel.css.add("fade")}return},delayed:function(){var s=this,q=s.owner.__key__;var r=function r(){if(s.key==q){if(s.owner.pannel){s.owner.pannel.css.add("fade")}s.xhr()}else{s.stoped();if(s.key!="null"&&s.key!=q){s.key=q;s.timer=i.setTimeout(r.bind(s),s.delta)}}return false};s.key=q;if(!s.timer){s.stoped()}s.timer=i.setTimeout(r.bind(s),s.delta);return},activeItem:function(r){var q=this.owner,s=this;if(r&&s.cache[r]){s.key=r}else{if(q.pannel){q.pannel.css.add("fade")}return false}s.index=-1;var t=s.cache[s.key]||[];if(q.pannel&&t.length){q.pannel.ui.el(".active",function(){this.css.del("active")});t.forEach(function(w,x,u){if((s.index<0)&&w[q.name]&&(w[q.name].trim().toLowerCase()==q.__key__)){s.index=x}});q.pannel.ui.el('[value="'+(s.index<0?0:s.index)+'"]',function(){this.css.add("active")})}else{if(q.pannel){q.pannel.css.add("fade")}}return false},tmpl:function(t){var s=this,q=this.owner;s.index=t.length?0:-1;if(q.pannel){if(t.length){var u=l.dom(tmpl(s.opt.tmpl,{data:t,field:q.name}));q.pannel.innerHTML=u?u.innerHTML:null}}else{var r=tmpl(this.opt.tmpl,{data:t,field:q.name});if(r){q.parentElement.insertAdjacentHTML("beforeend",r);q.parentElement.css.add(s.opt.up?"dropup":"dropdown");q.pannel=q.parentElement.ui.el(".dropdown-menu.list");q.pannel.ui.dg("li","mousedown",function(v){q.value=this.innerHTML;q.setValue(s.cache[s.key][s.index=parseInt(this.value)]);q.ui.focus();return false})}else{s.opt.warn(q.name+".typeahead panel not defined!")}}s.activeItem(s.key=q.__key__);return false},xhr:function(){var r=this,s=this.owner,z=s.__key__,v=r.opt.ignore?true:a(s);if((!v&&z!=="null")||(!r.opt.getEmpty&&z==="null")){return this}var w=r.cache.hasOwnProperty(z);if(w){r.activeItem(z);r.show(r.cache[z]);if(r.index>-1){s.__value=d;r.valueChanger(r.value)}}else{var x=w?r.cache[z].length:0;var t=!((z=="null"&&!!r.opt.skip)||(r.opt.skip>z.length));var q=(z!==s.__value.trim().toLowerCase());if(v&&t&&q&&!x){var y=s.status,u={};u[s.name]=s.value;s.status="spinner";r.__xhr=xhr({url:location.update(s.ui.attr("url"),u),rs:r.opt.rs,before:function(){s.status="spinner"},after:function(){s.status=y},done:function(B){try{var A=JSON.parse(this.responseText)}catch(B){A={result:"error",message:this.status+": "+HTTP_RESPONSE_CODE[this.status]}}switch(A.result){case"ok":case"success":r.cache[z]=A.data||[];r.activeItem(z);r.show(r.cache[z]);break;case"error":y="error";r.opt.error(A,this);break;case"warn":default:y="warning";r.opt.warn(A,this)}return this},fail:function(A){s.status="error";r.opt.error(A,this)}})}}return this},show:function(s){var q=this.owner,r=this;if(q.ui.active){if(s&&s.length){r.tmpl(s);if(r.index!=-1){q.setValue(r.value)}if(q.pannel){if(!r.opt.wrapper){q.pannel.setAttribute("style","margin-top:-"+i.getComputedStyle(q).marginBottom+";left:"+q.offsetLeft+"px;width:"+q.clientWidth+"px;")}q.pannel.css.del("fade")}}else{if(q.pannel){q.pannel.css.add("fade")}}}return false},onKeydown:function(u){var q=this,r=i.eventCode(u),s=this.typeahead,t=s.cache[s.key]||[];if(t.length&&q.pannel){switch(r){case"ArrowUp":case 38:if(s.index<0){s.index=0}if(q.pannel){q.pannel.css.del("fade")}if(s.index>0){s.index--}else{s.index=t.length-1}break;case"ArrowDown":case 40:if(s.index<0){s.index=0}if(q.pannel){q.pannel.css.del("fade")}if(s.index<t.length-1){s.index++}else{s.index=0}break;case"Enter":case 13:s.stoped();q.setValue(s.index>-1?s.value:s.cache[s.key][0]);if(q.value.length){q.setSelectionRange(q.value.length,q.value.length)}return false;case"Escape":case 27:s.stoped();return false;default:if(q.pannel){q.pannel.css.add("fade")}setTimeout(s.valueChanger.bind(s),0);return false}q.pannel.ui.el(".active",function(){this.css.del("active")});q.pannel.ui.el('[value="'+s.index+'"]',function(){this.css.add("active")});q.setValue(s.value);if(q.value.length){q.setSelectionRange(q.value.length,q.value.length)}return false}else{if(r=="Enter"||r==13){s.stoped();if(q.pannel){q.pannel.css.add("fade")}}}return false},onFocus:function(t){var r=this,s=this.typeahead,q=r.value.length;if(q){r.setSelectionRange(q,q)}if((!q&&s.opt.getEmpty)||(q&&this.status!="success")){s.delayed();s.activeItem(s.key=r.__key__)}return false},onInput:function(s){var q=this,r=this.typeahead;r.delayed();r.key=q.__key__;r.valueChanger();return false},onBlur:function(s){var q=this,r=this.typeahead;r.stoped();m(q);return false},valueChanger:function(u){var t=this,q=this.owner,r=this.owner.status,s="null";if(!u){if(q.__key__!=="null"){t.index=-1;var v=t.cache[t.key=q.__key__]||[];v.forEach(function(x,y,w){if((t.index<0)&&(x[q.name].trim().toLowerCase()==q.__key__)){t.index=y}});if(t.index>-1){u=t.value;s=t.value[q.name].trim().toLowerCase()||"null"}else{if(q.__value===q.value){return}}}else{u=null}}else{if(u[q.name]){s=u[q.name].trim().toLowerCase()||"null"}else{if(Object.keys(u).length===0){u=null}}}if(q.__key__==="null"||q.__value!==q.value||q.__key__!==s){if(typeof t.opt.fn==="function"){q.status=t.opt.fn.call(q,u)}else{if(t.validate){m(q)}else{q.status=r}}if(u&&u[q.name]){q.__value=q.value=u[q.name]}q.dispatchEvent(new i.ce("change",{detail:u}))}}};if(typeof o.typeahead==="undefined"){if(!l.wrap(o)||!o.ui.attr("url")){console.error("Not have attrib url",o);return}o.typeahead=p;Object.defineProperty(o,"__key__",{get:function(){var q=this.value.trim().toLowerCase();return q.length?q:"null"},enumerable:false});o.__value=o.value;o.typeahead.opt=merge({getEmpty:true,fn:null,wrapper:false,skip:0,ignore:false,rs:{},up:o.hasAttribute("dropup"),tmpl:"typeahead-tmpl",error:function(q,r){console.error(typeof q==="object"?q.message:q)},warn:function(q,r){console.warn(typeof q==="object"?q.message:q)}},g);o.setValue=function(s){var u=this.typeahead,r=this,t=s&&s.hasOwnProperty(this.name),q=this.value===this.__value?this.value.trim().length:0;if(q&&t&&r.__key__===s[r.name].trim().toLowerCase()){if(typeof u.opt.fn==="function"){r.status=u.opt.fn.call(r,s)}}else{u.valueChanger(t?s:((u.index>-1)?u.value:null))}return false};o.typeahead.owner=h(o);o.ui.on("focus",p.onFocus).ui.on("input",p.onInput).ui.on("blur",p.onBlur).ui.on("keydown",p.onKeydown).ui.on("search",p.onInput);if(!o.ui.attr("tabindex")){o.ui.attr("tabindex","0")}}return o}};i.typeahead=k;var n=function(p,r,g){if(p.tagName==="INPUT"){var q=h(p);q.cleared=g==d?true:!!g;if(r){q.maxLength=q.ui.attr("placeholder",r||"").attr("placeholder").length}if(!q.ui.attr("tabindex")){q.ui.attr("tabindex","0")}if(q&&!q.hasOwnProperty("insertDigit")){q.insertDigit=function(x,v){if(v){var z=this.value.indexOf(v);var w=/\d/.test(x)?1:0;var s=this.ui.attr("placeholder").substr(z,v.length).indexOf("_");if(s>0){z+=s}this.value=this.value.substr(0,z)+(/\d/.test(x)?x:"")+this.ui.attr("placeholder").substr(z+w,v.length-w)+this.value.substr(z+v.length,this.value.length);this.selectionStart=this.e1=this.selectionEnd=this.s1=z+1}else{if(/\d/.test(x)&&(this.value||this.ui.attr("placeholder")).indexOf("_")>-1){var y=this.value||this.ui.attr("placeholder");var z=y.indexOf("_");var u=y.match(/\d/)?(y.indexOf(y.match(/\d/))):-1;if(z<=this.selectionStart||u<0||u>z){this.value=(this.value||this.ui.attr("placeholder")).replace("_",x);z=(this.value||this.ui.attr("placeholder")).indexOf("_");this.e1=this.selectionEnd=this.selectionStart=this.s1=z>-1?z:this.value.length}else{if(z>this.selectionStart){this.s1=z=this.selectionStart;var y=x+(this.value.substr(z,this.value.length).match(/\d+/g)||[]).join("")+"_";for(var t=0;t<y.length-1;t++){z=this.value.indexOf(y.charAt(t+1),z);if(z>-1){this.value=this.value.substr(0,z)+y.charAt(t)+this.value.substr(z+1,this.value.length)}}this.selectionStart=this.e1=this.selectionEnd=++this.s1}}}}this.dispatchEvent(new Event("change"));return this.selectionStart};q.init=function(s){var v=this.value;var w=0;if(v){this.value="";var u=this.ui.attr("placeholder");for(var t in u){if(v.length>t&&u[t]==v[t]){this.value+=v[t];w++}else{if(/_/.test(u[t])){this.value+=(w<v.length)?v[w++]:"_"}}}w=this.value.indexOf("_")}else{if(!s){this.value=this.ui.attr("placeholder")}w=this.ui.attr("placeholder").indexOf("_")}if(s){this.value=this.value.replace(/\_/g,"")}return this.e1=this.selectionEnd=this.selectionStart=this.s1=(w>-1?w:this.value.length)}}q.init(true);q.ui.on("keydown",function(y){if(this.ui.attr("placeholder").length&&!this.value){this.value=this.ui.attr("placeholder");this.e1=this.selectionEnd=this.selectionStart=this.s1=0}else{this.s1=this.selectionStart;this.e1=this.selectionEnd}var C=eventCode(y);if(["V","v",86].indexOf(C)>-1&&(y.ctrlKey||y.metaKey)){this.dispatchEvent(new Event("paste"));return false}else{if(["Escape",27,"Enter",13,"R","r",82].indexOf(C)>-1){return true}}var B=((C>=96&&C<=105))?(C-96).toString():C;switch(C){case 8:case"Backspace":if(selected){var A=this.value.indexOf(selected);this.value=this.value.substr(0,A)+this.ui.attr("placeholder").substr(A,selected.length)+this.value.substr(A+selected.length,this.value.length);var t=this.ui.attr("placeholder").substr(A,selected.length).indexOf("_");if(t>0){A+=t}this.selectionStart=this.e1=this.selectionEnd=this.s1=A}else{this.e1=this.s1=--this.selectionStart;--this.selectionEnd;while((this.s1>=0)&&!/\d/.test(this.value.charAt(this.s1))){this.s1=--this.selectionStart;--this.selectionEnd}if(this.s1>=0&&/\d/.test(this.value.charAt(this.s1))){this.value=this.value.substr(0,this.s1)+"_"+this.value.substr((this.s1+1),this.value.length)}else{this.s1=this.e1+1}this.selectionStart=this.selectionEnd=this.s1}this.dispatchEvent(new Event("change"));break;case 9:case"Tab":var s=null;var D=y.shiftKey?-1:1;var w=parseInt(this.ui.attr("tabindex"))+D;if(w>0){while(s=l.el('[tabindex="'+w+'"]')){if(s.ui.attr("disabled")){w+=D}else{s.ui.focus();break}}}if(w<=1&&D<0){return y.preventDefault()}y.stopPropagation();return false;case 37:case"ArrowLeft":this.s1=--this.selectionStart;this.e1=--this.selectionEnd;break;case 39:case"ArrowRight":this.s1=++this.selectionStart;break;case 46:case"Delete":var u=this.value.slice(this.selectionStart),x,z=this.ui.attr("placeholder").slice(this.selectionStart);if(selected){x=(this.value.substr(this.selectionStart+selected.length,this.value.length).match(/\d+/g)||[]).join("");this.e1=this.s1}else{x=(this.value.slice(this.selectionStart).match(/\d+/g)||[]).join("").slice(1)}for(var v in x){z=z.replace("_",x[v])}this.value=this.value.replace(u,z);this.selectionStart=this.s1;this.selectionEnd=this.e1;break;default:if(selected&&(y.ctrlKey||y.metaKey)){if(["C","c",67].indexOf(C)>-1){this.dispatchEvent(new Event("copy"))}return false}this.insertDigit(B,selected)}y.preventDefault();y.stopPropagation();return false}).ui.on("focus",function(s){this.init(false);return false}).ui.on("blur",function(s){if(this.value.match(/[\d]+/g)){this.value=!this.cleared?this.value:this.value.replace(/\_/g,"")}else{this.value=""}m(this);return false}).ui.on("copy",function(s){if(i.clipboardData&&i.clipboardData.setData){i.clipboardData.setData("Text",selected)}else{var t=(s.originalEvent||s).clipboardData;if(t&&t.getData){t.setData("text/plain",selected)}}s.stopPropagation();s.preventDefault();return false}).ui.on("paste",function(t){var w="";if(i.clipboardData&&i.clipboardData.getData){w=i.clipboardData.getData("Text")}else{var v=(t.originalEvent||t).clipboardData;if(v&&v.getData){w=v.getData("text/plain")}t.stopPropagation();t.preventDefault()}var u=w.match(/\d+/g)?w.match(/\d+/g).join(""):"";for(var s in u){this.insertDigit(u[s],selected)}return false});return q}else{if(p instanceof Array){for(var o in p){i.maskedigits(p[o],r,g)}return p}}console.error("plugin maskedigits wrong parent element!");return d};i.maskedigits=n}(window,window.ui));