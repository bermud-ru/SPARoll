
 /**
 * @app jsroll.min.js
 * @category RIA (Rich Internet Application) / SPA (Single-page Application)
 *
 * Классы RIA / SPA javascritp framework
 * @author Андрей Новиков <andrey@novikov.be>
 * @data 22/12/2020
 * @status beta
 * @version 2.1.1b
 * @revision $Id: jsroll.min.js 2.1.1b 2020-12-22 09:30:32Z $
 **/

(function(g,undefined){"use strict";var version="2.1.2b";g.HTTP_RESPONSE_CODE={0:"Request runtime error",10:"Application offline",100:"Continue",101:"Switching Protocol",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choice",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Switch Proxy",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"};g.WEBSOCKET_RESPONSE_CODE={1000:"normal closure",1001:"going away",1002:"protocol error",1003:"unknown data (opcode)",1004:"frame too large",1005:"rrmote host error",1006:"remote host error",1007:"utf8 expected",1008:"message violates server policy",1015:"CERT_AUTHORITY_INVALID"};var WebSocket="MozWebSocket" in g?g.MozWebSocket:("WebSocket" in g?g.WebSocket:undefined);var ws=function(url,opt){this.protocol="";this.opt=opt;this.url=url};ws.prototype={socket:null,connected:false,binaryType:"blob",get readyState(){return this.socket.readyState},up:function(opt){if(!navigator.onLine){return console.error("Browser not connected!")}if(this.connected){return console.warn("Already connected!")}var self=this,socket=new WebSocket(this.url);socket.binaryType=this.binaryType;["error","open","message","close"].forEach(function(e){socket.addEventListener(e,self[e].bind(self))});this.socket=socket;return this},error:function(e){this.connected=false;var close=(this.opt&&typeof this.opt.error==="function")?this.opt.error.call(this,e):(console.error(e)||true);if(close&&this.socket){this.socket.close()}return this},message:function(e){return(this.opt&&typeof this.opt.message==="function")?this.opt.message.call(this,e):console.log(e)},open:function(e){this.connected=new Date();return(this.opt&&typeof this.opt.open==="function")?this.opt.open.call(this,e):console.log(e)},close:function(e){if(!e){return this.connected?this.socket.close():true}this.connected=false;return(this.opt&&typeof this.opt.close==="function")?this.opt.close.call(this,e):console.warn(e)},send:function(data){if(this.connected){this.socket.send(data)}else{console.warn(this.url+" not connected!")}}};g.ws=ws;var eventCode=function(e){if(g.InputEvent&&(e instanceof InputEvent)){return e.data}else{if(e instanceof Event){switch(true){case e.key!==undefined:return e.key;case e.keyIdentifier!==undefined:return e.keyIdentifier;case e.keyCode!==undefined:return e.keyCode;default:return e.charCode}}}return null};g.eventCode=eventCode;var xmlHttpRequest=("XMLHttpRequest" in g?g.XMLHttpRequest:("ActiveXObject" in g?g.ActiveXObject("Microsoft.XMLHTTP"):g.XDomainRequest));if(!("indexedDB" in g)){g.indexedDB=g.mozIndexedDB||g.webkitIndexedDB||g.msIndexedDB||g.shimIndexedDB||null}if(!("IDBTransaction" in g)){g.IDBTransaction=g.webkitIDBTransaction||g.msIDBTransaction||null}if(!("IDBKeyRange" in g)){g.IDBKeyRange=g.webkitIDBKeyRange||g.msIDBKeyRange||null}g.IndexedDBInterface=function(opt){var self=this;try{Object.defineProperty(self,"active",{__proto__:null,get:function active(){return self.instance?self.instance.readyState=="done":false}});if(typeof opt==="object"){self.merge(opt)}self.instance=g.indexedDB.open(self.name,self.version);self.instance.onupgradeneeded=function(e){return self.build(e.target.result)};self.instance.onsuccess=function(e){self.db=e.target.result;return self.success(self.db)};self.instance.onblocked=function(e){return self.blocked(e)};self.instance.onerror=function(e){return self.fail(e)}}catch(e){self.fail(e)}};g.IndexedDBInterface.prototype={db:null,name:null,version:1,schema:null,destroy:function(){var self=this;self.instance=null;self.populate=true;var instance=g.indexedDB.deleteDatabase(self.name,self.version);instance.onsuccess=self.success;instance.onerror=self.fail;instance.onblocked=self.blocked},success:function(e){console.log(this.name+" database ver "+this.version+" successfully");return this},fail:function(e){console.error("Fail "+this.name+" database ver "+this.version,e.message);return this},blocked:function(e){console.warn("Couldn't operate "+self.name+"database ver "+this.version+" due to the operation being blocked");return this},upgrade:function(e){console.log(this.name+" DDLs database ver "+this.version+" successfully inits!");return this},data2row:function(data,flag){if(data&&typeof data==="object"){var p=function(o){var res={};for(var i in o){res[i]=QueryParam(o[i],typeof flag==="undefined"?QueryParam.STRNULL:flag)}return res};if(data instanceof Array){return data.map(function(v){return p(v)})}return p(data)}return data},build:function(db){var self=this;self.db=db||self.db;try{if(self.db.objectStoreNames.contains(self.name)){self.db.deleteObjectStore(self.name)}self.db.createObjectStore(self.name);if(self.heirs){self.heirs.map(function(v,i,a){v.schema(db)})}self.upgrade();return true}catch(e){self.fail(e);return false}},close:function(db){var self=this;self.db=db||self.db;try{self.db.close()}catch(e){self.fail(e)}return self}};var QueryParam=function(v,o){var opt=typeof o==="undefined"?QueryParam.NATIVE:Number(o);if(typeof v==="undefined"||v===null){return !(opt&QueryParam.NULLSTR)&&opt&QueryParam.QOUTED|QueryParam.STRNULL?(opt&QueryParam.NULLSQL?"NULL":null):""}else{if(typeof v==="object"){return opt&QueryParam.QOUTED?"'"+JSON.stringify(v)+"'":String(JSON.stringify(v))}else{if(typeof v==="string"&&v===""){return(opt&QueryParam.NULLSTR)?"":((opt&QueryParam.STRNULL)?(opt&QueryParam.NULLSQL?"NULL":null):"")}}}return/\d+/.test(v)&&String(Number(v))===String(v)?(opt&QueryParam.INTQOUTED?String(v):Number(v)):(opt&QueryParam.QOUTED?"'"+v+"'":String(v))};QueryParam.NATIVE=0;QueryParam.QOUTED=1;QueryParam.STRNULL=2;QueryParam.INTQOUTED=4;QueryParam.NULLSTR=8;QueryParam.NULLSQL=16;g.QueryParam=QueryParam;var paramsNative=function(v,i,a){return QueryParam(v,QueryParam.STRNULL|QueryParam.INTQOUTED)};var paramStatment=function(v,i,a){return v+" = ?"};var webSQL=function(db,opt){if(typeof db!=="object"){throw"webSQL object not exist!"}var self=this;if(typeof opt==="object"){self.merge(opt)}this.db=db};webSQL.prototype={opt:QueryParam.STRNULL|QueryParam.INTQOUTED,changeVersion:function(currentVer,newVer,callback){try{return this.db.changeVersion(currentVer,newVer,callback)}catch(e){this.fail(null,e)}return false},get info(){return this.stmt("SELECT * FROM sqlite_master WHERE type='table' AND name NOT LIKE '__Webkit%';",[],function(tx,rs){var table,tablesNumber=rs.rows.length;console.log("webSQL DB info:");for(var i=0;i<tablesNumber;i++){table=rs.rows.item(i);if(table.type=="table"){tx.executeSql("SELECT name, sql FROM sqlite_master WHERE name = ?",[table.name],function(t,r){console.info("- table: "+r.rows[0].name+", DDL: "+r.rows[0].sql)})}else{console.info("- type: "+table.type+", name: "+table.name)}}})},get version(){return this.db.version},runnig:false,proc:function(tx,callback){this.runnig=tx;if(typeof callback==="function"){return callback.call(this,tx)}return tx},fail:function(tx,error,callback,sql,index,query){if(typeof callback==="function"){callback.call(this,tx,error,sql,index,query)}else{console.error("webSQL query ["+sql+"] error("+error.code+"): "+error.message)}return this.runnig=false},done:function(tx,result,callback,sql,index,query){if(typeof callback==="function"){callback.call(this,tx,result,sql,index,query)}else{console.warn("webSQL query ["+sql+"] resultSet: ",result)}return this.runnig=false},cancel:function(tx){},transaction:function(proc,fail){var self=this;return self.db.transaction(function(tx){return self.proc(tx,proc)},function(error){return self.fail(self.running,error,fail)})},executeSql:function(tx,query,data,done,fail){var self=this,multiQuery=typeof query!=="string";try{return(multiQuery?query:[query]).forEach(function(sql,i,a){return tx.executeSql(sql,(multiQuery?data[i]:data),function(tx,result){return self.done(tx,result,done,sql,i,a)},function(tx,error){return self.fail(tx,error,fail,sql,i,a)})})}catch(e){return self.fail(tx,e,fail)}},stmt:function(query,data,done,fail,bulk){var self=this,d=typeof data==="undefined"?[]:(!!bulk?data:[data]);return this.transaction(function(tx){var i=0,count=d.length,ResultSet=[];var next=function(tx,rs){if(i<count){if(typeof rs!=="undefined"){ResultSet[i]=rs}self.executeSql(tx,query,d[i++],next,fail)}else{return done.call(self,tx,count>1?ResultSet:rs)}};return next(tx)},fail)},grinder:function(o,fields,no_uppend){var res={},self=this;if(fields instanceof Array&&typeof o==="object"){fields.forEach(function(v){if(o.hasOwnProperty(v)||!!no_uppend){res[v]=o.hasOwnProperty(v)?QueryParam(o[v],self.opt):null}})}return res},filtration:function(query,params){var self=this,m=false;if(/:([^\s$%\),]*)/m.test(query)){if(!Object.keys(params).length){throw"webSQL::filter params not exist!"}while(m=/:([^\s$%\),]*)/gm.exec(query)){if(params.hasOwnProperty(m[1])){query=query.replace(m[0],QueryParam(params[m[1]],self.opt))}else{throw"webSQL::filter param ("+m[1]+") not exist!"}}}return query},filter:function(query,params,done,fail){return this.stmt(this.filtration(query,params),[],done,fail)},insert:function(table,params,done,fail,option){var opt=typeof option==="undefined"?webSQL.DEFAULT:Number(option);var fields=opt&webSQL.BULK?Object.keys(params[0]):Object.keys(params);var values=opt&webSQL.BULK?params.map(function(v,i,a){return Object.values(v).map(paramsNative)}):Object.values(params).map(paramsNative);var query=(opt&webSQL.UPSERT?"INSERT OR REPLACE INTO ":"INSERT INTO ")+table+" ("+(fields.join(","))+") VALUES ("+(Array(fields.length).fill("?").join(","))+");";return this.stmt(query,values,done,fail,opt&webSQL.BULK)},update:function(table,params,filter,done,fail){var keys=[],where=[],self=this;if(typeof filter==="string"){filter=this.filtration(filter,params)}else{if(typeof filter==="object"){if(filter instanceof Array){filter.forEach(function(v,i,a){keys.push(v);where.push(QueryParam(params[v],self.opt));delete params[v]})}else{keys=Object.keys(filter);where=Object.values(filter).map(paramsNative)}}}var fields=Object.keys(params);var values=Object.values(params).map(paramsNative);var query="UPDATE "+table+" SET "+(fields.map(paramStatment).join(","));if(keys.length){query+=" WHERE "+(keys.map(paramStatment).join(" AND "))}else{if(typeof filter==="string"){query+=" WHERE "+filter}}return this.stmt(query,values.concat(where),done,fail)}};webSQL.BULK=1;webSQL.UPSERT=2;webSQL.DEFAULT=0;g.webSQL=webSQL;var dbf=function(db,opt){if(!db){return console.warn("webSQL "+opt.naeme+" not exit!")}return{opt:{},db:db,cancel:function(){return false},done:function(tx,rs){if(typeof this.opt.done==="function"){this.opt.done.call(this,tx,rs)}if(typeof this.opt.after==="function"){return this.opt.after.call(this,tx,rs)}},fail:function(tx,er){if(typeof this.opt.fail==="function"){this.opt.fail.call(this,tx,er)}if(typeof this.opt.after==="function"){return this.opt.after.call(this,tx,er)}},filter:function(query,params,opt){if(typeof opt==="object"){this.opt.merge(opt)}if(typeof opt.before==="function"){opt.before.call(this)}this.db.filter(query,params,this.done.bind(this),this.fail.bind(this));return this}}};g.dbf=dbf;g.URL=g.URL||g.webkitURL;g.requestFileSystem=g.requestFileSystem||g.webkitRequestFileSystem;var is_url=/^(?:https?:\/\/)?(?:(?:[\w]+\.)(?:\.?[\w]{2,})+)?([\/\w]+)(\.[\w]+)|^(?:\/[\w]+){1,}/i;var re=function(s,flags){if(typeof s==="object"){return s}try{var p=/[?\/](.+)(\/([igum]*$))/.exec(s)||[];return new RegExp(p[1]||s,p[3]||flags||"")}catch(e){console.error("jsroll::re("+s+")",e);return undefined}};g.re=re;var str2json=function(s,def){try{var o=(typeof s==="string"?JSON.parse(s):s||(typeof def==="undefined"?null:def))}catch(e){o=typeof def==="undefined"?null:def}return o};g.str2json=str2json;var obj2array=function(a){return(a&&typeof a==="object")?Array.prototype.slice.call(a):[]};g.obj2array=obj2array;var kv2array=function(o,glue){return o&&typeof o==="object"?Object.keys(o).map(function(v,i,a){return typeof glue==="function"?glue(v,o[v]):(v+(glue?glue:" ")+o[v])}):[]};g.kv2array=kv2array;var coalesce=function(){for(var i in arguments){if(typeof arguments[i]!=="undefined"&&arguments[i]!==null&&arguments[i]!==""){return arguments[i]}}return undefined};g.coalesce=coalesce;var quoter=function(v,opt){var s=typeof v==="string"?v:(v?JSON.stringify(v):null);if(s){opt=typeof opt==="undefined"?quoter.CODE_QOUTAS:opt;if(opt&quoter.SLASHES_QOUTAS){s=s.replace(/\\"/g,'"').replace(/\\'/g,"'")}if(opt&quoter.CODE_QOUTAS){s=s.replace(/"/g,"&quot;").replace(/'/g,"&#39;")}return s}return""};g.quoter=quoter;g.quoter.CODE_QOUTAS=1;g.quoter.SLASHES_QOUTAS=2;var bundler=function(){return obj2array(arguments).filter(function(v){return(typeof v!=="undefined"&&v!==null&&v!=="")})};g.bundler=bundler;var bitfields=function(status,d){var res=[],st=parseInt(status);if(!st||typeof d!=="object"||d===null){return res}for(var i=0;i<d.length;i++){if(st&Math.pow(2,i)){res.push(d[i])}}return res};g.bitfields=bitfields;var uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16)})};g.uuid=uuid;var crc32=function(str){var makeCRCHelper=g.makeCRCHelper||(g.makeCRCHelper=function(){var c;var makeCRCHelper=[];for(var n=0;n<256;n++){c=n;for(var k=0;k<8;k++){c=((c&1)?(3988292384^(c>>>1)):(c>>>1))}makeCRCHelper[n]=c}return makeCRCHelper});var crc=0^(-1);for(var i=0;i<str.length;i++){crc=(crc>>>8)^makeCRCHelper[(crc^str.charCodeAt(i))&255]}return(crc^(-1))>>>0};g.crc32=crc32;Object.defineProperty(Object.prototype,"merge",{value:function(){if(!arguments.length){return null}var o=(typeof this==="object"?this:(typeof this==="function"?new this:null));if(typeof this==="function"&&o&&o.__proto__.__proto__){o.__proto__.constructor=this}obj2array(arguments).forEach(function(v,k,a){if(o===null){o=(typeof v==="object"?v:(typeof v==="function"?new v:null));if(o&&typeof v==="function"&&o.__proto__){o.__proto__.constructor=v}return o}var x=(typeof v==="object"?v:(typeof v==="function"?new v:null));if(x){if(typeof v==="function"&&x.__proto__){x.__proto__.constructor=v}if(Object.getPrototypeOf(x)!==Object.prototype){Object.merge(o.__proto__,x.__proto__)}Object.defineProperties(o,Object.getOwnPropertyNames(x).reduce(function(d,key){if(o.hasOwnProperty(key)&&Object.getOwnPropertyDescriptor(o,key)["set"]){o[key]=x[key];d[key]=Object.getOwnPropertyDescriptor(o,key)}else{d[key]=Object.getOwnPropertyDescriptor(x,key)}return d},{}))}});return o},enumerable:false});Object.defineProperty(Object.prototype,"__parent__",{value:function(){if(!arguments.length||typeof arguments[0]!=="object"){return null}var self=(typeof this==="object"?this:(typeof this==="function"?new this:{}));var owner=arguments[0];switch(typeof arguments[1]){case"function":var fn=arguments[1];self=new fn;if(self.__proto__){self.__proto__=Object.merge(self.__proto__,owner);self.__proto__.constructor=fn}else{self.prototype=Object.merge(fn.prototype,owner)}break;case"object":self=Object.merge(arguments[1]);case"undefined":default:if(self.__proto__){self.__proto__=owner}else{self.prototype=owner}}self.owner=owner;if(owner.hasOwnProperty("heirs")){if(owner.heirs instanceof Array){owner.heirs.push(self)}else{owner.heirs[self.hasOwnProperty("childIndex")?self.childIndex:Object.keys(owner.heirs).length]=self}}else{if(self.hasOwnProperty("childIndex")){owner.heirs={};owner.heirs[self.childIndex]=self}else{owner.heirs=[];owner.heirs.push(self)}}return self},enumerable:false});Object.defineProperty(String.prototype,"hash",{value:function(){var hash=0,chr;for(var i=0;i<this.length;i++){chr=this.charCodeAt(i);hash=((hash<<5)-hash)+chr;hash|=0}return hash}});var bb=function(blobParts,option){var opt=Object.assign({type:"application/x-www-form-urlencoded"},option);var BlobBuilder=("MozBlobBuilder" in g?g.MozBlobBuilder:("WebKitBlobBuilder" in g?g.WebKitBlobBuilder:g.BlobBuilder));if(BlobBuilder){var bb=new BlobBuilder();bb.append(blobParts);return bb.getBlob(opt.type)}return new Blob([blobParts],opt)};g.bb=bb;var dwnBlob=function(src,filename,type){var blob=g.bb(src,type);if(typeof g.navigator.msSaveBlob!=="undefined"){g.navigator.msSaveBlob(blob,filename)}else{var downloadUrl=g.URL.createObjectURL(blob);if(filename){var a=g.document.createElement("a");if(typeof a.download==="undefined"){g.open(downloadUrl)}else{a.href=downloadUrl;a.download=filename;g.document.body.appendChild(a);a.click();setTimeout(function(){g.document.body.removeChild(a)},100)}}else{g.open(downloadUrl,"_self")}setTimeout(function(){g.URL.revokeObjectURL(downloadUrl)},100)}return false};g.dwnBlob=dwnBlob;var func=function(str,self,args){if(typeof str!=="string"){return console.error("func src is't a string type!\n",str)}try{var s=str.replace(/\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/|\/\/[^\r\n]*/igm,"");switch(true){case /^\s*function.*[}|;]*$/igm.test(s):var _e="_e"+uuid().replace(/-/g,"");var fn=new Function("var "+_e+"="+s+"; return "+_e+".apply(this, arguments)");return fn;default:return function(){return eval(s)}}}catch(e){return console.error("func ",e.message+"\n",str)}};g.func=func;var decoder=function(search,re){var re=re||/[?&]([^=#]+)=([^&#]*)/g,p={},m;try{while(m=re.exec((search||g.location.search))){if(m[1]&&m[2]){p[decodeURIComponent(m[1])]=QueryParam(decodeURIComponent(m[2]),QueryParam.STRNULL)}}}catch(e){return null}return p};g.location.decoder=decoder;var encoder=function(params,divider){if(params&&typeof params==="object"){return String(Object.keys(params).map(function(e,i,a){return encodeURIComponent(e)+"="+encodeURIComponent(QueryParam(params[e],QueryParam.NULLSTR))}).join(divider||"&"))}return params};g.location.encoder=encoder;var update=function(search,params){var u=[],h=[],url=g.location.search,kv=params||{};if(typeof search==="string"){url=search}else{kv=search}var p=g.location.decoder(url);for(var i in kv){p[decodeURIComponent(i)]=QueryParam(decodeURIComponent(kv[i]),QueryParam.STRNULL)}var res=[];for(var a in p){res.push(a+"="+QueryParam(p[a],QueryParam.NULLSTR))}if(res.length){var prefix=url+"?",sufix="";if(url.indexOf("?")>-1){h=url.split("?");if(h.length>1){prefix=h[0]+"?"}}if(url.indexOf("#")>-1){u=url.split("#");if(u.length>1){sufix="#"+u[1]}}return prefix+res.join("&")+sufix}return url};g.location.update=update;function router(r){var isHistory=!!(history.pushState)?1:0;var root=r;return{root:root,rt:[],itv:0,base:isHistory?g.location.pathname+g.location.search:"",referrer:root,clr:function(path){return path.toString().replace(/\/$/,"").replace(/^\//,"")},fr:isHistory?function(){return this.root+this.clr(decodeURI(g.location.pathname+g.location.search)).replace(/\?(.*)$/,"")}:function(){var m=g.location.href.match(/#(.*)$/);return this.root+(m?this.clr(m[1]):"")},add:function(re,handler){if(typeof re=="function"){handler=re;re=""}this.rt.push({re:re,handler:handler});this.rt=this.rt.sort(function(a,b){if(a.re.toString().length<b.re.toString().length){return 1}if(a.re.toString().length>b.re.toString().length){return -1}return 0});return this},rm:function(param){for(var i in this.rt){if(this.rt[i].handler===param||this.rt[i].re.toString()===param.toString()){this.rt.splice(i,1);return this}}return this},chk:function(fr){var f=fr||this.fr(),m=false;for(var i in this.rt){if(m=f.match(this.rt[i].re)){this.rt[i].handler.call(m||{},f);return this}}return this},lsn:function(){var s=this,c=s.fr(),fn=function(){if(c!==s.fr()){c=s.fr();s.chk(c)}return s};clearInterval(s.itv);s.itv=setInterval(fn,50);return s},set:isHistory?function(path){this.referrer=g.location.pathname+g.location.search;history.pushState(null,null,this.root+this.clr(path||""));return this}:function(path){this.referrer=g.location.pathname+g.location.search;window.location.href=g.location.href.replace(/#(.*)$/,"")+"#"+(path||"");return this}}}g.router=router("/");function js(src,opt){if(!src){return null}var opt=Object.assign({async:false,type:"text/javascript",container:g.document.body},opt);var s=g.document.createElement("script");s.type=opt.type;s.async=opt.async;if(opt.hasOwnProperty("id")){s.id=opt.id}if(src.match(is_url)){s.src=src}else{s.text=src}if(typeof opt.onload==="funciton"){s.onload=onload}if(typeof opt.onreadystatechange==="funciton"){s.onreadystatechange=onreadystatechange}if(typeof opt.container.appendChild==="function"){opt.container.appendChild(s)}else{console.error("jsRoll::js() Не существущий контейнер",opt.container)}return s}g.js=js;function xhr(params){var x=new xmlHttpRequest();if(!x){return null}x.fail=function(fn){if(typeof fn==="function"){return fn.call(x,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm))}return x};x.done=function(fn){if(typeof fn==="function"){return fn.call(x,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm))}return x};x.cancel=function(fn){if(typeof fn==="function"){return fn.call(x,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm))}return x};x.process=function(opt){g.addEventListener("offline",x.onerror);var proc=opt.process;x.onreadystatechange=function(e){if(typeof proc==="function"){return proc.call(x,e,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm))}else{if(x.readyState==4&&x.status>=400){g.removeEventListener("offline",x.onerror);x.fail.call(x,e,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm));if(typeof x.after=="function"){x.after.call(x,{status:parseInt(x.status)})}}}return x};x.timeout=opt.timeout;x.ontimeout=function(e){x.halt({status:408});return x};return x};x.halt=function(opt){x.abort();g.removeEventListener("offline",x.onerror);x.cancel.call(x,opt,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm));if(typeof x.after=="function"){x.after.call(x,opt)}return x};x.onerror=function(e){x.fail.call(x,e,{status:10});x.halt({status:500});return false};x.onload=function(e){x.done.call(x,e,location.decoder(x.getAllResponseHeaders(),/([^:\s+\r\n]+):\s+([^\r\n]*)/gm));if(typeof x.after=="function"){x.after.call(x,{status:parseInt(x.status)})}g.removeEventListener("offline",x.onerror);return x};if(params&&params.hasOwnProperty("responseType")){x.responseType=params.responseType}var opt=Object.assign({method:"GET",timeout:10000,cache:false},params);x.method=opt.method.toUpperCase();var rs=Object.assign({"Xhr-Version":version,"Content-type":"application/x-www-form-urlencoded"},(params||{}).rs);if(rs["Content-type"]===false||rs["Content-type"].toLowerCase()=="multipart/form-data"){delete rs["Content-type"]}try{for(var i in opt){if(typeof opt[i]=="function"){x[i]=opt[i]}}if((["GET","DELETE"].indexOf(x.method)>=0)&&opt.data){var u=opt.url||g.location;opt.url=u+(u.indexOf("?")!=-1?"&":"?")+opt.data;opt.data=null}if(typeof x.before=="function"){x.before.call(x,opt,x)}x.open(x.method,opt.url||g.location,opt.async||true,opt.username,opt.password);for(var m in rs){x.setRequestHeader(m,rs[m])}x.response_header=null;x.process(opt).send(opt.data)}catch(e){x.fail.call(x,e,{status:0});x.halt({status:0});return x}return x}g.xhr=xhr;var InputHTMLElementValue=function(el,def){var n=null;if(el instanceof HTMLElement){switch((el.getAttribute("type")||"text").toLowerCase()){case"checkbox":case"radio":var on=(el.value.indexOf("on")==-1);n=el.checked?(on?el.value:1):(on?"":0);break;default:n=el.value||def}}return QueryParam(n,QueryParam.NULLSTR)};g.InputHTMLElementValue=InputHTMLElementValue;var getElementsValues=function(elements,opt){var empty=QueryParam(null,opt||QueryParam.NULLSTR),data={},next=function(keys,d,f,el){if(d===undefined){d=[]}if(!keys||!keys.length){var grp=["checkbox","radio"].indexOf((el.getAttribute("type")||"text").toLowerCase())>-1;if(f&&(!grp||grp&&el.checked)){if(d[f]===undefined||(grp&&d[f]===empty)){d[f]=InputHTMLElementValue(el)}else{if(!!el.getAttribute("pack")&&String(Number(el.value))===String(el.value)){d[f]=Number(d[f])|Number(el.value)}else{if(!(d[f] instanceof Array)){d[f]=[d[f]]}d[f].push(InputHTMLElementValue(el))}}}if(d[f]===undefined&&grp&&!el.checked){d[f]=empty}return d}var key=keys.shift().replace(/^\[+|\]+$/g,"");if(f){if(d[f]===undefined){d[f]=key?{}:[]}return next(keys,d[f],key,el)}return next(keys,d,key,el)};if(elements.length){obj2array(elements).map(function(v){var field=null;if((v.getAttribute("type")||"text")!="button"&&(field=v.name.match(/^\w+/g))){if(!data.hasOwnProperty(field)){data[field[0]]=undefined}return next(v.name.match(/(\[\w+\]?)/g),data,field[0],v)}return undefined})}return data};g.getElementsValues=getElementsValues;var setValueInputHTMLElement=function(el,value){switch((el.getAttribute("type")||"text").toLowerCase()){case"checkbox":case"radio":if(!!el.getAttribute("pack")&&String(Number(el.value))===String(el.value)){el.checked=(Number(value)&Number(el.value))===Number(el.value)}else{el.checked=el.value==="on"?!!value:((value instanceof Array)?value.indexOf(QueryParam(el.value))>-1:String(el.value)===String(value))}break;case"number":el.value=Number(value);break;case"text":case"textarea":case"hidden":case"date":case"time":case"datetime-local":case"month":case"week":case"color":case"range":case"search":case"email":case"tel":case"url":default:el.value=QueryParam(value,QueryParam.NULLSTR)}};g.setValueInputHTMLElement=setValueInputHTMLElement;Object.defineProperty(JSON,"form",{value:function(f){if(f&&!f.hasOwnProperty("MODEL")){Object.defineProperty(f,"MODEL",{set:function MODEL(d){f.reset();if(typeof d==="object"){var is_array,field,index,el,value,type;for(var i=0;i<f.elements.length;i++){field=null;index=null;el=f.elements[i];type=(el.getAttribute("type")||"text").toLowerCase();if(type==="button"){continue}if(is_array=/\[.*\]$/.test(el.name)){field=el.name.replace(/\[.*\]$/,"");if(!d.hasOwnProperty(field)){continue}else{value=d[field]}if(index=/\[([^\]]+)\]/.exec(this.elements[i].name)){index=String(index[1]);if(!d[field].hasOwnProperty(index)){continue}else{value=d[field][index]}}}else{field=el.name||String(i);if(!d.hasOwnProperty(field)){continue}else{value=d[field]}}switch(type){case"checkbox":case"radio":if(is_array){el.checked=el.value==="on"?!!value:str2json(value,[]).indexOf(el.value)!==-1}else{el.checked=el.value==="on"?!!value:String(el.value)==String(value)}break;case"number":el.value=Number(value);break;case"color":case"date":case"datetime-local":case"email":case"month":case"range":case"search":case"tel":case"time":case"url":case"week":case"hidden":case"text":case"textarea":default:el.value=QueryParam(value,QueryParam.NULLSTR)}}}},get:function MODEL(){f.__MODEL__={};var el,type;for(var i=0;i<f.elements.length;i++){el=f.elements[i];type=(el.getAttribute("type")||"text").toLowerCase();if(type==="button"){continue}var field=el.name&&/\[.*\]$/.test(el.name)?el.name.replace(/\[.*\]$/,""):(el.name||String(i));var n=g.InputHTMLElementValue(el);if((typeof f.__MODEL__[field]==="undefined")||(f.__MODEL__[field]===null)){f.__MODEL__[field]=n}else{if(typeof f.__MODEL__[field]!=="undefined"&&n!==null){if(typeof f.__MODEL__[field]!=="object"){f.__MODEL__[field]=[f.__MODEL__[field]]}f.__MODEL__[field].push(n)}}}return f.__MODEL__}});f.is_valid=function(){if(!f.validator||(typeof f.validator==="function"&&f.validator.call(f))){f.setAttribute("valid",1);return true}f.setAttribute("valid",0);return false};f.prepare=function(validator){var data="";if(!validator||(typeof validator==="function"&&validator.call(f,data))){data=encoder(f.MODEL,"&")}else{f.setAttribute("valid",0)}return data};f.fail=typeof f.fail=="function"?f.fail:function(res){f.setAttribute("valid",0);var a=res.form||res.message;if(a){for(var i=0;i<this.elements.length;i++){if(a.hasOwnProperty(this.elements[i].name)){this.elements[i].status="error"}else{this.elements[i].status="none"}}}return f};f.send=function(){var data=f.prepare(f.validator),before=true,args=arguments;if(f.getAttribute("valid")!=0){if(typeof f.before==="function"){before=f.before()}if(before===undefined||!!before){var done=typeof args[0]=="function"?function(e,hr){f.response_header=hr||{};var callback=args.shift();callback.apply(this,args);return f}:function(e,hr){f.response_header=hr||{};f.response=str2json(this.responseText)||{result:"error",message:this.status+": "+HTTP_RESPONSE_CODE[this.status]};if(f.response.result=="error"){if(typeof f.fail=="function"){f.fail.call(f,f.response,hr,args)}}else{if(typeof f.done=="function"){f.done.call(f,f.response,hr,args)}}return f};var after=(typeof f.after==="function")?f.after.bind(f):undefined;f.response={result:undefined};g.xhr(Object.assign({method:f.rest,url:f.action,data:data,done:done,after:after,fail:function(e,hr){console.error("JSON.form["+f.name+"]: "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},f.opt))}}else{f.setAttribute("valid",1)}return f}}f.setAttribute("valid",1);f.rest=f.getAttribute("rest")||f.method;f.validator=f.validator||null;f.opt=f.opt||{};return f},enumerable:false});var tmpl=function tmpl(str,data,cb,opt){var args=arguments;args[1]=args[1]||{};var fn,self={cached:false,str:str,data:data,cb:cb,opt:opt,processing:false,timer:null,wait:function(after,args){var item=this,self=this;if(item.processing){item.timer=setTimeout(function(){item.wait(after,args)},50);return self}else{if(typeof after=="function"){after.apply(item.tmplContext,args)}else{if(after&&(typeof(fn=func(after,item.tmplContext,args))==="function")){fn.apply(item.tmplContext,args)}}}return self},response_header:null,__tmplContext:undefined,get tmplContext(){if(this.__tmplContext){this.__tmplContext.owner=self}return this.__tmplContext},set tmplContext(v){this.__tmplContext=v},onTmplError:function(type,id,str,args,e){var msg=e&&typeof е==="object"?e.message:String(e);return console.error("tmpl type=["+type+"]",[id,str],args,msg+"\n")}};var compile=function(str){var _e="_e"+uuid().replace(/-/g,""),source=str.replace(/\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/|\/\/[^\r\n]*|\<![\-\-\s\w\>\/]*\>/igm,"").replace(/\>\s+\</g,"><").trim(),tag=["{%","%}"];if(!source.match(/{%(.*?)%}/g)&&source.match(/<%(.*?)%>/g)){tag=["<%","%>"]}return source.length?new Function(_e,"var p=[], print=function(){ p.push.apply(p,arguments); }; with("+_e+"){p.push('"+source.replace(/[\r\t\n]/g," ").split(tag[0]).join("\t").replace(re("/((^|"+tag[1]+")[^\t]*)'/g"),"$1\r").replace(re("/\t=(.*?)"+tag[1]+"/g"),"',$1,'").split("\t").join("');").split(tag[1]).join("p.push('").split("\r").join("\\'")+"');} return p.join('');"):undefined},build=function(str,id){var isId=typeof id!=="undefined",data={},pattern=null;var result=null,after,before,a,pig=g.document.getElementById(id);try{if(pig){var nn=undefined;Array.prototype.slice.call(pig.attributes).forEach(function(i){if(i&&/^tmpl-*/i.test(i.nodeName.toString())&&(nn=i.nodeName.toString().replace(/^tmpl-/i,""))){try{data[nn]=JSON.parse(i.value)}catch(e){data[nn]=i.value}}});if((a=pig.getAttribute("arguments"))){try{data=Object.merge(JSON.parse(a)||{},data)}catch(e){return self.onTmplError("tmpl-arguments",id,str,args,a)}}args[1].merge(data);if(pig.getAttribute("before")&&(typeof(fn=func(pig.getAttribute("before"),self,args))==="function")){fn.apply(self,args)}}else{if(opt&&typeof opt.before=="object"){args[1].merge(opt.before)}else{if(opt&&typeof opt.before=="function"){opt.before.call(self,args)}}}if(isId&&g.tmpl.cache.hasOwnProperty(id)){pattern=g.tmpl.cache[id]}else{pattern=compile(str);if(isId){g.tmpl.cache[id]=pattern;if(self.cached){g.localStorage.setItem(id,encodeURIComponent(str))}}}if(!pattern){return self.onTmplError("tmpl-pattern",id,str,args,"пустой шаблон")}var awaiting=function(self){if(self.processing){self.timer=setTimeout(function(){awaiting(self)},50);return}result=pattern.call(self,args[1]);if(typeof cb=="function"){self.tmplContext=cb.call(self,result)||g.tmpl}else{if(self.tmplContext instanceof HTMLElement||cb instanceof HTMLElement&&(self.tmplContext=cb)){self.tmplContext.innerHTML=result}}if(self.tmplContext&&pig&&(after=pig.getAttribute("after"))){self.wait(after,args)}else{if(opt&&typeof opt.after=="function"){self.wait(opt.after,args)}}return result};return awaiting(self)}catch(e){return self.onTmplError("tmpl-build",id,str,args,e)}return result};try{var t;switch(true){case str.match(is_url)?true:false:var id="uri"+str.hash();if(g.tmpl.cache.hasOwnProperty(id)){return build(null,id)}var opt=opt||{};opt.rs=Object.assign(opt.rs||{},{"Content-type":"text/x-template"});self.cached=opt.hasOwnProperty("cached")?!!opt.cached:false;if(self.cached&&(t=g.localStorage.getItem(id))){return build(decodeURIComponent(t),id)}return g.xhr(Object.assign({url:str,async:(typeof cb==="function"),done:function(e,hr){self.response_header=hr;return build(this.responseText,id)},fail:function(e,hr){return self.onTmplError("tmpl-xhr",id,str,args,e)}},opt));case !/[^#*\w\-\.]/.test(str)?true:false:if(g.tmpl.cache.hasOwnProperty(str)){return build(null,str)}var tmp=g.document.getElementById(str.replace(/^#/,""));if(!tmp){return self.onTmplError("tmpl-byId "+str+" not exist!")}self.cached=!!tmp.getAttribute("cached");if(self.cached&&(t=g.localStorage.getItem(str))){return build(decodeURIComponent(t),str)}return build(tmp.innerHTML,str);default:return build(str)}}catch(e){return self.onTmplError("tmpl",id,str,args,e)}};tmpl.cache={};g.tmpl=tmpl;var storage=function(s){try{var s=s||g.localStorage;s.setItem("test","1");s.removeItem("test")}catch(e){return{p:[],setItem:function(key,value){this.p.push(key);this[key]=value},getItem:function(key){if(this.hasOwnProperty(key)){return this[key]}return null},removeItem:function(key){if(this.hasOwnProperty(key)){delete this.p[key];delete this[key]}},clear:function(){this.p.forEach(function(item){delete this[item]});this.p=[]}}}return s};g.storage=storage();var dom=function(){var p;try{if("DOMParser" in g){p=new DOMParser();return function(d,mime){try{return p.parseFromString(d,mime||"text/xml")}catch(e){return null}}}else{if("ActiveXObject" in g){p=new ActiveXObject("Microsoft.XMLDOM");p.async="false";return function(d,mime){try{p.instance.loadXML(d);return p}catch(e){return null}}}}return null}catch(e){return undefined}};g.dom=dom()}(window));(function(e,b){"use strict";var f=function(g){this.instance=this.el(g).instance;return this};f.prototype={el:function(g){this.instance=typeof g==="string"?e.document.querySelector(g):g;return this},style:function(l,g){this.instance.style[l]=g;return this},has:function(m){var l=this.instance.className;if(typeof m!=="string"&&l){return null}var g=[];m.split(" +").forEach(function(p,o,n){if(l.match(re("/(?:^|\\s)"+p+"(?!\\S)/"))){g.push(p)}});return g.length?g:null},replace:function(g,m,l){this.instance.className=this.instance.className.replace(g,m,l);return this},add:function(m){var g=(typeof m==="string")?m.split(/(\s+|,)/):m,l=this;g.forEach(function(o,p,n){if(l.instance&&!l.has(o)){l.instance.className+=" "+o}});return this},del:function(m){var l=this.instance;if(typeof m==="string"||m instanceof Array){var g=typeof m==="string"?m.split(/(\s+|,)/):m;g.forEach(function(o,p,n){l.className=l.className.replace(re("/(?:^|\\s)"+o+"(?!\\S)/"),"").replace(/\s+/," ").trim()})}else{if(typeof m==="object"){l.className=l.className.replace(m,"").replace(/\s+/," ").trim()}}return this},tgl:function(g){if(this.instance){if(!this.has(g)){this.instance.className+=" "+g}else{this.instance.className=this.instance.className.replace(re("/(?:^|\\s)"+g+"(?!\\S)/"),"").trim()}}return this}};e.css=new f(e);Object.defineProperty(e,"selected",{get:function c(){return e.getSelection?e.getSelection().toString():e.document.selection.createRange().text}});function i(){if(e.getSelection){if(e.getSelection().empty){e.getSelection().empty()}else{if(e.getSelection().removeAllRanges){e.getSelection().removeAllRanges()}}}else{if(e.document.selection){e.document.selection.empty()}}}e.selection=i;var k=("CustomEvent" in e?e.CustomEvent:(function(){function g(m,n){n=n||{bubbles:false,cancelable:false,detail:b};var l=e.document.createEvent("CustomEvent");l.initCustomEvent(m,n.bubbles,n.cancelable,n.detail);return l}g.prototype=e.Event.prototype;return g})());e.ce=k;Element.matches=Element.matches||Element.matchesSelector||Element.webkitMatchesSelector||Element.msMatchesSelector||function(g){var n=this,l=(n.parentNode||n.document).querySelectorAll(g),m=-1;while(l[++m]&&l[m]!=n){}return !!l[m]};var h=function(g){if(g.hasOwnProperty("ui")){return g}this._parent=null;this.instance=g||e.document;if(g){this.instance.css=new f(this.instance);this.wrap(this.instance.parentElement)}return this};h.prototype={wrap:function(l,g){if(l&&!l.hasOwnProperty("ui")){l.ui=new h(l);if(typeof g=="string"){e[g]=l}}return l},el:function(m,g){var l=null;if(typeof m==="string"){if(!m.match(/^#*/)){l=e.document.getElementById(m.replace(/^#/,""))}else{l=this.instance.querySelector(m)}}else{if(typeof m==="object"){l=m}}if(l){if(!l.hasOwnProperty("ui")){l.ui=new h(l)}if(typeof g==="string"){e[g]=l}else{if(typeof g==="function"){g.call(l,arguments)}}}return l},els:function(m,l,g){var n=[];if(typeof m==="string"||m instanceof Array){var o=typeof m==="string"?m.split(/,/):m;o.forEach((function(p){n.push.apply(n,obj2array(this.instance.querySelectorAll(p.trim())||{}).map(function(s,r,q){if(!s.hasOwnProperty("ui")){s.ui=new h(s)}if(typeof l=="function"){l.call(s,r,q)}return s}))}).bind(this));if(typeof l=="string"){e[l]=n}else{if(typeof g=="string"){e[g]=n}}}return n},attr:function(l,m){if(l==b){var o={},s;for(var p in this.instance.attributes){o[(s=this.instance.attributes[p].nodeName)]=this.instance.getAttribute(s)}return o}else{if(typeof l==="object"&&typeof m==="undefined"){for(var p in l){if(!/\d+/.test(p)){this.instance.setAttribute(p,l[p])}}return this}else{if(typeof l==="string"&&typeof m==="undefined"){var g=l.indexOf("*")!=-1?re("/"+l.split("*")[0]+"/i"):null;if(g){var q={};obj2array(this.instance.attributes).forEach(function(v,u,n){var t=v.nodeName.toString();if(g.test(t)&&(t=t.replace(g,""))){q[t]=v.value}});return q}else{try{return JSON.parse(this.instance.getAttribute(l))}catch(r){return this.instance.getAttribute(l)}}}else{if(typeof l==="string"&&m){if(!/\d+/.test(l)){if(typeof m==="object"){this.instance.setAttribute(l,JSON.stringify(m))}else{this.instance.setAttribute(l,m)}}}}}}return this},tmpl:function(n,m,g,l){tmpl.apply(this.instance,[n,m,g,l]);return this.instance},merge:function(){merge.apply(this.instance,arguments);return this.instance},src:function(g){if(g instanceof Event){return this.wrap(g.target||g.srcElement)}return this.instance},on:function(n,m,l){var g=this;n.split(",").forEach(function(p){var o=g.instance instanceof Element?[g.instance]:g.instance;o.map(function(q){q.addEventListener(p.trim(),m,!!l)})});return this.instance},dg:function(n,o,m,l){var g=this;g.instance.addEventListener(o,function(r){var q,p=(r.target||r.srcElement);while(p&&p.matches&&p!==g&&!(q=p.matches(n))){p=p.parentElement}if(q){m.call(g.wrap(p),r);return p}return !!q},!!l);return this.instance},dom:function(m,l){if(!m||typeof m!=="string"){return null}var g=e.dom(m,l).childNodes;return g.length>1?g:g[0]},up:function(o,n){var g=e.dom(o,n).childNodes,m=this.instance===e.document?e.ui.el("body"):this.instance;for(var l=0;l<g.length;l++){m.appendChild(g[l])}return m},rm:function(g){if(!g||typeof g!=="string"){return null}this.els(g).forEach(function(l){l.parentNode.removeChild(l)});return this.instance},get active(){return(this.instance instanceof Element&&(this.instance===e.document.activeElement))},focus:function(l){var g=null;if(l){g=(typeof l=="string"?this.el(l):l)}else{g=this.instance}if(g instanceof HTMLElement){e.setTimeout(function(m){g.focus()},0)}return g}};e.ui=new h(document);var a=function(l,m){var n=e.document.createElement("iframe");n.name="print_layer";n.src="printer";n.style.display="none";e.document.body.appendChild(n);var g=(n.contentWindow)?n.contentWindow:(n.contentDocument.document)?n.contentDocument.document:n.contentDocument;g.document.open();g.document.write(tmpl(l,m||{}));g.document.close();setTimeout(function(){e.frames.print_layer.focus();e.frames.print_layer.print();e.document.body.removeChild(n)},1)};e.copy2prn=a;function d(m,l){if(!m){return false}var g=null;var l=Object.assign({display:false,timeout:300,context:null},l),n=function(o){if(!o.hasOwnProperty("fade")){o.faded=o.style.opacity==0;o.opt=l;o.opt.context=typeof l.context==="string"?o.el(l.context):o;Object.defineProperty(o,"fade",{get:function(){return o.faded},set:function(p){if(p){o.css.add("fade");if(o.opt.display){setTimeout(function(){o.style.display="none"},o.opt.timeout)}return o.faded=true}else{if(o.opt.display){o.style.display=o.getAttribute("display")?o.getAttribute("display"):"inherit"}o.css.del("fade");return o.faded=false}},enumerable:true,configurable:true})}return o};if(typeof m==="string"){g=e.ui.els(m);g.forEach(function(p,q,o){n(p)})}else{if(m instanceof HTMLElement){g=n(m)}else{if(typeof m==="object"){g=m;m.forEach(function(p,q,o){n(p)})}}}return g}e.fader=d;var j=function(m,l){this.opt=Object.merge({method:"post",url:location.href,before:function(n){return this.valid?spinner=true:false},after:function(n,o){this.valid=n;return spinner=false},done:function(o){var n=str2json(this.responseText)||{result:"error",message:this.status+": "+HTTP_RESPONSE_CODE[this.status]};if(n.result=="error"){g.opt.fail(n,o)}else{g.opt.done(n,o)}return g.opt.after(n,o)},fail:function(n,o){return console.error(n.message||n)},api:xhr},l);this.__elements=typeof m==="string"?h.els(m):m;if(this.__elements instanceof Array){var g=this;this.elements.forEach(function(p,o,n){p.group=g})}else{this.opt.method=this.__elements.getAttribute("method")||"post";this.opt.url=this.__elements.getAttribute("action")||this.opt.url;this.__elements.addEventListener("submit",this.onsubmit,true)}};j.prototype={onsubmit:function(g){this.send();return g.preventDefault()},get length(){return this.elements.length},__elements:[],get elements(){return this.__elements instanceof HTMLFormElement?this.__elements.elements:this.__elements},events:{},on:function(n,m,l){var g=this;g.events[n]=m;this.elements.forEach(function(q,p,o){q.ui.on(n,g.events[n],l)})},__valid:[],set valid(l){this.__valid=[];if(l&&typeof l.message==="object"){for(var g=0;g<this.elements.length;g++){if(l.message.hasOwnProperty(this.elements[g].name)){this.elements[g].status=l.result||"error";this.__valid.push(this.elements[g])}else{this.elements[g].status="none"}}}},get valid(){this.__valid=[];var g=this;this.elements.forEach(function(n,m,l){if(!input_validator(n)){g.__valid.push(n)}});return !this.__valid.length},set data(l){if(l&&typeof l==="object"){for(var g=0;g<this.elements.length;g++){setValueInputHTMLElement(this.elements[g],(l.hasOwnProperty(this.elements[g].name))?l[this.elements[g].name]:null)}}},get data(){return getElementsValues(this.elements)},send:function(m){var g=this.data;try{return this.opt.before(g)?this.opt.api(Object.assign({data:JSON.stringify(g)},this.opt)):false}catch(l){this.opt.fail({result:"error",message:l.message})}}};e.group=j}(window));(function(c,e,h){"use strict";if(typeof e==="undefined"){return false}c.config={app:{container:'[role="workspace"]'},msg:{container:".alert.alert-danger",tmpl:"alert-box"},spinner:".locker.spinner",popup:{wnd:".b-popup",container:".b-popup .b-popup-content"}};function b(j,g){var i=typeof g==="object"?g:e.el(g);if(i){if(!i.hasOwnProperty("modal")){i.modal={kicker:j,visible:false,callback:null,event:function(l){var k=c.eventCode(l);if((k==27||k=="Escape")&&i.css.has("show")){i.modal.hide(i.modal.callback)}},show:function(m,l,k){this.callback=typeof k==="function"?k:this.callback;if(m&&!i.css.has("show")){try{tmpl(m,(l?l:{}),i)}catch(n){console.error(n.message);return this.hide()}i.css.add("show");c.addEventListener("keydown",i.modal.event);this.visible=true;if(this.callback){this.callback()}}if(this.kicker instanceof HTMLElement){i.kicker=this.kicker}return this},getKicker:function(){return i.kicker},hide:function(k){c.removeEventListener("keydown",i.modal.event);i.css.del("show");i.innerHTML="";this.visible=false;this.callback=k||this.callback;if(typeof this.callback==="function"){this.callback(this)}if(i.kicker){i.kicker.ui.focus()}return this}}}else{if(j instanceof HTMLElement){i.modal.kicker=j}}return i}console.error('modalDialog: "'+g+'" wrong dialog object or selector!');return null}c.modalDialog=b;var f=function(g){this.route=router;this.registry={};this.dim={};this.instance=g||c;return this};f.prototype={online:function(g){console.log("app::online");c.onbeforeunload=h},offline:function(g){console.warn("app::offline");c.onbeforeunload=function(j){if(navigator.onLine){return h}var i="Возможна потеря несохранённых данных.";if(typeof j==="undefined"){j=window.Event}if(j){j.returnValue=i}return i}},bootstrap:function(g){this.route.set(g).chk(g).lsn();return this},get store(){return str2json(storage.getItem("app"),{})},set store(i){var g=str2json(storage.getItem("app"),{});if(typeof i==="object"){storage.setItem("app",JSON.stringify(Object.merge(g,i)))}else{console.error("app::store only Object instance can store! ["+JSON.stringify(i)+"]")}},widget:function(i,l,m,k){var j=this,g=typeof i.root=="string"?c.ui.el(i.root):i.root;tmpl(l,m,function(n){if(g&&n&&(g.innerHTML=n)){j.implement(g,i.event||[]);j.inject(i.root,g,i.code||k&&k.code)}},k);return this},event:function(g,i){this.registry[g]=i;return this},implement:function(j,i){var g=this;(i||[]).forEach(function(l,m){for(var k in g.registry[l]){switch(typeof g.registry[l][k]){case"object":j.ui.els(l,function(){this.ui.on(g.registry[l][k][0],g.registry[l][k][1]);return this});break;case"string":j.ui.els(l,function(){this.ui.on(g.registry[l][0],g.registry[l][1]);return this});return;case"function":g.registry[l][k].call(j.ui.els(l),g.dim[l]||{})}}});return g},variable:function(g,i){if(!g){return h}if(!g.hasOwnProperty("dim")){Object.defineProperty(g,"dim",{get:function(){try{return c.app.dim[i]||(c.app.dim[i]=Object.assign(JSON.parse(storage.getItem(i)||""),{self:g}))}catch(j){c.app.dim[i]={};c.app.dim[i].self=g;return c.app.dim[i]}}});c.app.dim[i]={};c.app.dim[i].self=g;g.store=function(j){var k={};Object.keys(c.app.dim[i]).forEach(function(l){if(j.indexOf(l)!=-1){k[l]=c.app.dim[i][l]}});storage.setItem(i,JSON.stringify(k));return this}}return g},inject:function(g,j,i){if(typeof i==="function"){i.apply(this.variable(j,g),arguments)}return false},elem:fader(config.msg.container)[0],msg:function(i){var g=this;tmpl(config.msg.tmpl,i,g.elem);g.elem.fade=false;setTimeout(function(){g.elem.fade=true},3000);return this},spinner_count:0,spinner_element:e.el(c.config.spinner),set spinner(g){g?this.spinner_count++:this.spinner_count--;this.spinner_count>0?this.spinner_element.style.display="block":this.spinner_element.style.display="none"},get spinner(){if(this.spinner_element.style.display=="none"){return false}return true},before:function(g){c.app.spinner=true},after:function(g){if(g&&g.hasOwnProperty("status")&&parseInt(g.status)==408){c.app.msg({result:"warning",message:"Первышен интервал запроса!"})}c.app.spinner=false},list:c,popupEvent:function(g){if(g.keyCode==27){if(!c.app.elem.css.has("fade")){clearTimeout(c.app.elem.timer);c.app.elem.fade=true}else{c.app.popup()}}},popup:function(m,l,k){var i=this;this.wnd=this.wnd||e.el(c.config.popup.wnd);if(i.wnd.fade){this.container=this.container||e.el('[role="workspace"]');var g=false,j={onTmplError:function(){c.app.msg({message:"Ошибка выполнения приложения!"});console.error(arguments);g=true}};tmpl.apply(j,[m,l,this.variable(this.container,"popupBox"),k]);if(!g){c.addEventListener("keydown",c.app.popupEvent);i.container.css.del("is-(valid|invalid|warning|spinner)");i.wnd.fade=g=false}}else{c.removeEventListener("keydown",i.popupEvent);if(typeof arguments[0]=="function"){arguments[0].apply(i,obj2array(arguments).slice(1))}i.container.innerHTML=null;i.wnd.fade=true;if(i.list){i.list.ui.el('[role="popup-box"]',function(){this.ui.focus()})}}return this},fader:function(i,g){c.fader(i,g);return this},download:function(g,j,k){var i=g,l=this;return c.xhr(Object.assign({responseType:"arraybuffer",url:j,before:k&&k.before||null,after:k&&k.after||null,done:function(q,m){var o=m.hasOwnProperty("action-status")?str2json(decodeURIComponent(m["action-status"]),{result:"ok"}):{result:"ok"};if(o.result!="ok"){if(i.disabled){setTimeout(function(){i.disabled=false;i.css.del("spinner")},1500)}c.app.msg(o);return false}try{var n=c.uuid();if(k&&k.hasOwnProperty("filename")){n=decodeURIComponent(quoter(k.filename,quoter.SLASHES_QOUTAS).replace(/['"]/g,""))}else{var s=this.getResponseHeader("Content-Disposition");if(s&&s.indexOf("attachment")!==-1){var r=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;var p=r.exec(s);if(p!=null&&p[1]){n=decodeURIComponent(quoter(p[1],quoter.SLASHES_QOUTAS).replace(/['"]/g,""))}}}if(i.disabled){setTimeout(function(){i.disabled=false;i.css.del("spinner")},1500)}return c.dwnBlob(this.response,n,this.getResponseHeader("Content-Type"))}catch(q){if(i.disabled){setTimeout(function(){i.disabled=false;i.css.del("spinner")},1500)}c.app.msg({message:this.status+": "+q+" (URL: "+j+")"});console.error("app::download Error "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},fail:k&&k.fail||function(m){if(i.disabled){setTimeout(function(){i.disabled=false;i.css.del("spinner")},1500)}console.error("download Error "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},k))},upload:function(n,m,g){var x=n.files[0];var r=g.done;delete g.done;var o=g.fail;delete g.fail;var u=g.stop;delete g.stop;var s=g.dir||null;delete g.dir;if(!x){return console.warn("File not found!")}var t=function(A,D,z,B){var C=A.mozSlice?A.mozSlice:A.webkitSlice?A.webkitSlice:A.slice?A.slice:function(){};return C.bind(A)(D,z)};var q=x.size,v=x.name;var k=g.sliceSize||1024;var l=g.start||0,j;var y,i,p;var w=function(){j=l+k;y=new FormData();if(q-j<0){j=q;if(g.extra){y.append("payload",typeof g.extra==="string"?g.extra:(g.extra?JSON.stringify(g.extra):null))}}i=t(x,l,j);y.append("dir",s);y.append("filename",v);y.append("size",q);y.append("start",l);y.append("end",j);y.append("file",i);if(u.call(this,p)){p=c.xhr(Object.assign({method:"post",rs:{"Content-type":"multipart/form-data",Hash:acl.user.hash},url:m,data:y,done:function(B,z){var A=str2json(this.responseText)||{result:"error",message:this.status+": "+HTTP_RESPONSE_CODE[this.status]};if(A.result=="ok"){if(typeof g.progress==="function"){g.progress.call(A,(Math.floor(A.end/q*1000)/10))}if(A.end<q){l+=k;setTimeout(w,1)}else{r.call(A)}}else{o.call(A);c.app.msg(A)}return},fail:function(A,z){if(typeof g.fail==="function"){g.fail.call(z,A)}console.error("app::upload Error "+this.status+": "+HTTP_RESPONSE_CODE[this.status],this)}},g))}};if(q>0){setTimeout(w,1)}return}};c.app=new f(c.document);c.paginator=function(k,j,g){var i=this,m=k.paginator,l=g?parseInt(g):10;if(m){this.ui.el(".paginator",function(n){tmpl("paginator-box",{pages:Math.ceil(m.count/l),page:m.page,model:j},this)})}return m};var a=function(j,g){var k=[],i=0;if(j){if(typeof g==="object"&&g.hasOwnProperty("page")){i=g.page}j.forEach(function(o,n,l){var m=["INPUT","SELECT"].indexOf(o.tagName)>-1?o:o.ui.el("input,select");if(m){k.push(m);if(typeof g==="object"&&g.hasOwnProperty(m.name)){m.value=g[m.name]}if(m.tagName==="INPUT"){input_validator(m)}}});return{el:k,index:i,__valid:true,transformer:null,get valid(){var l=this;l.__valid=true;this.el.forEach(function(o,n,m){l.__valid&=input_validator(o)});return this.__valid},set params(m){var n={},l=this;l.__valid=true;if(m&&typeof m==="object"){n=m}else{if(typeof m==="string"){n=c.location.decoder(m)}}if(n.hasOwnProperty("page")){this.index=parseInt(n.page)}this.el.forEach(function(q,p,o){setValueInputHTMLElement(q,n.hasOwnProperty(q.name)?n[q.name]:null);l.__valid&=input_validator(q)})},get params(){var m={},l=this;this.el.forEach(function(q,p,n){var o=InputHTMLElementValue(q);if(o){m[q.name]=o;input_validator(q)}});return m},diff:function(l){var m=this.params;return Object.keys(m).concat(Object.keys(l)).reduce(function(o,n){if(m[n]!=l[n]){o[n]=l[n]}return o},{})},update:function(m){var o=this.params;o.page=this.index||0;if(typeof m==="string"){var l=c.location.decoder(m);this.el.forEach(function(p){if(l.hasOwnProperty(p.name)){l[p.name]=""}});return c.location.update(m,Object.assign(l,o))}else{if(typeof m==="object"){for(var n in this.el){m[this.el[n].name]=InputHTMLElementValue(this.el[n]);if(m.hasOwnProperty(this.el[n].name)&&!m[this.el[n].name]){delete m[this.el[n].name]}}return Object.assign(m,o)}}return"?"+c.location.encoder(o)},get uri(){var l=this.params;l.page=this.index||0;if(typeof this.transformer==="function"){return c.location.encoder(this.transformer(l))}return c.location.encoder(l)},callback:function(n){var l=true,o=Object.keys(n.message||{});if(typeof n==="undefined"){return n}if(o.length){for(var m in this.el){if(o.indexOf(this.el[m].name)>-1){switch(n.result){case"ok":this.el[m].status="success";break;case"error":l&=false;default:this.el[m].status=n.result}}else{l&=input_validator(this.el[m])}}}return l}}}return null};c.filter=a;var d=function(j,i,l){if(!j){return h}var g=j.match(/^\/\w+.*/i)?"//"+location.hostname+j:j;var m=function(n,t,s){var p=[];if(s&&typeof s=="object"){for(var r in s){p.push(r+"="+encodeURIComponent(c.QueryParam(s[r],QueryParam.NULLSTR)))}s=p.join("&")}return xhr(Object.assign({method:t,url:n.route,data:s},n.opt))};var o={methods:i?i:["GET","POST","PUT","DELETE"],route:j,opt:l?l:this,rs:{},error:{},proc:null,before:null,after:null,process:function(n,p){return n},abort:function(){if(this.proc){this.proc.abort()}this.proc=null},done:function(n,p){return this.rs[p]=n},fail:function(n,p){return this.error=n}};for(var q in o.methods){var k=i[q].toUpperCase();o.rs[k]={};o[k]=(function(n){return function(p){this.rs[n]=null;return this.proc=m(this,n,p)}}).apply(o,[k])}if(g){return o}else{console.warn("Can't resolve route:",j)}return{}};c.crud=d}(window,window.ui));(function(h,k,d){if(typeof k==="undefined"){return false}var c={elem:k.el(h.config.msg.container),show:function(o,n){tmpl(h.config.msg.tmpl,o,this.elem);this.elem.css.del("fade");var g=this.elem;if(typeof n=="undefined"||!n){g.timer=setTimeout(function(){g.css.add("fade")},3000)}return this.elem}};h.msg=c;h.spinner_count=0;h.spinner_element=k.el(h.config.spinner);if(h.spinner_element){Object.defineProperty(h,"spinner",{__proto__:null,enumerable:false,configurable:false,set:function(g){g?h.spinner_count++:h.spinner_count--;h.spinner_count>0?h.spinner_element.style.display="block":h.spinner_element.style.display="none"},get:function(){if(h.spinner_element.style.display=="none"){return false}return true}})}var i=function(p,n,q,o){if(p&&p.tagName){p.value=null;if(!(this instanceof HTMLElement)){p.required=!!q}if(typeof n==="object"&&n&&n.hasOwnProperty(o||p.name)){p.value=n[o||p.name]}else{p.value=typeof n==="undefined"?null:n}var g=p.required?l(p):!!p.value;if(this instanceof HTMLElement){if(!!q&&!g){this.status="error"}else{if(this.value){this.status="success"}}}return g}return false};h.setValueFromObject=i;var a=function(o){var n=true,g=null,p;if((o.getAttribute("required")!==null)&&!o.value){n=false}else{if((o.getAttribute("required")===null)&&!o.value){n=true}else{if((p=o.getAttribute("pattern"))===null){n=true}else{if(!o.hasOwnProperty("testPattern")){o.regex=re(p);Object.defineProperty(o,"testPattern",{get:function q(){if(typeof this.regex==="object"){this.regex.lastIndex=0;return this.regex.test(this.value.trim())}else{return true}}})}n=o.testPattern}}}if(typeof(g=o.getAttribute("validator")||o.validator)==="function"){n=g.apply(o,[n])}else{if(o.hasAttribute("validator")){var g=func(o.getAttribute("validator"));n=g.apply(o,[n])}}return n};var l=function(o,g){if(o&&((g||["INPUT","SELECT","TEXTAREA"]).indexOf(o.tagName)>-1)){var n=a(o)&&(o.hasOwnProperty("bindingElement")?a(o.bindingElement):true);if(o.type!="hidden"){f(o);if(n===false){o.status="error"}else{if(n===null||n===d){o.status="warning"}else{if(o.value&&o.value.length){o.status="success"}else{o.status="none"}}}}return n}return true};h.input_validator=l;var e=function(n,g){if(!n){return null}return this.ui.els(n,function(){if(["checkbox","radio"].indexOf((this.getAttribute("type")||"text").toLowerCase())>-1){this.checked=this.ui.attr(g||"default")||false}else{switch(this.tagName){case"SELECT":this.value=this.ui.attr(g||"default")||0;break;case"INPUT":case"TEXTAREA":default:this.value=this.ui.attr(g||"default")||""}}this.status="none"})};h.set_default=e;var f=function(n){if(n instanceof Element&&k.wrap(n)&&!n.hasOwnProperty("status")&&!n.css.has("no-status")){Object.defineProperty(n,"status",{set:function g(o){this.parentElement.css.del("has-(danger|warning|success|spinner)");this.css.del("is-(valid|invalid|warning|spinner)");if(this.disabled){o="none"}else{if(o===d||o===null){o="warn"}}switch(o){case"error":this._status="error";this.css.add("is-invalid");this.parentElement.css.add("has-danger");break;case"warning":case"warn":this._status="warning";this.css.add("is-warning");this.parentElement.css.add("has-warning");break;case"success":case"ok":this._status="success";this.css.add("is-valid");this.parentElement.css.add("has-success");break;case"spinner":this._status="spinner";this.css.add("is-spinner");this.parentElement.css.add("has-spinner");break;case"none":default:this._status="none"}},get:function g(){return this._status}})}return n};h.inputer=f;h.formvalidator=function(o,p){var g=o&&o.hasOwnProperty("message")&&typeof o.message==="object"&&o.message?o.message:{};for(var n=0;n<this.elements.length;n++){if(!g.hasOwnProperty(this.elements[n].name)&&!l(this.elements[n])){if(!this.elements[n].hasOwnProperty("message")||(this.elements[n].message!==false)){g[this.elements[n].name]=this.elements[n].message||"Поле с неверными данными или пустым значения!"}}}if(Object.keys(g).length){if(h.spinner){h.spinner=false}g.caption="Неверно заполнена форма!";if(typeof p==="undefined"||!!p){app.msg({message:g})}else{return g}return false}return true};var b=function(n){if(!n){return console.error("pattern_validator of null object!")}var p=typeof this==="undefined"?h:this,g=typeof n==="string"?p.ui.els(n):(n instanceof Element?[n]:n);g.forEach(function(r,q,o){if(r instanceof Element&&k.wrap(r)){f(r).ui.on("focus",function(s){if(this.tagName=="INPUT"&&this.value.length){l(this)}else{this.status="none"}return false}).ui.on("input",function(s){if(this.tagName=="INPUT"&&this.value.length){l(this)}else{this.status="none"}return false}).ui.on("blur",function(s){l(this);return false})}});return};h.pattern_validator=b;var j=function(n,g){if(n&&n.tagName==="INPUT"){var o={owner:null,index:0,key:null,cache:{},opt:{},delta:250,timer:null,__xhr:null,get value(){return this.cache.hasOwnProperty(this.key)&&this.cache[this.key][this.index]?this.cache[this.key][this.index]:null},stoped:function(p){if(this.timer!==null){if(this.__xhr){this.__xhr.cancel()}if(this.timer){h.clearTimeout(this.timer);this.timer=null}}if(this.owner.pannel){this.owner.pannel.css.add("fade")}return},delayed:function(){var r=this,p=r.owner.__key__;var q=function q(){if(r.key==p){if(r.owner.pannel){r.owner.pannel.css.add("fade")}r.xhr()}else{r.stoped();if(r.key!="null"&&r.key!=p){r.key=p;r.timer=h.setTimeout(q.bind(r),r.delta)}}return false};r.key=p;if(!r.timer){r.stoped()}r.timer=h.setTimeout(q.bind(r),r.delta);return},activeItem:function(q){var p=this.owner,r=this;if(q&&r.cache[q]){r.key=q}else{if(p.pannel){p.pannel.css.add("fade")}return false}r.index=-1;var s=r.cache[r.key]||[];if(p.pannel&&s.length){p.pannel.ui.el(".active",function(){this.css.del("active")});s.forEach(function(u,w,t){if((r.index<0)&&u[p.name]&&(u[p.name].trim().toLowerCase()==p.__key__)){r.index=w}});p.pannel.ui.el('[value="'+(r.index<0?0:r.index)+'"]',function(){this.css.add("active")})}else{if(p.pannel){p.pannel.css.add("fade")}}return false},tmpl:function(r){var q=this,p=this.owner;q.index=r.length?0:-1;if(p.pannel){if(r.length){tmpl(q.opt.tmpl,{data:r,field:p.name},function(s){var t=k.dom(s);p.pannel.innerHTML=t?t.innerHTML:null})}}else{tmpl(this.opt.tmpl,{data:r,field:p.name},function(s){p.parentElement.insertAdjacentHTML("beforeend",s);p.parentElement.css.add(q.opt.up?"dropup":"dropdown");p.pannel=p.parentElement.ui.el(".dropdown-menu.list");p.pannel.ui.dg("li","mousedown",function(t){p.value=this.innerHTML;p.setValue(q.cache[q.key][q.index=parseInt(this.value)]);p.ui.focus()})})}q.activeItem(q.key=p.__key__);return false},xhr:function(){var q=this,r=this.owner,y=r.__key__,u=q.opt.ignore?true:a(r);if((!u&&y!=="null")||(!q.opt.getEmpty&&y==="null")){return this}var v=q.cache.hasOwnProperty(y);if(v){q.activeItem(y);q.show(q.cache[y]);if(q.index>-1){r.__value=d;q.valueChanger(q.value)}}else{var w=v?q.cache[y].length:0;var s=!((y=="null"&&!!q.opt.skip)||(q.opt.skip>y.length));var p=(y!==r.__value.trim().toLowerCase());if(u&&s&&p&&!w){var x=r.status,t={};if(q.opt.alias){t[q.opt.alias]=r.value}else{t[r.name]=r.value}r.status="spinner";q.__xhr=q.opt.dbf?q.opt.dbf.filter(q.opt.query,t,{before:function(){r.status="spinner"},after:function(){r.status=x},done:function(z,A){q.cache[y]=h.obj2array(A.rows).map(function(B){if(q.opt.alias){B[r.name]=B[q.opt.alias];delete B[q.opt.alias];return B}else{return B}});q.activeItem(y);q.show(q.cache[y]);return false},fail:function(z,A){r.status="error";q.opt.error(A.message,this);return false}}):xhr({url:location.update(r.ui.attr("url"),t),rs:q.opt.rs,before:function(){r.status="spinner"},after:function(){r.status=x},done:function(A){var z=str2json(this.responseText)||{result:"error",message:this.status+": "+HTTP_RESPONSE_CODE[this.status]};switch(z.result){case"ok":case"success":q.cache[y]=(z.data||[]).map(function(B){if(q.opt.alias){B[r.name]=B[q.opt.alias];delete B[q.opt.alias];return B}else{return B}});q.activeItem(y);q.show(q.cache[y]);break;case"error":x="error";q.opt.error(z,this);break;case"warn":default:x="warning";q.opt.warn(z,this)}return this},fail:function(z){r.status="error";q.opt.error(z,this)}})}}return this},show:function(r){var p=this.owner,q=this;if(p.ui.active){if(r&&r.length){q.tmpl(r);if(q.index!=-1){p.setValue(q.value)}if(p.pannel){if(!q.opt.wrapper){p.pannel.setAttribute("style","margin-top:-"+h.getComputedStyle(p).marginBottom+";left:"+p.offsetLeft+"px;width:"+p.clientWidth+"px;")}p.pannel.css.del("fade")}}else{if(p.pannel){p.pannel.css.add("fade")}}}return false},onKeydown:function(t){var p=this,q=h.eventCode(t),r=this.typeahead,s=r.cache[r.key]||[];if(s.length&&p.pannel){switch(q){case"ArrowUp":case 38:if(r.index<0){r.index=0}if(p.pannel){p.pannel.css.del("fade")}if(r.index>0){r.index--}else{r.index=s.length-1}break;case"ArrowDown":case 40:if(r.index<0){r.index=0}if(p.pannel){p.pannel.css.del("fade")}if(r.index<s.length-1){r.index++}else{r.index=0}break;case"Enter":case 13:r.stoped();p.setValue(r.index>-1?r.value:r.cache[r.key][0]);if(p.value.length){p.setSelectionRange(p.value.length,p.value.length)}return false;case"Escape":case 27:r.stoped();return false;default:if(p.pannel){p.pannel.css.add("fade")}setTimeout(r.valueChanger.bind(r),0);return false}p.pannel.ui.el(".active",function(){this.css.del("active")});p.pannel.ui.el('[value="'+r.index+'"]',function(){this.css.add("active")});p.setValue(r.value);if(p.value.length){p.setSelectionRange(p.value.length,p.value.length)}return false}else{if(q=="Enter"||q==13){r.stoped();if(p.pannel){p.pannel.css.add("fade")}}}return false},onFocus:function(s){var q=this,r=this.typeahead,p=q.value.length;if(p){q.setSelectionRange(p,p)}if((!p&&r.opt.getEmpty)||(p&&this.status!="success")){r.delayed();r.activeItem(r.key=q.__key__)}return false},onInput:function(r){var p=this,q=this.typeahead;q.delayed();q.key=p.__key__;q.valueChanger();return false},onBlur:function(r){var p=this,q=this.typeahead;q.stoped();l(p);return false},valueChanger:function(t){var s=this,p=this.owner,q=this.owner.status,r="null";if(!t){if(p.__key__!=="null"){s.index=-1;var u=s.cache[s.key=p.__key__]||[];u.forEach(function(x,y,w){if((s.index<0)&&(x[p.name].trim().toLowerCase()==p.__key__)){s.index=y}});if(s.index>-1){t=s.value;r=s.value[p.name].trim().toLowerCase()||"null"}else{if(p.__value===p.value){return}}}else{t=null}}else{if(t[p.name]){r=t[p.name].trim().toLowerCase()||"null"}else{if(Object.keys(t).length===0){t=null}}}if(p.__key__==="null"||p.__value!==p.value||p.__key__!==r){if(typeof s.opt.fn==="function"){p.status=s.opt.fn.call(p,t)}else{if(s.validate){l(p)}else{p.status=q}}if(t&&t[p.name]){p.__value=p.value=t[p.name]}p.dispatchEvent(new h.ce("change",{detail:t}))}}};if(typeof n.typeahead==="undefined"){if(!k.wrap(n)){console.error("Not have attrib url",n);return}n.typeahead=o;Object.defineProperty(n,"__key__",{get:function(){var p=this.value.trim().toLowerCase();return p.length?p:"null"},enumerable:false});n.__value=n.value;n.typeahead.opt=merge({alias:null,getEmpty:true,query:null,dbf:null,fn:null,wrapper:false,skip:0,ignore:false,rs:{},up:n.hasAttribute("dropup"),tmpl:"typeahead-tmpl",error:function(p,q){console.error(typeof p==="object"?p.message:p)},warn:function(p,q){console.warn(typeof p==="object"?p.message:p)}},g);n.setValue=function(r){var t=this.typeahead,q=this,s=r&&r.hasOwnProperty(this.name),p=this.value===this.__value?this.value.trim().length:0;if(p&&s&&q.__key__===r[q.name].trim().toLowerCase()){if(typeof t.opt.fn==="function"){q.status=t.opt.fn.call(q,r)}}else{t.valueChanger(s?r:((t.index>-1)?t.value:null))}return false};n.typeahead.owner=f(n);n.ui.on("focus",o.onFocus).ui.on("input",o.onInput).ui.on("blur",o.onBlur).ui.on("keydown",o.onKeydown).ui.on("search",o.onInput);if(!n.ui.attr("tabindex")){n.ui.attr("tabindex","0")}}return n}};h.typeahead=j;var m=function(o,q,g){if(o.tagName==="INPUT"){var p=f(o);p.cleared=g==d?true:!!g;if(q){p.maxLength=p.ui.attr("placeholder",q||"").attr("placeholder").length}if(!p.ui.attr("tabindex")){p.ui.attr("tabindex","0")}if(p&&!p.hasOwnProperty("insertDigit")){p.insertDigit=function(w,u){if(u){var y=this.value.indexOf(u);var v=/\d/.test(w)?1:0;var r=this.ui.attr("placeholder").substr(y,u.length).indexOf("_");if(r>0){y+=r}this.value=this.value.substr(0,y)+(/\d/.test(w)?w:"")+this.ui.attr("placeholder").substr(y+v,u.length-v)+this.value.substr(y+u.length,this.value.length);this.selectionStart=this.e1=this.selectionEnd=this.s1=y+1}else{if(/\d/.test(w)&&(this.value||this.ui.attr("placeholder")).indexOf("_")>-1){var x=this.value||this.ui.attr("placeholder");var y=x.indexOf("_");var t=x.match(/\d/)?(x.indexOf(x.match(/\d/))):-1;if(y<=this.selectionStart||t<0||t>y){this.value=(this.value||this.ui.attr("placeholder")).replace("_",w);y=(this.value||this.ui.attr("placeholder")).indexOf("_");this.e1=this.selectionEnd=this.selectionStart=this.s1=y>-1?y:this.value.length}else{if(y>this.selectionStart){this.s1=y=this.selectionStart;var x=w+(this.value.substr(y,this.value.length).match(/\d+/g)||[]).join("")+"_";for(var s=0;s<x.length-1;s++){y=this.value.indexOf(x.charAt(s+1),y);if(y>-1){this.value=this.value.substr(0,y)+x.charAt(s)+this.value.substr(y+1,this.value.length)}}this.selectionStart=this.e1=this.selectionEnd=++this.s1}}}}this.dispatchEvent(new Event("change"));return this.selectionStart};p.init=function(r){var u=this.value;var v=0;if(u){this.value="";var t=this.ui.attr("placeholder");for(var s in t){if(u.length>s&&t[s]==u[s]){this.value+=u[s];v++}else{if(/_/.test(t[s])){this.value+=(v<u.length)?u[v++]:"_"}}}v=this.value.indexOf("_")}else{if(!r){this.value=this.ui.attr("placeholder")}v=this.ui.attr("placeholder").indexOf("_")}if(r){this.value=this.value.replace(/\_/g,"")}return this.e1=this.selectionEnd=this.selectionStart=this.s1=(v>-1?v:this.value.length)}}p.init(true);p.ui.on("keydown",function(x){if(x.ctrlKey||x.metaKey){return false}var B=eventCode(x);var A=((B>=96&&B<=105))?(B-96).toString():B;if(/\d/.test(A)){this.insertDigit(A,selected)}else{if(this.ui.attr("placeholder").length&&!this.value){this.value=this.ui.attr("placeholder");this.e1=this.selectionEnd=this.selectionStart=this.s1=0}else{this.s1=this.selectionStart;this.e1=this.selectionEnd}switch(B){case 8:case"Backspace":if(selected){var z=this.value.indexOf(selected);this.value=this.value.substr(0,z)+this.ui.attr("placeholder").substr(z,selected.length)+this.value.substr(z+selected.length,this.value.length);var s=this.ui.attr("placeholder").substr(z,selected.length).indexOf("_");if(s>0){z+=s}this.selectionStart=this.e1=this.selectionEnd=this.s1=z}else{this.e1=this.s1=--this.selectionStart;--this.selectionEnd;while((this.s1>=0)&&!/\d/.test(this.value.charAt(this.s1))){this.s1=--this.selectionStart;--this.selectionEnd}if(this.s1>=0&&/\d/.test(this.value.charAt(this.s1))){this.value=this.value.substr(0,this.s1)+"_"+this.value.substr((this.s1+1),this.value.length)}else{this.s1=this.e1+1}this.selectionStart=this.selectionEnd=this.s1}this.dispatchEvent(new Event("change"));break;case 13:case"Enter":this.dispatchEvent(new Event("change"));return false;case 27:case"Escape":this.dispatchEvent(new Event("blur"));return false;case 9:case"Tab":var r=null;var C=x.shiftKey?-1:1;var v=parseInt(this.ui.attr("tabindex"))+C;if(v>0){while(r=k.el('[tabindex="'+v+'"]')){if(r.ui.attr("disabled")){v+=C}else{r.ui.focus();break}}}if(v<=1&&C<0){return x.preventDefault()}break;case 37:case"ArrowLeft":if(this.selectionStart>0){this.s1=--this.selectionStart;this.e1=--this.selectionEnd}break;case 39:case"ArrowRight":this.s1=++this.selectionStart;break;case 46:case"Delete":var t=this.value.slice(this.selectionStart),w,y=this.ui.attr("placeholder").slice(this.selectionStart);if(selected){w=(this.value.substr(this.selectionStart+selected.length,this.value.length).match(/\d+/g)||[]).join("");this.e1=this.s1}else{w=(this.value.slice(this.selectionStart).match(/\d+/g)||[]).join("").slice(1)}for(var u in w){y=y.replace("_",w[u])}this.value=this.value.replace(t,y);this.selectionStart=this.s1;this.selectionEnd=this.e1;this.dispatchEvent(new Event("change"));break;default:}}x.preventDefault();x.stopPropagation();return false}).ui.on("focus",function(r){this.init(false);return false}).ui.on("blur",function(r){if(this.value.match(/[\d]+/g)){this.value=!this.cleared?this.value:this.value.replace(/\_/g,"")}else{this.value=""}l(this);return false}).ui.on("copy",function(r){r.stopPropagation();r.preventDefault();if(h.clipboardData&&h.clipboardData.setData){h.clipboardData.setData("Text",selected)}else{var s=(r.originalEvent||r).clipboardData;if(s&&s.getData){s.setData("text/plain",selected)}}return false}).ui.on("paste",function(s){s.stopPropagation();s.preventDefault();var v="";if(h.clipboardData&&h.clipboardData.getData){v=h.clipboardData.getData("Text")}else{var u=(s.originalEvent||s).clipboardData;if(u&&u.getData){v=u.getData("text/plain")}}if(v){var t=v.match(/\d+/g)?v.match(/\d+/g).join(""):"";for(var r in t){this.insertDigit(t[r],selected)}}return false});return p}else{if(o instanceof Array){for(var n in o){h.maskedigits(o[n],q,g)}return o}}console.error("plugin maskedigits wrong parent element!");return d};h.maskedigits=m}(window,window.ui));